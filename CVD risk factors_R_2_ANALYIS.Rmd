---
title: "CVD risk factors among bottom billion - ANALYSIS"
author: "Lisa Stehr"
date: "7 1 2022"
output: html_document
---

```{r setup, include=FALSE}

library(tidyverse)
library(forcats) # for categorical variables (R for data science rec) --> see https://rdrr.io/cran/forcats/man/fct_unify.html
library(stringr) # for manipulating string variables (R for data science rec)
library(ggplot2) 
library(ggrepel) # to avoid text labels in ggplot from overlapping
library(broom) # to create tidy data from model output
library(binom) # for confidence intervals for binary data. It seems the recommended approach for any n is the wilson method (methods="wilson")
library(margins) # R equivalent of Stata's margins command --> Thomas Leeper said this only to be used for marginal effects (not prediction)
library(srvyr)  # survey package that also works with dplyr 
library(survey) # includes the command svyglm
library(miceadds) 
library(lemon) # some nice features for ggplot, e.g., grid_arrange_shared_legend (to have a shared legend between multiple plots)
library(lme4) # for multi-level modeling
library(lmerTest) # for p-values with the lmer command
library(sjPlot) # for plotting lmer models
library(openxlsx) # to open xlxs files (works without java)
library(gridExtra)
library(rms) # for restricted cubic splines
library(mfp) # for fractional polynomials
library(scales) # for adding labels in percent
library(statar) # for xtile command
library(haven) # for write_dta
library(readxl)
library(epikit)
library(readxl)
options(survey.lonely.psu="adjust")

```


```{r load in final dataset created in bb.cleaning script}

  bottombillion <- read.csv("~/bottombillion1.csv", stringsAsFactors=F)
  bottombillion <- bottombillion[,-1]
  bottombillion$country <- as.character(bottombillion$country)

```

#before the analysis some more country-level data needs to be adde~ WB regions, epidemiological subregions for WHO CVD risk package, population, GDP

```{r add regions}
###allocate regions according to WB classification (https://datahelpdesk.worldbank.org/knowledgebase/articles/906519-world-bank-country-and-lending-groups)

#Latin America  
  bottombillion <- bottombillion %>% 
    mutate(region = ifelse(country=='Albania' | country=='Georgia' | country=='Kazakhstan' | country=='Kyrgyz Republic' | country=='Romania' | 
                             country=='Armenia' | country=='Tajikistan' | country=='Turkey', "Europe and Central Asia ",
                    ifelse(country=='Bangladesh' | country=='Bhutan' | country=='India' | country=='Maldives' | country=='Pakistan', 'South Asia',
                    ifelse(country=='Bolivia' | country=='Brazil' | country=='Chile' | country=='Ecuador' | country=='Mexico' | country=='Peru' | 
                             country=='Dominican Republic' | country=='Guatemala' | country=='Honduras' | country=='Costa Rica' | country=='Panama' | 
                             country=='Uruguay' | country=='Colombia' | country=='Haiti', 'Latin America and the Caribbean ', NA))))

#Africa                     
  bottombillion <- bottombillion %>% 
    mutate(region = ifelse(country=='Benin' | country=='Burkina Faso' | country=='Comoros' | country=='Ghana' |country=='Kenya' | country=='Liberia' | 
                             country=='Mozambique' | country=='South Africa' | country=='Swaziland' | country=='Tanzania' | country=='Togo' | 
                             country=='Uganda' | country=='Zanzibar' | country=='Lesotho' | country=='Namibia' | country=='Burundi' | 
                             country=='Cameroon' | country=='Congo' | country=='Congo Democratic Republic' | country=='Cote dIvoire' | 
                             country=='Ethiopia' | country=='Gabon' | country=='Gambia' | country=='Guinea' | country=='Sierra Leone' | 
                             country=='Malawi' | country=='Niger' | country=='Rwanda' | country=='Senegal' | country=='Zimbabwe' | country=='Zambia' | 
                             country=='Angola' | country=='Chad' | country=='Nigeria' | country=='Mali' | country=='Sao Tome and Principe' | 
                             country=='Botswana' | country=='Madagascar' | country=='Cabo Verde', 'Sub-Saharan Africa ', region))
 
#Middle East North Africa                                                           
  bottombillion <- bottombillion %>% 
    mutate(region = ifelse(country=='Egypt' | country=='Lebanon' | country=='Jordan' | country=='Yemen' | country=='Iran', 'Middle East and North 
                           Africa', region))

#East Asia  
  bottombillion <- bottombillion %>% 
    mutate(region = ifelse(country=='Indonesia' | country=='Mongolia' | country=='Vanuatu' | country=='China' | country=='Timor Leste' |  
                           country=='Myanmar' |  country=='Philippines' |  country=='Thailand' |  country=='Vietnam' |  country=='Kiribati' |  
                           country=='Laos' |  country=='Samoa' |  country=='Solomon Islands' |  country=='Tuvalu' |  country=='Tonga', 'East Asia and 
                           Pacific ', region))
   
###create epidemiological subregions from https://www.who.int/ncds/management/WHO_ISH_Risk_Prediction_Charts.pdf?ua=1
  bottombillion  <- bottombillion %>% 
    mutate(subregion =ifelse(country=="Angola" | country=="Benin" | country=="Burkina Faso" | country=="Cameroon" | country=="Cabo Verde" | 
                          country=="Chad" | country=="Comoros" | country=="Gabon" | country=="Gambia" | country=="Ghana" | country=="Guinea" | 
                          country=="Guinea-Bissau" | country=="Liberia" |  
                          country=="Madagascar" | country=="Mali"|  country=="Niger" | country=="Nigeria" | country=="Sao Tome and Principe"  
                         |country=="Senegal" | country=="Sierra Leone" | country=="Togo", '"AFR_D"', 
                   ifelse(country=="Botswana" | country=="Burundi" | country=="Congo" | country=="Cote dIvoire" | country=="Ethiopia" | country=="Kenya"
                         |country=="Lesotho" | country=="Malawi" | country=="Namibia" | country=="Rwanda" | country=="South Africa" | 
                          country=="Swaziland" | country=="Uganda" | country=="Tanzania" | country=="Zambia" | country=="Zimbabwe" | 
                          country=="Zanzibar" | country=="Mozambique", '"AFR_E"',
                   ifelse(country=="Belize" |country=="Brazil" |country=="Costa Rica" |country=="Honduras" |country=="Mexico" |country=="Uruguay" 
                          |country=="Panama" |country=="Dominican Republic" |country=="Paraguay" | country=="Chile" , '"AMR_B"',
                   ifelse(country=="Bolivia" | country=="Ecuador" |country=="Guatemala" |country=="Haiti" |country=="Nicaragua" |country=="Peru", 
                           '"AMR_D"',      
                   ifelse(country=="Iran" | country=="Jordan" |country=="Tunisia", '"EMR_B"',
                   ifelse(country=="Egypt" |country=="Pakistan" |country=="Yemen", '"EMR_D"',
                   ifelse(country=="Albania" | country=="Armenia" |country=="Kyrgyz Republic" |country=="Romania" |country=="Georgia" 
                          |country=="Turkey", '"EUR_B"',
                   ifelse(country=="Kazakhstan" |country=="Ukraine" | country=="Tajikistan", '"EUR_C"',
                   ifelse(country=="Indonesia", '"SEAR_B"',
                   ifelse(country=="Bangladesh" | country=="Bhutan" |country=="India" |country=="Maldives" |country=="Myanmar" | country=="Timor Leste",
                          '"SEAR_D"',
                   ifelse(country=="China" |country=="Kiribati" |country=="Laos" |country=="Mongolia" |country=="Philippines" | country=="Samoa" 
                          |country=="Solomon Islands" |country=="Tonga" |country=="Tuvalu" |country=="Vanuatu" |country=="Vietnam", '"WPR_B"', 
                          NA))))))))))))   

###add GDP per capita data: prepare files for merging
###from https://data.worldbank.org/indicator/NY.GDP.PCAP.PP.KD
  gdp.data <- read_excel("~/API_NY.GDP.PCAP.PP.KD_DS2_en_excel_v2_382494.xls", col_names = T)
  gdp.data <- gdp.data[,-c(2:34)]
  gdp.data <- gdp.data[-c(1:2),]
  colnames(gdp.data) = gdp.data[1, ] # the first row will be the header
  gdp.data = gdp.data[-1, ] 
  library(reshape2)
  gdp.data <- melt(gdp.data, id = 'Country Name')
  detach(package:reshape2)
  gdp.data <- gdp.data %>% 
    rename(year = variable,
                GDPpercapita = value,
                country = `Country Name`,)
            
#limit to GDP display to 2 digits
  gdp.data$GDPpercapita <- as.numeric(gdp.data$GDPpercapita)
  gdp.data <- gdp.data %>% 
    mutate_if(is.numeric, round, digits = 2)
            
#rename Yemen, Gambia, Egypt, Timor Leste etc. in gdp.data so that it is identical to main dataset
  gdp.data$country[gdp.data$country == "Yemen, Rep."] <- "Yemen"
  gdp.data$country[gdp.data$country == "Eswatini"] <- "Swaziland"
  gdp.data$country[gdp.data$country == "Gambia, The"] <- "Gambia"
  gdp.data$country[gdp.data$country == "Timor-Leste"] <- "Timor Leste"
  gdp.data$country[gdp.data$country == "Egypt, Arab Rep."] <- "Egypt"
  gdp.data$country[gdp.data$country == "Cote d'Ivoire"] <- "Cote dIvoire"
  gdp.data$country[gdp.data$country == "Congo, Dem. Rep."] <- "Congo Democratic Republic"
  gdp.data$country[gdp.data$country == "Congo, Rep."] <- "Congo"

#format and then add GDP data to main dataset          	
  gdp.data$year <- as.character(gdp.data$year)
  bottombillion$year <- as.character(bottombillion$year)
  bottombillion  <- bottombillion %>% left_join(gdp.data, by=c("country", "year"))
            
#add Tanzanian GDP for Zanzizbar and add GDP in countries that did not merge because their surveys were conducted over multiple years
  bottombillion <- bottombillion %>% mutate(
    GDPpercapita = ifelse(country=='Zanzibar', 2329.33, 
                   ifelse(country=='Bangladesh' & year=="2017-2018", 3634.32,   
                   ifelse(country=='Swaziland', 9309.10, 
                   ifelse(country=='India' & year=="2015-2016", 9309.10, 
                   ifelse(country=='Madagascar', 	1523.02, 
                   ifelse(country=='Ghana' & year=='2007/8', 2813.21,
                   ifelse(country=='Mexico', 16520.26,
                   ifelse(country=='Romania', 21782.13,
                   ifelse(country=='Laos', 5115.60,
                   ifelse(country=='Iran', 18663.54, 
                   ifelse(country=='Mongolia', 12209.25,
                   ifelse(country=='Jordan', 8309.30, GDPpercapita)))))))))))))

###add population data (2015), can be downloaded from here: https://population.un.org/wpp/Download/Standard/Population/
  pop.data <- read_excel("~/API_SP.POP.TOTL_DS2_en_excel_v2_422160.xls")
  pop.data <- pop.data[-c(1:2),]
  colnames(pop.data) = pop.data[1, ] 
  pop.data = pop.data[-1, ]
  pop.data <- select(pop.data, 'Country Name', '2015')
  pop.data <- pop.data %>% 
    rename(country = 'Country Name',
           population2015 = '2015')
  
#rename Yemen, Gambia, Egypt, Timor Leste etc. so that it is identical to main dataset              
  pop.data$country[pop.data$country == "Yemen, Rep."] <- "Yemen"
  pop.data$country[pop.data$country == "Eswatini"] <- "Swaziland"
  pop.data$country[pop.data$country == "Gambia, The"] <- "Gambia"
  pop.data$country[pop.data$country == "Timor-Leste"] <- "Timor Leste"
  pop.data$country[pop.data$country == "Egypt, Arab Rep."] <- "Egypt"
  pop.data$country[pop.data$country == "Cote d'Ivoire"] <- "Cote dIvoire"
  pop.data$country[pop.data$country == "Congo, Dem. Rep."] <- "Congo Democratic Republic"
  pop.data$country[pop.data$country == "Congo, Rep."] <- "Congo"
  pop.data$country[pop.data$country == "Iran, Islamic Rep."] <- "Iran"
  pop.data$country[pop.data$country == "Lao PDR"] <- "Laos"
  
#format and then add GDP data to main dataset               
  bottombillion <- left_join(bottombillion, pop.data, by="country")
              
#add population for Zanzibar, Iran and Laos, matching didn't work
  bottombillion <- bottombillion %>% mutate(
    population2015 = ifelse(country=='Zanzibar', 403658, 
                     ifelse(country=='Iran', 78492215, 
                     ifelse(country=='Laos', 	6741164, population2015))))
```


```{r correct survey years}

###change format of survey years and double-check that all survey years are correctly listed in our dataset-some surveys are conducted over multiple year, which complicates the merge with other raw datasets a bit. 
  bottombillion <- bottombillion %>% 
    mutate(year = as.character(year))
          
#for some reason the code did not work well when I wrote this into one single mutate function. Therefore, I re-did this for each survey-year separately 
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Albania' & year==2017 | year==2018, '2017-2018', year)) 
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Armenia' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Benin' & svy=='DHS', '2011-2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Burundi' & svy=='DHS', '2016-2017', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Congo' & svy=='DHS', '2011-2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Congo Democratic Republic' & svy=='DHS', '2013-2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Cote dIvoire' & svy=='DHS', '2011-2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Guatemala' & svy=='DHS', '2014-2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Haiti' & svy=='DHS', '2016-2017', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Honduras' & svy=='DHS', '2011-2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Jordan' & svy=='DHS', '2017-2018', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Malawi' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Myanmar' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Pakistan' & svy=='DHS', '2017-2018', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Rwanda' & svy=='DHS', '2014-2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Rwanda' & svy=='STEPS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Senegal' & svy=='DHS', '2010-2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Tanzania' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Togo' & svy=='DHS', '2013-2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='India' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Angola' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Chad' & svy=='DHS', '2014-2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Uganda' & svy=='DHS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Mexico' & svy=='Mexican Family Life Survey MXFLS', '2009-2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Ghana' & year=='2007/8', '2007-2008', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Zambia' & svy=='STEPS', '2017', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Kiribati', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Laos', '2013', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Myanmar' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Colombia', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Uganda' & svy=='STEPS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Uganda' & svy=='DHS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Tanzania' & svy=='DHS', '2015-2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='India' & svy=='GATS', '2017', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Egypt' & year=='2013-2014' & svy=='DHS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Egypt' & year=='2014-2015' & svy=='DHS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Costa Rica' & svy=='GATS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Ethiopia' & svy=='GATS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Kazakhstan' & svy=='GATS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Mexico' & svy=='GATS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Nigeria' & svy=='GATS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Pakistan' & svy=='GATS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Philippines' & svy=='GATS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Senegal' & svy=='GATS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Vietnam' & svy=='GATS','2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Bhutan' & svy=='STEPS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Cameroon' & svy=='DHS', '2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Comoros' & svy=='DHS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Comoros' & svy=='STEPS', '2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Ecuador' & svy=='ENSANUT', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Gabon' & svy=='DHS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Georgia' & svy=='STEPS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Ghana' & svy=='DHS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Guinea' & svy=='DHS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Indonesia' & svy=='DHS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Indonesia' & svy=='IFLS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Kazakhstan' & svy=='Household Health Survey', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Kenya' & svy=='DHS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Kenya' & svy=='STEPS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Kyrgyz Republic' & svy=='STEPS', '2013', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Liberia' & svy=='DHS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Liberia' & svy=='STEPS', '2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Mali', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Mozambique'& svy=='DHS', '2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Niger' & svy=='DHS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Niger' & svy=='STEPS', '2007', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Nigeria' & svy=='DHS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Philippines' & svy=='DHS', '2017', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Sierra Leone', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='South Africa' & svy=='DHS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Swaziland' & svy=='STEPS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Tajikistan' & svy=='STEPS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Tajikistan' & svy=='DHS', '2017', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Tanzania' & svy=='STEPS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Timor Leste' & svy=='DHS', '2016', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Timor Leste' & svy=='STEPS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Vanuatu', '2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Zanzibar', '2011', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Zimbabwe' & svy=='DHS', '2015', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Lesotho' & svy=='DHS', '2014', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Lesotho' & svy=='STEPS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Peru' & svy=='DHS', '2012', year))
  bottombillion<- bottombillion %>% mutate(year = ifelse(country=='Burkina Faso' & year=='2013-2014', '2014', year))
                
```

```{r Create table 1: survey characteristics for manuscript}

#create separate dataset and get some basic summary statistics first
  table1 <- bottombillion %>% 
    group_by(region, country, svy, year) %>%
    summarise(samplesize=n(),
              Medianage = median(age, na.rm=T),
              minage = min(age, na.rm=T),
              maxage = format(round(max(age, na.rm=T), 0), nsmall=0), 
              agerange = str_c(as.character(minage), as.character(maxage), sep="-"),
              female = format(round((100*mean(sex, na.rm=T)), 1), nsmall=1)) %>% ungroup()

#change years and country names for merging with poverty rates
  table1 <- table1 %>% 
    mutate(year.new =  ifelse(year == "2010-2011", "2011",
                       ifelse(year == "2011-2012", "2012",
                       ifelse(year == "2012-2013", "2013",
                       ifelse(year == "2013-2014", "2014",
                       ifelse(year == "2014-2015", "2015",
                       ifelse(year == "2015-2016", "2016",
                       ifelse(year == "2016-2017", "2017",
                       ifelse(year == "2017-2018", "2018", year)))))))))

###preparation for the remaining summary statistics: adding the poverty ratios has not worked for surveys with multiple survey years, so we need to add them now manually. Poverty rates are derived from https://pip.worldbank.org/#, we used Kalman filter to impute missing values

#load in raw file with poverty data
  poverty_ratios <- read.csv("~/imputed_pov_ratios_kalman_reshaped.csv", header=T, stringsAsFactors = F)
  poverty_ratios <- poverty_ratios %>% 
    mutate(year.new = as.character(year)) %>% 
    select(-year) %>% 
    mutate_at(vars(starts_with("YR")), funs(round(., 1)))
  poverty_ratios$country[poverty_ratios$country == "Timor-Leste"] <- "Timor Leste"
  
#append
  table1pov <- left_join(table1, poverty_ratios, by = c("country", "year.new"))
  table1pov <- table1pov %>% 
    mutate(YRpov19 = ifelse(country=='Zanzibar', 49.6, YRpov19),
           YRpov32 = ifelse(country=='Zanzibar', 79.5, YRpov32),
           YRpov55 = ifelse(country=='Zanzibar', 93.2, YRpov55))

#add column for poverty groups
  table1pov <- table1pov %>% 
    mutate(pov_number= as.integer((YRpov19/100)*samplesize),
           pov_temp = str_c(as.character(pov_number), as.character(YRpov19), sep=" ("),
           bracket = ")",
           poor19 = str_c(as.character(pov_temp), as.character(bracket)))%>% 
    mutate(pov_number= as.integer((YRpov32/100)*samplesize),
           pov_temp = str_c(as.character(pov_number), as.character(YRpov32), sep=" ("),
           bracket = ")",
           poor32 = str_c(as.character(pov_temp), as.character(bracket)))%>% 
    mutate(pov_number= as.integer((YRpov55/100)*samplesize),
           pov_temp = str_c(as.character(pov_number), as.character(YRpov55), sep=" ("),
           bracket = ")",
           poor55 = str_c(as.character(pov_temp), as.character(bracket)))
 
#remove everything from table that we no longer need   
  table1pov <- table1pov %>%  
    select(-minage, -maxage, -bracket, -pov_temp, -year.new, -pov_number, -CountryCode, -YRpov19, -YRpov32, -YRpov55)
  
##add population and gdp data to table - as this data is country based it is easier to add it by creating a separate dataset from main file
  join.data <- select(bottombillion, region, country, svy, year, population2015, GDPpercapita)
  join.data <- distinct(join.data, region, country, svy, year, .keep_all = TRUE)
  table1pov <- table1pov %>% left_join(join.data)
 
#save table in excel and derive quantile, sums and median from there
  write.xlsx (x = as.data.frame(table1pov), file = "table1.xlsx")

```

```{r prepare Analysis: Clean id variables, psu, stratum, outcomes and sampling weights}  

#remove all observations without poverty data
  bottombillion <- bottombillion %>% filter(!is.na(poor19))

###STEP 1: hh_id is replaced with row number if unavailable
  bb_allpovgroups <- bottombillion %>% 
    mutate(rown = row_number()) %>% 
    mutate(hh_id = ifelse(is.na(hh_id), rown, hh_id)) %>%
    select(-rown)

###STEP2: Primary sampling unit is replaced with 1 if unavailable
  bb_allpovgroups <- bb_allpovgroups %>% mutate(
    psu = ifelse(country=='Mexico' & svy=='Mexican Family Life Survey MXFLS', 1, psu))

###STEP3: Sampling weights are created for all observations - STEPS offers three sampling weights wstep1, wstep2, and wstep3, these are specific for each risk factor and therefore more accurate for analysis than the general sampling weight
###In general, we use wstep1, wstep2, wstep3 wherever possible, otherwise we use the general sampling weight
  bb_allpovgroups <- bb_allpovgroups %>% 
    mutate(sampling_weight =ifelse(country=='Mozambique' & svy=='STEPS', wstep1,
                            ifelse(country=='Niger' & year=='2007', 1, 
                            ifelse(country=='Comoros' & year=='2011', 1, 
                            ifelse(country=='Mexico' & year=='2009-2012', w_all, 
                            ifelse(country=='Indonesia' & year=='2014', w_all,
                            ifelse(country=='Ethiopia' & svy=='STEPS', w_all,
                            ifelse(country=='Jordan' & year=='2019', w_all,
                            ifelse(country=='Mongolia' & year=='2019', w_all,sampling_weight)))))))))

#STEP4: set all remaining odd values to NA for our six main risk factors: smoking, hypertension, diabetes, overweight, obesits and lipids
  bb_allpovgroups <- bb_allpovgroups %>% 
    mutate(all_hypt = ifelse(all_hypt==1, 1,
                      ifelse(all_hypt==0, 0, NA)),
           all_dia = ifelse(all_dia==1, 1,
                     ifelse(all_dia==0, 0, NA)),
           csmoke = ifelse(csmoke==1 | csmoke>1 & csmoke<98, 1,
                    ifelse(csmoke==0, 0, NA)),
           obese = ifelse(obese==1, 1,
                   ifelse(obese==0, 0, NA)),
           overweight = ifelse(overweight==1, 1,
                        ifelse(overweight==0, 0, NA)),
           dyslipid = ifelse(dyslipid==1, 1,
                      ifelse(dyslipid==0, 0, NA)))

#STEP5: Set stratum to 1 for all surveys without stratum. 
   bb_allpovgroups <- bb_allpovgroups %>% 
      mutate(stratum = ifelse(is.na(stratum)==T, 1, stratum))
 
#convert to factors 
  bb_allpovgroups$stratum <- as.factor(bb_allpovgroups$stratum) 
  bb_allpovgroups$psu <- as.factor(bb_allpovgroups$psu) 
  bb_allpovgroups$hh_id <- as.factor(bb_allpovgroups$hh_id) 

```


```{r Calculate sampling weights for each outcome: hypertension, diabetes, overweight, obesity, smoking, lipis}

###from now on we need to separate the main dataset for each of the six risk factors
###The sampling weights for each risk factor is calculated in three steps, each step is done for each risk factor separately

#*****step 1: Weight by sampling weight mean******

###1) HYPERTENSION - use wstep2
  bb_allpovgroups_hypt <- bb_allpovgroups %>% 
    mutate(sampling_weight = ifelse(is.na(wstep2)==F, wstep2, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep1)==F, wstep1, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T, 1, sampling_weight))
  
#only keep observations that have value for hypertension
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% filter(!is.na(all_hypt)) 
  sampling.mean <- select(bb_allpovgroups_hypt, country, svy, year, sampling_weight) %>% 
    group_by(country, svy, year) %>%
    summarise_at(vars(sampling_weight), funs(mean(., na.rm=TRUE)))%>% rename(
    mean_sw = sampling_weight) 

  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% 
    left_join(sampling.mean, by=c("country", "svy", "year"))%>% 
    mutate( new_sw = sampling_weight / mean_sw) %>% 
    ungroup()

#limit to necessary variables 
  bb_allpovgroups_hypt <- select(bb_allpovgroups_hypt, region, subregion, country, year, svy, age, sex, educat, urban, mergeid, hh_id, psu, stratum, 
                                 new_sw, sampling_weight, all_hypt, poor19, poor32, poor55, population2015, GDPpercapita, hypt_treat, hypt_ctrl) 

###2) DIABETES - use wstep3
  bb_allpovgroups_dia <- bb_allpovgroups %>% 
    mutate(sampling_weight = ifelse(is.na(wstep3)==F, wstep3, sampling_weight)) %>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep1)==F, wstep1, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep2)==F, wstep2, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T, 1, sampling_weight))
  
  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% filter(!is.na(all_dia))
  sampling.mean <- select(bb_allpovgroups_dia, country, svy, year, sampling_weight) %>% 
    group_by(country, svy, year) %>%
    summarise_at(vars(sampling_weight), funs(mean(., na.rm=TRUE)))%>% 
    rename(mean_sw = sampling_weight)

  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% 
    left_join(sampling.mean, by=c("country", "svy", "year"))%>% 
    group_by(country, svy, year) %>% 
    mutate(new_sw = sampling_weight / mean_sw) %>% 
    ungroup()

  bb_allpovgroups_dia <- select(bb_allpovgroups_dia, region, subregion, country, year, svy, age, sex, educat, urban, mergeid, hh_id, psu, stratum, 
                                new_sw, sampling_weight, poor19, poor32, poor55, population2015, GDPpercapita, dia_treat, dia_ctrl, csmoke, sbp_ave, 
                                all_dia, tchol_mmoll, mi, statin)

###3) OVERWEIGHT - use wstep2
  bb_allpovgroups_overw <- bb_allpovgroups %>% 
    mutate(sampling_weight = ifelse(is.na(wstep2)==F, wstep2, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep1)==F, wstep1, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T, 1, sampling_weight))
  
  bb_allpovgroups_overw <- bb_allpovgroups_overw %>% filter(!is.na(overweight))
  sampling.mean <- select(bb_allpovgroups_overw, country, svy, year, sampling_weight) %>% 
    group_by(country, svy, year) %>%
    summarise_at(vars(sampling_weight), funs(mean(., na.rm=TRUE)))%>% 
    rename(mean_sw = sampling_weight)

  bb_allpovgroups_overw <- bb_allpovgroups_overw %>% 
    left_join(sampling.mean, by=c("country", "svy", "year")) %>% 
    group_by(country, svy, year) %>%
    mutate(new_sw = sampling_weight / mean_sw) %>% 
    ungroup() 
  
  bb_allpovgroups_overw <- select(bb_allpovgroups_overw, region, subregion, country, year, svy, age, sex, educat, urban, mergeid, hh_id, psu, stratum, 
                                  new_sw, sampling_weight, overweight, poor19, poor32, poor55, population2015, GDPpercapita) 

###4) OBESITY
  bb_allpovgroups_obese <- bb_allpovgroups %>% 
    mutate(sampling_weight = ifelse(is.na(wstep2)==F, wstep2, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep1)==F, wstep1, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T, 1, sampling_weight))

  bb_allpovgroups_obese <- bb_allpovgroups_obese %>% filter(!is.na(obese))
  sampling.mean <- select(bb_allpovgroups_obese, country, svy, year, sampling_weight)%>% 
    group_by(country, svy, year) %>%
    summarise_at(vars(sampling_weight), funs(mean(., na.rm=TRUE)))%>% rename(
    mean_sw = sampling_weight)

  bb_allpovgroups_obese <- bb_allpovgroups_obese %>% 
    left_join(sampling.mean, by=c("country", "svy", "year")) %>% 
    group_by(country, svy, year) %>%
    mutate(new_sw = sampling_weight / mean_sw) %>% 
    ungroup()

  bb_allpovgroups_obese <- select(bb_allpovgroups_obese, region, subregion, country, year, svy, age, sex, educat, urban, mergeid, hh_id, psu, stratum, 
                                  new_sw, sampling_weight, obese, poor19, poor32, poor55, population2015, GDPpercapita)

###5) SMOKING     -use wstep1
  bb_allpovgroups_smoke <- bb_allpovgroups %>% 
    mutate(sampling_weight = ifelse(is.na(wstep1)==F, wstep1, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T, 1, sampling_weight))
  
  bb_allpovgroups_smoke <- bb_allpovgroups_smoke %>% filter(!is.na(csmoke))
  sampling.mean <- select(bb_allpovgroups_smoke, country, svy, year, sampling_weight) %>% 
    group_by(country, svy, year) %>%
    summarise_at(vars(sampling_weight), funs(mean(., na.rm=TRUE))) %>% 
    rename(mean_sw = sampling_weight)

  bb_allpovgroups_smoke <- bb_allpovgroups_smoke %>% 
    left_join(sampling.mean, by=c("country", "svy", "year"))%>% 
    group_by(country, svy, year) %>% 
    mutate(new_sw = sampling_weight / mean_sw) %>% 
    ungroup()

  bb_allpovgroups_smoke <- select(bb_allpovgroups_smoke, region, subregion, country, year, svy, age, sex, educat, urban, mergeid, hh_id, psu, stratum, 
                                  new_sw, sampling_weight, csmoke, poor19, poor32, poor55, population2015, GDPpercapita)

###6) LIPIDS - use wstep3
  bb_allpovgroups_lipids <- bb_allpovgroups %>% 
    mutate(sampling_weight = ifelse(is.na(wstep3)==F, wstep3, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep1)==F, wstep1, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T & is.na(wstep2)==F, wstep2, sampling_weight))%>% 
    mutate(sampling_weight = ifelse(is.na(sampling_weight)==T, 1, sampling_weight))

  bb_allpovgroups_lipids <- bb_allpovgroups_lipids %>% filter(!is.na(dyslipid))
  sampling.mean <- select(bb_allpovgroups_lipids, country, svy, year, sampling_weight) %>% 
    group_by(country, svy, year) %>%
    summarise_at(vars(sampling_weight), funs(mean(., na.rm=TRUE)))%>% 
    rename(mean_sw = sampling_weight)

  bb_allpovgroups_lipids <- bb_allpovgroups_lipids %>% 
    left_join(sampling.mean, by=c("country", "svy", "year"))%>% 
    group_by(country, svy, year) %>% 
    mutate( new_sw = sampling_weight / mean_sw) %>% 
    ungroup()

  bb_allpovgroups_lipids <- select(bb_allpovgroups_lipids, region, subregion, country, year, svy, age, sex, educat, urban, mergeid, hh_id, psu, stratum, 
                                   new_sw, sampling_weight, dyslipid, poor19, poor32, poor55, population2015, GDPpercapita)


#*****step 2: weight countries by their extreme poor******
###for this we need the population in extreme poverty for each country and the number of people in extreme poverty in our sample

#import poverty rates 
  poverty_ratios <- read.csv("~/imputed_pov_ratios_kalman_reshaped.csv") #see above on how poverty rates were derived and imputed
  poverty_ratios <- poverty_ratios %>% 
    mutate(year.new = as.character(year)) %>% 
    select(country, YRpov19, year.new) %>% 
    mutate_at(vars(starts_with("YR")), funs(round(., 1))) 
  poverty_ratios$country[poverty_ratios$country == "Timor-Leste"] <- "Timor Leste"
  
#determine the poor population for the each country
  abs_poor <- select(bb_allpovgroups, country, population2015, year)
  abs_poor <- abs_poor %>% 
    mutate(year.new = ifelse(year=="2010-2011", "2011",
                          ifelse(year=="2011-2012", "2012",
                              ifelse(year == "2012-2013", "2013",
                                     ifelse(year == "2013-2014", "2014",
                                            ifelse(year == "2014-2015", "2015",
                                                   ifelse(year == "2015-2016", "2016",
                                                          ifelse(year == "2016-2017", "2017",
                                                                 ifelse(year == "2017-2018", "2018",
                                                                        ifelse(year == "2009-2012", "2012",year)))))))))
  )
  
#merge with poverty rate file
  poorpop19 <- left_join(abs_poor, poverty_ratios, by = c("country", "year.new"))
  poorpop19 <- poorpop19 %>% 
    mutate(YRpov19 = ifelse(country=='Zanzibar', 49.5, YRpov19)) %>% 
    select(-year.new)
    
#add column that shows poor population for all countries
  poorpop19 <- poorpop19 %>% 
    group_by(country, year) %>%
    mutate(population2015 = as.numeric(population2015),
           abs_pov19 = as.integer((YRpov19/100)*population2015)) %>%
    select(-population2015, -YRpov19) %>% ungroup()
  poorpop19 <- unique(poorpop19[,c('country', 'year', 'abs_pov19')])

##merge with risk factor datasets
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% left_join(poorpop19)
  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% left_join(poorpop19)
  bb_allpovgroups_overw <- bb_allpovgroups_overw  %>% left_join(poorpop19)
  bb_allpovgroups_obese <- bb_allpovgroups_obese  %>% left_join(poorpop19)
  bb_allpovgroups_smoke <- bb_allpovgroups_smoke %>% left_join(poorpop19)
  bb_allpovgroups_lipids <- bb_allpovgroups_lipids %>% left_join(poorpop19)

###now we can calculate weight for each risk factor
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% mutate(rown = row_number())
  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% ungroup()
  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% mutate(rown = row_number())
  bb_allpovgroups_overw <- bb_allpovgroups_overw %>% mutate(rown = row_number())
  bb_allpovgroups_obese <- bb_allpovgroups_obese %>% mutate(rown = row_number())
  bb_allpovgroups_smoke <- bb_allpovgroups_smoke %>% mutate(rown = row_number())    #row number as new id
  bb_allpovgroups_lipids <- bb_allpovgroups_lipids %>% mutate(rown = row_number()) 
  
###1 HYPERTENSION
    weights.hypt <- bb_allpovgroups_hypt %>% 
      filter(!is.na(all_hypt)) 
    
    npoor_sample <- weights.hypt %>% 
      group_by(country) %>%  
      summarise_at(vars(poor19), list(name = sum))
    
    weights.hypt <- weights.hypt %>% 
      left_join(npoor_sample) %>%  
      mutate(w_hypt_poor19 = new_sw * (abs_pov19 /name))%>% 
      ungroup() %>%
      select(country, svy, year, age, rown, w_hypt_poor19)
    
###2 DIABETES
    weights.dia <- bb_allpovgroups_dia %>% filter(!is.na(all_dia))
    
    npoor_sample <- weights.dia %>% 
      group_by(country) %>%  
      summarise_at(vars(poor19), list(name = sum))
    
    weights.dia <- weights.dia %>% 
      left_join(npoor_sample) %>%  
      mutate(w_dia_poor19 = new_sw * (abs_pov19 /name)) %>% 
      ungroup() %>%
      select(country, svy, year, age, rown, w_dia_poor19)
    
###3 OVERWEIGHT
    weights.overw <-bb_allpovgroups_overw %>% filter(!is.na(overweight))

    npoor_sample <- weights.overw %>% 
      group_by(country) %>%  
      summarise_at(vars(poor19), list(name = sum))
    
    weights.overw <- weights.overw %>% 
      left_join(npoor_sample)%>%  
      mutate(w_overw_poor19 = new_sw * (abs_pov19 /name))
      ungroup() %>%
      select(country, svy, year, age, rown, w_overw_poor19)
    
###4 OBESITY
    weights.obese <- bb_allpovgroups_obese %>% filter(!is.na(obese))

    npoor_sample <- weights.obese %>% 
      group_by(country) %>%  
      summarise_at(vars(poor19), list(name = sum))
    
    weights.obese <- weights.obese %>% 
      left_join(npoor_sample)%>%  
      mutate(w_obese_poor19 = new_sw * (abs_pov19 /name))
      ungroup() %>%
      select(country, svy, year, age, rown, w_obese_poor19)
    
###5 SMOKING
    weights.smoke <- bb_allpovgroups_smoke %>% filter(!is.na(csmoke)) 

    npoor_sample <- weights.smoke %>% 
      group_by(country) %>%  
      summarise_at(vars(poor19), list(name = sum))
    
    weights.smoke <- weights.smoke %>% 
      left_join(npoor_sample)%>%  
      mutate(w_smoke_poor19 = new_sw * (abs_pov19 /name))
      ungroup() %>%
      select(country, svy, year, age, rown, w_smoke_poor19)
   
###6 LIPIDS
    weights.lipids <- bb_allpovgroups_lipids %>% filter(!is.na(dyslipid))

    npoor_sample <- weights.lipids %>% 
      group_by(country) %>%  
      summarise_at(vars(poor19), list(name = sum))
    
    weights.lipids <- weights.lipids %>% 
      left_join(npoor_sample) %>%  
      mutate(w_lipid_poor19 = new_sw * (abs_pov19 /name))%>% 
      ungroup()%>% 
      select(country, svy, year, age, rown, w_lipid_poor19)

#********step 3: age standardization using WHO standardization rates from here https://www.who.int/healthinfo/paper31.pdf

###1) HYPERTENSION 
  weights.hypt <- weights.hypt %>% 
    mutate(w_hypt_poor19_age= ifelse(age>=15 & age<=19, w_hypt_poor19 * 0.0847, 
                              ifelse(age>=20 & age<=24, w_hypt_poor19 * 0.0822, 
                              ifelse(age>=25 & age<=29, w_hypt_poor19 * 0.0793, 
                              ifelse(age>=30 & age<=34, w_hypt_poor19 * 0.0761, 
                              ifelse(age>=35 & age<=39, w_hypt_poor19 * 0.0715, 
                              ifelse(age>=40 & age<=44, w_hypt_poor19 * 0.0659, 
                              ifelse(age>=45 & age<=49, w_hypt_poor19 * 0.0604, 
                              ifelse(age>=50 & age<=54, w_hypt_poor19 * 0.0537, 
                              ifelse(age>=55 & age<=59, w_hypt_poor19 * 0.0455, 
                              ifelse(age>=60 & age<=64, w_hypt_poor19 * 0.0372, 
                              ifelse(age>=65 & age<=69, w_hypt_poor19 * 0.0296, 
                              ifelse(age>=70 & age<=74, w_hypt_poor19 * 0.0221, 
                              ifelse(age>=75 & age<=79, w_hypt_poor19 * 0.0152, 
                              ifelse(age>=80 & age<=84, w_hypt_poor19 * 0.0091, 
                              ifelse(age>=85 & age<=89, w_hypt_poor19 * 0.0044, 
                              ifelse(age>=90 & age<=94, w_hypt_poor19 * 0.0015, 
                              ifelse(age>=95 & age<=99, w_hypt_poor19 * 0.0004, NA))))))))))))))))))

###2) DIABETES
  weights.dia <- weights.dia %>% 
    mutate(w_dia_poor19_age = ifelse(age>=15 & age<=19, w_dia_poor19 * 0.0847, 
                              ifelse(age>=20 & age<=24, w_dia_poor19 * 0.0822, 
                              ifelse(age>=25 & age<=29, w_dia_poor19 * 0.0793, 
                              ifelse(age>=30 & age<=34, w_dia_poor19 * 0.0761, 
                              ifelse(age>=35 & age<=39, w_dia_poor19 * 0.0715, 
                              ifelse(age>=40 & age<=44, w_dia_poor19 * 0.0659, 
                              ifelse(age>=45 & age<=49, w_dia_poor19 * 0.0604, 
                              ifelse(age>=50 & age<=54, w_dia_poor19 * 0.0537, 
                              ifelse(age>=55 & age<=59, w_dia_poor19 * 0.0455, 
                              ifelse(age>=60 & age<=64, w_dia_poor19 * 0.0372, 
                              ifelse(age>=65 & age<=69, w_dia_poor19 * 0.0296, 
                              ifelse(age>=70 & age<=74, w_dia_poor19 * 0.0221, 
                              ifelse(age>=75 & age<=79, w_dia_poor19 * 0.0152, 
                              ifelse(age>=80 & age<=84, w_dia_poor19 * 0.0091, 
                              ifelse(age>=85 & age<=89, w_dia_poor19 * 0.0044, 
                              ifelse(age>=90 & age<=94, w_dia_poor19 * 0.0015, 
                              ifelse(age>=95 & age<=99, w_dia_poor19 * 0.0004, NA))))))))))))))))))

###3) OVERWEIGHT 
  weights.overw <- weights.overw %>% 
    mutate(w_overw_poor19_age = ifelse(age>=15 & age<=19, w_overw_poor19 * 0.0847, 
                                ifelse(age>=20 & age<=24, w_overw_poor19 * 0.0822, 
                                ifelse(age>=25 & age<=29, w_overw_poor19 * 0.0793, 
                                ifelse(age>=30 & age<=34, w_overw_poor19 * 0.0761, 
                                ifelse(age>=35 & age<=39, w_overw_poor19 * 0.0715, 
                                ifelse(age>=40 & age<=44, w_overw_poor19 * 0.0659, 
                                ifelse(age>=45 & age<=49, w_overw_poor19 * 0.0604, 
                                ifelse(age>=50 & age<=54, w_overw_poor19 * 0.0537, 
                                ifelse(age>=55 & age<=59, w_overw_poor19 * 0.0455, 
                                ifelse(age>=60 & age<=64, w_overw_poor19 * 0.0372, 
                                ifelse(age>=65 & age<=69, w_overw_poor19 * 0.0296, 
                                ifelse(age>=70 & age<=74, w_overw_poor19 * 0.0221, 
                                ifelse(age>=75 & age<=79, w_overw_poor19 * 0.0152, 
                                ifelse(age>=80 & age<=84, w_overw_poor19 * 0.0091, 
                                ifelse(age>=85 & age<=89, w_overw_poor19 * 0.0044, 
                                ifelse(age>=90 & age<=94, w_overw_poor19 * 0.0015, 
                                ifelse(age>=95 & age<=99, w_overw_poor19 * 0.0004, NA)))))))))))))))))) 

###4) OBESITY 
  weights.obese <- weights.obese %>% 
    mutate(w_obese_poor19_age = ifelse(age>=15 & age<=19, w_obese_poor19 * 0.0847, 
                                ifelse(age>=20 & age<=24, w_obese_poor19 * 0.0822, 
                                ifelse(age>=25 & age<=29, w_obese_poor19 * 0.0793, 
                                ifelse(age>=30 & age<=34, w_obese_poor19 * 0.0761, 
                                ifelse(age>=35 & age<=39, w_obese_poor19 * 0.0715, 
                                ifelse(age>=40 & age<=44, w_obese_poor19 * 0.0659, 
                                ifelse(age>=45 & age<=49, w_obese_poor19 * 0.0604, 
                                ifelse(age>=50 & age<=54, w_obese_poor19 * 0.0537, 
                                ifelse(age>=55 & age<=59, w_obese_poor19 * 0.0455, 
                                ifelse(age>=60 & age<=64, w_obese_poor19 * 0.0372, 
                                ifelse(age>=65 & age<=69, w_obese_poor19 * 0.0296, 
                                ifelse(age>=70 & age<=74, w_obese_poor19 * 0.0221, 
                                ifelse(age>=75 & age<=79, w_obese_poor19 * 0.0152, 
                                ifelse(age>=80 & age<=84, w_obese_poor19 * 0.0091, 
                                ifelse(age>=85 & age<=89, w_obese_poor19 * 0.0044, 
                                ifelse(age>=90 & age<=94, w_obese_poor19 * 0.0015, 
                                ifelse(age>=95 & age<=99, w_obese_poor19 * 0.0004, NA))))))))))))))))))

###5) SMOKING 
  weights.smoke <- weights.smoke %>% 
    mutate(w_smoke_poor19_age = ifelse(age>=15 & age<=19, w_smoke_poor19 * 0.0847, 
                                ifelse(age>=20 & age<=24, w_smoke_poor19 * 0.0822, 
                                ifelse(age>=25 & age<=29, w_smoke_poor19 * 0.0793, 
                                ifelse(age>=30 & age<=34, w_smoke_poor19 * 0.0761, 
                                ifelse(age>=35 & age<=39, w_smoke_poor19 * 0.0715, 
                                ifelse(age>=40 & age<=44, w_smoke_poor19 * 0.0659, 
                                ifelse(age>=45 & age<=49, w_smoke_poor19 * 0.0604, 
                                ifelse(age>=50 & age<=54, w_smoke_poor19 * 0.0537, 
                                ifelse(age>=55 & age<=59, w_smoke_poor19 * 0.0455, 
                                ifelse(age>=60 & age<=64, w_smoke_poor19 * 0.0372, 
                                ifelse(age>=65 & age<=69, w_smoke_poor19 * 0.0296, 
                                ifelse(age>=70 & age<=74, w_smoke_poor19 * 0.0221, 
                                ifelse(age>=75 & age<=79, w_smoke_poor19 * 0.0152, 
                                ifelse(age>=80 & age<=84, w_smoke_poor19 * 0.0091, 
                                ifelse(age>=85 & age<=89, w_smoke_poor19 * 0.0044, 
                                ifelse(age>=90 & age<=94, w_smoke_poor19 * 0.0015, 
                                ifelse(age>=95 & age<=99, w_smoke_poor19 * 0.0004, NA))))))))))))))))))

###6) LIPIDS  
weights.lipids <- weights.lipids %>% 
  mutate(w_lipid_poor19_age = ifelse(age>=15 & age<=19, w_lipid_poor19 * 0.0847, 
                              ifelse(age>=20 & age<=24, w_lipid_poor19 * 0.0822, 
                              ifelse(age>=25 & age<=29, w_lipid_poor19 * 0.0793, 
                              ifelse(age>=30 & age<=34, w_lipid_poor19 * 0.0761, 
                              ifelse(age>=35 & age<=39, w_lipid_poor19 * 0.0715, 
                              ifelse(age>=40 & age<=44, w_lipid_poor19 * 0.0659, 
                              ifelse(age>=45 & age<=49, w_lipid_poor19 * 0.0604, 
                              ifelse(age>=50 & age<=54, w_lipid_poor19 * 0.0537, 
                              ifelse(age>=55 & age<=59, w_lipid_poor19 * 0.0455, 
                              ifelse(age>=60 & age<=64, w_lipid_poor19 * 0.0372, 
                              ifelse(age>=65 & age<=69, w_lipid_poor19 * 0.0296, 
                              ifelse(age>=70 & age<=74, w_lipid_poor19 * 0.0221, 
                              ifelse(age>=75 & age<=79, w_lipid_poor19 * 0.0152, 
                              ifelse(age>=80 & age<=84, w_lipid_poor19 * 0.0091, 
                              ifelse(age>=85 & age<=89, w_lipid_poor19 * 0.0044, 
                              ifelse(age>=90 & age<=94, w_lipid_poor19 * 0.0015, 
                              ifelse(age>=95 & age<=99, w_lipid_poor19 * 0.0004, NA))))))))))))))))))


#append and save  
  weights.hypt <- select(weights.hypt, -country, -year, -svy, -age)
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% left_join(weights.hypt, by="rown")
  
  weights.dia <- select(weights.dia, -country, -year, -svy, -age)
  bb_allpovgroups_dia <- weights.dia %>% left_join(bb_allpovgroups_dia)
  
  weights.obese <- select(weights.obese, -country, -year, -svy, -age)
  bb_allpovgroups_obese <- bb_allpovgroups_obese %>% left_join(weights.obese, by="rown")
  
  weights.overw <- select(weights.overw, -country, -year, -svy, -age)
  bb_allpovgroups_overw <- bb_allpovgroups_overw %>% left_join(weights.overw, by="rown")
  
  weights.smoke <- select(weights.smoke, -country, -year, -svy, -age)
  bb_allpovgroups_smoke <- weights.smoke %>% left_join(bb_allpovgroups_smoke)
  
  weights.lipids <- select(weights.lipids, -country, -year, -svy, -age)
  bb_allpovgroups_lipids <- weights.lipids %>% left_join(bb_allpovgroups_lipids, by="rown")


  write.csv(bb_allpovgroups_hypt, "~/bb_allpovgroupsnew_hypt.csv")
  write.csv(bb_allpovgroups_dia, "~/bb_allpovgroupsnew_dia.csv")
  write.csv(bb_allpovgroups_overw, "~/bb_allpovgroupsnew_overw.csv")
  write.csv(bb_allpovgroups_obese, "~/bb_allpovgroupsnew_obese.csv")
  write.csv(bb_allpovgroups_smoke, "~/bb_allpovgroups_smoke.csv")
  write.csv(bb_allpovgroups_lipids, "~/bb_allpovgroups_lipids.csv")
  
```




```{r Calculate prevalence, separate for each risk factor}

###prepare analysis: create agegroups for regression
#create age groups
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))
  
  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))
  
  bb_allpovgroups_overw <- bb_allpovgroups_overw %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))

  bb_allpovgroups_obese <- bb_allpovgroups_obese %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))
  
  bb_allpovgroups_smoke <- bb_allpovgroups_smoke %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))


  bb_allpovgroups_lipids <- bb_allpovgroups_lipids %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))

###prepare survey command for each risk factor and calculate prevalence for each risk factor
  bb_allpovgroups_hypt$stratum <- as.factor(bb_allpovgroups_hypt$stratum)
  bb_allpovgroups_hypt$country <- as.factor(bb_allpovgroups_hypt$country)
  bb_allpovgroups_hypt$region <- as.factor(bb_allpovgroups_hypt$region)
  bb_allpovgroups_hypt$psu <- as.factor(bb_allpovgroups_hypt$psu)
  bb_allpovgroups_hypt$hh_id <- as.factor(bb_allpovgroups_hypt$hh_id)
  
  bb_allpovgroups_dia$stratum <- as.factor(bb_allpovgroups_dia$stratum)
  bb_allpovgroups_dia$country <- as.factor(bb_allpovgroups_dia$country)
  bb_allpovgroups_dia$region <- as.factor(bb_allpovgroups_dia$region)
  bb_allpovgroups_dia$psu <- as.factor(bb_allpovgroups_dia$psu)
  bb_allpovgroups_dia$hh_id <- as.factor(bb_allpovgroups_dia$hh_id)
  
  bb_allpovgroups_overw$stratum <- as.factor(bb_allpovgroups_overw$stratum)
  bb_allpovgroups_overw$country <- as.factor(bb_allpovgroups_overw$country)
  bb_allpovgroups_overw$region <- as.factor(bb_allpovgroups_overw$region)
  bb_allpovgroups_overw$psu <- as.factor(bb_allpovgroups_overw$psu)
  bb_allpovgroups_overw$hh_id <- as.factor(bb_allpovgroups_overw$hh_id)
  
  bb_allpovgroups_obese$stratum <- as.factor(bb_allpovgroups_obese$stratum)
  bb_allpovgroups_obese$country <- as.factor(bb_allpovgroups_obese$country)
  bb_allpovgroups_obese$region <- as.factor(bb_allpovgroups_obese$region)
  bb_allpovgroups_obese$psu <- as.factor(bb_allpovgroups_obese$psu)
  bb_allpovgroups_obese$hh_id <- as.factor(bb_allpovgroups_obese$hh_id)
  
  bb_allpovgroups_smoke$stratum <- as.factor(bb_allpovgroups_smoke$stratum)
  bb_allpovgroups_smoke$country <- as.factor(bb_allpovgroups_smoke$country)
  bb_allpovgroups_smoke$region <- as.factor(bb_allpovgroups_smoke$region)
  bb_allpovgroups_smoke$psu <- as.factor(bb_allpovgroups_smoke$psu)
  bb_allpovgroups_smoke$hh_id <- as.factor(bb_allpovgroups_smoke$hh_id)
  
  bb_allpovgroups_lipids$stratum <- as.factor(bb_allpovgroups_lipids$stratum)
  bb_allpovgroups_lipids$country <- as.factor(bb_allpovgroups_lipids$country)
  bb_allpovgroups_lipids$region <- as.factor(bb_allpovgroups_lipids$region)
  bb_allpovgroups_lipids$psu <- as.factor(bb_allpovgroups_lipids$psu)
  bb_allpovgroups_lipids$hh_id <- as.factor(bb_allpovgroups_lipids$hh_id)

###1) HYPERTENSION
#first create subset which only entails relevant vars and filter missing values 
    hypt_subset <-  select(bb_allpovgroups_hypt, all_hypt, stratum, svy, age, educat, psu, hh_id, country, year, sex, agegroups, urban, region, 
                          w_hypt_poor19_age, population2015, poor19, poor32, poor55) %>%
                    filter(is.na(all_hypt)==F) %>%
                    filter(is.na(w_hypt_poor19_age)==F) %>% 
                    mutate(psu = ifelse(is.na(psu==T), 1, psu))
    
#define surveys that are used for countries which have multiple surveys
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Myanmar' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Timor Leste' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Kyrgyz Republic' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Tajikistan' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Albania' & hypt_subset$year=='2017-2018'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Egypt' & hypt_subset$year=='2014'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Comoros' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Ethiopia' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Gambia' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Ghana' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Kenya' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Malawi' & hypt_subset$svy=='DHS'),]    
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Mozambique' & hypt_subset$svy=='DHS'),]    
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Niger' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Rwanda' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Tanzania' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Togo' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Uganda' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Zambia' & hypt_subset$svy=='DHS'),]
    hypt_subset<-hypt_subset[!(hypt_subset$country=='Jordan' & hypt_subset$svy=='DHS'),]

#get sample sizes
    hypt_n19 <- hypt_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0 <- hypt_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall <- hypt_subset %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    hypt_n <- hypt_n19 %>%
      left_join(hypt_n0) %>%
      left_join(hypt_nall)  
    
#get sample size for females   
    hypt_n19.women <- hypt_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0.women <- hypt_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall.women <- hypt_subset %>%
      filter(sex==1) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    hypt_n.women <- hypt_n19.women %>%
      left_join(hypt_n0.women) %>%
      left_join(hypt_nall.women)   
    
#get sample size for males   
    hypt_n19.men <- hypt_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0.men <- hypt_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall.men <- hypt_subset %>%
      filter(sex==0) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    hypt_n.men <- hypt_n19.men %>%
      left_join(hypt_n0.men) %>%
      left_join(hypt_nall.men)     
    
###get sample size by regions    
    hypt_n19 <- hypt_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0 <- hypt_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall <- hypt_subset %>%
      group_by(region) %>%
      summarise(nall = n())
    
    hypt_n <- hypt_n19 %>%
      left_join(hypt_n0) %>%
      left_join(hypt_nall)  
    
#get sample size for females   
    hypt_n19.women <- hypt_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0.women <- hypt_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall.women <- hypt_subset %>%
      filter(sex==1) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    hypt_n.women <- hypt_n19.women %>%
      left_join(hypt_n0.women) %>%
      left_join(hypt_nall.women)   
    
#get sample size for males   
    hypt_n19.men <- hypt_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0.men <- hypt_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall.men <- hypt_subset %>%
      filter(sex==0) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    hypt_n.men <- hypt_n19.men %>%
      left_join(hypt_n0.men) %>%
      left_join(hypt_nall.men)  
    
###add income group, can be derived from: https://datahelpdesk.worldbank.org/knowledgebase/articles/906519-world-bank-country-and-lending-groups
  CLASS <- read_excel("~/CLASS.xlsx")
  CLASS <- CLASS %>% rename(
    country = 'Economy',
    region = 'Region',
    income_group = 'Income group') %>% 
    select(country, income_group)

#add manually where merging failed
  hypt_subset <- hypt_subset %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                            ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income", income_group)))))))))    
    
###sample sizes by income_group
    hypt_n19 <- hypt_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0 <- hypt_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall <- hypt_subset %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    hypt_n <- hypt_n19 %>%
      left_join(hypt_n0) %>%
      left_join(hypt_nall)  
    
#get sample size for females   
    hypt_n19.women <- hypt_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0.women <- hypt_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall.women <- hypt_subset %>%
      filter(sex==1) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    hypt_n.women <- hypt_n19.women %>%
      left_join(hypt_n0.women) %>%
      left_join(hypt_nall.women)   
    
#get sample size for males   
    hypt_n19.men <- hypt_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    hypt_n0.men <- hypt_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    hypt_nall.men <- hypt_subset %>%
      filter(sex==0) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    hypt_n.men <- hypt_n19.men %>%
      left_join(hypt_n0.men) %>%
      left_join(hypt_nall.men)     
    
###run survey design, separate for each poverty group and for entire dataset
  risk.hypt.pov19 <- hypt_subset %>% filter(poor19==1)
  risk.hypt.pov19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19, nest = T)
  
  risk.hypt.pov32 <- hypt_subset %>% filter(poor32==1)
  risk.hypt.pov32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32, nest = T)
  
  risk.hypt.pov55 <- hypt_subset %>% filter(poor55==1)
  risk.hypt.pov55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55, nest = T)
  
  risk.hypt.pov0 <- hypt_subset %>% filter(poor55==0)
  risk.hypt.pov0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0, nest = T)

  risk.hypt.all_povgroups <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_subset, nest = T)

#use survey design to get prevalence for all regions
  prev.hypt.pov19.region <- svyby(~all_hypt, by=~region, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov19.region <- unite_ci(prev.hypt.pov19.region, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.region <- svyby(~all_hypt, by=~region, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov32.region <- unite_ci(prev.hypt.pov32.region, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.region <- svyby(~all_hypt, by=~region, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov55.region <- unite_ci(prev.hypt.pov55.region, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.region <- svyby(~all_hypt, by=~region, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov0.region <- unite_ci(prev.hypt.pov0.region, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.region <- svyby(~all_hypt, by=~region, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  prev.hypt.allpov.region <- unite_ci(prev.hypt.allpov.region, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.region.all <- prev.hypt.pov19.region %>%
    left_join(prev.hypt.pov32.region) %>%
    left_join(prev.hypt.pov55.region) %>%
    left_join(prev.hypt.pov0.region)
  
  write.csv(prev.hypt.region.all, "~/prev.hypt.region.all.csv")
  
#get prevalencs for all regions and sex
  prev.hypt.pov19.region.sex <- svyby(~all_hypt, by=~region + sex, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                        "ci")
  prev.hypt.pov19.region.sex <- unite_ci(prev.hypt.pov19.region.sex, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.hypt.pov32.region.sex <- svyby(~all_hypt, by=~region + sex, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                        "ci")
  prev.hypt.pov32.region.sex <- unite_ci(prev.hypt.pov32.region.sex, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.pov55.region.sex <- svyby(~all_hypt, by=~region + sex, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                        "ci")
  prev.hypt.pov55.region.sex <- unite_ci(prev.hypt.pov55.region.sex, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.pov0.region.sex <- svyby(~all_hypt, by=~region + sex, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov0.region.sex <- unite_ci(prev.hypt.pov0.region.sex, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.allpov.region.sex <- svyby(~all_hypt, by=~region + sex, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                       vartype = "ci")
  prev.hypt.allpov.region.sex <- unite_ci(prev.hypt.allpov.region.sex, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.region.all.sex <- prev.hypt.pov19.region.sex %>%
    left_join(prev.hypt.pov32.region.sex) %>%
    left_join(prev.hypt.pov55.region.sex) %>%
    left_join(prev.hypt.pov0.region.sex)
  
  write.csv(prev.hypt.region.all.sex, "~/prev.hypt.region.all.sex.csv")  
  
#get prevalence for income groups  
    prev.hypt.pov19.incomegroup <- svyby(~all_hypt, by=~income_group, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                           "ci")
  prev.hypt.pov19.incomegroup <- unite_ci(prev.hypt.pov19.incomegroup, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.hypt.pov32.incomegroup <- svyby(~all_hypt, by=~income_group, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.hypt.pov32.incomegroup <- unite_ci(prev.hypt.pov32.incomegroup, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.pov55.incomegroup <- svyby(~all_hypt, by=~income_group, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.hypt.pov55.incomegroup <- unite_ci(prev.hypt.pov55.incomegroup, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.pov0.incomegroup <- svyby(~all_hypt, by=~income_group, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                        "ci")
  prev.hypt.pov0.incomegroup <- unite_ci(prev.hypt.pov0.incomegroup, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.allpov.incomegroup <- svyby(~all_hypt, by=~income_group, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.hypt.allpov.incomegroup <- unite_ci(prev.hypt.allpov.incomegroup, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.incomegroup.all <- prev.hypt.pov19.incomegroup %>%
    left_join(prev.hypt.pov32.incomegroup) %>%
    left_join(prev.hypt.pov55.incomegroup) %>%
    left_join(prev.hypt.pov0.incomegroup)
  
  write.csv(prev.hypt.incomegroup.all, "~/prev.hypt.incomegroup.all.csv")
  
#get prevalence for all income groups and sex
  prev.hypt.pov19.incomegroup.sex <- svyby(~all_hypt, by=~income_group + sex, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.hypt.pov19.incomegroup.sex <- unite_ci(prev.hypt.pov19.incomegroup.sex, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.hypt.pov32.incomegroup.sex <- svyby(~all_hypt, by=~income_group + sex, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.hypt.pov32.incomegroup.sex <- unite_ci(prev.hypt.pov32.incomegroup.sex, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.pov55.incomegroup.sex <- svyby(~all_hypt, by=~income_group + sex, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.hypt.pov55.incomegroup.sex <- unite_ci(prev.hypt.pov55.incomegroup.sex, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.pov0.incomegroup.sex <- svyby(~all_hypt, by=~income_group + sex, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", 
                                          vartype = "ci")
  prev.hypt.pov0.incomegroup.sex <- unite_ci(prev.hypt.pov0.incomegroup.sex, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.hypt.allpov.incomegroup.sex <- svyby(~all_hypt, by=~income_group + sex, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, 
                                            prop_method="asin", vartype = "ci")
  prev.hypt.allpov.incomegroup.sex <- unite_ci(prev.hypt.allpov.incomegroup.sex, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.incomegroup.all.sex <- prev.hypt.pov19.incomegroup.sex %>%
    left_join(prev.hypt.pov32.incomegroup.sex) %>%
    left_join(prev.hypt.pov55.incomegroup.sex) %>%
    left_join(prev.hypt.pov0.incomegroup.sex)
  
  write.csv(prev.hypt.incomegroup.all.sex, "~/prev.hypt.incomegroup.all.sex.csv")  

#get prevalence by age groups
  prev.hypt.pov19 <- svyby(~all_hypt, by=~agegroups, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov19 <- unite_ci(prev.hypt.pov19, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32 <- svyby(~all_hypt, by=~agegroups, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov32 <- unite_ci(prev.hypt.pov32, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55 <- svyby(~all_hypt, by=~agegroups, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov55 <- unite_ci(prev.hypt.pov55, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0 <- svyby(~all_hypt, by=~agegroups, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov0 <- unite_ci(prev.hypt.pov0, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov <- svyby(~all_hypt, by=~agegroups, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.allpov <- unite_ci(prev.hypt.allpov, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.agegroups <- prev.hypt.pov19 %>% 
    left_join(prev.hypt.pov32) %>% 
    left_join(prev.hypt.pov55) %>% 
    left_join(prev.hypt.pov0)
  
  write.csv(prev.hypt.agegroups, "~/prev.hypt.agegroups.csv")
  
#get overall prevalence for each poverty group
  svymean(~all_hypt, risk.hypt.pov55, deff=TRUE)  
  confint(svymean(~all_hypt, risk.hypt.pov55, level = 0.95)) 
  
  svymean(~all_hypt, risk.hypt.pov0, deff=TRUE)  
  confint(svymean(~all_hypt, risk.hypt.pov0, level = 0.95)) 
    
  svymean(~all_hypt, risk.hypt.pov19, deff=TRUE)  
  confint(svymean(~all_hypt, risk.hypt.pov19, level = 0.95))  
  
  svymean(~all_hypt, risk.hypt.pov32, deff=TRUE)  
  confint(svymean(~all_hypt, risk.hypt.pov32, level = 0.95)) 
  
  svymean(~all_hypt, risk.hypt.all_povgroups, deff=TRUE)  
  confint(svymean(~all_hypt, risk.hypt.all_povgroups, level = 0.95))
  
#to get the total for all age groups and sex
  prev.hypt.pov19.sex <- svyby(~all_hypt, by=~agegroups + sex, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov19.sex <- unite_ci(prev.hypt.pov19.sex, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.sex <- svyby(~all_hypt, by=~agegroups + sex, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov32.sex <- unite_ci(prev.hypt.pov32.sex, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.sex <- svyby(~all_hypt, by=~agegroups + sex, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov55.sex <- unite_ci(prev.hypt.pov55.sex, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.sex <- svyby(~all_hypt, by=~agegroups + sex, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov0.sex <- unite_ci(prev.hypt.pov0.sex, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.sex <- svyby(~all_hypt, by=~agegroups + sex, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype 
                                = "ci")
  prev.hypt.allpov.sex <- unite_ci(prev.hypt.allpov.sex, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.agegroups.sex <- prev.hypt.pov19.sex %>% 
    left_join(prev.hypt.pov32.sex) %>% 
    left_join(prev.hypt.pov55.sex) %>% 
    left_join(prev.hypt.pov0.sex)
  
  write.csv(prev.hypt.agegroups.sex, "~/prev.hypt.agegroups.sex.csv")
    
#to get the total for sex
  prev.hypt.pov19.sexonly <- svyby(~all_hypt, by=~sex, design=risk.hypt.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov19.sexonly <- unite_ci(prev.hypt.pov19.sexonly, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.sexonly <- svyby(~all_hypt, by=~sex, design=risk.hypt.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov32.sexonly <- unite_ci(prev.hypt.pov32.sexonly, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.sexonly <- svyby(~all_hypt, by=~sex, design=risk.hypt.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov55.sexonly <- unite_ci(prev.hypt.pov55.sexonly, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.sexonly <- svyby(~all_hypt, by=~sex, design=risk.hypt.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.pov0.sexonly <- unite_ci(prev.hypt.pov0.sexonly, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.sexonly <- svyby(~all_hypt, by=~sex, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.allpov.sexonly <- unite_ci(prev.hypt.allpov.sexonly, "Prev_allpov", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.agegroups.sexonly <- prev.hypt.pov19.sexonly %>% 
    left_join(prev.hypt.pov32.sexonly) %>% 
    left_join(prev.hypt.pov55.sexonly) %>% 
    left_join(prev.hypt.pov0.sexonly) %>% 
    left_join(prev.hypt.allpov.sexonly)
  
  write.csv(prev.hypt.agegroups.sexonly, "~/prev.hypt.agegroups.sexonly.csv")    
  
###2) DIABETES (same procedure as for hypertension)
  dia_subset <- select(bb_allpovgroups_dia, all_dia, svy, stratum, educat, psu, urban, sex, age, hh_id, country, year, agegroups, region,  
                       w_dia_poor19_age, w_dia_poor19, poor19, poor32, poor55) %>%
                filter(is.na(all_dia)==F) %>%
                filter(is.na(w_dia_poor19_age)==F) %>%
                mutate(psu = ifelse(is.na(psu==T), 1, psu))

#define surveys for countries which have multiple surveys
     dia_subset<- dia_subset[!(dia_subset$country=='Myanmar' & dia_subset$svy=='DHS'),] 
     dia_subset<- dia_subset[!( dia_subset$country=='Timor Leste' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!(dia_subset$country=='Kyrgyz Republic' & dia_subset$svy=='DHS'),] 
     dia_subset<- dia_subset[!(dia_subset$country=='Tajikistan' & dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Jordan' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!(dia_subset$country=='Comoros' & dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Mozambique' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Niger' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Rwanda' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!(dia_subset$country=='Kenya' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Zambia' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Tanzania' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Togo' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Malawi' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Uganda' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Peru' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Lesotho' &  dia_subset$svy=='DHS'),]
     dia_subset<- dia_subset[!( dia_subset$country=='Ethiopia' &  dia_subset$svy=='DHS'),]

#get sample sizes
    dia_n19 <- dia_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    dia_n0 <- dia_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall <- dia_subset %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    dia_n <- dia_n19 %>%
      left_join(dia_n0) %>%
      left_join(dia_nall) 
    
#get sample size for females   
    dia_n19.women <- dia_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    dia_n0.women <- dia_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall.women <- dia_subset %>%
      filter(sex==1) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    dia_n.women <- dia_n19.women %>%
      left_join(dia_n0.women) %>%
      left_join(dia_nall.women)   
    
#get sample size for males   
    dia_n19.men <- dia_subset %>% 
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    dia_n0.men <- dia_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall.men <- dia_subset %>%
      filter(sex==0) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    dia_n.men <- dia_n19.men %>%
      left_join(dia_n0.men) %>%
      left_join(dia_nall.men)  
    
### sample sizes by regions    
    dia_n19 <- dia_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    dia_n0 <- dia_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall <- dia_subset %>%
      group_by(region) %>%
      summarise(nall = n())
    
    dia_n <- dia_n19 %>%
      left_join(dia_n0) %>%
      left_join(dia_nall)  
    
#get sample size for females   
    dia_n19.women <- dia_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    dia_n0.women <- dia_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall.women <- dia_subset %>%
      filter(sex==1) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    dia_n.women <- dia_n19.women %>%
      left_join(dia_n0.women) %>%
      left_join(dia_nall.women)   
    
#get sample size for males   
    dia_n19.men <- dia_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    dia_n0.men <- dia_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall.men <- dia_subset %>%
      filter(sex==0) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    dia_n.men <- dia_n19.men %>%
      left_join(dia_n0.men) %>%
      left_join(dia_nall.men)     
    
#add regions and income group
  CLASS <- read_excel("~/CLASS.xlsx")
  CLASS <- CLASS %>% rename(
    country = 'Economy',
    region = 'Region',
    income_group = 'Income group') %>% 
    select(country, income_group)

  dia_subset <- dia_subset %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                              ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income", income_group))))))))) 

### sample sizes by income_group   
    dia_n19 <- dia_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    dia_n0 <- dia_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall <- dia_subset %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    dia_n <- dia_n19 %>%
      left_join(dia_n0) %>%
      left_join(dia_nall)  
    
#get sample size for females   
    dia_n19.women <- dia_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    dia_n0.women <- dia_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall.women <- dia_subset %>%
      filter(sex==1) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    dia_n.women <- dia_n19.women %>%
      left_join(dia_n0.women) %>%
      left_join(dia_nall.women)   
    
#get sample size for males   
    dia_n19.men <- dia_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    dia_n0.men <- dia_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    dia_nall.men <- dia_subset %>%
      filter(sex==0) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    dia_n.men <- dia_n19.men %>%
      left_join(dia_n0.men) %>%
      left_join(dia_nall.men)

###run survey design for each poverty group
  risk.dia.pov19 <- dia_subset %>% filter(poor19==1)
  table(risk.dia.pov19$region, risk.dia.pov19$all_dia)
  risk.dia.pov19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov19, nest = T)
  
  risk.dia.pov32 <- dia_subset %>% filter(poor32==1)
  table(risk.dia.pov32$region, risk.dia.pov32$all_dia)
  risk.dia.pov32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov32, nest = T)
  
  risk.dia.pov55 <- dia_subset %>% filter(poor55==1)
  table(risk.dia.pov55$region, risk.dia.pov55$all_dia)
  risk.dia.pov55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov55, nest = T)
  
  risk.dia.pov0 <- dia_subset %>% filter(poor55==0)
  table(risk.dia.pov0$region, risk.dia.pov0$all_dia)
  risk.dia.pov0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov0, nest = T)
  
  risk.dia.all_povgroups <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia_subset, nest = T)
  
#get prevalence for all regions
  prev.dia.pov19.region <- svyby(~all_dia, by=~region, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov19.region <- unite_ci(prev.dia.pov19.region, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.region <- svyby(~all_dia, by=~region, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov32.region <- unite_ci(prev.dia.pov32.region, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.region <- svyby(~all_dia, by=~region, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov55.region <- unite_ci(prev.dia.pov55.region, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.region <- svyby(~all_dia, by=~region, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov0.region <- unite_ci(prev.dia.pov0.region, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.region <- svyby(~all_dia, by=~region, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.allpov.region <- unite_ci(prev.dia.allpov.region, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.region.all <- prev.dia.pov19.region %>%
    left_join(prev.dia.pov32.region) %>%
    left_join(prev.dia.pov55.region) %>%
    left_join(prev.dia.pov0.region) %>%
    left_join(prev.dia.allpov.region)
  
  write.csv(prev.dia.region.all, "~/prev.dia.region.all.csv")
  
#get prevalences for all regions and sex
  prev.dia.pov19.region.sex <- svyby(~all_dia, by=~region + sex, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov19.region.sex <- unite_ci(prev.dia.pov19.region.sex, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.region.sex <- svyby(~all_dia, by=~region + sex, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov32.region.sex <- unite_ci(prev.dia.pov32.region.sex, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.region.sex <- svyby(~all_dia, by=~region + sex, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov55.region.sex <- unite_ci(prev.dia.pov55.region.sex, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.region.sex <- svyby(~all_dia, by=~region + sex, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov0.region.sex <- unite_ci(prev.dia.pov0.region.sex, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.region.sex <- svyby(~all_dia, by=~region + sex, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype
                                      = "ci")
  prev.dia.allpov.region.sex <- unite_ci(prev.dia.allpov.region.sex, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.region.all.sex <- prev.dia.pov19.region.sex %>%
    left_join(prev.dia.pov32.region.sex) %>%
    left_join(prev.dia.pov55.region.sex) %>%
    left_join(prev.dia.pov0.region.sex) %>% 
    left_join(prev.dia.allpov.region.sex)
  
  write.csv(prev.dia.region.all.sex, "~/prev.dia.region.all.sex.csv")  
  
#get prevalences for all income groups  
  prev.dia.pov19.incomegroup <- svyby(~all_dia, by=~income_group, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.dia.pov19.incomegroup <- unite_ci(prev.dia.pov19.incomegroup, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.incomegroup <- svyby(~all_dia, by=~income_group, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov32.incomegroup <- unite_ci(prev.dia.pov32.incomegroup, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.incomegroup <- svyby(~all_dia, by=~income_group, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov55.incomegroup <- unite_ci(prev.dia.pov55.incomegroup, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.incomegroup <- svyby(~all_dia, by=~income_group, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov0.incomegroup <- unite_ci(prev.dia.pov0.incomegroup, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.incomegroup <- svyby(~all_dia, by=~income_group, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                       vartype = "ci")
  prev.dia.allpov.incomegroup <- unite_ci(prev.dia.allpov.incomegroup, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.dia.incomegroup.all <- prev.dia.pov19.incomegroup %>%
    left_join(prev.dia.pov32.incomegroup) %>%
    left_join(prev.dia.pov55.incomegroup) %>%
    left_join(prev.dia.pov0.incomegroup) %>%
    left_join(prev.dia.allpov.incomegroup)
  
  write.csv(prev.dia.incomegroup.all, "~/prev.dia.incomegroup.all.csv")
  
#get prevalence for all income groups and sex
  prev.dia.pov19.incomegroup.sex <- svyby(~all_dia, by=~income_group + sex, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.dia.pov19.incomegroup.sex <- unite_ci(prev.dia.pov19.incomegroup.sex, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.dia.pov32.incomegroup.sex <- svyby(~all_dia, by=~income_group + sex, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", 
                                          vartype = "ci")
  prev.dia.pov32.incomegroup.sex <- unite_ci(prev.dia.pov32.incomegroup.sex, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.dia.pov55.incomegroup.sex <- svyby(~all_dia, by=~income_group + sex, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", 
                                          vartype = "ci")
  prev.dia.pov55.incomegroup.sex <- unite_ci(prev.dia.pov55.incomegroup.sex, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.dia.pov0.incomegroup.sex <- svyby(~all_dia, by=~income_group + sex, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype
                                         = "ci")
  prev.dia.pov0.incomegroup.sex <- unite_ci(prev.dia.pov0.incomegroup.sex, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.dia.allpov.incomegroup.sex <- svyby(~all_dia, by=~income_group + sex, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, 
                                           prop_method="asin", vartype = "ci")
  prev.dia.allpov.incomegroup.sex <- unite_ci(prev.dia.allpov.incomegroup.sex, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.incomegroup.all.sex <- prev.dia.pov19.incomegroup.sex %>%
    left_join(prev.dia.pov32.incomegroup.sex) %>%
    left_join(prev.dia.pov55.incomegroup.sex) %>%
    left_join(prev.dia.pov0.incomegroup.sex) %>%
    left_join(prev.dia.allpov.incomegroup.sex)
  
  write.csv(prev.dia.incomegroup.all.sex, "~/prev.dia.incomegroup.all.sex.csv") 

#get the total for all age groupss
  prev.dia.pov19 <- svyby(~all_dia, by=~agegroups, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov19 <- unite_ci(prev.dia.pov19, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32 <- svyby(~all_dia, by=~agegroups, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov32 <- unite_ci(prev.dia.pov32, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55 <- svyby(~all_dia, by=~agegroups, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov55 <- unite_ci(prev.dia.pov55, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0 <- svyby(~all_dia, by=~agegroups, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov0 <- unite_ci(prev.dia.pov0, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.allpov <- svyby(~all_dia, by=~agegroups, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.allpov <- unite_ci(prev.dia.allpov, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.dia.agegroups <- prev.dia.pov19 %>% 
    left_join(prev.dia.pov32) %>% 
    left_join(prev.dia.pov55) %>% 
    left_join(prev.dia.pov0)  
  
  write.csv(prev.dia.agegroups, "~/prev.dia.agegroups.csv")
     
#to get total for each risk factor
  svymean(~all_dia, risk.dia.pov19, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.pov19, level = 0.95))
  
  svymean(~all_dia, risk.dia.pov32, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.pov32, level = 0.95))
  
  svymean(~all_dia, risk.dia.pov55, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.pov55, level = 0.95))
  
  svymean(~all_dia, risk.dia.pov0, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.pov0, level = 0.95))
  
  svymean(~all_dia, risk.dia.all_povgroups, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.all_povgroups, level = 0.95))
  
  write.csv(prev.dia.allpov, "~/prev.dia.allpov.csv")
  
#to get the total for all age groups and sex
  prev.dia.pov19.sex <- svyby(~all_dia, by=~agegroups + sex, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov19.sex <- unite_ci(prev.dia.pov19.sex, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.sex <- svyby(~all_dia, by=~agegroups + sex, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov32.sex <- unite_ci(prev.dia.pov32.sex, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.sex <- svyby(~all_dia, by=~agegroups + sex, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov55.sex <- unite_ci(prev.dia.pov55.sex, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.sex <- svyby(~all_dia, by=~agegroups + sex, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov0.sex <- unite_ci(prev.dia.pov0.sex, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.sex <- svyby(~all_dia, by=~agegroups + sex, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                 "ci")
  prev.dia.allpov.sex <- unite_ci(prev.dia.allpov.sex, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

#merge prevalence by agegroups
  prev.dia.agegroups.sex <- prev.dia.pov19.sex %>% 
    left_join(prev.dia.pov32.sex) %>% 
    left_join(prev.dia.pov55.sex) %>% 
    left_join(prev.dia.pov0.sex) 
  
  write.csv(prev.dia.agegroups.sex, "~/prev.dia.agegroups.sex.csv")
      
  svymean(~all_dia, risk.dia.females19, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.females19, level = 0.95))
  
  svymean(~all_dia, risk.dia.females32, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.females32, level = 0.95))
  
  svymean(~all_dia, risk.dia.females55, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.females55, level = 0.95))
  
  svymean(~all_dia, risk.dia.females0, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.females0, level = 0.95))
  
  svymean(~all_dia, risk.dia.females.all, deff=TRUE)  
  confint(svymean(~all_dia, risk.dia.females.all, level = 0.95))
      
#to get the total for sex
  prev.dia.pov19.sexonly <- svyby(~all_dia, by=~sex, design=risk.dia.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov19.sexonly <- unite_ci(prev.dia.pov19.sexonly, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.sexonly <- svyby(~all_dia, by=~sex, design=risk.dia.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov32.sexonly <- unite_ci(prev.dia.pov32.sexonly, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.sexonly <- svyby(~all_dia, by=~sex, design=risk.dia.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov55.sexonly <- unite_ci(prev.dia.pov55.sexonly, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.sexonly <- svyby(~all_dia, by=~sex, design=risk.dia.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.pov0.sexonly <- unite_ci(prev.dia.pov0.sexonly, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.sexonly <- svyby(~all_dia, by=~sex, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.dia.allpov.sexonly <- unite_ci(prev.dia.allpov.sexonly, "Prev_allpov", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)    
  
#merge  
  prev.dia.agegroups.sexonly <- prev.dia.pov19.sexonly %>% 
    left_join(prev.dia.pov32.sexonly) %>% 
    left_join(prev.dia.pov55.sexonly) %>% 
    left_join(prev.dia.pov0.sexonly)  
  
  write.csv(prev.dia.agegroups.sexonly, "~/prev.dia.agegroups.sexonly.csv")  

###3) OVERWEIGHT 
  overw_subset <- select(bb_allpovgroups_overw, overweight, svy, sex, educat, stratum, urban, age, psu, hh_id, country, year, agegroups, region, 
                         w_overw_poor19_age, w_overw_poor19, poor19, poor32, poor55) %>%
                  filter(is.na(overweight)==F) %>%
                  filter(is.na(w_overw_poor19_age)==F)%>%
                  mutate(psu = ifelse(is.na(psu==T), 1, psu))
  
  #define surveys for countries which have multiple surveys
    overw_subset<-overw_subset[!(overw_subset$country=='Myanmar' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Timor Leste' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Albania' & overw_subset$year=='2008'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Kyrgyz Republic' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Tajikistan' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Egypt' & overw_subset$year=='2015'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Comoros' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Mozambique' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Niger' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Rwanda' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Ghana' & overw_subset$svy=='SAGE'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Kenya' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Tanzania' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Togo' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Ethiopa' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Uganda' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Malawi' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Gambia' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Jordan' & overw_subset$svy=='STEPS'),]
    overw_subset<-overw_subset[!(overw_subset$country=='Ethiopia' & overw_subset$svy=='STEPS'),]
    
#get sample size for females   
    overw_n19.women <- overw_subset %>% 
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    overw_n0.women <- overw_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall.women <- overw_subset %>%
      filter(sex==1) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    overw_n.women <- overw_n19.women %>%
      left_join(overw_n0.women) %>%
      left_join(overw_nall.women)   
    
#get sample size for males   
    overw_n19.men <- overw_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    overw_n0.men <- overw_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall.men <- overw_subset %>%
      filter(sex==0) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    overw_n.men <- overw_n19.men %>%
      left_join(overw_n0.men) %>%
      left_join(overw_nall.men)     
    
#get sample size    
    overw_n19 <- overw_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    overw_n0 <- overw_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall <- overw_subset %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    overw_n <- overw_n19 %>%
      left_join(overw_n0) %>%
      left_join(overw_nall) 
    
### sample sizes by regions    
    overw_n19 <- overw_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    overw_n0 <- overw_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall <- overw_subset %>%
      group_by(region) %>%
      summarise(nall = n())
    
    overw_n <- overw_n19 %>%
      left_join(overw_n0) %>%
      left_join(overw_nall)  
    
#get sample size for females   
    overw_n19.women <- overw_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    overw_n0.women <- overw_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall.women <- overw_subset %>%
      filter(sex==1) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    overw_n.women <- overw_n19.women %>%
      left_join(overw_n0.women) %>%
      left_join(overw_nall.women)   
    
#get sample size for males   
    overw_n19.men <- overw_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    overw_n0.men <- overw_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall.men <- overw_subset %>%
      filter(sex==0) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    overw_n.men <- overw_n19.men %>%
      left_join(overw_n0.men) %>%
      left_join(overw_nall.men)
    
#add regions and income group
  CLASS <- read_excel("~/CLASS.xlsx")
  CLASS <- CLASS %>% rename(
    country = 'Economy',
    region = 'Region',
    income_group = 'Income group') %>% 
    select(country, income_group)

  overw_subset <- overw_subset %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                            ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income",
                                                                             ifelse(country=='Congo', "Lower middle income",
                                                                                    ifelse(country=='Congo Democratic Republic', "Low income",
                                                                                           ifelse(country=='Cote dIvoire', "Lower middle income",
                                                                                                  ifelse(country=='Yemen', "Low income",
                                                                                                         income_group)))))))))))))

### sample sizes by income_group    
    overw_n19 <- overw_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    overw_n0 <- overw_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall <- overw_subset %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    overw_n <- overw_n19 %>%
      left_join(overw_n0) %>%
      left_join(overw_nall)  
    
#get sample size for females   
    overw_n19.women <- overw_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    overw_n0.women <- overw_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall.women <- overw_subset %>%
      filter(sex==1) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    overw_n.women <- overw_n19.women %>%
      left_join(overw_n0.women) %>%
      left_join(overw_nall.women)   
    
#get sample size for males   
    overw_n19.men <- overw_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    overw_n0.men <- overw_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    overw_nall.men <- overw_subset %>%
      filter(sex==0) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    overw_n.men <- overw_n19.men %>%
      left_join(overw_n0.men) %>%
      left_join(overw_nall.men)
    
#run survey design for each poverty group
  risk.overw.pov19 <- overw_subset %>% filter(poor19==1)
  risk.overw.pov19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.pov19, nest = T)
  
  risk.overw.pov32 <- overw_subset %>% filter(poor32==1)
  risk.overw.pov32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.pov32, nest = T)
  
  risk.overw.pov55 <- overw_subset %>% filter(poor55==1)
  risk.overw.pov55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.pov55, nest = T)
  
  risk.overw.pov0 <- overw_subset %>% filter(poor55==0)
  risk.overw.pov0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.pov0, nest = T)
  
  risk.overw.all_povgroups <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw_subset, nest = T)

#get prevalence for all regions
  prev.overw.pov19.region <- svyby(~overweight, by=~region, design=risk.overw.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov19.region <- unite_ci(prev.overw.pov19.region, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.overw.pov32.region <- svyby(~overweight, by=~region, design=risk.overw.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov32.region <- unite_ci(prev.overw.pov32.region, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov55.region <- svyby(~overweight, by=~region, design=risk.overw.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov55.region <- unite_ci(prev.overw.pov55.region, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov0.region <- svyby(~overweight, by=~region, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov0.region <- unite_ci(prev.overw.pov0.region, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.allpov.region <- svyby(~overweight, by=~region, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                      "ci")
  prev.overw.allpov.region <- unite_ci(prev.overw.allpov.region, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.region.all <- prev.overw.pov19.region %>%
    left_join(prev.overw.pov32.region) %>%
    left_join(prev.overw.pov55.region) %>%
    left_join(prev.overw.pov0.region)
  
  write.csv(prev.overw.region.all, "~/prev.overw.region.all.csv")
  
#get prevalences for all regions and sex
  prev.overw.pov19.region.sex <- svyby(~overweight, by=~region + sex, design=risk.overw.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype =
                                         "ci")
  prev.overw.pov19.region.sex <- unite_ci(prev.overw.pov19.region.sex, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.overw.pov32.region.sex <- svyby(~overweight, by=~region + sex, design=risk.overw.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype =
                                         "ci")
  prev.overw.pov32.region.sex <- unite_ci(prev.overw.pov32.region.sex, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.overw.pov55.region.sex <- svyby(~overweight, by=~region + sex, design=risk.overw.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype =
                                         "ci")
  prev.overw.pov55.region.sex <- unite_ci(prev.overw.pov55.region.sex, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.overw.pov0.region.sex <- svyby(~overweight, by=~region + sex, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                        "ci")
  prev.overw.pov0.region.sex <- unite_ci(prev.overw.pov0.region.sex, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.overw.allpov.region.sex <- svyby(~overweight, by=~region + sex, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.overw.allpov.region.sex <- unite_ci(prev.overw.allpov.region.sex, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.region.all.sex <- prev.overw.pov19.region.sex %>%
    left_join(prev.overw.pov32.region.sex) %>%
    left_join(prev.overw.pov55.region.sex) %>%
    left_join(prev.overw.pov0.region.sex)
  
  write.csv(prev.overw.region.all.sex, "~/prev.overw.region.all.sex.csv")  
  
#get prevalences for all income groups  
  prev.overw.pov19.incomegroup <- svyby(~overweight, by=~income_group, design=risk.overw.pov19, svyciprop, proportion=TRUE, prop_method="asin", 
                                          vartype = "ci")
  prev.overw.pov19.incomegroup <- unite_ci(prev.overw.pov19.incomegroup, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.overw.pov32.incomegroup <- svyby(~overweight, by=~income_group, design=risk.overw.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype 
                                        = "ci")
  prev.overw.pov32.incomegroup <- unite_ci(prev.overw.pov32.incomegroup, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov55.incomegroup <- svyby(~overweight, by=~income_group, design=risk.overw.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype 
                                        = "ci")
  prev.overw.pov55.incomegroup <- unite_ci(prev.overw.pov55.incomegroup, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov0.incomegroup <- svyby(~overweight, by=~income_group, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.overw.pov0.incomegroup <- unite_ci(prev.overw.pov0.incomegroup, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.allpov.incomegroup <- svyby(~overweight, by=~income_group, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin",
                                         vartype = "ci")
  prev.overw.allpov.incomegroup <- unite_ci(prev.overw.allpov.incomegroup, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.incomegroup.all <- prev.overw.pov19.incomegroup %>%
    left_join(prev.overw.pov32.incomegroup) %>%
    left_join(prev.overw.pov55.incomegroup) %>%
    left_join(prev.overw.pov0.incomegroup)
  
  write.csv(prev.overw.incomegroup.all, "~/prev.overw.incomegroup.all.csv")
  
# get prevalences for all income groups and sex
  prev.overw.pov19.incomegroup.sex <- svyby(~overweight, by=~income_group + sex, design=risk.overw.pov19, svyciprop, proportion=TRUE, 
                                              prop_method="asin", vartype = "ci")
  prev.overw.pov19.incomegroup.sex <- unite_ci(prev.overw.pov19.incomegroup.sex, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.overw.pov32.incomegroup.sex <- svyby(~overweight, by=~income_group + sex, design=risk.overw.pov32, svyciprop, proportion=TRUE, 
                                            prop_method="asin", vartype = "ci")
  prev.overw.pov32.incomegroup.sex <- unite_ci(prev.overw.pov32.incomegroup.sex, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov55.incomegroup.sex <- svyby(~overweight, by=~income_group + sex, design=risk.overw.pov55, svyciprop, proportion=TRUE, 
                                            prop_method="asin", vartype = "ci")
  prev.overw.pov55.incomegroup.sex <- unite_ci(prev.overw.pov55.incomegroup.sex, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov0.incomegroup.sex <- svyby(~overweight, by=~income_group + sex, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.overw.pov0.incomegroup.sex <- unite_ci(prev.overw.pov0.incomegroup.sex, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.allpov.incomegroup.sex <- svyby(~overweight, by=~income_group + sex, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.overw.allpov.incomegroup.sex <- unite_ci(prev.overw.allpov.incomegroup.sex, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.incomegroup.all.sex <- prev.overw.pov19.incomegroup.sex %>%
    left_join(prev.overw.pov32.incomegroup.sex) %>%
    left_join(prev.overw.pov55.incomegroup.sex) %>%
    left_join(prev.overw.pov0.incomegroup.sex)
  
  write.csv(prev.overw.incomegroup.all.sex, "~/prev.overw.incomegroup.all.sex.csv")   

#to get the total for all age groups
  prev.overw.pov19 <- svyby(~overweight, by=~agegroups, design=risk.overw.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov19 <- unite_ci(prev.overw.pov19, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.overw.pov32 <- svyby(~overweight, by=~agegroups, design=risk.overw.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov32 <- unite_ci(prev.overw.pov32, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov55 <- svyby(~overweight, by=~agegroups, design=risk.overw.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov55 <- unite_ci(prev.overw.pov55, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov0 <- svyby(~overweight, by=~agegroups, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov0 <- unite_ci(prev.overw.pov0, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.allpov <- svyby(~overweight, by=~agegroups, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                               "ci")
  prev.overw.allpov <- unite_ci(prev.overw.allpov, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.overw.agegroups <- prev.overw.pov19 %>% 
    left_join(prev.overw.pov32) %>% 
    left_join(prev.overw.pov55) %>% 
    left_join(prev.overw.pov0) 
  
  write.csv(prev.overw.agegroups, "~/prev.overw.agegroups.csv") 

#to get total for each risk factor
  svymean(~overweight, risk.overw.pov19, deff=TRUE)  
  confint(svymean(~overweight, risk.overw.pov19, level = 0.95))
  
  svymean(~overweight, risk.overw.pov32, deff=TRUE)  
  confint(svymean(~overweight, risk.overw.pov32, level = 0.95))
  
  svymean(~overweight, risk.overw.pov55, deff=TRUE)  
  confint(svymean(~overweight, risk.overw.pov55, level = 0.95))
  
  svymean(~overweight, risk.overw.pov0, deff=TRUE)  
  confint(svymean(~overweight, risk.overw.pov0, level = 0.95))

  svymean(~overweight, risk.overw.all_povgroups, deff=TRUE)  
  confint(svymean(~overweight, risk.overw.all_povgroups, level = 0.95))
  
#get the total for all age groups and sex
  prev.overw.pov19.sex <- svyby(~overweight, by=~agegroups + sex, design=risk.overw.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                  "ci")
  prev.overw.pov19.sex <- unite_ci(prev.overw.pov19.sex, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.overw.pov32.sex <- svyby(~overweight, by=~agegroups  + sex, design=risk.overw.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                  "ci")
  prev.overw.pov32.sex <- unite_ci(prev.overw.pov32.sex, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.overw.pov55.sex <- svyby(~overweight, by=~agegroups  + sex, design=risk.overw.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                  "ci")
  prev.overw.pov55.sex <- unite_ci(prev.overw.pov55.sex, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.overw.pov0.sex <- svyby(~overweight, by=~agegroups  + sex, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                 "ci")
  prev.overw.pov0.sex <- unite_ci(prev.overw.pov0.sex, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.overw.allpov.sex <- svyby(~overweight, by=~agegroups  + sex, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                 vartype = "ci")
  prev.overw.allpov.sex <- unite_ci(prev.overw.allpov.sex, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalence by agegroups
  prev.overw.agegroups.sex <- prev.overw.pov19.sex %>% 
    left_join(prev.overw.pov32.sex) %>% 
    left_join(prev.overw.pov55.sex) %>% 
    left_join(prev.overw.pov0.sex) 
  
  write.csv(prev.overw.agegroups.sex, "~/prev.overw.agegroups.sex.csv") 
    
#for all agegroups and sex
  prev.overw.pov19.sexonly <- svyby(~overweight, by=~sex, design=risk.overw.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov19.sexonly <- unite_ci(prev.overw.pov19.sexonly, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.overw.pov32.sexonly <- svyby(~overweight, by=~sex, design=risk.overw.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov32.sexonly <- unite_ci(prev.overw.pov32.sexonly, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov55.sexonly <- svyby(~overweight, by=~sex, design=risk.overw.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov55.sexonly <- unite_ci(prev.overw.pov55.sexonly, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.pov0.sexonly <- svyby(~overweight, by=~sex, design=risk.overw.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.overw.pov0.sexonly <- unite_ci(prev.overw.pov0.sexonly, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.overw.allpov.sexonly <- svyby(~overweight, by=~sex, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                       "ci")
  prev.overw.allpov.sexonly <- unite_ci(prev.overw.allpov.sexonly, "Prev_allpov", overweight, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.overw.agegroups.sexonly <- prev.overw.pov19.sexonly %>% 
    left_join(prev.overw.pov32.sexonly) %>% 
    left_join(prev.overw.pov55.sexonly) %>% 
    left_join(prev.overw.pov0.sexonly) 
  
  write.csv(prev.overw.agegroups.sexonly, "~/prev.overw.agegroups.sexonly.csv") 
  
###4) OBESITY 
  obese_subset <- select(bb_allpovgroups_obese, obese, svy, sex, educat, stratum, urban, age, psu, hh_id, country, year, agegroups, region, 
                         w_obese_poor19_age, w_obese_poor19, poor19, poor32, poor55) %>%
                  filter(is.na(obese)==F) %>%
                  filter(is.na(w_obese_poor19_age)==F) %>%
                  mutate( psu = ifelse(is.na(psu==T), 1, psu))
  
#define surveys for countries which have multiple surveys
    obese_subset<-obese_subset[!(obese_subset$country=='Myanmar' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Timor Leste' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Albania' & obese_subset$year=='2008'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Kyrgyz Republic' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Tajikistan' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Egypt' & obese_subset$year=='2015'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Comoros' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Mozambique' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Niger' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Rwanda' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Ghana' & obese_subset$svy=='SAGE'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Kenya' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Tanzania' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Togo' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Ethiopa' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Uganda' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Malawi' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Gambia' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Jordan' & obese_subset$svy=='STEPS'),]
    obese_subset<-obese_subset[!(obese_subset$country=='Ethiopia' & obese_subset$svy=='STEPS'),]

#get sample size    
    obese_n19 <- obese_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    obese_n0 <- obese_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    obese_nall <- obese_subset %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    obese_n <- obese_n19 %>%
      left_join(obese_n0) %>%
      left_join(obese_nall)  
    
#get sample size for females   
    obese_n19.women <- obese_subset %>% 
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    obese_n0.women <- obese_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    obese_nall.women <- obese_subset %>%
      filter(sex==1) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    obese_n.women <- obese_n19.women %>%
      left_join(obese_n0.women) %>%
      left_join(obese_nall.women)   
    
#get sample size for males   
    obese_n19.men <- obese_subset %>% 
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    obese_n0.men <- obese_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    obese_nall.men <- obese_subset %>%
      filter(sex==0) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    obese_n.men <- obese_n19.men %>%
      left_join(obese_n0.men) %>%
      left_join(obese_nall.men) 
    
### sample sizes by regions    
    #get sample sizes
    obese_n19 <- obese_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    obese_n0 <- obese_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    obese_nall <- obese_subset %>%
      group_by(region) %>%
      summarise(nall = n())
    
    obese_n <- obese_n19 %>%
      left_join(obese_n0) %>%
      left_join(obese_nall)  
    
#get sample size for females   
    obese_n19.women <- obese_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    obese_n0.women <- obese_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    obese_nall.women <- obese_subset %>%
      filter(sex==1) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    obese_n.women <- obese_n19.women %>%
      left_join(obese_n0.women) %>%
      left_join(obese_nall.women)   
    
#get sample size for males   
    obese_n19.men <- obese_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    obese_n0.men <- obese_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    obese_nall.men <- obese_subset %>%
      filter(sex==0) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    obese_n.men <- obese_n19.men %>%
      left_join(obese_n0.men) %>%
      left_join(obese_nall.men)
    
    
#add regions and incomeroup
  CLASS <- read_excel("~/CLASS.xlsx")
  CLASS <- CLASS %>% rename(
    country = 'Economy',
    region = 'Region',
    income_group = 'Income group') %>% 
    select(country, income_group)

  obese_subset <- obese_subset %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                            ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income", income_group))))))))) 
      
#run survey design for each poverty group
  risk.obese.pov19 <- obese_subset %>% filter(poor19==1)
  risk.obese.pov19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.pov19, nest = T)
  
  risk.obese.pov32 <- obese_subset %>% filter(poor32==1)
  risk.obese.pov32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.pov32, nest = T)
  
  risk.obese.pov55 <- obese_subset %>% filter(poor55==1)
  risk.obese.pov55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.pov55, nest = T)
  
  risk.obese.pov0 <- obese_subset %>% filter(poor55==0)
  risk.obese.pov0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.pov0, nest = T)
  
#get prevalence for all regions
  prev.obese.pov19.region <- svyby(~obese, by=~region, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov19.region <- unite_ci(prev.obese.pov19.region, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.obese.pov32.region <- svyby(~obese, by=~region, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov32.region <- unite_ci(prev.obese.pov32.region, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov55.region <- svyby(~obese, by=~region, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov55.region <- unite_ci(prev.obese.pov55.region, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov0.region <- svyby(~obese, by=~region, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov0.region <- unite_ci(prev.obese.pov0.region, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov.region <- svyby(~obese, by=~region, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.allpov.region <- unite_ci(prev.obese.allpov.region, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.region.all <- prev.obese.pov19.region %>%
    left_join(prev.obese.pov32.region) %>%
    left_join(prev.obese.pov55.region)# %>%
    left_join(prev.obese.pov0.region)
  
  write.csv(prev.obese.region.all, "~/prev.obese.region.all.csv")
  
#get prevalences for all regions and sex
  prev.obese.pov19.region.sex <- svyby(~obese, by=~region + sex, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.obese.pov19.region.sex <- unite_ci(prev.obese.pov19.region.sex, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.obese.pov32.region.sex <- svyby(~obese, by=~region + sex, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.obese.pov32.region.sex <- unite_ci(prev.obese.pov32.region.sex, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.obese.pov55.region.sex <- svyby(~obese, by=~region + sex, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.obese.pov55.region.sex <- unite_ci(prev.obese.pov55.region.sex, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.obese.pov0.region.sex <- svyby(~obese, by=~region + sex, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov0.region.sex <- unite_ci(prev.obese.pov0.region.sex, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov.region.sex <- svyby(~obese, by=~region + sex, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.obese.allpov.region.sex <- unite_ci(prev.obese.allpov.region.sex, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.region.all.sex <- prev.obese.pov19.region.sex %>%
    left_join(prev.obese.pov32.region.sex) %>%
    left_join(prev.obese.pov55.region.sex) %>%
    left_join(prev.obese.pov0.region.sex)
  
  write.csv(prev.obese.region.all.sex, "~/prev.obese.region.all.sex.csv")  
  
#get prevalence for all income groups  
    prev.obese.pov19.incomegroup <- svyby(~obese, by=~income_group, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                            "ci")
  prev.obese.pov19.incomegroup <- unite_ci(prev.obese.pov19.incomegroup, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  

  prev.obese.pov32.incomegroup <- svyby(~obese, by=~income_group, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.obese.pov32.incomegroup <- unite_ci(prev.obese.pov32.incomegroup, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.obese.pov55.incomegroup <- svyby(~obese, by=~income_group, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.obese.pov55.incomegroup <- unite_ci(prev.obese.pov55.incomegroup, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.obese.pov0.incomegroup <- svyby(~obese, by=~income_group, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov0.incomegroup <- unite_ci(prev.obese.pov0.incomegroup, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov.incomegroup <- svyby(~obese, by=~income_group, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                         vartype = "ci")
  prev.obese.allpov.incomegroup <- unite_ci(prev.obese.allpov.incomegroup, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.incomegroup.all <- prev.obese.pov19.incomegroup %>%
    left_join(prev.obese.pov32.incomegroup) %>%
    left_join(prev.obese.pov55.incomegroup) %>%
    left_join(prev.obese.pov0.incomegroup)
  
  write.csv(prev.obese.incomegroup.all, "~/prev.obese.incomegroup.all.csv")
  
#get prevalences for all income groups and sex
  prev.obese.pov19.incomegroup.sex <- svyby(~obese, by=~income_group + sex, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", 
                                              vartype = "ci")
  prev.obese.pov19.incomegroup.sex <- unite_ci(prev.obese.pov19.incomegroup.sex, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.obese.pov32.incomegroup.sex <- svyby(~obese, by=~income_group + sex, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.obese.pov32.incomegroup.sex <- unite_ci(prev.obese.pov32.incomegroup.sex, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov55.incomegroup.sex <- svyby(~obese, by=~income_group + sex, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.obese.pov55.incomegroup.sex <- unite_ci(prev.obese.pov55.incomegroup.sex, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov0.incomegroup.sex <- svyby(~obese, by=~income_group + sex, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.obese.pov0.incomegroup.sex <- unite_ci(prev.obese.pov0.incomegroup.sex, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov.incomegroup.sex <- svyby(~obese, by=~income_group + sex, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.obese.allpov.incomegroup.sex <- unite_ci(prev.obese.allpov.incomegroup.sex, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.incomegroup.all.sex <- prev.obese.pov19.incomegroup.sex %>%
    left_join(prev.obese.pov32.incomegroup.sex) %>%
    left_join(prev.obese.pov55.incomegroup.sex) %>%
    left_join(prev.obese.pov0.incomegroup.sex)
  
  write.csv(prev.obese.incomegroup.all.sex, "~/prev.obese.incomegroup.all.sex.csv")   
  
#get the total for all age groups
  prev.obese.pov19 <- svyby(~obese, by=~agegroups, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov19 <- unite_ci(prev.obese.pov19, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.obese.pov32 <- svyby(~obese, by=~agegroups, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov32 <- unite_ci(prev.obese.pov32, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov55 <- svyby(~obese, by=~agegroups, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov55 <- unite_ci(prev.obese.pov55, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov0 <- svyby(~obese, by=~agegroups, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov0 <- unite_ci(prev.obese.pov0, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov <- svyby(~obese, by=~agegroups, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.allpov <- unite_ci(prev.obese.allpov, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalence by agegroups
  prev.obese.agegroups <- prev.obese.pov19 %>% 
    left_join(prev.obese.pov32) %>% 
    left_join(prev.obese.pov55) %>% 
    left_join(prev.obese.pov0)  
  
  write.csv(prev.obese.agegroups, "~/prev.obese.agegroups.csv")  

#to get total for each risk factor
  svymean(~obese, risk.obese.pov19, deff=TRUE)
  confint(svymean(~obese, risk.obese.pov19, level = 0.95))
  
  svymean(~obese, risk.obese.pov32, deff=TRUE)
  confint(svymean(~obese, risk.obese.pov32, level = 0.95))
  
  svymean(~obese, risk.obese.pov55, deff=TRUE)
  confint(svymean(~obese, risk.obese.pov55, level = 0.95))
  
  svymean(~obese, risk.obese.pov0, deff=TRUE)
  confint(svymean(~obese, risk.obese.pov0, level = 0.95))

  svymean(~obese, risk.obese.all_povgroups, deff=TRUE)
  confint(svymean(~obese, risk.obese.all_povgroups, level = 0.95))
  
#to get the total for all age groups and sex
  prev.obese.pov19.sex <- svyby(~obese, by=~agegroups + sex, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov19.sex <- unite_ci(prev.obese.pov19.sex, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.obese.pov32.sex <- svyby(~obese, by=~agegroups + sex, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov32.sex <- unite_ci(prev.obese.pov32.sex, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov55.sex <- svyby(~obese, by=~agegroups + sex, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov55.sex <- unite_ci(prev.obese.pov55.sex, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov0.sex <- svyby(~obese, by=~agegroups + sex, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov0.sex <- unite_ci(prev.obese.pov0.sex, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov.sex <- svyby(~obese, by=~agegroups + sex, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype =
                                   "ci")
  prev.obese.allpov.sex <- unite_ci(prev.obese.allpov.sex, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.obese.agegroups.sex <- prev.obese.pov19.sex %>% 
    left_join(prev.obese.pov32.sex) %>% 
    left_join(prev.obese.pov55.sex) %>% 
    left_join(prev.obese.pov0.sex)  
  
  write.csv(prev.obese.agegroups.sex, "~/prev.obese.agegroups.sex.csv") 
  
#for all agegroups
  prev.obese.pov19.sexonly <- svyby(~obese, by=~sex, design=risk.obese.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov19.sexonly <- unite_ci(prev.obese.pov19.sexonly, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.obese.pov32.sexonly <- svyby(~obese, by=~sex, design=risk.obese.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov32.sexonly <- unite_ci(prev.obese.pov32.sexonly, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov55.sexonly <- svyby(~obese, by=~sex, design=risk.obese.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov55.sexonly <- unite_ci(prev.obese.pov55.sexonly, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.pov0.sexonly <- svyby(~obese, by=~sex, design=risk.obese.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.pov0.sexonly <- unite_ci(prev.obese.pov0.sexonly, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.obese.allpov.sexonly <- svyby(~obese, by=~sex, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.obese.allpov.sexonly <- unite_ci(prev.obese.allpov.sexonly, "Prev_allpov", obese, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge
  prev.obese.agegroups.sexonly <- prev.obese.pov19.sexonly %>% 
    left_join(prev.obese.pov32.sexonly) %>% 
    left_join(prev.obese.pov55.sexonly) %>% 
    left_join(prev.obese.pov0.sexonly)  
  
  write.csv(prev.obese.agegroups.sexonly, "~/prev.obese.agegroups.sexonly.csv")
  
###5) SMOKING 
  smoke_subset <- select(bb_allpovgroups_smoke, csmoke, stratum, sex, urban, educat, age, svy, psu, hh_id, country, year, agegroups, region, 
                         w_smoke_poor19_age, w_smoke_poor19, poor19, poor32, poor55) %>% 
                  filter(is.na(csmoke)==F)  %>% 
                  filter(is.na(w_smoke_poor19_age)==F)  %>% 
                  mutate(psu = ifelse(is.na(psu==T), 1, psu))
  
#define surveys for countries which have multiple surveys
    smoke_subset<-smoke_subset[!(smoke_subset$country=='China' & smoke_subset$svy=='CHNS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Myanmar' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Timor Leste' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Albania' & smoke_subset$year=='2008'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Kyrgyz Republic' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Tajikistan' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Mexico' & smoke_subset$year=='2009-2012'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Egypt' & smoke_subset$year=='2014'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Bangladesh' & smoke_subset$svy=='DHS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='India' & smoke_subset$svy=='DHS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Comoros' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Ethiopa' & smoke_subset$svy=='DHS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Mozambique' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Niger' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Rwanda' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Senegal' & smoke_subset$svy=='DHS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Ghana' & smoke_subset$svy=='SAGE'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Kenya' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Tanzania' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Togo' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Uganda' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Gambia' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Malawi' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Zambia' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Botswana' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Jordan' & smoke_subset$svy=='STEPS'),]
    smoke_subset<-smoke_subset[!(smoke_subset$country=='Ethiopia' & smoke_subset$svy=='STEPS'),]

#get sample size    
    smoke_n19 <- smoke_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0 <- smoke_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall <- smoke_subset %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    smoke_n <- smoke_n19 %>%
      left_join(smoke_n0) %>%
      left_join(smoke_nall)   
    
#get sample size for females   
    smoke_n19.women <- smoke_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0.women <- smoke_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall.women <- smoke_subset %>%
      filter(sex==1) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    smoke_n.women <- smoke_n19.women %>%
      left_join(smoke_n0.women) %>%
      left_join(smoke_nall.women)   
    
#get sample size for males   
    smoke_n19.men <- smoke_subset %>% 
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0.men <- smoke_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall.men <- smoke_subset %>%
      filter(sex==0) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    smoke_n.men <- smoke_n19.men %>%
      left_join(smoke_n0.men) %>%
      left_join(smoke_nall.men)  
    
### sample sizes by regions    
    smoke_n19 <- smoke_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0 <- smoke_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall <- smoke_subset %>%
      group_by(region) %>%
      summarise(nall = n())
    
    smoke_n <- smoke_n19 %>%
      left_join(smoke_n0) %>%
      left_join(smoke_nall)  
    
#get sample size for females   
    smoke_n19.women <- smoke_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0.women <- smoke_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall.women <- smoke_subset %>%
      filter(sex==1) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    smoke_n.women <- smoke_n19.women %>%
      left_join(smoke_n0.women) %>%
      left_join(smoke_nall.women)   
    
#get sample size for males   
    smoke_n19.men <- smoke_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0.men <- smoke_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall.men <- smoke_subset %>%
      filter(sex==0) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    smoke_n.men <- smoke_n19.men %>%
      left_join(smoke_n0.men) %>%
      left_join(smoke_nall.men)    
    
#add regions and income group
  CLASS <- read_excel("~/CLASS.xlsx")
  CLASS <- CLASS %>% rename(
    country = 'Economy',
    region = 'Region',
    income_group = 'Income group') %>% 
    select(country, income_group)

  smoke_subset <- smoke_subset %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                               ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income",
                                                                             ifelse(country=='Congo', "Lower middle income",
                                                                                    ifelse(country=='Congo Democratic Republic', "Low income",
                                                                                           ifelse(country=='Cote dIvoire', "Lower middle income",
                                                                                                  ifelse(country=='Yemen', "Low income",
                                                                                                         income_group)))))))))))))

###sample size by income_groups    
    smoke_n19 <- smoke_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0 <- smoke_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall <- smoke_subset %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    smoke_n <- smoke_n19 %>%
      left_join(smoke_n0) %>%
      left_join(smoke_nall)  
    
#get sample size for females   
    smoke_n19.women <- smoke_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0.women <- smoke_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall.women <- smoke_subset %>%
      filter(sex==1) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    smoke_n.women <- smoke_n19.women %>%
      left_join(smoke_n0.women) %>%
      left_join(smoke_nall.women)   
    
#get sample size for males   
    smoke_n19.men <- smoke_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    smoke_n0.men <- smoke_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    smoke_nall.men <- smoke_subset %>%
      filter(sex==0) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    smoke_n.men <- smoke_n19.men %>%
      left_join(smoke_n0.men) %>%
      left_join(smoke_nall.men)
    
#run survey design for each poverty group
  risk.smoke.pov19 <- smoke_subset %>% filter(poor19==1)
  risk.smoke.pov19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.pov19, nest = T)
  
  risk.smoke.pov32 <- smoke_subset %>% filter(poor32==1)
  risk.smoke.pov32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.pov32, nest = T)
  
  risk.smoke.pov55 <- smoke_subset %>% filter(poor55==1)
  risk.smoke.pov55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.pov55, nest = T)
  
  risk.smoke.pov0 <- smoke_subset %>% filter(poor55==0)
  risk.smoke.pov0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.pov0, nest = T)
  
  risk.smoke.all_povgroups <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke_subset, nest = T)
  
#get prevalences for all regions
  prev.smoke.pov19.region <- svyby(~csmoke, by=~region, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov19.region <- unite_ci(prev.smoke.pov19.region, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32.region <- svyby(~csmoke, by=~region, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov32.region <- unite_ci(prev.smoke.pov32.region, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55.region <- svyby(~csmoke, by=~region, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov55.region <- unite_ci(prev.smoke.pov55.region, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0.region <- svyby(~csmoke, by=~region, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov0.region <- unite_ci(prev.smoke.pov0.region, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.allpov.region <- svyby(~csmoke, by=~region, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                      "ci")
  prev.smoke.allpov.region <- unite_ci(prev.smoke.allpov.region, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.region.all <- prev.smoke.pov19.region %>%
    left_join(prev.smoke.pov32.region) %>%
    left_join(prev.smoke.pov55.region) %>%
    left_join(prev.smoke.pov0.region)
  
  write.csv(prev.smoke.region.all, "~/prev.smoke.region.all.csv")
  
#get prevalences for all regions and sex
  prev.smoke.pov19.region.sex <- svyby(~csmoke, by=~region + sex, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.smoke.pov19.region.sex <- unite_ci(prev.smoke.pov19.region.sex, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32.region.sex <- svyby(~csmoke, by=~region + sex, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.smoke.pov32.region.sex <- unite_ci(prev.smoke.pov32.region.sex, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55.region.sex <- svyby(~csmoke, by=~region + sex, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.smoke.pov55.region.sex <- unite_ci(prev.smoke.pov55.region.sex, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0.region.sex <- svyby(~csmoke, by=~region + sex, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov0.region.sex <- unite_ci(prev.smoke.pov0.region.sex, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.allpov.region.sex <- svyby(~csmoke, by=~region + sex, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.smoke.allpov.region.sex <- unite_ci(prev.smoke.allpov.region.sex, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.region.all.sex <- prev.smoke.pov19.region.sex %>%
    left_join(prev.smoke.pov32.region.sex) %>%
    left_join(prev.smoke.pov55.region.sex) %>%
    left_join(prev.smoke.pov0.region.sex)
  
  write.csv(prev.smoke.region.all.sex, "~/prev.smoke.region.all.sex.csv")  
  
#get prevalences for all income groups  
    prev.smoke.pov19.incomegroup <- svyby(~csmoke, by=~income_group, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                            "ci")
  prev.smoke.pov19.incomegroup <- unite_ci(prev.smoke.pov19.incomegroup, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32.incomegroup <- svyby(~csmoke, by=~income_group, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.smoke.pov32.incomegroup <- unite_ci(prev.smoke.pov32.incomegroup, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55.incomegroup <- svyby(~csmoke, by=~income_group, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.smoke.pov55.incomegroup <- unite_ci(prev.smoke.pov55.incomegroup, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0.incomegroup <- svyby(~csmoke, by=~income_group, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.smoke.pov0.incomegroup <- unite_ci(prev.smoke.pov0.incomegroup, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.allpov.incomegroup <- svyby(~csmoke, by=~income_group, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                         vartype = "ci")
  prev.smoke.allpov.incomegroup <- unite_ci(prev.smoke.allpov.incomegroup, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  
  prev.smoke.incomegroup.all <- prev.smoke.pov19.incomegroup %>%
    left_join(prev.smoke.pov32.incomegroup) %>%
    left_join(prev.smoke.pov55.incomegroup) %>%
    left_join(prev.smoke.pov0.incomegroup)
  
  write.csv(prev.smoke.incomegroup.all, "~/prev.smoke.incomegroup.all.csv")
  
# get prevalences for all income groups and sex
  prev.smoke.pov19.incomegroup.sex <- svyby(~csmoke, by=~income_group + sex, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.smoke.pov19.incomegroup.sex <- unite_ci(prev.smoke.pov19.incomegroup.sex, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32.incomegroup.sex <- svyby(~csmoke, by=~income_group + sex, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.smoke.pov32.incomegroup.sex <- unite_ci(prev.smoke.pov32.incomegroup.sex, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55.incomegroup.sex <- svyby(~csmoke, by=~income_group + sex, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.smoke.pov55.incomegroup.sex <- unite_ci(prev.smoke.pov55.incomegroup.sex, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0.incomegroup.sex <- svyby(~csmoke, by=~income_group + sex, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.smoke.pov0.incomegroup.sex <- unite_ci(prev.smoke.pov0.incomegroup.sex, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.allpov.incomegroup.sex <- svyby(~csmoke, by=~income_group + sex, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.smoke.allpov.incomegroup.sex <- unite_ci(prev.smoke.allpov.incomegroup.sex, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.incomegroup.all.sex <- prev.smoke.pov19.incomegroup.sex %>%
    left_join(prev.smoke.pov32.incomegroup.sex) %>%
    left_join(prev.smoke.pov55.incomegroup.sex) %>%
    left_join(prev.smoke.pov0.incomegroup.sex)
  
  write.csv(prev.smoke.incomegroup.all.sex, "~/prev.smoke.incomegroup.all.sex.csv")   

#to get the total for all age groupss
  prev.smoke.pov19 <- svyby(~csmoke, by=~agegroups, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov19 <- unite_ci(prev.smoke.pov19, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32 <- svyby(~csmoke, by=~agegroups, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov32 <- unite_ci(prev.smoke.pov32, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55 <- svyby(~csmoke, by=~agegroups, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov55 <- unite_ci(prev.smoke.pov55, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0 <- svyby(~csmoke, by=~agegroups, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov0 <- unite_ci(prev.smoke.pov0, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.allpov <- svyby(~csmoke, by=~agegroups, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.allpov <- unite_ci(prev.smoke.allpov, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.smoke.agegroups <- prev.smoke.pov19 %>% 
    left_join(prev.smoke.pov32) %>% 
    left_join(prev.smoke.pov55) %>% 
    left_join(prev.smoke.pov0)  
  
  write.csv(prev.smoke.agegroups, "~/prev.smoke.agegroups.csv")
  
  svymean(~csmoke, risk.smoke.pov19, deff=TRUE)
  confint(svymean(~csmoke, risk.smoke.pov19, level = 0.95))
  
  svymean(~csmoke, risk.smoke.pov32, deff=TRUE)
  confint(svymean(~csmoke, risk.smoke.pov32, level = 0.95))
        
  svymean(~csmoke, risk.smoke.pov55, deff=TRUE)
  confint(svymean(~csmoke, risk.smoke.pov55, level = 0.95))
  
  svymean(~csmoke, risk.smoke.pov0, deff=TRUE)
  confint(svymean(~csmoke, risk.smoke.pov0, level = 0.95))

#to get the total for all age groups and sex
  prev.smoke.pov19.sex <- svyby(~csmoke, by=~agegroups + sex, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov19.sex <- unite_ci(prev.smoke.pov19.sex, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32.sex <- svyby(~csmoke, by=~agegroups + sex, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov32.sex <- unite_ci(prev.smoke.pov32.sex, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55.sex <- svyby(~csmoke, by=~agegroups + sex, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov55.sex <- unite_ci(prev.smoke.pov55.sex, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0.sex <- svyby(~csmoke, by=~agegroups+ sex, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov0.sex <- unite_ci(prev.smoke.pov0.sex, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.allpov.sex <- svyby(~csmoke, by=~agegroups + sex, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype 
                                 = "ci")
  prev.smoke.allpov.sex <- unite_ci(prev.smoke.allpov.sex, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

#merge prevalences by agegroups and sex
  prev.smoke.agegroups.sex <- prev.smoke.pov19.sex %>% 
    left_join(prev.smoke.pov32.sex) %>% 
    left_join(prev.smoke.pov55.sex) %>% 
    left_join(prev.smoke.pov0.sex)  
  
  write.csv(prev.smoke.agegroups.sex, "~/prev.smoke.agegroups.sex.csv")
   
#to get the total for sex
  prev.smoke.pov19.sexonly <- svyby(~csmoke, by=~sex, design=risk.smoke.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov19.sexonly <- unite_ci(prev.smoke.pov19.sexonly, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.smoke.pov32.sexonly <- svyby(~csmoke, by=~sex, design=risk.smoke.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov32.sexonly <- unite_ci(prev.smoke.pov32.sexonly, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov55.sexonly <- svyby(~csmoke, by=~sex, design=risk.smoke.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov55.sexonly <- unite_ci(prev.smoke.pov55.sexonly, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.smoke.pov0.sexonly <- svyby(~csmoke, by=~sex, design=risk.smoke.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.pov0.sexonly <- unite_ci(prev.smoke.pov0.sexonly, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)   
  
  prev.smoke.allpov.sexonly <- svyby(~csmoke, by=~sex, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.smoke.allpov.sexonly <- unite_ci(prev.smoke.allpov.sexonly, "Prev_allpov", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)

#merge prevalences by agegroups and sex
  prev.smoke.agegroups.sexonly <- prev.smoke.pov19.sexonly %>% 
    left_join(prev.smoke.pov32.sexonly) %>% 
    left_join(prev.smoke.pov55.sexonly) %>% 
    left_join(prev.smoke.pov0.sexonly)  
  
   write.csv(prev.smoke.agegroups.sex, "~/prev.smoke.agegroups.sex.csv")  
  
  svymean(~csmoke, risk.smoke.all_povgroups, deff=TRUE)
  confint(svymean(~csmoke, risk.smoke.all_povgroups, level = 0.95))
  
###6) LIPIDS 
    lipid_subset <- select(bb_allpovgroups_lipids, dyslipid, svy, sex, educat, stratum, urban, age, psu, hh_id, country, year, agegroups, region, 
                           w_lipid_poor19_age, poor19, poor32, poor55) %>% 
                    filter(is.na(dyslipid)==F) %>% 
                    filter(is.na(w_lipid_poor19_age)==F) %>%
                    mutate(psu = ifelse(is.na(psu==T), 1, psu)) %>% 
                    filter(country!='China') %>% #filter countries where sample size is too small
                    filter(country!='Indonesia') %>% 
                    filter(country!='Iran') %>% 
                    filter(country!='Romania')

#get sample size for both sexes   
    lipid_n19 <- lipid_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    lipid_n0 <- lipid_subset %>%  
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    lipid_nall <- lipid_subset %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    lipid_n <- lipid_n19 %>%
      left_join(lipid_n0) %>%
      left_join(lipid_nall)
    
#get sample size for females   
    lipid_n19.women <- lipid_subset %>% 
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    lipid_n0.women <- lipid_subset %>%  
      filter(sex==1) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    lipid_nall.women <- lipid_subset %>%
      filter(sex==1) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    lipid_n.women <- lipid_n19.women %>%
      left_join(lipid_n0.women) %>%
      left_join(lipid_nall.women)   
    
#get sample size for males   
    lipid_n19.men <- lipid_subset %>% 
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n = n())
    
    lipid_n0.men <- lipid_subset %>%  
      filter(sex==0) %>%
      select(agegroups, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(agegroups, pov_group) %>% 
      summarise(n0 = n())
    
    lipid_nall.men <- lipid_subset %>%
      filter(sex==0) %>%
      group_by(agegroups) %>%
      summarise(nall = n())
    
    lipid_n.men <- lipid_n19.men %>%
      left_join(lipid_n0.men) %>%
      left_join(lipid_nall.men) 
    
###sample sizes by regions    
    lipids_n19 <- lipid_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    lipids_n0 <- lipid_subset %>%  
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    lipids_nall <- lipid_subset %>%
      group_by(region) %>%
      summarise(nall = n())
    
    lipids_n <- lipids_n19 %>%
      left_join(lipids_n0) %>%
      left_join(lipids_nall)  
    
#get sample size for females   
    lipids_n19.women <- lipid_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    lipids_n0.women <- lipid_subset %>%  
      filter(sex==1) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    lipids_nall.women <- lipid_subset %>%
      filter(sex==1) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    lipids_n.women <- lipids_n19.women %>%
      left_join(lipids_n0.women) %>%
      left_join(lipids_nall.women)   
    
#get sample size for males   
    lipids_n19.men <- lipid_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(region, pov_group) %>% 
      summarise(n = n())
    
    lipids_n0.men <- lipid_subset %>%  
      filter(sex==0) %>%
      select(region, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(region, pov_group) %>% 
      summarise(n0 = n())
    
    lipids_nall.men <- lipid_subset %>%
      filter(sex==0) %>%
      group_by(region) %>%
      summarise(nall = n())
    
    lipids_n.men <- lipids_n19.men %>%
      left_join(lipids_n0.men) %>%
      left_join(lipids_nall.men)     
    
#add regions and income group
  CLASS <- read_excel("~/CLASS.xlsx")
  CLASS <- CLASS %>% rename(
    country = 'Economy',
    region = 'Region',
    income_group = 'Income group') %>% 
    select(country, income_group)
  
  lipid_subset <- lipid_subset %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                            ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income", income_group))))))))) 
  
#get sample sizes
    lipid_n19 <- lipid_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    lipid_n0 <- lipid_subset %>%  
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    lipid_nall <- lipid_subset %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    lipid_n <- lipid_n19 %>%
      left_join(lipid_n0) %>%
      left_join(lipid_nall)  
    
#get sample size for females   
    lipid_n19.women <- lipid_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    lipid_n0.women <- lipid_subset %>%  
      filter(sex==1) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    lipid_nall.women <- lipid_subset %>%
      filter(sex==1) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    lipid_n.women <- lipid_n19.women %>%
      left_join(lipid_n0.women) %>%
      left_join(lipid_nall.women)   
    
#get sample size for males   
    lipid_n19.men <- lipid_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(x==1) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n = n())
    
    lipid_n0.men <- lipid_subset %>%  
      filter(sex==0) %>%
      select(income_group, poor19, poor32, poor55) %>%
      pivot_longer(cols = c("poor19", "poor32", "poor55"), names_to = "pov_group", values_to = "x") %>%
      filter(pov_group=='poor55' & x==0) %>%
      group_by(income_group, pov_group) %>% 
      summarise(n0 = n())
    
    lipid_nall.men <- lipid_subset %>%
      filter(sex==0) %>%
      group_by(income_group) %>%
      summarise(nall = n())
    
    lipid_n.men <- lipid_n19.men %>%
      left_join(lipid_n0.men) %>%
      left_join(lipid_nall.men)
  
 #run survey design for each poverty group
  risk.lipid.pov19 <- lipid_subset %>% filter(poor19==1) 
  table(risk.lipid.pov19$region, risk.lipid.pov19$dyslipid) #exclude Middle East and North Africa
  risk.lipid.pov19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.pov19, nest = T)
  
  risk.lipid.pov32 <- lipid_subset %>% filter(poor32==1)
  table(risk.lipid.pov32$region, risk.lipid.pov32$dyslipid)
  risk.lipid.pov32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.pov32, nest = T)
  
  risk.lipid.pov55 <- lipid_subset %>% filter(poor55==1)
  table(risk.lipid.pov55$region, risk.lipid.pov55$dyslipid)
  risk.lipid.pov55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.pov55, nest = T)
  
  lipid_subsetpov0 <- lipid_subset %>% filter(poor55==0)
  table(lipid_subsetpov0$region, lipid_subsetpov0$dyslipid)
  risk.lipid.pov0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipid_subsetpov0, nest = T)
  
  risk.lipids.all_povgroups <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipid_subset, nest = T)
  
#get prevalences for all regions
  prev.lipid.pov19.region <- svyby(~dyslipid, by=~region, design=risk.lipid.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov19.region <- unite_ci(prev.lipid.pov19.region, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32.region <- svyby(~dyslipid, by=~region, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov32.region <- unite_ci(prev.lipid.pov32.region, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55.region <- svyby(~dyslipid, by=~region, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov55.region <- unite_ci(prev.lipid.pov55.region, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0.region <- svyby(~dyslipid, by=~region, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov0.region <- unite_ci(prev.lipid.pov0.region, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov.region <- svyby(~dyslipid, by=~region, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                      "ci")
  prev.lipid.allpov.region <- unite_ci(prev.lipid.allpov.region, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.region.all <- prev.lipid.pov19.region %>%
    left_join(prev.lipid.pov32.region) %>%
    left_join(prev.lipid.pov55.region) %>%
    left_join(prev.lipid.pov0.region) %>%
    left_join(prev.lipid.allpov.region)
  
  write.csv(prev.lipid.region.all, "~/prev.lipid.region.all.csv")
  
#get prevalences for all regions and sex
  prev.lipid.pov19.region.sex <- svyby(~dyslipid, by=~region + sex, design=risk.lipid.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.lipid.pov19.region.sex <- unite_ci(prev.lipid.pov19.region.sex, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32.region.sex <- svyby(~dyslipid, by=~region + sex, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.lipid.pov32.region.sex <- unite_ci(prev.lipid.pov32.region.sex, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55.region.sex <- svyby(~dyslipid, by=~region + sex, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.lipid.pov55.region.sex <- unite_ci(prev.lipid.pov55.region.sex, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0.region.sex <- svyby(~dyslipid, by=~region + sex, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                        "ci")
  prev.lipid.pov0.region.sex <- unite_ci(prev.lipid.pov0.region.sex, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov.region.sex <- svyby(~dyslipid, by=~region + sex, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.lipid.allpov.region.sex <- unite_ci(prev.lipid.allpov.region.sex, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.region.all.sex <- prev.lipid.pov19.region.sex %>%
    left_join(prev.lipid.pov32.region.sex) %>%
    left_join(prev.lipid.pov55.region.sex) %>%
    left_join(prev.lipid.pov0.region.sex) %>%
    left_join(prev.lipid.allpov.region.sex)
  
  write.csv(prev.lipid.region.all.sex, "~/prev.lipid.region.all.sex.csv")  
  
#get prevalences for all income groups  
  prev.lipid.pov19.incomegroup <- svyby(~dyslipid, by=~income_group, design=risk.lipid.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype 
                                          = "ci")
  prev.lipid.pov19.incomegroup <- unite_ci(prev.lipid.pov19.incomegroup, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32.incomegroup <- svyby(~dyslipid, by=~income_group, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.lipid.pov32.incomegroup <- unite_ci(prev.lipid.pov32.incomegroup, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55.incomegroup <- svyby(~dyslipid, by=~income_group, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                          "ci")
  prev.lipid.pov55.incomegroup <- unite_ci(prev.lipid.pov55.incomegroup, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0.incomegroup <- svyby(~dyslipid, by=~income_group, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                         "ci")
  prev.lipid.pov0.incomegroup <- unite_ci(prev.lipid.pov0.incomegroup, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov.incomegroup <- svyby(~dyslipid, by=~income_group, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                         vartype = "ci")
  prev.lipid.allpov.incomegroup <- unite_ci(prev.lipid.allpov.incomegroup, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.incomegroup.all <- prev.lipid.pov19.incomegroup %>%
    left_join(prev.lipid.pov32.incomegroup) %>%
    left_join(prev.lipid.pov55.incomegroup) %>%
    left_join(prev.lipid.pov0.incomegroup) %>%
    left_join(prev.lipid.allpov.incomegroup)
  
  write.csv(prev.lipid.incomegroup.all, "~/prev.lipid.incomegroup.all.csv")
  
#get prevalences for all income groups and sex
  prev.lipid.pov19.incomegroup.sex <- svyby(~dyslipid, by=~income_group + sex, design=risk.lipid.pov19, svyciprop, proportion=TRUE, 
                                              prop_method="asin", vartype = "ci")
  prev.lipid.pov19.incomegroup.sex <- unite_ci(prev.lipid.pov19.incomegroup.sex, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32.incomegroup.sex <- svyby(~dyslipid, by=~income_group + sex, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.lipid.pov32.incomegroup.sex <- unite_ci(prev.lipid.pov32.incomegroup.sex, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55.incomegroup.sex <- svyby(~dyslipid, by=~income_group + sex, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", 
                                            vartype = "ci")
  prev.lipid.pov55.incomegroup.sex <- unite_ci(prev.lipid.pov55.incomegroup.sex, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0.incomegroup.sex <- svyby(~dyslipid, by=~income_group + sex, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", 
                                           vartype = "ci")
  prev.lipid.pov0.incomegroup.sex <- unite_ci(prev.lipid.pov0.incomegroup.sex, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov.incomegroup.sex <- svyby(~dyslipid, by=~income_group + sex, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.lipid.allpov.incomegroup.sex <- unite_ci(prev.lipid.allpov.incomegroup.sex, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.incomegroup.all.sex <- prev.lipid.pov19.incomegroup.sex %>%
    left_join(prev.lipid.pov32.incomegroup.sex) %>%
    left_join(prev.lipid.pov55.incomegroup.sex) %>%
    left_join(prev.lipid.pov0.incomegroup.sex) %>%
    left_join(prev.lipid.allpov.incomegroup.sex)
  
  write.csv(prev.lipid.incomegroup.all.sex, "~/prev.lipid.incomegroup.all.sex.csv")   
  
#to get the total for all age groups
  prev.lipid.pov19 <- svyby(~dyslipid, by=~agegroups, design=risk.lipid.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov19 <- unite_ci(prev.lipid.pov19, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32 <- svyby(~dyslipid, by=~agegroups, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov32 <- unite_ci(prev.lipid.pov32, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55 <- svyby(~dyslipid, by=~agegroups, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov55 <- unite_ci(prev.lipid.pov55, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0 <- svyby(~dyslipid, by=~agegroups, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov0 <- unite_ci(prev.lipid.pov0, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov <- svyby(~dyslipid, by=~agegroups, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.allpov <- unite_ci(prev.lipid.allpov, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.lipid.agegroups <- prev.lipid.pov19 %>% 
    left_join(prev.lipid.pov32) %>% 
    left_join(prev.lipid.pov55) %>% 
    left_join(prev.lipid.pov0) %>% 
    left_join(prev.lipid.allpov)
  
#get total for each risk factor
  svymean(~dyslipid, risk.lipid.pov19, deff=TRUE)  
  confint(svymean(~dyslipid, risk.lipid.pov19, level = 0.95))  
  
  svymean(~dyslipid, risk.lipid.pov32, deff=TRUE)  
  confint(svymean(~dyslipid, risk.lipid.pov32, level = 0.95))  
  
  svymean(~dyslipid, risk.lipid.pov55, deff=TRUE)  
  confint(svymean(~dyslipid, risk.lipid.pov55, level = 0.95))  
  
  svymean(~dyslipid, risk.lipid.pov0, deff=TRUE)  
  confint(svymean(~dyslipid, risk.lipid.pov0, level = 0.95))  
  
#get the total for all age groups and sex
  prev.lipid.pov19.sex <- svyby(~dyslipid, by=~agegroups + sex, design=risk.lipid.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov19.sex <- unite_ci(prev.lipid.pov19.sex, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32.sex <- svyby(~dyslipid, by=~agegroups+ sex, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov32.sex <- unite_ci(prev.lipid.pov32.sex, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55.sex <- svyby(~dyslipid, by=~agegroups+ sex, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov55.sex <- unite_ci(prev.lipid.pov55.sex, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0.sex <- svyby(~dyslipid, by=~agegroups+ sex, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov0.sex <- unite_ci(prev.lipid.pov0.sex, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov.sex <- svyby(~dyslipid, by=~agegroups+ sex, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", 
                                 vartype = "ci")
  prev.lipid.allpov.sex <- unite_ci(prev.lipid.allpov.sex, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.agegroups.sex <- prev.lipid.pov19.sex %>% 
    left_join(prev.lipid.pov32.sex) %>% 
    left_join(prev.lipid.pov55.sex) %>% 
    left_join(prev.lipid.pov0.sex) #%>% 
    left_join(prev.lipid.allpov.sex)
    
  write.csv(prev.lipid.agegroups.sex, "~/prev.lipid.agegroups.sex.csv")
    
#to get the total for all sex
  prev.lipid.pov19.sexonly <- svyby(~dyslipid, by=~sex, design=risk.lipid.pov19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov19.sexonly <- unite_ci(prev.lipid.pov19.sexonly, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.lipid.pov32.sexonly <- svyby(~dyslipid, by=~sex, design=risk.lipid.pov32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov32.sexonly <- unite_ci(prev.lipid.pov32.sexonly, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov55.sexonly <- svyby(~dyslipid, by=~sex, design=risk.lipid.pov55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov55.sexonly <- unite_ci(prev.lipid.pov55.sexonly, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.pov0.sexonly <- svyby(~dyslipid, by=~sex, design=risk.lipid.pov0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.lipid.pov0.sexonly <- unite_ci(prev.lipid.pov0.sexonly, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.lipid.allpov.sexonly <- svyby(~dyslipid, by=~sex, design=risk.lipids.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                       "ci")
  prev.lipid.allpov.sexonly <- unite_ci(prev.lipid.allpov.sexonly, "Prev_allpov", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
  
prev.lipid.agegroups.sexonly <- prev.lipid.pov19.sexonly %>% 
    left_join(prev.lipid.pov32.sexonly) %>% 
    left_join(prev.lipid.pov55.sexonly) %>% 
    left_join(prev.lipid.pov0.sexonly) 
    
write.csv(prev.lipid.agegroups.sexonly, "~/prev.lipid.agegroups.sexonly.csv")    
    
 svymean(~dyslipid, risk.lipids.all_povgroups, deff=TRUE)  
 confint(svymean(~dyslipid, risk.lipids.all_povgroups, level = 0.95))  
 
###combine prevalence by agegroups in excel and bring merged table for agegroup prevalences into right format
  prev.agegroups.comb <- read.csv("~/Prevalences Agegroups - all(1).csv", stringsAsFactors=F)
  prev.agegroups.comb <- prev.agegroups.comb %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(hypt19 = as.numeric(hypt19),
             cil_hypt19 = as.numeric(cil_hypt19),
            ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(dia19 = as.numeric(dia19),
             cil_dia19 = as.numeric(cil_dia19),
             ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(overw19 = as.numeric(overw19),
             cil_overw19 = as.numeric(cil_overw19),
             ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(obese19 = as.numeric(obese19),
             cil_obese19 = as.numeric(cil_obese19),
             ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(smoke19 = as.numeric(smoke19),
             cil_smoke19 = as.numeric(cil_smoke19),
             ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate( lipids19 = as.numeric(lipids19),
             cil_lipids19 = as.numeric(cil_lipids19),
             ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
#append    
prev.agegroups.comb <- prev.agegroups.comb %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   

###bring merged table for agegroup prevalences and men into right format
  prev.agegroups.comb <- read.csv("~/Prevalences agegroups and sex - Males.csv", stringsAsFactors=F)
  prev.agegroups.comb <- prev.agegroups.comb %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(overw19 = as.numeric(overw19),
            cil_overw19 = as.numeric(cil_overw19),
            ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(obese19 = as.numeric(obese19),
            cil_obese19 = as.numeric(cil_obese19),
            ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(smoke19 = as.numeric(smoke19),
             cil_smoke19 = as.numeric(cil_smoke19),
             ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(lipids19 = as.numeric(lipids19),
            cil_lipids19 = as.numeric(cil_lipids19),
            ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
 
#append       
    prev.agegroups.comb <- prev.agegroups.comb %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   

##bring merged table for agegroup prevalences and women into right format
  prev.agegroups.comb <- read.csv("~/Prevalences agegroups and sex - Females.csv", stringsAsFactors=F)
  prev.agegroups.comb <- prev.agegroups.comb %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(hypt19 = as.numeric(hypt19),
             cil_hypt19 = as.numeric(cil_hypt19),
             ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(dia19 = as.numeric(dia19),
             cil_dia19 = as.numeric(cil_dia19),
             ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>%
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(overw19 = as.numeric(overw19),
             cil_overw19 = as.numeric(cil_overw19),
             ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(obese19 = as.numeric(obese19),
              cil_obese19 = as.numeric(cil_obese19),
              ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.agegroups.comb$V2  <- gsub("[()]", "", prev.agegroups.comb$V2 )
    prev.agegroups.comb <- tidyr::separate(prev.agegroups.comb, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.agegroups.comb <- prev.agegroups.comb %>% 
      mutate(lipids19 = as.numeric(lipids19),
            cil_lipids19 = as.numeric(cil_lipids19),
            ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
#append
    prev.agegroups.comb <- prev.agegroups.comb %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19) 


###format for region prevalence
  prev.region.comb <- read.csv("~/by regions - all(1).csv", stringsAsFactors=F)
  prev.region.comb <- prev.region.comb %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.region.comb <- tidyr::separate(prev.region.comb, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb$V2  <- gsub("[()]", "", prev.region.comb$V2 )
    prev.region.comb <- tidyr::separate(prev.region.comb, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.region.comb <- prev.region.comb %>% 
      mutate(hypt19 = as.numeric(hypt19),
             cil_hypt19 = as.numeric(cil_hypt19),
             ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.region.comb <- tidyr::separate(prev.region.comb, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb$V2  <- gsub("[()]", "", prev.region.comb$V2 )
    prev.region.comb <- tidyr::separate(prev.region.comb, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.region.comb <- prev.region.comb %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.region.comb <- tidyr::separate(prev.region.comb, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb$V2  <- gsub("[()]", "", prev.region.comb$V2 )
    prev.region.comb <- tidyr::separate(prev.region.comb, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.region.comb <- prev.region.comb %>% 
      mutate( overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.region.comb <- tidyr::separate(prev.region.comb, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb$V2  <- gsub("[()]", "", prev.region.comb$V2 )
    prev.region.comb <- tidyr::separate(prev.region.comb, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.region.comb <- prev.region.comb %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.region.comb <- tidyr::separate(prev.region.comb, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb$V2  <- gsub("[()]", "", prev.region.comb$V2 )
    prev.region.comb <- tidyr::separate(prev.region.comb, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.region.comb <- prev.region.comb %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.region.comb <- tidyr::separate(prev.region.comb, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb$V2  <- gsub("[()]", "", prev.region.comb$V2 )
    prev.region.comb <- tidyr::separate(prev.region.comb, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.region.comb <- prev.region.comb %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
    prev.region.comb <- prev.region.comb %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   

##bring merged table for agegroup prevalences and men into right format
  prev.region.comb.men <- read.csv("~/by region and sex - Males.csv", stringsAsFactors=F)
  prev.region.comb.men <- prev.region.comb.men %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.men$V2  <- gsub("[()]", "", prev.region.comb.men$V2 )
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.region.comb.men <- prev.region.comb.men %>% 
      mutate(hypt19 = as.numeric(hypt19),
             cil_hypt19 = as.numeric(cil_hypt19),
             ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.men$V2  <- gsub("[()]", "", prev.region.comb.men$V2 )
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.region.comb.men <- prev.region.comb.men %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.men$V2  <- gsub("[()]", "", prev.region.comb.men$V2 )
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.region.comb.men <- prev.region.comb.men %>% 
      mutate( overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.men$V2  <- gsub("[()]", "", prev.region.comb.men$V2 )
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.region.comb.men <- prev.region.comb.men %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.men$V2  <- gsub("[()]", "", prev.region.comb.men$V2 )
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.region.comb.men <- prev.region.comb.men %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.men$V2  <- gsub("[()]", "", prev.region.comb.men$V2 )
    prev.region.comb.men <- tidyr::separate(prev.region.comb.men, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.region.comb.men <- prev.region.comb.men %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
  
  prev.region.comb.men <- prev.region.comb.men %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   

##bring merged table for agegroup prevalences and women into right format
  prev.region.comb.women <- read.csv("~/by region and sex - Females.csv", stringsAsFactors=F)
  prev.region.comb.women <- prev.region.comb.women %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.women$V2  <- gsub("[()]", "", prev.region.comb.women$V2 )
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.region.comb.women <- prev.region.comb.women %>% 
      mutate(hypt19 = as.numeric(hypt19),
             cil_hypt19 = as.numeric(cil_hypt19),
             ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.women$V2  <- gsub("[()]", "", prev.region.comb.women$V2 )
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.region.comb.women <- prev.region.comb.women %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.women$V2  <- gsub("[()]", "", prev.region.comb.women$V2 )
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.region.comb.women <- prev.region.comb.women %>% 
      mutate( overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.women$V2  <- gsub("[()]", "", prev.region.comb.women$V2 )
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.region.comb.women <- prev.region.comb.women %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.women$V2  <- gsub("[()]", "", prev.region.comb.women$V2 )
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.region.comb.women <- prev.region.comb.women %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.region.comb.women$V2  <- gsub("[()]", "", prev.region.comb.women$V2 )
    prev.region.comb.women <- tidyr::separate(prev.region.comb.women, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.region.comb.women <- prev.region.comb.women %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
    prev.region.comb.women <- prev.region.comb.women %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19) 

### format for income group prevalences
  prev.incomegroup.comb <- read.csv("~/by income group - all(1).csv", stringsAsFactors=F)
  prev.incomegroup.comb <- prev.incomegroup.comb %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb$V2  <- gsub("[()]", "", prev.incomegroup.comb$V2 )
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.incomegroup.comb <- prev.incomegroup.comb %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb$V2  <- gsub("[()]", "", prev.incomegroup.comb$V2 )
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.incomegroup.comb <- prev.incomegroup.comb %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb$V2  <- gsub("[()]", "", prev.incomegroup.comb$V2 )
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.incomegroup.comb <- prev.incomegroup.comb %>% 
      mutate(overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb$V2  <- gsub("[()]", "", prev.incomegroup.comb$V2 )
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.incomegroup.comb <- prev.incomegroup.comb %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb$V2  <- gsub("[()]", "", prev.incomegroup.comb$V2 )
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.incomegroup.comb <- prev.incomegroup.comb %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb$V2  <- gsub("[()]", "", prev.incomegroup.comb$V2 )
    prev.incomegroup.comb <- tidyr::separate(prev.incomegroup.comb, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.incomegroup.comb <- prev.incomegroup.comb %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
    prev.incomegroup.comb <- prev.incomegroup.comb %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   

##bring merged table for agegroup prevalences and men into right format
    prev.incomegroup.comb.men <- read.csv("~/by income group and sex - Males.csv", stringsAsFactors=F)
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.men$V2  <- gsub("[()]", "", prev.incomegroup.comb.men$V2 )
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.men$V2  <- gsub("[()]", "", prev.incomegroup.comb.men$V2 )
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.men$V2  <- gsub("[()]", "", prev.incomegroup.comb.men$V2 )
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% 
      mutate(overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.men$V2  <- gsub("[()]", "", prev.incomegroup.comb.men$V2 )
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.men$V2  <- gsub("[()]", "", prev.incomegroup.comb.men$V2 )
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.men$V2  <- gsub("[()]", "", prev.incomegroup.comb.men$V2 )
    prev.incomegroup.comb.men <- tidyr::separate(prev.incomegroup.comb.men, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
  prev.incomegroup.comb.men <- prev.incomegroup.comb.men %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   


##bring merged table for agegroup prevalences and women into right format
    prev.incomegroup.comb.women <- read.csv("~/by income group and sex - Females(1).csv", stringsAsFactors=F)
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% select(Hypertension, Diabetes, Overweight, Obesity, Smoking, Dyslipidemia) 

#Hypertension
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, Hypertension, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.women$V2  <- gsub("[()]", "", prev.incomegroup.comb.women$V2 )
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, V2, c("cil_hypt19", "ciu_hypt19"), "\\-") 
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#Diabetes
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, Diabetes, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.women$V2  <- gsub("[()]", "", prev.incomegroup.comb.women$V2 )
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, V2, c("cil_dia19", "ciu_dia19"), "\\-") 
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))  
    
#Overweight
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, Overweight, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.women$V2  <- gsub("[()]", "", prev.incomegroup.comb.women$V2 )
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, V2, c("cil_overw19", "ciu_overw19"), "\\-") 
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% 
      mutate(overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#Obesity
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, Obesity, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.women$V2  <- gsub("[()]", "", prev.incomegroup.comb.women$V2 )
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, V2, c("cil_obese19", "ciu_obese19"), "\\-") 
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#Smoking
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, Smoking, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.women$V2  <- gsub("[()]", "", prev.incomegroup.comb.women$V2 )
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, V2, c("cil_smoke19", "ciu_smoke19"), "\\-") 
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
#Lipids
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, Dyslipidemia, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.incomegroup.comb.women$V2  <- gsub("[()]", "", prev.incomegroup.comb.women$V2 )
    prev.incomegroup.comb.women <- tidyr::separate(prev.incomegroup.comb.women, V2, c("cil_lipids19", "ciu_lipids19"), "\\-") 
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
    prev.incomegroup.comb.women <- prev.incomegroup.comb.women %>% select(hypt19, dia19, overw19, obese19, smoke19, lipids19)   
  
```

```{r Prevalences: country level}

#before calculating prevalences we need to check whether we have a big enough sample in each country, because country prevalence is only calculated when we have at least 20 people with risk factor or 100 people for whom risk factor was collected

###1) HYPERTENSION 
  
#surveydesign for poor19
    risk.hypt.country.poor19 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% filter(poor19==1)
    risk.hypt.country.poor19 <- risk.hypt.country.poor19 %>% 
      filter(country!='Albania') %>%
      filter(country!='Bhutan') %>%
      filter(country!='Iran') %>%
      filter(country!='Jordan') %>%
      filter(country!='Romania') %>%
      filter(country!='Samoa') %>%
      filter(country!='Tajikistan') %>%
      filter(country!='Tonga') %>%
      filter(country!='Tuvalu') %>%
      filter(country!='Tonga') %>%
      filter(country!='Cabo Verde') %>%
      filter(country!='Kyrgyz Republic') %>%
      filter(country!='Mongolia')

    risk.hypt.country.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.country.poor19, nest = T)
    
#surveydesign for poor32
    risk.hypt.country.poor32 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% 
      filter(poor32==1) %>% 
      filter(country!='Tuvalu')
    
    risk.hypt.country.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.country.poor32, nest = T)
    
#surveydesign for poor55
    risk.hypt.country.poor55 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% filter(poor55==1)
    risk.hypt.country.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.country.poor55, nest = T)
    
#surveydesign for nonpoor
    risk.hypt.country.poor0 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% 
      filter(poor55==0)%>% 
      filter(country!='Malawi') %>%
      filter(country!='Liberia') %>%
      filter(country!='Mozambique') %>%
      filter(country!='Niger') 
    
    risk.hypt.country.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.country.poor0, nest = T)
    
#surveydesign for all
    risk.hypt.country.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_subset, nest = T)
  
###country prevalences for all 
    prev.hypt.all <- svyby(~all_hypt, by=~country, design=risk.hypt.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.hypt.all <- unite_ci(prev.hypt.all, "Prev_poorall", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)   
    
  #country prevalences for poor19  
    prev.hypt.poor19 <- svyby(~all_hypt, by=~country, design=risk.hypt.country.poor19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.hypt.poor19 <- unite_ci(prev.hypt.poor19, "Prev_poor19", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)    
    
  #country prevalences for poor32  
    prev.hypt.poor32 <- svyby(~all_hypt, by=~country, design=risk.hypt.country.poor32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.hypt.poor32 <- unite_ci(prev.hypt.poor32, "Prev_poor32", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor55 
    prev.hypt.poor55 <- svyby(~all_hypt, by=~country, design=risk.hypt.country.poor55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.hypt.poor55 <- unite_ci(prev.hypt.poor55, "Prev_poor55", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor0  
    prev.hypt.poor0 <- svyby(~all_hypt, by=~country, design=risk.hypt.country.poor0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.hypt.poor0 <- unite_ci(prev.hypt.poor0, "Prev_poor0", all_hypt, ci_l, ci_u, m100 = T, percent = FALSE)     
    
#merge
    prev.hypt.country <- prev.hypt.all %>%
      left_join(prev.hypt.poor19) %>%
      left_join(prev.hypt.poor32) %>%
      left_join(prev.hypt.poor55) %>%
      left_join(prev.hypt.poor0) 
      
    write.csv(prev.hypt.country, "~/prev.hypt.country.csv") 
    
#format and append 
    prev.hypt.all <- tidyr::separate(prev.hypt.all, Prev_poorall, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.all$V2  <- gsub("[()]", "", prev.hypt.all$V2 )
    prev.hypt.all <- tidyr::separate(prev.hypt.all, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.hypt.all <- prev.hypt.all %>% 
      mutate(hypt19 = as.numeric(hypt19),
             cil_hypt19 = as.numeric(cil_hypt19),
             ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep="")) %>%
      select(country, hypt19)
    
    prev.countries <- read.csv("~/prev.countries - country.list.csv", stringsAsFactors=F)
    prev.hypt.all <- prev.countries %>%
      left_join(prev.hypt.all)
    
#do this manually for Mexico  
    
#poor19
    hypt.mexico19 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% filter(poor19==1)
    hypt.mexico19 <- filter(hypt.mexico19, country=='Mexico')
    risk.hypt.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt.mexico19, nest = T)
    svymean(~all_hypt, risk.hypt.mexico19, deff=TRUE)
    confint(svymean(~all_hypt, risk.hypt.mexico19, level = 0.95))
    
#poor32
    hypt.mexico32 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% filter(poor32==1)
    hypt.mexico32 <- filter(hypt.mexico32, country=='Mexico')
    risk.hypt.mexico32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt.mexico32, nest = T)
    svymean(~all_hypt, risk.hypt.mexico32, deff=TRUE)
    confint(svymean(~all_hypt, risk.hypt.mexico32, level = 0.95))
    
#poor55
    hypt.mexico55 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% filter(poor55==1)
    hypt.mexico55 <- filter(hypt.mexico55, country=='Mexico')
    risk.hypt.mexico55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt.mexico55, nest = T)
    svymean(~all_hypt, risk.hypt.mexico55, deff=TRUE)
    confint(svymean(~all_hypt, risk.hypt.mexico55, level = 0.95))
    
#poor0
    hypt.mexico0 <- filter(hypt_subset, is.na(w_hypt_poor19_age)==F) %>% filter(poor55==0)
    hypt.mexico0 <- filter(hypt.mexico0, country=='Mexico')
    risk.hypt.mexico0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt.mexico0, nest = T)
    svymean(~all_hypt, risk.hypt.mexico0, deff=TRUE)
    confint(svymean(~all_hypt, risk.hypt.mexico0, level = 0.95))
    
#all
    hypt.mexico19 <- filter(hypt_subset, country=='Mexico')
    risk.hypt.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt.mexico19, nest = T)
    svymean(~all_hypt, risk.hypt.mexico19, deff=TRUE)
    confint(svymean(~all_hypt, risk.hypt.mexico19, level = 0.95))

###2) DIABETES   

#surveydesign for poor19
    risk.dia.country.poor19 <- filter(dia_subset, is.na(w_dia_poor19_age)==F) %>% filter(poor19==1)
    risk.dia.country.poor19 <- risk.dia.country.poor19 %>% 
      filter(country!='Bhutan') %>%
      filter(country!='Botswana') %>%
      filter(country!='Malawi') %>%
      filter(country!='Cabo Verde') %>%
      filter(country!='Comoros') %>%
      filter(country!='Ecuador') %>%
      filter(country!='Georgia') %>%
      filter(country!='Iran') %>%
      filter(country!='Jordan') %>%
      filter(country!='Kiribati') %>%
      filter(country!='Kyrgyz Republic') %>%
      filter(country!='Laos') %>%
      filter(country!='Mongolia') %>%
      filter(country!='Mozambique') %>%
      filter(country!='Myanmar') %>%
      filter(country!='Namibia') %>%
      filter(country!='Romania') %>%
      filter(country!='Samoa') %>%
      filter(country!='Tajikistan') %>%
      filter(country!='Tuvalu') %>%
      filter(country!='Uganda') 
    
    risk.dia.country.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.country.poor19, nest = T)
    
#surveydesign for poor32
    risk.dia.country.poor32 <- filter(dia.prev, is.na(w_dia_poor19_age)==F) %>% filter(poor32==1)
    risk.dia.country.poor32 <- risk.dia.country.poor32 %>% 
      filter(country!='Bhutan') %>%
      filter(country!='Cabo Verde') %>%
      filter(country!='Comoros') %>%
      filter(country!='Jordan') %>%
      filter(country!='Mongolia') %>%
      filter(country!='Romania') %>%
      filter(country!='Tajikistan') %>%
      filter(country!='Tuvalu') %>%
      filter(country!='Uganda') %>%
      filter(country!='Tuvalu') 
      
    risk.dia.country.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.country.poor32, nest = T)
    
#surveydesign for poor55
    risk.dia.country.poor55 <- filter(dia.prev, is.na(w_dia_poor19_age)==F) %>% filter(poor55==1)
    risk.dia.country.poor55 <- risk.dia.country.poor55 %>% 
      filter(country!='Tuvalu') %>%
      filter(country!='Uganda') 
      
    risk.dia.country.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.country.poor55, nest = T)
    
#surveydesign for nonpoor
    risk.dia.country.poor0 <- filter(dia.prev, is.na(w_dia_poor19_age)==F) %>% filter(poor55==0)
    risk.dia.country.poor0 <- risk.dia.country.poor0 %>% 
      filter(country!='Cabo Verde') %>%
      filter(country!='Kenya') %>%
      filter(country!='Liberia') %>%
      filter(country!='Mozambique') %>%
      filter(country!='Niger') %>%
      filter(country!='Rwanda') %>%
      filter(country!='Sao Tome and Principe') %>%
      filter(country!='Solomon Islands') %>%
      filter(country!='Tajikistan') %>%
      filter(country!='Timor Leste') %>%
      filter(country!='Togo') %>%
      filter(country!='Uganda') %>%
      filter(country!='Zambia') %>%
      filter(country!='Tanzania') %>%
      filter(country!='Zanzibar') 
    
    risk.dia.country.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.country.poor0, nest = T)   
  
#surveydesign for all
    risk.dia.country.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia.prev, nest = T)
  
#country prevalence for all 
    prev.dia.all <- svyby(~all_dia, by=~country, design=risk.dia.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.dia.all <- unite_ci(prev.dia.all, "Prev_poorall", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)      
    
  #country prevalences for poor19  
    prev.dia.poor19 <- svyby(~all_dia, by=~country, design=risk.dia.country.poor19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.dia.poor19 <- unite_ci(prev.dia.poor19, "Prev_poor19", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)    
    
  #country prevalences for poor32  
    prev.dia.poor32 <- svyby(~all_dia, by=~country, design=risk.dia.country.poor32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.dia.poor32 <- unite_ci(prev.dia.poor32, "Prev_poor32", all_dia, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor55 
    prev.dia.poor55 <- svyby(~all_dia, by=~country, design=risk.dia.country.poor55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.dia.poor55 <- unite_ci(prev.dia.poor55, "Prev_poor55", all_dia, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor19  
    prev.dia.poor0 <- svyby(~all_dia, by=~country, design=risk.dia.country.poor0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.dia.poor0 <- unite_ci(prev.dia.poor0, "Prev_poor0", all_dia, ci_l, ci_u, m100 = T, percent = FALSE)     
    
#merge
    prev.dia.country <- prev.dia.poor55 %>%
      left_join(prev.dia.poor32) %>%
      left_join(prev.dia.poor19) %>%
      left_join(prev.dia.poor0) 
      
    write.csv(prev.dia.country, "~/prev.dia.country.csv") 
    
#format    
    prev.dia.all <- tidyr::separate(prev.dia.all, Prev_poorall, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.dia.all$V2  <- gsub("[()]", "", prev.dia.all$V2 )
    prev.dia.all <- tidyr::separate(prev.dia.all, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.dia.all <- prev.dia.all %>% 
      mutate(hypt19 = as.numeric(hypt19),
            cil_hypt19 = as.numeric(cil_hypt19),
            ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep="")) %>%
      select(country, hypt19)
    
    prev.countries <- read.csv("~/prev.countries - country.list.csv", stringsAsFactors=F)
    prev.dia.all <- prev.countries %>%
      left_join(prev.dia.all)
  
#Mexico  
    
#poor19
    dia.mexico19 <- filter(dia_subset, is.na(w_dia_poor19_age)==F) %>% filter(poor19==1)
    dia.mexico19 <- filter(dia.mexico19, country=='Mexico')
    risk.dia.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia.mexico19, nest = T)
    svymean(~all_dia, risk.dia.mexico19, deff=TRUE)
    confint(svymean(~all_dia, risk.dia.mexico19, level = 0.95))
    
#poor32
    dia.mexico32 <- filter(dia_subset, is.na(w_dia_poor19_age)==F) %>% filter(poor32==1)
    dia.mexico32 <- filter(dia.mexico32, country=='Mexico')
    risk.dia.mexico32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia.mexico32, nest = T)
    svymean(~all_dia, risk.dia.mexico32, deff=TRUE)
    confint(svymean(~all_dia, risk.dia.mexico32, level = 0.95))
    
#poor55
    dia.mexico55 <- filter(dia_subset, is.na(w_dia_poor19_age)==F) %>% filter(poor55==1)
    dia.mexico55 <- filter(dia.mexico55, country=='Mexico')
    risk.dia.mexico55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia.mexico55, nest = T)
    svymean(~all_dia, risk.dia.mexico55, deff=TRUE)
    confint(svymean(~all_dia, risk.dia.mexico55, level = 0.95))
    
#poor0
    dia.mexico0 <- filter(dia_subset, is.na(w_dia_poor19_age)==F) %>% filter(poor55==0)
    dia.mexico0 <- filter(dia.mexico0, country=='Mexico')
    risk.dia.mexico0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia.mexico0, nest = T)
    svymean(~all_dia, risk.dia.mexico0, deff=TRUE)
    confint(svymean(~all_dia, risk.dia.mexico0, level = 0.95))
    
#all
    dia.mexico19 <- filter(dia_subset, country=='Mexico')
    risk.dia.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia.mexico19, nest = T)
    svymean(~all_dia, risk.dia.mexico19, deff=TRUE)
    confint(svymean(~all_dia, risk.dia.mexico19, level = 0.95))
    
    
###3) OVERWEIGHT  
    
#surveydesign for poor19
    risk.overw.country.poor19 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor19==1)
    risk.overw.country.poor19 <- risk.overw.country.poor19 %>% 
          filter(country!='Bhutan') %>%
          filter(country!='Bhutan') %>%
          filter(country!='Jordan') %>%
          filter(country!='Mongolia') %>%
          filter(country!='Samoa') %>%
          filter(country!='Turkey') %>%
          filter(country!='Armenia') %>%
          filter(country!='Cabo Verde') %>%
          filter(country!='Dominican Republic') %>%
          filter(country!='Gabon') %>%
          filter(country!='Iran') %>%
          filter(country!='Romania') %>%
          filter(country!='Tonga') %>%
          filter(country!='Tuvalu')

    risk.overw.country.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.country.poor19, nest = T)
    
#surveydesign for poor32
    risk.overw.country.poor32 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor32==1)
    risk.overw.country.poor32 <- risk.overw.country.poor32 %>% 
      filter(country!='Tuvalu') 
    risk.overw.country.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.country.poor32, nest = T)
    
#surveydesign for poor55
    risk.overw.country.poor55 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor55==1)
    risk.overw.country.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.country.poor55, nest = T)
    
#surveydesign for nonpoor
    risk.overw.country.poor0 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor55==0)
    risk.overw.country.poor0 <- risk.overw.country.poor0 %>% 
      filter(country!='Liberia') 
    risk.overw.country.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=risk.overw.country.poor0, nest = T) 
    
#surveydesign for all
    risk.overw.country.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw.prev, nest = T)
  
#country prevalences for all 
   prev.overw.all <- svyby(~overweight, by=~country, design=risk.overw.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
   prev.overw.all <- unite_ci(prev.overw.all, "Prev_poorall", overweight, ci_l, ci_u, m100 = T, percent = FALSE)      
    
  #country prevalences for poor19  
    prev.overw.poor19 <- svyby(~overweight, by=~country, design=risk.overw.country.poor19, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                 "ci")
    prev.overw.poor19 <- unite_ci(prev.overw.poor19, "Prev_poor19", overweight, ci_l, ci_u, m100 = T, percent = FALSE)    
    
  #country prevalences for poor32  
    prev.overw.poor32 <- svyby(~overweight, by=~country, design=risk.overw.country.poor32, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                 "ci")
    prev.overw.poor32 <- unite_ci(prev.overw.poor32, "Prev_poor32", overweight, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor55 
    prev.overw.poor55 <- svyby(~overweight, by=~country, design=risk.overw.country.poor55, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                 "ci")
    prev.overw.poor55 <- unite_ci(prev.overw.poor55, "Prev_poor55", overweight, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor0 
    prev.overw.poor0 <- svyby(~overweight, by=~country, design=risk.overw.country.poor0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.overw.poor0 <- unite_ci(prev.overw.poor0, "Prev_poor0", overweight, ci_l, ci_u, m100 = T, percent = FALSE)     
    
#merge
    prev.overw.country <- prev.overw.poor55 %>%
      left_join(prev.overw.poor32) %>%
      left_join(prev.overw.poor19) %>%
      left_join(prev.overw.poor0) %>%  
      
    write.csv(prev.overw.country, "~/prev.overw.country.csv")     
 
#format    
    prev.overw.all <- tidyr::separate(prev.overw.all,Prev_poorall, c("hypt19", "V2"), "\\s(?:.+\\s)?")  
    prev.overw.all$V2  <- gsub("[()]", "", prev.overw.all$V2 )
    prev.overw.all <- tidyr::separate(prev.overw.all, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.overw.all <- prev.overw.all %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep="")) %>%
      select(country, hypt19)
    
    prev.countries <- read.csv("~/prev.countries - country.list.csv", stringsAsFactors=F)
    prev.overw.all <- prev.countries %>%
      left_join(prev.overw.all)
    write.csv(prev.overw.all, "~/prev.overw.all.csv")  
        
#Mexico  
    
#poor19
    overw.mexico19 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor19==1)
    overw.mexico19 <- filter(overw.mexico19, country=='Mexico')
    risk.overw.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw.mexico19, nest = T)
    svymean(~overweight, risk.overw.mexico19, deff=TRUE)
    confint(svymean(~overweight, risk.overw.mexico19, level = 0.95))
    
#poor32
    overw.mexico32 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor32==1)
    overw.mexico32 <- filter(overw.mexico32, country=='Mexico')
    risk.overw.mexico32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw.mexico32, nest = T)
    svymean(~overweight, risk.overw.mexico32, deff=TRUE)
    confint(svymean(~overweight, risk.overw.mexico32, level = 0.95))
    
#poor55
    overw.mexico55 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor55==1)
    overw.mexico55 <- filter(overw.mexico55, country=='Mexico')
    risk.overw.mexico55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw.mexico55, nest = T)
    svymean(~overweight, risk.overw.mexico55, deff=TRUE)
    confint(svymean(~overweight, risk.overw.mexico55, level = 0.95))
    
#poor0
    overw.mexico0 <- filter(overw_subset, is.na(w_overw_poor19_age)==F) %>% filter(poor55==0)
    overw.mexico0 <- filter(overw.mexico0, country=='Mexico')
    risk.overw.mexico0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw.mexico0, nest = T)
    svymean(~overweight, risk.overw.mexico0, deff=TRUE)
    confint(svymean(~overweight, risk.overw.mexico0, level = 0.95))
    
#all
    overw.mexico19 <- filter(overw_subset, country=='Mexico')
    risk.overw.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_overw_poor19_age, data=overw.mexico19, nest = T)
    svymean(~overweight, risk.overw.mexico19, deff=TRUE)
    confint(svymean(~overweight, risk.overw.mexico19, level = 0.95))
    
###4) OBESITY 
  obese_subset <- read.csv("~/obese_subset.csv", stringsAsFactors=F)
    
#surveydesign for poor19
  risk.obese.country.poor19 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor19==1)
  risk.obese.country.poor19 <- risk.obese.country.poor19 %>% 
          filter(country!='Armenia') %>%
          filter(country!='Armenia') %>%
          filter(country!='Bhutan') %>%
          filter(country!='Burundi') %>%
          filter(country!='Cabo Verde') %>%
          filter(country!='Dominican Republic') %>%
          filter(country!='Gabon') %>%
          filter(country!='Ghana') %>%
          filter(country!='Iran') %>%
          filter(country!='Jordan') %>%
          filter(country!='Laos') %>%
          filter(country!='Mongolia') %>%
          filter(country!='Myanmar') %>%
          filter(country!='Pakistan') %>%
          filter(country!='Romania') %>%
          filter(country!='Samoa') %>%
          filter(country!='Tajikistan') %>%
          filter(country!='Timor Leste') %>%
          filter(country!='Turkey') %>%
          filter(country!='Tuvalu') %>%
          filter(country!='Tonga')
        
  risk.obese.country.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.country.poor19, nest = T)
    
#surveydesign for poor32
    risk.obese.country.poor32 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor32==1)
    risk.obese.country.poor32 <- risk.obese.country.poor32 %>% 
          filter(country!='Tuvalu') 
          
    risk.obese.country.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.country.poor32, nest = T)
    
#surveydesign for poor55
    risk.obese.country.poor55 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor55==1)
    risk.obese.country.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.country.poor55, nest = T)
    
#surveydesign for nonpoor
    risk.obese.country.poor0 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor55==0)
    risk.obese.country.poor0 <- risk.obese.country.poor0 %>% 
      filter(country!='Liberia')

    risk.obese.country.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=risk.obese.country.poor0, nest = T) 

#surveydesign for all
    risk.obese.country.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=obese.prev, nest = T)
  
###country prevalences for all 
   prev.obese.all <- svyby(~obese, by=~country, design=risk.obese.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
   prev.obese.all <- unite_ci(prev.obese.all, "Prev_poorall", obese, ci_l, ci_u, m100 = T, percent = FALSE)         
    
  #country prevalences for poor19  
    prev.obese.poor19 <- svyby(~obese, by=~country, design=risk.obese.country.poor19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.obese.poor19 <- unite_ci(prev.obese.poor19, "Prev_poor19", obese, ci_l, ci_u, m100 = T, percent = FALSE)    
    
  #country prevalences for poor32  
    prev.obese.poor32 <- svyby(~obese, by=~country, design=risk.obese.country.poor32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.obese.poor32 <- unite_ci(prev.obese.poor32, "Prev_poor32", obese, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor55 
    prev.obese.poor55 <- svyby(~obese, by=~country, design=risk.obese.country.poor55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.obese.poor55 <- unite_ci(prev.obese.poor55, "Prev_poor55", obese, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor19  
    prev.obese.poor0 <- svyby(~obese, by=~country, design=risk.obese.country.poor0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.obese.poor0 <- unite_ci(prev.obese.poor0, "Prev_poor0", obese, ci_l, ci_u, m100 = T, percent = FALSE)     
    
#merge
    prev.obese.country <- prev.obese.poor55 %>%
      left_join(prev.obese.poor32) %>%
      left_join(prev.obese.poor19) %>%
      left_join(prev.obese.poor0) 
      
    write.csv(prev.obese.country, "~/prev.obese.country.csv")     

#format    
    prev.obese.all <- tidyr::separate(prev.obese.all,Prev_poorall, c("hypt19", "V2"), "\\s(?:.+\\s)?")  
    prev.obese.all$V2  <- gsub("[()]", "", prev.obese.all$V2 )
    prev.obese.all <- tidyr::separate(prev.obese.all, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.obese.all <- prev.obese.all %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep="")) %>%
      select(country, hypt19)
    
    prev.countries <- read.csv("~/prev.countries - country.list.csv", stringsAsFactors=F)
    prev.obese.all <- prev.countries %>%
      left_join(prev.obese.all)
    write.csv(prev.obese.all, "~/prev.obese.all.csv")         

###Mexico   
    
#poor19
    obese.mexico19 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor19==1)
    obese.mexico19 <- filter(obese.mexico19, country=='Mexico')
    risk.obese.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=obese.mexico19, nest = T)
    svymean(~obese, risk.obese.mexico19, deff=TRUE)
    confint(svymean(~obese, risk.obese.mexico19, level = 0.95))
    
#poor32
    obese.mexico32 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor32==1)
    obese.mexico32 <- filter(obese.mexico32, country=='Mexico')
    risk.obese.mexico32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=obese.mexico32, nest = T)
    svymean(~obese, risk.obese.mexico32, deff=TRUE)
    confint(svymean(~obese, risk.obese.mexico32, level = 0.95))
    
#poor55
    obese.mexico55 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor55==1)
    obese.mexico55 <- filter(obese.mexico55, country=='Mexico')
    risk.obese.mexico55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=obese.mexico55, nest = T)
    svymean(~obese, risk.obese.mexico55, deff=TRUE)
    confint(svymean(~obese, risk.obese.mexico55, level = 0.95))
    
#poor0
    obese.mexico0 <- filter(obese_subset, is.na(w_obese_poor19_age)==F) %>% filter(poor55==0)
    obese.mexico0 <- filter(obese.mexico0, country=='Mexico')
    risk.obese.mexico0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=obese.mexico0, nest = T)
    svymean(~obese, risk.obese.mexico0, deff=TRUE)
    confint(svymean(~obese, risk.obese.mexico0, level = 0.95))
    
#all
    obese.mexico19 <- filter(obese_subset, country=='Mexico')
    risk.obese.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_obese_poor19_age, data=obese.mexico19, nest = T)
    svymean(~obese, risk.obese.mexico19, deff=TRUE)
    confint(svymean(~obese, risk.obese.mexico19, level = 0.95))
 
###5) SMOKING  
  smoke_subset <- read.csv("~/smoke_subset.csv", stringsAsFactors=F)
  
  smoke.prev <- smoke_subset %>% 
            filter(country!='Albania') %>%         
             filter(country!='Armenia') %>% 
             filter(country!='Burundi') %>% 
             filter(country!='Comoros') %>% 
             filter(country!='Guatemala') %>% 
             filter(country!='Haiti') %>% 
             filter(country!='Honduras') %>% 
             filter(country!='Kenya') %>% 
             filter(country!='Nigeria') %>% 
             filter(country!='Pakistan') %>% 
             filter(country!='South Africa') %>% 
             filter(country!='Tajikistan') %>% 
             filter(country!='Tanzania') %>% 
             filter(country!='Timor Leste') %>% 
             filter(country!='Burkina Faso') %>% 
             filter(country!='Uganda')

  write.csv(smoke.prev, "~/smoke.prev.csv") 
           
#surveydesign for poor19
    risk.smoke.country.poor19 <- filter(smoke.prev, is.na(w_smoke_poor19_age)==F) %>% filter(poor19==1)
    risk.smoke.country.poor19 <- risk.smoke.country.poor19 %>% 
      filter(country!='Armenia') %>%
      filter(country!='Bhutan') %>%
      filter(country!='Burkina Faso') %>%
      filter(country!='Cabo Verde') %>%
      filter(country!='Cameroon') %>%
      filter(country!='Costa Rica') %>%
      filter(country!='Dominican Republic') %>%
      filter(country!='Ecuador') %>%
      filter(country!='Guinea') %>%
      filter(country!='Iran') %>%
      filter(country!='Jordan') %>%
      filter(country!='Mongolia') %>%
      filter(country!='Romania') %>%
      filter(country!='Samoa') %>%
      filter(country!='Tonga') %>%
      filter(country!='Tuvalu') %>%
      filter(country!='Uruguay') 
    
    risk.smoke.country.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.country.poor19, nest = T)
    
#surveydesign for poor32
    risk.smoke.country.poor32 <- filter(smoke.prev, is.na(w_smoke_poor19_age)==F) %>% filter(poor32==1)
    risk.smoke.country.poor32 <- risk.smoke.country.poor32 %>% 
      filter(country!='Armenia') %>%
      filter(country!='Bhutan') %>%
      filter(country!='Cameroon') %>%
      filter(country!='Burkina Faso') %>%
      filter(country!='Dominican Republic') %>%
      filter(country!='Uruguay') %>%
      filter(country!='Guinea') %>%
      filter(country!='Tuvalu') 
    
    risk.smoke.country.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.country.poor32, nest = T)
    
#surveydesign for poor55
    risk.smoke.country.poor55 <- filter(smoke.prev, is.na(w_smoke_poor19_age)==F) %>% filter(poor55==1)
    risk.smoke.country.poor55 <- risk.smoke.country.poor55 %>% 
      filter(country!='Armenia') %>%
      filter(country!='Burkina Faso') %>%
      filter(country!='Cameroon') %>%
      filter(country!='Dominican Republic') 

    risk.smoke.country.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.country.poor55, nest = T)
    
#surveydesign for nonpoor
    risk.smoke.country.poor0 <- filter(smoke.prev, is.na(w_smoke_poor19_age)==F) %>% filter(poor55==0)
    risk.smoke.country.poor0 <- risk.smoke.country.poor0 %>% 
      filter(country!='Armenia') %>%
      filter(country!='Burkina Faso') %>%
      filter(country!='Cameroon') %>%
      filter(country!='Congo Democratic Republic') %>%
      filter(country!='Dominican Republic') %>%
      filter(country!='Guinea') %>%
      filter(country!='Liberia') %>%
      filter(country!='Madagascar') %>%
      filter(country!='Mozambique') %>%
      filter(country!='Sao Tome and Principe') %>%
      filter(country!='Togo') %>%
      filter(country!='Zambia') %>%
      filter(country!='Zanzibar')
    
    risk.smoke.country.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=risk.smoke.country.poor0, nest = T)  
    
#surveydesign for all
    risk.smoke.country.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke.prev, nest = T)
  
###country prevalence for all 
    prev.smoke.all <- svyby(~csmoke,by=~country, design=risk.smoke.all_povgroups, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.smoke.all <- unite_ci(prev.smoke.all, "Prev_poorall", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)         

  #country prevalences for poor19  
    prev.smoke.poor19 <- svyby(~csmoke, by=~country, design=risk.smoke.country.poor19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.smoke.poor19 <- unite_ci(prev.smoke.poor19, "Prev_poor19", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)    
    
  #country prevalences for poor32  
    prev.smoke.poor32 <- svyby(~csmoke, by=~country, design=risk.smoke.country.poor32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.smoke.poor32 <- unite_ci(prev.smoke.poor32, "Prev_poor32", csmoke, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor55 
    prev.smoke.poor55 <- svyby(~csmoke, by=~country, design=risk.smoke.country.poor55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.smoke.poor55 <- unite_ci(prev.smoke.poor55, "Prev_poor55", csmoke, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor19  
    prev.smoke.poor0 <- svyby(~csmoke, by=~country, design=risk.smoke.country.poor0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.smoke.poor0 <- unite_ci(prev.smoke.poor0, "Prev_poor0", csmoke, ci_l, ci_u, m100 = T, percent = FALSE)     
    
#merge
    prev.smoke.country <- prev.smoke.poor55 %>%
      left_join(prev.smoke.poor32) %>%
      left_join(prev.smoke.poor19) %>%
      left_join(prev.smoke.poor0)  
      
    write.csv(prev.smoke.country, "~/prev.smoke.country.csv")           
           
#format    
    prev.smoke.all <- tidyr::separate(prev.smoke.all,Prev_poorall, c("hypt19", "V2"), "\\s(?:.+\\s)?")  
    prev.smoke.all$V2  <- gsub("[()]", "", prev.smoke.all$V2 )
    prev.smoke.all <- tidyr::separate(prev.smoke.all, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.smoke.all <- prev.smoke.all %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep="")) %>%
      select(country, hypt19)
    
    prev.countries <- read.csv("~/prev.countries - country.list.csv", stringsAsFactors=F)
    prev.smoke.all <- prev.countries %>%
      left_join(prev.smoke.all)
    write.csv(prev.smoke.all, "~/prev.smoke.all.csv") 
         
#Mexico
  
#poor19      
    smoke.mexico19 <- filter(smoke_subset, is.na(w_smoke_poor19_age)==F) %>% filter(poor19==1)
    smoke.mexico19 <- filter(smoke.mexico19, country=='Mexico')
    risk.smoke.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke.mexico19, nest = T)
    svymean(~csmoke, risk.smoke.mexico19, deff=TRUE)
    confint(svymean(~csmoke, risk.smoke.mexico19, level = 0.95))
    
#poor32
    smoke.mexico32 <- filter(smoke_subset, is.na(w_smoke_poor19_age)==F) %>% filter(poor32==1)
    smoke.mexico32 <- filter(smoke.mexico32, country=='Mexico')
    risk.smoke.mexico32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke.mexico32, nest = T)
    svymean(~csmoke, risk.smoke.mexico32, deff=TRUE)
    confint(svymean(~csmoke, risk.smoke.mexico32, level = 0.95))
    
#poor55
    smoke.mexico55 <- filter(smoke_subset, is.na(w_smoke_poor19_age)==F) %>% filter(poor55==1)
    smoke.mexico55 <- filter(smoke.mexico55, country=='Mexico')
    risk.smoke.mexico55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke.mexico55, nest = T)
    svymean(~csmoke, risk.smoke.mexico55, deff=TRUE)
    confint(svymean(~csmoke, risk.smoke.mexico55, level = 0.95))
    
#poor0
    smoke.mexico0 <- filter(smoke_subset, is.na(w_smoke_poor19_age)==F) %>% filter(poor55==0)
    smoke.mexico0 <- filter(smoke.mexico0, country=='Mexico')
    risk.smoke.mexico0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke.mexico0, nest = T)
    svymean(~csmoke, risk.smoke.mexico0, deff=TRUE)
    confint(svymean(~csmoke, risk.smoke.mexico0, level = 0.95))
    
#all
    smoke.mexico19 <- filter(smoke_subset, country=='Mexico')
    risk.smoke.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_smoke_poor19_age, data=smoke.mexico19, nest = T)
    svymean(~csmoke, risk.smoke.mexico19, deff=TRUE)
    confint(svymean(~csmoke, risk.smoke.mexico19, level = 0.95))
 
###LIPIDS 
    
    lipid_subset <- read.csv("~/lipid_subset.csv", stringsAsFactors=F)
    lipid.prev <- lipid_subset %>% 
      filter(country!='Kenya') %>%
      filter(country!='Malawi') %>%
      filter(country!='Mozambique') %>%
      filter(country!='Timor Leste') %>%
      filter(country!='Tuvalu') %>%
      filter(country!='Georgia') 
    
#surveydesign for poor19
    risk.lipid.country.poor19 <- filter(lipid.prev, is.na(w_lipid_poor19_age)==F) %>% filter(poor19==1) %>% 
      filter(country=="Benin" | country=="Ethiopia" | country=="Mexico" | country=="Solomon Islands" | country=="Swaziland" | country=="Tanzania" | 
               country=="Vanuatu" | country=="Zambia" | country=="Zanzibar") 
    risk.lipid.country.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.country.poor19, nest = T)
    
#surveydesign for poor32
    risk.lipid.country.poor32 <- filter(lipid.prev, is.na(w_lipid_poor19_age)==F) %>% filter(poor32==1) %>% 
      filter(country!='Bhutan') %>%
      filter(country!='Cabo Verde') %>%
      filter(country!='Jordan') %>%
      filter(country!='Kiribati') %>%
      filter(country!='Kyrgyz Republic') %>%
      filter(country!='Rwanda') %>%
      filter(country!='Samoa') %>%
      filter(country!='Sao Tome and Principe') %>%
      filter(country!='Tajikistan') %>%
      filter(country!='Togo') %>%
      filter(country!='Uganda') 
      
    risk.lipid.country.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.country.poor32, nest = T)
    
#surveydesign for poor55
    risk.lipid.country.poor55 <- filter(lipid.prev, is.na(w_lipid_poor19_age)==F) %>% filter(poor55==1) %>% 
      filter(country!='Cabo Verde') %>%
      filter(country!='Samoa') %>%
      filter(country!='Jordan') %>%
      filter(country!='Sao Tome and Principe') %>%
      filter(country!='Tajikistan') %>%
      filter(country!='Togo') %>%
      filter(country!='Uganda') 
      
    risk.lipid.country.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.country.poor55, nest = T)
    
#surveydesign for nonpoor
    risk.lipid.country.poor0 <- filter(lipid.prev, is.na(w_lipid_poor19_age)==F) %>% filter(poor55==0) %>% 
      filter(country!='Cabo Verde') %>%
      filter(country!='Ethiopia') %>%
      filter(country!='Kiribati') %>%
      filter(country!='Rwanda') %>%
      filter(country!='Sao Tome and Principe') %>%
      filter(country!='Tanzania') %>%
      filter(country!='Togo') %>%
      filter(country!='Uganda') %>%
      filter(country!='Zambia') %>%
      filter(country!='Zanzibar')
   
    risk.lipid.country.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=risk.lipid.country.poor0, nest = T) 
    
###surveydesign for all
   risk.lipids.country.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipid.prev, nest = T)
    
  #country prevalences for poor19  
    prev.lipid.poor19 <- svyby(~dyslipid, by=~country, design=risk.lipid.country.poor19, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.lipid.poor19 <- unite_ci(prev.lipid.poor19, "Prev_poor19", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)    
    
  #country prevalences for poor32  
    prev.lipid.poor32 <- svyby(~dyslipid, by=~country, design=risk.lipid.country.poor32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.lipid.poor32 <- unite_ci(prev.lipid.poor32, "Prev_poor32", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor55 
    prev.lipid.poor55 <- svyby(~dyslipid, by=~country, design=risk.lipid.country.poor55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.lipid.poor55 <- unite_ci(prev.lipid.poor55, "Prev_poor55", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for poor0 
    prev.lipid.poor0 <- svyby(~dyslipid, by=~country, design=risk.lipid.country.poor0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.lipid.poor0 <- unite_ci(prev.lipid.poor0, "Prev_poor0", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE) 
    
  #country prevalences for all 
    prev.lipids.all <- svyby(~dyslipid, by=~country, design=risk.lipids.country.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
    prev.lipids.all <- unite_ci(prev.lipids.all, "Prev_poorall", dyslipid, ci_l, ci_u, m100 = T, percent = FALSE)
    
#merge
    prev.lipid.country <- prev.lipids.all %>%
      left_join(prev.lipid.poor19) %>%
      left_join(prev.lipid.poor32) %>%
      left_join(prev.lipid.poor55) %>%
      left_join(prev.lipid.poor0) 
      
    write.csv(prev.lipid.country, "~/prev.lipid.country.csv") 
    
 #format    
    prev.lipids.all <- tidyr::separate(prev.lipids.all,Prev_poorall, c("hypt19", "V2"), "\\s(?:.+\\s)?")  
    prev.lipids.all$V2  <- gsub("[()]", "", prev.lipids.all$V2 )
    prev.lipids.all <- tidyr::separate(prev.lipids.all, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.lipids.all <- prev.lipids.all %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep="")) %>%
      select(country, hypt19)
    
    prev.countries <- read.csv("~/prev.countries - country.list.csv", stringsAsFactors=F)
    prev.lipids.all <- prev.countries %>%
      left_join(prev.lipids.all)
    write.csv(prev.lipids.all, "~/prev.lipids.all.csv")
  
###mexico
    
#poor19    
    lipids.mexico19 <- filter(lipid_subset, is.na(w_lipid_poor19_age)==F) %>% filter(poor19==1)
    lipids.mexico19 <- filter(lipids.mexico19, country=='Mexico')
    risk.lipids.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipids.mexico19, nest = T)
    svymean(~dyslipid, risk.lipids.mexico19, deff=TRUE)
    confint(svymean(~dyslipid, risk.lipids.mexico19, level = 0.95))
    
#poor32
    lipids.mexico32 <- filter(lipid_subset, is.na(w_lipid_poor19_age)==F) %>% filter(poor32==1)
    lipids.mexico32 <- filter(lipids.mexico32, country=='Mexico')
    risk.lipids.mexico32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipids.mexico32, nest = T)
    svymean(~dyslipid, risk.lipids.mexico32, deff=TRUE)
    confint(svymean(~dyslipid, risk.lipids.mexico32, level = 0.95))
    
#poor55
    lipids.mexico55 <- filter(lipid_subset, is.na(w_lipid_poor19_age)==F) %>% filter(poor55==1)
    lipids.mexico55 <- filter(lipids.mexico55, country=='Mexico')
    risk.lipids.mexico55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipids.mexico55, nest = T)
    svymean(~dyslipid, risk.lipids.mexico55, deff=TRUE)
    confint(svymean(~dyslipid, risk.lipids.mexico55, level = 0.95))
    
#poor0
    lipids.mexico0 <- filter(lipid_subset, is.na(w_lipid_poor19_age)==F) %>% filter(poor55==0)
    lipids.mexico0 <- filter(lipids.mexico0, country=='Mexico')
    risk.lipids.mexico0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipids.mexico0, nest = T)
    svymean(~dyslipid, risk.lipids.mexico0, deff=TRUE)
    confint(svymean(~dyslipid, risk.lipids.mexico0, level = 0.95))
    
#all
    lipids.mexico19 <- filter(lipid_subset, country=='Mexico')
    risk.lipids.mexico19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=lipids.mexico19, nest = T)
    svymean(~dyslipid, risk.lipids.mexico19, deff=TRUE)
    confint(svymean(~dyslipid, risk.lipids.mexico19, level = 0.95))
 
 #merge country prevalences into one file and bring into right format
   prev.all.countries <- prev.countries %>% 
     left_join(prev.countries.hypt, by = "country")%>% 
     left_join(prev.countries.dia, by = "country")%>% 
     left_join(prev.countries.overw, by = "country")%>% 
     left_join(prev.countries.obese, by = "country")%>% 
     left_join(prev.countries.smoke, by = "country")%>% 
     left_join(prev.countries.lipids, by = "country")
 
###format
#hypt19  
    prev.all.countries <- tidyr::separate(prev.all.countries, poor19.hypt, c("hypt19", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_hypt19", "ciu_hypt19"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(hypt19 = as.numeric(hypt19),
          cil_hypt19 = as.numeric(cil_hypt19),
          ciu_hypt19 = as.numeric(ciu_hypt19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt19 = str_c(as.character(hypt19), " (", as.character(cil_hypt19), "-", as.character(ciu_hypt19), ")", sep=""))
    
#hypt32
    prev.all.countries <- tidyr::separate(prev.all.countries, poor32.hypt, c("hypt32", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_hypt32", "ciu_hypt32"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(hypt32 = as.numeric(hypt32),
          cil_hypt32 = as.numeric(cil_hypt32),
          ciu_hypt32 = as.numeric(ciu_hypt32))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt32 = str_c(as.character(hypt32), " (", as.character(cil_hypt32), "-", as.character(ciu_hypt32), ")", sep=""))
    
#hypt55
    prev.all.countries <- tidyr::separate(prev.all.countries, poor55.hypt, c("hypt55", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_hypt55", "ciu_hypt55"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(hypt55 = as.numeric(hypt55),
          cil_hypt55 = as.numeric(cil_hypt55),
          ciu_hypt55 = as.numeric(ciu_hypt55))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt55 = str_c(as.character(hypt55), " (", as.character(cil_hypt55), "-", as.character(ciu_hypt55), ")", sep=""))
    
#hypt0
    prev.all.countries <- tidyr::separate(prev.all.countries, poor0.hypt, c("hypt0", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_hypt0", "ciu_hypt0"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(hypt0 = as.numeric(hypt0),
          cil_hypt0 = as.numeric(cil_hypt0),
          ciu_hypt0 = as.numeric(ciu_hypt0))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt0 = str_c(as.character(hypt0), " (", as.character(cil_hypt0), "-", as.character(ciu_hypt0), ")", sep=""))
    
#dia19
    prev.all.countries <- tidyr::separate(prev.all.countries, poor19.dia, c("dia19", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_dia19", "ciu_dia19"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(dia19 = as.numeric(dia19),
          cil_dia19 = as.numeric(cil_dia19),
          ciu_dia19 = as.numeric(ciu_dia19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(dia19 = str_c(as.character(dia19), " (", as.character(cil_dia19), "-", as.character(ciu_dia19), ")", sep=""))
    
#dia32
    prev.all.countries <- tidyr::separate(prev.all.countries, poor32.dia, c("dia32", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_dia32", "ciu_dia32"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(dia32 = as.numeric(dia32),
          cil_dia32 = as.numeric(cil_dia32),
          ciu_dia32 = as.numeric(ciu_dia32))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia32 = str_c(as.character(dia32), " (", as.character(cil_dia32), "-", as.character(ciu_dia32), ")", sep=""))
    
#dia55
    prev.all.countries <- tidyr::separate(prev.all.countries, poor55.dia, c("dia55", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_dia55", "ciu_dia55"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(dia55 = as.numeric(dia55),
          cil_dia55 = as.numeric(cil_dia55),
          ciu_dia55 = as.numeric(ciu_dia55))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia55 = str_c(as.character(dia55), " (", as.character(cil_dia55), "-", as.character(ciu_dia55), ")", sep=""))
    
#dia0
    prev.all.countries <- tidyr::separate(prev.all.countries, poor0.dia, c("dia0", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_dia0", "ciu_dia0"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(dia0 = as.numeric(dia0),
          cil_dia0 = as.numeric(cil_dia0),
          ciu_dia0 = as.numeric(ciu_dia0))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(dia0 = str_c(as.character(dia0), " (", as.character(cil_dia0), "-", as.character(ciu_dia0), ")", sep=""))
    
#overweight19
    prev.all.countries <- tidyr::separate(prev.all.countries, poor19.overw, c("overw19", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_overw19", "ciu_overw19"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(overw19 = as.numeric(overw19),
          cil_overw19 = as.numeric(cil_overw19),
          ciu_overw19 = as.numeric(ciu_overw19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw19 = str_c(as.character(overw19), " (", as.character(cil_overw19), "-", as.character(ciu_overw19), ")", sep=""))
    
#overw32
    prev.all.countries <- tidyr::separate(prev.all.countries, poor32.overw, c("overw32", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_overw32", "ciu_overw32"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(overw32 = as.numeric(overw32),
          cil_overw32 = as.numeric(cil_overw32),
          ciu_overw32 = as.numeric(ciu_overw32))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(overw32 = str_c(as.character(overw32), " (", as.character(cil_overw32), "-", as.character(ciu_overw32), ")", sep=""))
    
#overw55
    prev.all.countries <- tidyr::separate(prev.all.countries, poor55.overw, c("overw55", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_overw55", "ciu_overw55"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(overw55 = as.numeric(overw55),
          cil_overw55 = as.numeric(cil_overw55),
          ciu_overw55 = as.numeric(ciu_overw55))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(overw55 = str_c(as.character(overw55), " (", as.character(cil_overw55), "-", as.character(ciu_overw55), ")", sep=""))
    
#overw0
    prev.all.countries <- tidyr::separate(prev.all.countries, poor0.overw, c("overw0", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_overw0", "ciu_overw0"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(overw0 = as.numeric(overw0),
          cil_overw0 = as.numeric(cil_overw0),
          ciu_overw0 = as.numeric(ciu_overw0))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(overw0 = str_c(as.character(overw0), " (", as.character(cil_overw0), "-", as.character(ciu_overw0), ")", sep=""))

#obese19
    prev.all.countries <- tidyr::separate(prev.all.countries, poor19.obese, c("obese19", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_obese19", "ciu_obese19"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(obese19 = as.numeric(obese19),
          cil_obese19 = as.numeric(cil_obese19),
          ciu_obese19 = as.numeric(ciu_obese19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese19 = str_c(as.character(obese19), " (", as.character(cil_obese19), "-", as.character(ciu_obese19), ")", sep=""))
    
#obese32
    prev.all.countries <- tidyr::separate(prev.all.countries, poor32.obese, c("obese32", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_obese32", "ciu_obese32"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(obese32 = as.numeric(obese32),
          cil_obese32 = as.numeric(cil_obese32),
          ciu_obese32 = as.numeric(ciu_obese32))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese32 = str_c(as.character(obese32), " (", as.character(cil_obese32), "-", as.character(ciu_obese32), ")", sep=""))
    
#obese55
    prev.all.countries <- tidyr::separate(prev.all.countries, poor55.obese, c("obese55", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_obese55", "ciu_obese55"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(obese55 = as.numeric(obese55),
          cil_obese55 = as.numeric(cil_obese55),
          ciu_obese55 = as.numeric(ciu_obese55))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese55 = str_c(as.character(obese55), " (", as.character(cil_obese55), "-", as.character(ciu_obese55), ")", sep=""))
    
#obese0
    prev.all.countries <- tidyr::separate(prev.all.countries, poor0.obese, c("obese0", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_obese0", "ciu_obese0"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(obese0 = as.numeric(obese0),
          cil_obese0 = as.numeric(cil_obese0),
          ciu_obese0 = as.numeric(ciu_obese0))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(obese0 = str_c(as.character(obese0), " (", as.character(cil_obese0), "-", as.character(ciu_obese0), ")", sep=""))
    
#smoke19
    prev.all.countries <- tidyr::separate(prev.all.countries, poor19.smoke, c("smoke19", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_smoke19", "ciu_smoke19"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(smoke19 = as.numeric(smoke19),
          cil_smoke19 = as.numeric(cil_smoke19),
          ciu_smoke19 = as.numeric(ciu_smoke19))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(smoke19 = str_c(as.character(smoke19), " (", as.character(cil_smoke19), "-", as.character(ciu_smoke19), ")", sep=""))
    
 #smoke32
    prev.all.countries <- tidyr::separate(prev.all.countries, poor32.smoke, c("smoke32", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_smoke32", "ciu_smoke32"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(smoke32 = as.numeric(smoke32),
          cil_smoke32 = as.numeric(cil_smoke32),
          ciu_smoke32 = as.numeric(ciu_smoke32))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke32 = str_c(as.character(smoke32), " (", as.character(cil_smoke32), "-", as.character(ciu_smoke32), ")", sep=""))
    
#smoke55
    prev.all.countries <- tidyr::separate(prev.all.countries, poor55.smoke, c("smoke55", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_smoke55", "ciu_smoke55"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(smoke55 = as.numeric(smoke55),
          cil_smoke55 = as.numeric(cil_smoke55),
          ciu_smoke55 = as.numeric(ciu_smoke55))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(smoke55 = str_c(as.character(smoke55), " (", as.character(cil_smoke55), "-", as.character(ciu_smoke55), ")", sep=""))
    
#smoke0
    prev.all.countries <- tidyr::separate(prev.all.countries, poor0.smoke, c("smoke0", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_smoke0", "ciu_smoke0"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(smoke0 = as.numeric(smoke0),
          cil_smoke0 = as.numeric(cil_smoke0),
          ciu_smoke0 = as.numeric(ciu_smoke0))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(smoke0 = str_c(as.character(smoke0), " (", as.character(cil_smoke0), "-", as.character(ciu_smoke0), ")", sep=""))
    
#lipids19
    prev.all.countries <- tidyr::separate(prev.all.countries, poor19.lipids, c("lipids19", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_lipids19", "ciu_lipids19"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(lipids19 = as.numeric(lipids19),
          cil_lipids19 = as.numeric(cil_lipids19),
          ciu_lipids19 = as.numeric(ciu_lipids19))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids19 = str_c(as.character(lipids19), " (", as.character(cil_lipids19), "-", as.character(ciu_lipids19), ")", sep=""))
    
#lipids32
    prev.all.countries <- tidyr::separate(prev.all.countries, poor32.lipids, c("lipids32", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_lipids32", "ciu_lipids32"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(lipids32 = as.numeric(lipids32),
          cil_lipids32 = as.numeric(cil_lipids32),
          ciu_lipids32 = as.numeric(ciu_lipids32))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(lipids32 = str_c(as.character(lipids32), " (", as.character(cil_lipids32), "-", as.character(ciu_lipids32), ")", sep=""))
    
#lipids55
    prev.all.countries <- tidyr::separate(prev.all.countries, poor55.lipids, c("lipids55", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_lipids55", "ciu_lipids55"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(lipids55 = as.numeric(lipids55),
          cil_lipids55 = as.numeric(cil_lipids55),
          ciu_lipids55 = as.numeric(ciu_lipids55))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(lipids55 = str_c(as.character(lipids55), " (", as.character(cil_lipids55), "-", as.character(ciu_lipids55), ")", sep=""))
    
#lipids0
    prev.all.countries <- tidyr::separate(prev.all.countries, poor0.lipids, c("lipids0", "V2"), "\\s(?:.+\\s)?")
    prev.all.countries$V2  <- gsub("[()]", "", prev.all.countries$V2 )
    prev.all.countries <- tidyr::separate(prev.all.countries, V2, c("cil_lipids0", "ciu_lipids0"), "\\--") 
    prev.all.countries <- prev.all.countries %>% 
      mutate(lipids0 = as.numeric(lipids0),
          cil_lipids0 = as.numeric(cil_lipids0),
          ciu_lipids0 = as.numeric(ciu_lipids0))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(lipids0 = str_c(as.character(lipids0), " (", as.character(cil_lipids0), "-", as.character(ciu_lipids0), ")", sep=""))
    
    prev.all.countries <- prev.all.countries %>% select(country, hypt19, hypt32, hypt55, hypt0, 
                                                        dia19, dia32, dia55, dia0,
                                                        overw19, overw32, overw55, overw0, 
                                                        obese19, obese32, obese55, obese0, 
                                                        smoke19, smoke32, smoke55, smoke0,
                                                        lipids19, lipids32, lipids55, lipids0)  
    
    write.csv(prev.all.countries, "~/prev.all.countries.csv")
    
```


```{r Regressions: Hypertension}

#to determine how the prevalence of each CVD risk factor varied by individual-level characteristics among those living in extreme poverty and each poverty level, we regressed each CVD risk factor onto age, sex, educational attainment, and rural versus urban residency (both jointly in covariate-adjusted regression and separately in covariate-unadjusted regressions). We used Poisson regression models with a robust error structure, country-level fixed effects, and restricted cubic splines with five knots for age (placed at the 5th, 27.5th, 50th, 72.5th, and 95th percentile). Education was categorized as no formal schooling, primary education ( grade 6), and secondary education (grade 7 to 12) or further, using local education classifications whenever available, and years of education in cases where categorical variables were unavailable.We determined both the Risk Ratio and Average marginal effects (AME) using the margins() package and accounted for complex survey design for all regressions (by using the survey()package) 

#prepare regressions
  hypt_subset <- read.csv("~/hypt_subset.csv", stringsAsFactors=F)
  hypt_subset <- hypt_subset[,-1]

  hypt_subset <- hypt_subset %>% 
          mutate(female_lab = as.factor(
                          ifelse(sex=="1", "Female", 
                             ifelse(sex=="0", "Male", NA))),
                 urban_lab = as.factor(
                          ifelse(urban=="1", "urban", 
                             ifelse(urban=="0", "rural", NA))),
                 age_10yr_lab = as.factor(
                             ifelse(age>=15 & age<=24, "15-24",
                                ifelse(age>=25 & age<=34, "25-34",
                                    ifelse(age>=35 & age<=44, "35-44",
                                        ifelse(age>=45 & age<=54, "45-54",
                                             ifelse(age>=55 & age<=64, "55-64",
                                                  ifelse(age>=65, "65+", NA))))))),
                 age_5yr_lab = as.factor(
                             ifelse(age>=15 & age<=19, "15-19",
                                ifelse(age>=20 & age<=24, "20-24",
                                    ifelse(age>=25 & age<=29, "25-29",
                                        ifelse(age>=30 & age<=34, "30-34",
                                             ifelse(age>=35 & age<=39, "35-39",
                                                  ifelse(age>=40 & age<=44, "40-44",
                                                         ifelse(age>=45 & age<=49, "45-49", 
                                                                ifelse(age>=50 & age<=54, "50-54",
                                                                       ifelse(age>=55 & age<=59, "55-59",
                                                                              ifelse(age>=60 & age<=64, "60-64",
                                                                                     ifelse(age>=65, "65+", NA)))))))))))),
                 educat_lab = as.factor(
                            ifelse(educat=="0", "No formal schooling", 
                                     ifelse(educat=="1", "Primary school",
                                            ifelse(educat=="2", "Primary school",
                                            ifelse(educat=='3', 'High school or above', 
                                                   ifelse(educat=="4", "High school or above",NA)))))))

  hypt_subset$educat_lab <- factor(hypt_subset$educat_lab, levels = c("No formal schooling", "Primary school", "High school or above"))

#prepare for regression  
  dat.reg.hypt <- hypt_subset %>% 
    dplyr::mutate(
      country = as.factor(country),
      region = as.factor(region),
      urban_lab = as.factor(urban_lab),
      sex = as.factor(sex)
      )


###hypertension
#global
#no urban sample

#sex
  dat.reg.hypt.global <- filter(dat.reg.hypt, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.global %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.global <- x2 %>% left_join(dat.reg.hypt.global)
  
  dat.reg.hypt.global <- dat.reg.hypt.global %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global <- dat.reg.hypt.global %>% mutate(
    country = as.factor(country))
  
#run survey design
  svy.hypt.pop.global <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.global, family=poisson(link="log"),design=svy.hypt.pop.global )
  
  univar.hypt.global.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.global.sex.rr)
  univar.hypt.global.sex.rr <- as.data.frame(univar.hypt.global.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.global.sex.rr$coef <- coefficients
  univar.hypt.global.sex.rr <- univar.hypt.global.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.global.sex.rr, "univar.hypt.global.sex.rr.xlsx")

#to get average marginal effect (AME), using the margins() package
  (models <- margins(models,design=svy.hypt.pop.global))
  univar.hypt.global.sex.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.global.sex.ame, "univar.hypt.global.sex.ame.xlsx")

# educat
  dat.reg.hypt.global.edu <- filter(dat.reg.hypt, is.na(educat_lab)==F)
    x2 <- dat.reg.hypt.global.edu %>%
      group_by(country) %>%
      filter(all_hypt==1) %>%
      summarise(comb=n()) %>%
      filter(any(comb>0)) %>%
      select(country) 
  
  dat.reg.hypt.global.edu <- x2 %>% left_join(dat.reg.hypt.global.edu)
  
  dat.reg.hypt.global.edu <- dat.reg.hypt.global.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.edu <- dat.reg.hypt.global.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.global.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.global.edu, family=poisson(link="log"),design=svy.hypt.pop.global.edu )
  
  univar.hypt.global.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.global.edu.rr)
  univar.hypt.global.edu.rr <- as.data.frame(univar.hypt.global.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.global.edu.rr$coef <- coefficients
  univar.hypt.global.edu.rr <- univar.hypt.global.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.global.edu.rr, "univar.hypt.global.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.global.edu))
  univar.hypt.global.edu.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.global.edu.ame, "univar.hypt.global.edu.ame.xlsx")

###multivariate: education, sex
  dat.reg.hypt.global.edu.sex <- filter(dat.reg.hypt, is.na(educat_lab)==F)
  dat.reg.hypt.global.edu.sex <- filter(dat.reg.hypt.global.edu.sex, is.na(female_lab)==F)
  x2 <- dat.reg.hypt.global.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.global.edu.sex <- x2 %>% left_join(dat.reg.hypt.global.edu.sex)
  
  dat.reg.hypt.global.edu.sex <- dat.reg.hypt.global.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.edu.sex <- dat.reg.hypt.global.edu.sex %>% mutate(
    country = as.factor(country))
  uniqueN(dat.reg.hypt.global.edu.sex$country)

#run survey design
  svy.hypt.pop.global.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global.edu.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.hypt.global.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.global.edu.sex )
  
  multivar.hypt.global.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.global.rr)
  multivar.hypt.global.rr <- as.data.frame(multivar.hypt.global.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.global.rr$coef <- coefficients
  multivar.hypt.global.rr <- multivar.hypt.global.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.global.rr, "multivar.hypt.global.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.global.edu.sex))
  multivar.hypt.global.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.global.ame, "multivar.hypt.global.ame.xlsx")

###urban sample
#sex
  dat.reg.hypt.global.urban.sex <- filter(dat.reg.hypt, is.na(female_lab)==F)
  dat.reg.hypt.global.urban.sex <- filter(dat.reg.hypt.global.urban.sex, is.na(urban_lab)==F)
  x2 <- dat.reg.hypt.global.urban.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.global.urban.sex <- x2 %>% left_join(dat.reg.hypt.global.urban.sex)
  
  dat.reg.hypt.global.urban.sex <- dat.reg.hypt.global.urban.sex %>%
    mutate(country=as.character(country))
  dat.reg.hypt.global.urban.sex <- dat.reg.hypt.global.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.urban.sex <- dat.reg.hypt.global.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.global.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global.urban.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.global.urban.sex, family=poisson(link="log"),design=svy.hypt.pop.global.urban.sex )
  
  univar.hypt.global.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.global.sex.urban.rr)
  univar.hypt.global.sex.urban.rr <- as.data.frame(univar.hypt.global.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.global.sex.urban.rr$coef <- coefficients
  univar.hypt.global.sex.urban.rr <- univar.hypt.global.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.global.sex.urban.rr, "univar.hypt.global.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.global.urban.sex))
  univar.hypt.global.sex.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.global.sex.urban.ame, "univar.hypt.global.sex.urban.ame.xlsx")

###educat
  dat.reg.hypt.global.urban.edu <- filter(dat.reg.hypt, is.na(educat_lab)==F)
  dat.reg.hypt.global.urban.edu <- filter(dat.reg.hypt.global.urban.edu, is.na(urban_lab)==F)
  x2 <- dat.reg.hypt.global.urban.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.global.urban.edu <- x2 %>% left_join(dat.reg.hypt.global.urban.edu)
  
  dat.reg.hypt.global.urban.edu <- dat.reg.hypt.global.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.urban.edu <- dat.reg.hypt.global.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.global.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global.urban.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.global.urban.edu, family=poisson(link="log"),design=svy.hypt.pop.global.urban.edu )
  
  univar.hypt.global.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.global.edu.urban.rr)
  univar.hypt.global.edu.urban.rr <- as.data.frame(univar.hypt.global.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.global.edu.urban.rr$coef <- coefficients
  univar.hypt.global.edu.urban.rr <- univar.hypt.global.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.global.edu.urban.rr, "univar.hypt.global.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.global.urban.edu))
  univar.hypt.global.edu.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.global.edu.urban.ame, "univar.hypt.global.edu.urban.ame.xlsx")

###urban
  dat.reg.hypt.global.urban <- filter(dat.reg.hypt, is.na(urban_lab)==F)
    x2 <- dat.reg.hypt.global.urban %>%
      group_by(country) %>%
      filter(all_hypt==1) %>%
      summarise(comb=n()) %>%
      filter(any(comb>0)) %>%
      select(country) 
  
  dat.reg.hypt.global.urban <- x2 %>% left_join(dat.reg.hypt.global.urban)
  
  dat.reg.hypt.global.urban <- dat.reg.hypt.global.urban %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.urban <- dat.reg.hypt.global.urban %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.urban <- dat.reg.hypt.global.urban %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.global.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global.urban , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.hypt.global.urban, family=poisson(link="log"),design=svy.hypt.pop.global.urban )
  
  univar.hypt.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.global.urban.rr)
  univar.hypt.global.urban.rr <- as.data.frame(univar.hypt.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.global.urban.rr$coef <- coefficients
  univar.hypt.global.urban.rr <- univar.hypt.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.global.urban.rr, "univar.hypt.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.global.urban))
  univar.hypt.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.global.urban.ame, "univar.hypt.global.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.hypt.global.urban.edu.sex <- filter(dat.reg.hypt, is.na(urban_lab)==F)
  dat.reg.hypt.global.urban.edu.sex <- filter(dat.reg.hypt.global.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.global.urban.edu.sex <- filter(dat.reg.hypt.global.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.global.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.global.urban.edu.sex <- x2 %>% left_join(dat.reg.hypt.global.urban.edu.sex)
  
  dat.reg.hypt.global.urban.edu.sex <- dat.reg.hypt.global.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.urban.edu.sex <- dat.reg.hypt.global.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.global.urban.edu.sex <- dat.reg.hypt.global.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.global.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.global.urban.edu.sex , 
                                                 nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.hypt.global.urban.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.global.urban.edu.sex )
  
  multivar.hypt.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.global.urban.rr)
  multivar.hypt.global.urban.rr <- as.data.frame(multivar.hypt.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.global.urban.rr$coef <- coefficients
  multivar.hypt.global.urban.rr <- multivar.hypt.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.global.urban.rr, "multivar.hypt.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.global.urban.edu.sex))
  multivar.hypt.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.global.urban.ame, "multivar.hypt.global.urban.ame.xlsx")

### Poor19
#no urban sample

#sex
  dat.reg.hypt.poor19 <- dat.reg.hypt %>% dplyr::filter(poor19==1) 
  dat.reg.hypt.poor19 <- filter(dat.reg.hypt.poor19, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor19 %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor19 <- x2 %>% left_join(dat.reg.hypt.poor19)
  
  dat.reg.hypt.poor19 <- dat.reg.hypt.poor19 %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor19 <- dat.reg.hypt.poor19 %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor19 , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab, data=dat.reg.hypt.poor19, family=poisson(link="log"),design=svy.hypt.pop.poor19 )
  
  univar.hypt.poor19.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor19.sex.rr)
  univar.hypt.poor19.sex.rr <- as.data.frame(univar.hypt.poor19.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor19.sex.rr$coef <- coefficients
  univar.hypt.poor19.sex.rr <- univar.hypt.poor19.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor19.sex.rr, "univar.hypt.poor19.sex.rr.xlsx")

#to get AME
  models <- margins(models,design=svy.hypt.pop.poor19)
  univar.hypt.poor19.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor19.sex.ame, "univar.hypt.poor19.sex.ame.xlsx")

#educat
  dat.reg.hypt.poor19.edu <- dat.reg.hypt %>% dplyr::filter(poor19==1) 
  dat.reg.hypt.poor19.edu <- filter(dat.reg.hypt.poor19.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.hypt.poor19.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor19.edu <- x2 %>% left_join(dat.reg.hypt.poor19.edu)
  
  dat.reg.hypt.poor19.edu <- dat.reg.hypt.poor19.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor19.edu <- dat.reg.hypt.poor19.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor19.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor19.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor19.edu, family=poisson(link="log"),design=svy.hypt.pop.poor19.edu )
  
  univar.hypt.poor19.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor19.edu.rr)
  univar.hypt.poor19.edu.rr <- as.data.frame(univar.hypt.poor19.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor19.edu.rr$coef <- coefficients
  univar.hypt.poor19.edu.rr <- univar.hypt.poor19.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor19.edu.rr, "univar.hypt.poor19.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor19.edu))
  univar.hypt.poor19.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor19.edu.ame, "univar.hypt.poor19.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.hypt.poor19.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor19==1) 
  dat.reg.hypt.poor19.edu.sex <- filter(dat.reg.hypt.poor19.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor19.edu.sex <- filter(dat.reg.hypt.poor19.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor19.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor19.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor19.edu.sex)
  
  dat.reg.hypt.poor19.edu.sex <- dat.reg.hypt.poor19.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor19.edu.sex <- dat.reg.hypt.poor19.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor19.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor19.edu.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.hypt.poor19.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor19.edu.sex )
  
  multivar.hypt.poor19.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor19.edu.sex.rr)
  multivar.hypt.poor19.edu.sex.rr <- as.data.frame(multivar.hypt.poor19.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor19.edu.sex.rr$coef <- coefficients
  multivar.hypt.poor19.edu.sex.rr <- multivar.hypt.poor19.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor19.edu.sex.rr, "multivar.hypt.poor19.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor19.edu.sex))
  multivar.hypt.poor19.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor19.edu.sex.ame, "multivar.hypt.poor19.edu.sex.ame.xlsx")

###urban sample
#sex
  dat.reg.hypt.poor19.urban.sex <- dat.reg.hypt %>%dplyr::filter(poor19==1) 
  dat.reg.hypt.poor19.urban.sex <- filter(dat.reg.hypt.poor19.urban.sex, is.na(female_lab)==F)
  dat.reg.hypt.poor19.urban.sex <- filter(dat.reg.hypt.poor19.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor19.urban.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor19.urban.sex <- x2 %>% left_join(dat.reg.hypt.poor19.urban.sex)
  
  dat.reg.hypt.poor19.urban.sex <- dat.reg.hypt.poor19.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor19.urban.sex <- dat.reg.hypt.poor19.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor19.urban.sex <- svydesign(id=~psu+hh_idat.reg.hypt.poor19.urban.sexd, strata=~stratum, weights=~w_lipid_poor19_age, 
                                             data=dat.reg.hypt.poor19.urban.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor19.urban.sex, family=poisson(link="log"),design=svy.hypt.pop.poor19.urban.sex )
  
  univar.hypt.poor19.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor19.sex.urban.rr)
  univar.hypt.poor19.sex.urban.rr <- as.data.frame(univar.hypt.poor19.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor19.sex.urban.rr$coef <- coefficients
  univar.hypt.poor19.sex.urban.rr <- univar.hypt.poor19.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor19.sex.urban.rr, "univar.hypt.poor19.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor19.urban.sex))
  univar.hypt.poor19.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor19.sex.urban.ame, "univar.hypt.poor19.sex.urban.ame.xlsx")

###educat
  dat.reg.hypt.poor19.urban.edu <- dat.reg.hypt %>%dplyr::filter(poor19==1) 
  dat.reg.hypt.poor19.urban.edu <- filter(dat.reg.hypt.poor19.urban.edu, is.na(educat_lab)==F)
  dat.reg.hypt.poor19.urban.edu <- filter(dat.reg.hypt.poor19.urban.edu, is.na(urban_lab)==F)
  
    x2 <- dat.reg.hypt.poor19.urban.edu %>%
      group_by(country) %>%
      filter(all_hypt==1) %>%
      summarise(comb=n()) %>%
      filter(any(comb>0)) %>%
      select(country) 
  
  dat.reg.hypt.poor19.urban.edu <- x2 %>% left_join(dat.reg.hypt.poor19.urban.edu)
  
  dat.reg.hypt.poor19.urban.edu <- dat.reg.hypt.poor19.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor19.urban.edu <- dat.reg.hypt.poor19.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor19.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor19.urban.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor19.urban.edu, family=poisson(link="log"),design=svy.hypt.pop.poor19.urban.edu )
  
  univar.hypt.poor19.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor19.edu.urban.rr)
  univar.hypt.poor19.edu.urban.rr <- as.data.frame(univar.hypt.poor19.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor19.edu.urban.rr$coef <- coefficients
  univar.hypt.poor19.edu.urban.rr <- univar.hypt.poor19.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor19.edu.urban.rr, "univar.hypt.poor19.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor19.urban.edu))
  univar.hypt.poor19.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor19.edu.urban.ame, "univar.hypt.poor19.edu.urban.ame.xlsx")

#urban
    dat.reg.hypt.poor19.urban <- dat.reg.hypt %>%dplyr::filter(poor19==1)  
    dat.reg.hypt.poor19.urban <- filter(dat.reg.hypt.poor19.urban, is.na(urban_lab)==F)
    
      x2 <- dat.reg.hypt.poor19.urban %>%
        group_by(country) %>%
        filter(all_hypt==1) %>%
        summarise(comb=n()) %>%
        filter(any(comb>0)) %>%
        select(country) 
    
    dat.reg.hypt.poor19.urban <- x2 %>% left_join(dat.reg.hypt.poor19.urban)
    
    dat.reg.hypt.poor19.urban <- dat.reg.hypt.poor19.urban %>% mutate(
      country = as.character(country))
    dat.reg.hypt.poor19.urban <- dat.reg.hypt.poor19.urban %>% mutate(
      country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor19.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor19.urban , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.hypt.poor19.urban, family=poisson(link="log"),design=svy.hypt.pop.poor19.urban )
  
  univar.hypt.poor19.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor19.urban.rr)
  univar.hypt.poor19.urban.rr <- as.data.frame(univar.hypt.poor19.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor19.urban.rr$coef <- coefficients
  univar.hypt.poor19.urban.rr <- univar.hypt.poor19.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor19.urban.rr, "univar.hypt.poor19.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor19.urban))
  univar.hypt.poor19.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor19.urban.ame, "univar.hypt.poor19.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.hypt.poor19.urban.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor19==1)  
  dat.reg.hypt.poor19.urban.edu.sex <- filter(dat.reg.hypt.poor19.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.hypt.poor19.urban.edu.sex <- filter(dat.reg.hypt.poor19.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor19.urban.edu.sex <- filter(dat.reg.hypt.poor19.urban.edu.sex, is.na(female_lab)==F)
  
    x2 <- dat.reg.hypt.poor19.urban.edu.sex %>%
      group_by(country) %>%
      filter(all_hypt==1) %>%
      summarise(comb=n()) %>%
      filter(any(comb>0)) %>%
      select(country) 
  
  dat.reg.hypt.poor19.urban.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor19.urban.edu.sex)
  
  dat.reg.hypt.poor19.urban.edu.sex <- dat.reg.hypt.poor19.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor19.urban.edu.sex <- dat.reg.hypt.poor19.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor19.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor19.urban.edu.sex , 
                                                 nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.hypt.poor19.urban.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor19.urban.edu.sex )
  
  multivar.hypt.poor19.urban.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor19.urban.edu.sex.rr)
  multivar.hypt.poor19.urban.edu.sex.rr <- as.data.frame(multivar.hypt.poor19.urban.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor19.urban.edu.sex.rr$coef <- coefficients
  multivar.hypt.poor19.urban.edu.sex.rr <- multivar.hypt.poor19.urban.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor19.urban.edu.sex.rr, "multivar.hypt.poor19.urban.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor19.urban.edu.sex))
  multivar.hypt.poor19.urban.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor19.urban.edu.sex.ame, "multivar.hypt.poor19.urban.edu.sex.ame.xlsx")

###poor32
#no urban sample

#sex
  dat.reg.hypt.poor32 <- dat.reg.hypt %>% dplyr::filter(poor32==1) 
  dat.reg.hypt.poor32 <- filter(dat.reg.hypt.poor32, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor32 %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor32 <- x2 %>% left_join(dat.reg.hypt.poor32)
  
  dat.reg.hypt.poor32 <- dat.reg.hypt.poor32 %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32 <- dat.reg.hypt.poor32 %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32 , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor32, family=poisson(link="log"),design=svy.hypt.pop.poor32 )
  
  univar.hypt.poor32.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor32.sex.rr)
  univar.hypt.poor32.sex.rr <- as.data.frame(univar.hypt.poor32.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor32.sex.rr$coef <- coefficients
  univar.hypt.poor32.sex.rr <- univar.hypt.poor32.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor32.sex.rr, "univar.hypt.poor32.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32))
  univar.hypt.poor32.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor32.sex.ame, "univar.hypt.poor32.sex.ame.xlsx")

#educat
  dat.reg.hypt.poor32.edu <- dat.reg.hypt %>% dplyr::filter(poor32==1) 
  dat.reg.hypt.poor32.edu <- filter(dat.reg.hypt.poor32.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.hypt.poor32.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor32.edu <- x2 %>% left_join(dat.reg.hypt.poor32.edu)
  
  dat.reg.hypt.poor32.edu <- dat.reg.hypt.poor32.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32.edu <- dat.reg.hypt.poor32.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor32.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor32.edu, family=poisson(link="log"),design=svy.hypt.pop.poor32.edu )
  
  univar.hypt.poor32.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor32.edu.rr)
  univar.hypt.poor32.edu.rr <- as.data.frame(univar.hypt.poor32.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor32.edu.rr$coef <- coefficients
  univar.hypt.poor32.edu.rr <- univar.hypt.poor32.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor32.edu.rr, "univar.hypt.poor32.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32.edu))
  univar.hypt.poor32.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor32.edu.ame, "univar.hypt.poor32.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.hypt.poor32.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor32==1) 
  dat.reg.hypt.poor32.edu.sex <- filter(dat.reg.hypt.poor32.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor32.edu.sex <- filter(dat.reg.hypt.poor32.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor32.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor32.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor32.edu.sex)
  
  dat.reg.hypt.poor32.edu.sex <- dat.reg.hypt.poor32.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32.edu.sex <- dat.reg.hypt.poor32.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor32.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32.edu.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.hypt.poor32.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor32.edu.sex )
  
  multivar.hypt.poor32.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor32.rr)
  multivar.hypt.poor32.rr <- as.data.frame(multivar.hypt.poor32.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor32.rr$coef <- coefficients
  multivar.hypt.poor32.rr <- multivar.hypt.poor32.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor32.rr, "multivar.hypt.poor32.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32.edu.sex))
  multivar.hypt.poor32.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor32.ame, "multivar.hypt.poor32.ame.xlsx")

#urban sample
#sex
  dat.reg.hypt.poor32.urban.sex <- dat.reg.hypt %>%dplyr::filter(poor32==1) 
  dat.reg.hypt.poor32.urban.sex <- filter(dat.reg.hypt.poor32.urban.sex, is.na(female_lab)==F)
  dat.reg.hypt.poor32.urban.sex <- filter(dat.reg.hypt.poor32.urban.sex, is.na(urban_lab)==F)
  
    x2 <- dat.reg.hypt.poor32.urban.sex %>%
      group_by(country) %>%
      filter(all_hypt==1) %>%
      summarise(comb=n()) %>%
      filter(any(comb>0)) %>%
      select(country) 
  
  dat.reg.hypt.poor32.urban.sex <- x2 %>% left_join(dat.reg.hypt.poor32.urban.sex)
  
  dat.reg.hypt.poor32.urban.sex <- dat.reg.hypt.poor32.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32.urban.sex <- dat.reg.hypt.poor32.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor32.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32.urban.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor32.urban.sex, family=poisson(link="log"),design=svy.hypt.pop.poor32.urban.sex )
  
  univar.hypt.poor32.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor32.sex.urban.rr)
  univar.hypt.poor32.sex.urban.rr <- as.data.frame(univar.hypt.poor32.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor32.sex.urban.rr$coef <- coefficients
  univar.hypt.poor32.sex.urban.rr <- univar.hypt.poor32.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor32.sex.urban.rr, "univar.hypt.poor32.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32.urban.sex))
  univar.hypt.poor32.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor32.sex.urban.ame, "univar.hypt.poor32.sex.urban.ame.xls")

# educat
  dat.reg.hypt.poor32.urban.edu <- dat.reg.hypt %>%dplyr::filter(poor32==1) 
  dat.reg.hypt.poor32.urban.edu <- filter(dat.reg.hypt.poor32.urban.edu, is.na(educat_lab)==F)
  dat.reg.hypt.poor32.urban.edu <- filter(dat.reg.hypt.poor32.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor32.urban.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor32.urban.edu <- x2 %>% left_join(dat.reg.hypt.poor32.urban.edu)
  
  dat.reg.hypt.poor32.urban.edu <- dat.reg.hypt.poor32.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32.urban.edu <- dat.reg.hypt.poor32.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor32.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32.urban.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor32.urban.edu, family=poisson(link="log"),design=svy.hypt.pop.poor32.urban.edu )
  
  univar.hypt.poor32.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor32.edu.urban.rr)
  univar.hypt.poor32.edu.urban.rr <- as.data.frame(univar.hypt.poor32.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor32.edu.urban.rr$coef <- coefficients
  univar.hypt.poor32.edu.urban.rr <- univar.hypt.poor32.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor32.edu.urban.rr, "univar.hypt.poor32.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32.urban.edu))
  univar.hypt.poor32.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor32.edu.urban.ame, "univar.hypt.poor32.edu.urban.ame.xls")

#urban
  dat.reg.hypt.poor32.urban <- dat.reg.hypt %>%dplyr::filter(poor32==1)  
  dat.reg.hypt.poor32.urban <- filter(dat.reg.hypt.poor32.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor32.urban %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor32.urban <- x2 %>% left_join(dat.reg.hypt.poor32.urban)
  
  dat.reg.hypt.poor32.urban <- dat.reg.hypt.poor32.urban %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32.urban <- dat.reg.hypt.poor32.urban %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor32.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32.urban , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.hypt.poor32.urban, family=poisson(link="log"),design=svy.hypt.pop.poor32.urban )
  
  univar.hypt.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor32.urban.rr)
  univar.hypt.poor32.urban.rr <- as.data.frame(univar.hypt.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor32.urban.rr$coef <- coefficients
  univar.hypt.poor32.urban.rr <- univar.hypt.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor32.urban.rr, "univar.hypt.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32.urban))
  univar.hypt.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor32.urban.ame, "univar.hypt.poor32.urban.ame.xls")

###multivariate: edu, sex, urban
  dat.reg.hypt.poor32.urban.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor32==1)  
  dat.reg.hypt.poor32.urban.edu.sex <- filter(dat.reg.hypt.poor32.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.hypt.poor32.urban.edu.sex <- filter(dat.reg.hypt.poor32.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor32.urban.edu.sex <- filter(dat.reg.hypt.poor32.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor32.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor32.urban.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor32.urban.edu.sex)
  
  dat.reg.hypt.poor32.urban.edu.sex <- dat.reg.hypt.poor32.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor32.urban.edu.sex <- dat.reg.hypt.poor32.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor32.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor32.urban.edu.sex , 
                                                 nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.hypt.poor32.urban.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor32.urban.edu.sex )
  
  multivar.hypt.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor32.urban.rr)
  multivar.hypt.poor32.urban.rr <- as.data.frame(multivar.hypt.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor32.urban.rr$coef <- coefficients
  multivar.hypt.poor32.urban.rr <- multivar.hypt.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor32.urban.rr, "multivar.hypt.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor32.urban.edu.sex))
  multivar.hypt.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor32.urban.ame, "multivar.hypt.poor32.urban.ame.xls")

###poor55
#no urban sample

#sex
  dat.reg.hypt.poor55 <- dat.reg.hypt %>% dplyr::filter(poor55==1) 
  dat.reg.hypt.poor55 <- filter(dat.reg.hypt.poor55, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor55 %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55 <- x2 %>% left_join(dat.reg.hypt.poor55)
  
  dat.reg.hypt.poor55 <- dat.reg.hypt.poor55 %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55 <- dat.reg.hypt.poor55 %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55 , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor55, family=poisson(link="log"),design=svy.hypt.pop.poor55 )
  
  univar.hypt.poor55.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor55.sex.rr)
  univar.hypt.poor55.sex.rr <- as.data.frame(univar.hypt.poor55.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor55.sex.rr$coef <- coefficients
  univar.hypt.poor55.sex.rr <- univar.hypt.poor55.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor55.sex.rr, "univar.hypt.poor55.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55))
  univar.hypt.poor55.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor55.sex.ame, "univar.hypt.poor55.sex.ame.xls")

#educat
  dat.reg.hypt.poor55.edu <- dat.reg.hypt %>% dplyr::filter(poor55==1) 
  dat.reg.hypt.poor55.edu <- filter(dat.reg.hypt.poor55.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.hypt.poor55.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55.edu <- x2 %>% left_join(dat.reg.hypt.poor55.edu)
  
  dat.reg.hypt.poor55.edu <- dat.reg.hypt.poor55.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55.edu <- dat.reg.hypt.poor55.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor55.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor55.edu, family=poisson(link="log"),design=svy.hypt.pop.poor55.edu )
  
  univar.hypt.poor55.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor55.edu.rr)
  univar.hypt.poor55.edu.rr <- as.data.frame(univar.hypt.poor55.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor55.edu.rr$coef <- coefficients
  univar.hypt.poor55.edu.rr <- univar.hypt.poor55.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor55.edu.rr, "univar.hypt.poor55.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55.edu))
  univar.hypt.poor55.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor55.edu.ame, "univar.hypt.poor55.edu.ame.xls")

###multivariate: edu, sex
  dat.reg.hypt.poor55.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor55==1) 
  dat.reg.hypt.poor55.edu.sex <- filter(dat.reg.hypt.poor55.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor55.edu.sex <- filter(dat.reg.hypt.poor55.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor55.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor55.edu.sex)
  
  dat.reg.hypt.poor55.edu.sex <- dat.reg.hypt.poor55.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55.edu.sex <- dat.reg.hypt.poor55.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor55.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55.edu.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.hypt.poor55.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor55.edu.sex )
  
  multivar.hypt.poor55.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor55.rr)
  multivar.hypt.poor55.rr <- as.data.frame(multivar.hypt.poor55.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor55.rr$coef <- coefficients
  multivar.hypt.poor55.rr <- multivar.hypt.poor55.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor55.rr, "multivar.hypt.poor55.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55.edu.sex))
  multivar.hypt.poor55.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor55.ame, "multivar.hypt.poor55.ame.xls")

#urban sample
#sex
  dat.reg.hypt.poor55.urban.sex <- dat.reg.hypt %>%dplyr::filter(poor55==1) 
  dat.reg.hypt.poor55.urban.sex <- filter(dat.reg.hypt.poor55.urban.sex, is.na(female_lab)==F)
  dat.reg.hypt.poor55.urban.sex <- filter(dat.reg.hypt.poor55.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor55.urban.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55.urban.sex <- x2 %>% left_join(dat.reg.hypt.poor55.urban.sex)
  
  dat.reg.hypt.poor55.urban.sex <- dat.reg.hypt.poor55.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55.urban.sex <- dat.reg.hypt.poor55.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor55.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55.urban.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor55.urban.sex, family=poisson(link="log"),design=svy.hypt.pop.poor55.urban.sex )
  
  univar.hypt.poor55.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor55.sex.urban.rr)
  univar.hypt.poor55.sex.urban.rr <- as.data.frame(univar.hypt.poor55.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor55.sex.urban.rr$coef <- coefficients
  univar.hypt.poor55.sex.urban.rr <- univar.hypt.poor55.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor55.sex.urban.rr, "univar.hypt.poor55.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55.urban.sex))
  univar.hypt.poor55.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor55.sex.urban.ame, "univar.hypt.poor55.sex.urban.ame.xls")

#educat
  dat.reg.hypt.poor55.urban.edu <- dat.reg.hypt %>%dplyr::filter(poor55==1) 
  dat.reg.hypt.poor55.urban.edu <- filter(dat.reg.hypt.poor55.urban.edu, is.na(educat_lab)==F)
  dat.reg.hypt.poor55.urban.edu <- filter(dat.reg.hypt.poor55.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor55.urban.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55.urban.edu <- x2 %>% left_join(dat.reg.hypt.poor55.urban.edu)
  
  dat.reg.hypt.poor55.urban.edu <- dat.reg.hypt.poor55.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55.urban.edu <- dat.reg.hypt.poor55.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor55.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55.urban.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor55.urban.edu, family=poisson(link="log"),design=svy.hypt.pop.poor55.urban.edu )
  
  univar.hypt.poor55.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor55.edu.urban.rr)
  univar.hypt.poor55.edu.urban.rr <- as.data.frame(univar.hypt.poor55.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor55.edu.urban.rr$coef <- coefficients
  univar.hypt.poor55.edu.urban.rr <- univar.hypt.poor55.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor55.edu.urban.rr, "univar.hypt.poor55.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55.urban.edu))
  univar.hypt.poor55.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor55.edu.urban.ame, "univar.hypt.poor55.edu.urban.ame.xls")

#urban
  dat.reg.hypt.poor55.urban <- dat.reg.hypt %>%dplyr::filter(poor55==1)  
  dat.reg.hypt.poor55.urban <- filter(dat.reg.hypt.poor55.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor55.urban %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55.urban <- x2 %>% left_join(dat.reg.hypt.poor55.urban)
  
  dat.reg.hypt.poor55.urban <- dat.reg.hypt.poor55.urban %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55.urban <- dat.reg.hypt.poor55.urban %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor55.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55.urban , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.hypt.poor55.urban, family=poisson(link="log"),design=svy.hypt.pop.poor55.urban )
  
  univar.hypt.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor55.urban.rr)
  univar.hypt.poor55.urban.rr <- as.data.frame(univar.hypt.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor55.urban.rr$coef <- coefficients
  univar.hypt.poor55.urban.rr <- univar.hypt.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor55.urban.rr, "univar.hypt.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55.urban))
  univar.hypt.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor55.urban.ame, "univar.hypt.poor55.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.hypt.poor55.urban.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor55==1)  
  dat.reg.hypt.poor55.urban.edu.sex <- filter(dat.reg.hypt.poor55.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.hypt.poor55.urban.edu.sex <- filter(dat.reg.hypt.poor55.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor55.urban.edu.sex <- filter(dat.reg.hypt.poor55.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor55.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor55.urban.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor55.urban.edu.sex)
  
  dat.reg.hypt.poor55.urban.edu.sex <- dat.reg.hypt.poor55.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor55.urban.edu.sex <- dat.reg.hypt.poor55.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor55.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor55.urban.edu.sex , 
                                                 nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.hypt.poor55.urban.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor55.urban.edu.sex )
  
  multivar.hypt.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor55.urban.rr)
  multivar.hypt.poor55.urban.rr <- as.data.frame(multivar.hypt.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor55.urban.rr$coef <- coefficients
  multivar.hypt.poor55.urban.rr <- multivar.hypt.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor55.urban.rr, "multivar.hypt.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor55.urban.edu.sex))
  multivar.hypt.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor55.urban.ame, "multivar.hypt.poor55.urban.ame.xls")


###nonpoor
#no urban sample

#sex
  dat.reg.hypt.poor0 <- dat.reg.hypt %>% dplyr::filter(poor55==0) 
  dat.reg.hypt.poor0 <- filter(dat.reg.hypt.poor0, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor0 %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0 <- x2 %>% left_join(dat.reg.hypt.poor0)
  
  dat.reg.hypt.poor0 <- dat.reg.hypt.poor0 %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0 <- dat.reg.hypt.poor0 %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0 , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor0, family=poisson(link="log"),design=svy.hypt.pop.poor0 )
  
  univar.hypt.poor0.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor0.sex.rr)
  univar.hypt.poor0.sex.rr <- as.data.frame(univar.hypt.poor0.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor0.sex.rr$coef <- coefficients
  univar.hypt.poor0.sex.rr <- univar.hypt.poor0.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor0.sex.rr, "univar.hypt.poor0.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0))
  univar.hypt.poor0.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor0.sex.ame, "univar.hypt.poor0.sex.ame.xls")

#educat
  dat.reg.hypt.poor0.edu <- dat.reg.hypt %>% dplyr::filter(poor55==0)  
  dat.reg.hypt.poor0.edu <- filter(dat.reg.hypt.poor0.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.hypt.poor0.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0.edu <- x2 %>% left_join(dat.reg.hypt.poor0.edu)
  
  dat.reg.hypt.poor0.edu <- dat.reg.hypt.poor0.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0.edu <- dat.reg.hypt.poor0.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor0.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor0.edu, family=poisson(link="log"),design=svy.hypt.pop.poor0.edu )
  
  univar.hypt.poor0.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor0.edu.rr)
  univar.hypt.poor0.edu.rr <- as.data.frame(univar.hypt.poor0.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor0.edu.rr$coef <- coefficients
  univar.hypt.poor0.edu.rr <- univar.hypt.poor0.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor0.edu.rr, "univar.hypt.poor0.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0.edu))
  univar.hypt.poor0.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor0.edu.ame, "univar.hypt.poor0.edu.ame.xls")

###multivariate: edu, sex
  dat.reg.hypt.poor0.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor55==0) 
  dat.reg.hypt.poor0.edu.sex <- filter(dat.reg.hypt.poor0.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor0.edu.sex <- filter(dat.reg.hypt.poor0.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor0.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor0.edu.sex)
  
  dat.reg.hypt.poor0.edu.sex <- dat.reg.hypt.poor0.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0.edu.sex <- dat.reg.hypt.poor0.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor0.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0.edu.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.hypt.poor0.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor0.edu.sex )
  
  multivar.hypt.poor0.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor0.rr)
  multivar.hypt.poor0.rr <- as.data.frame(multivar.hypt.poor0.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor0.rr$coef <- coefficients
  multivar.hypt.poor0.rr <- multivar.hypt.poor0.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor0.rr, "multivar.hypt.poor0.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0.edu.sex))
  multivar.hypt.poor0.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor0.ame, "multivar.hypt.poor0.ame.xls")

#urban sample
#sex
  dat.reg.hypt.poor0.urban.sex <- dat.reg.hypt %>%dplyr::filter(poor55==0) 
  dat.reg.hypt.poor0.urban.sex <- filter(dat.reg.hypt.poor0.urban.sex, is.na(female_lab)==F)
  dat.reg.hypt.poor0.urban.sex <- filter(dat.reg.hypt.poor0.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor0.urban.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0.urban.sex <- x2 %>% left_join(dat.reg.hypt.poor0.urban.sex)
  
  dat.reg.hypt.poor0.urban.sex <- dat.reg.hypt.poor0.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0.urban.sex <- dat.reg.hypt.poor0.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor0.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0.urban.sex , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.hypt.poor0.urban.sex, family=poisson(link="log"),design=svy.hypt.pop.poor0.urban.sex )
  
  univar.hypt.poor0.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor0.sex.urban.rr)
  univar.hypt.poor0.sex.urban.rr <- as.data.frame(univar.hypt.poor0.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor0.sex.urban.rr$coef <- coefficients
  univar.hypt.poor0.sex.urban.rr <- univar.hypt.poor0.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor0.sex.urban.rr, "univar.hypt.poor0.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0.urban.sex))
  univar.hypt.poor0.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor0.sex.urban.ame, "univar.hypt.poor0.sex.urban.ame.xls")

#educat
  dat.reg.hypt.poor0.urban.edu <- dat.reg.hypt %>%dplyr::filter(poor55==0)  
  dat.reg.hypt.poor0.urban.edu <- filter(dat.reg.hypt.poor0.urban.edu, is.na(educat_lab)==F)
  dat.reg.hypt.poor0.urban.edu <- filter(dat.reg.hypt.poor0.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor0.urban.edu %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0.urban.edu <- x2 %>% left_join(dat.reg.hypt.poor0.urban.edu)
  
  dat.reg.hypt.poor0.urban.edu <- dat.reg.hypt.poor0.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0.urban.edu <- dat.reg.hypt.poor0.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor0.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0.urban.edu , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.hypt.poor0.urban.edu, family=poisson(link="log"),design=svy.hypt.pop.poor0.urban.edu )
  
  univar.hypt.poor0.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor0.edu.urban.rr)
  univar.hypt.poor0.edu.urban.rr <- as.data.frame(univar.hypt.poor0.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor0.edu.urban.rr$coef <- coefficients
  univar.hypt.poor0.edu.urban.rr <- univar.hypt.poor0.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor0.edu.urban.rr, "univar.hypt.poor0.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0.urban.edu))
  univar.hypt.poor0.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor0.edu.urban.ame, "univar.hypt.poor0.edu.urban.ame.xls")

#urban
  dat.reg.hypt.poor0.urban <- dat.reg.hypt %>%dplyr::filter(poor55==0)   
  dat.reg.hypt.poor0.urban <- filter(dat.reg.hypt.poor0.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.hypt.poor0.urban %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0.urban <- x2 %>% left_join(dat.reg.hypt.poor0.urban)
  
  dat.reg.hypt.poor0.urban <- dat.reg.hypt.poor0.urban %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0.urban <- dat.reg.hypt.poor0.urban %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.hypt.pop.poor0.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0.urban , nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.hypt.poor0.urban, family=poisson(link="log"),design=svy.hypt.pop.poor0.urban )
  
  univar.hypt.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.hypt.poor0.urban.rr)
  univar.hypt.poor0.urban.rr <- as.data.frame(univar.hypt.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.hypt.poor0.urban.rr$coef <- coefficients
  univar.hypt.poor0.urban.rr <- univar.hypt.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.hypt.poor0.urban.rr, "univar.hypt.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0.urban))
  univar.hypt.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.hypt.poor0.urban.ame, "univar.hypt.poor0.urban.ame.xls")

###multivariate: edu, sex, urban
  dat.reg.hypt.poor0.urban.edu.sex <- dat.reg.hypt %>% dplyr::filter(poor55==0)  
  dat.reg.hypt.poor0.urban.edu.sex <- filter(dat.reg.hypt.poor0.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.hypt.poor0.urban.edu.sex <- filter(dat.reg.hypt.poor0.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.hypt.poor0.urban.edu.sex <- filter(dat.reg.hypt.poor0.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.hypt.poor0.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_hypt==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.hypt.poor0.urban.edu.sex <- x2 %>% left_join(dat.reg.hypt.poor0.urban.edu.sex)
  
  dat.reg.hypt.poor0.urban.edu.sex <- dat.reg.hypt.poor0.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.hypt.poor0.urban.edu.sex <- dat.reg.hypt.poor0.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.hypt.pop.poor0.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.hypt.poor0.urban.edu.sex , 
                                                nest = T)
  
  models <- svyglm(all_hypt ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.hypt.poor0.urban.edu.sex, family=poisson(link="log"),design=svy.hypt.pop.poor0.urban.edu.sex )
  
  multivar.hypt.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.hypt.poor0.urban.rr)
  multivar.hypt.poor0.urban.rr <- as.data.frame(multivar.hypt.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.hypt.poor0.urban.rr$coef <- coefficients
  multivar.hypt.poor0.urban.rr <- multivar.hypt.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.hypt.poor0.urban.rr, "multivar.hypt.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.hypt.pop.poor0.urban.edu.sex))
  multivar.hypt.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.hypt.poor0.urban.ame, "multivar.hypt.poor0.urban.ame.xls")


```




```{r Regressions: Diabetes}

  dia_subset <- read.csv("~/dia_subset.csv", stringsAsFactors=F)
  dia_subset <- dia_subset[,-1]

#prepare regression 
  dat.reg.dia <- dia_subset %>% 
    dplyr::mutate(
      country = as.factor(country),
      region = as.factor(region),
      urban = as.factor(urban),
      sex = as.factor(sex))

  dat.reg.dia <- dat.reg.dia %>% 
    dplyr::mutate(female_lab = as.factor(
                            ifelse(sex=="1", "Female", 
                               ifelse(sex=="0", "Male", NA))),
                  urban_lab = as.factor(
                            ifelse(urban=="1", "urban", 
                               ifelse(urban=="0", "rural", NA))),
                           age_10yr_lab = as.factor(
                       ifelse(age>=15 & age<=24, "15-24",
                          ifelse(age>=25 & age<=34, "25-34",
                              ifelse(age>=35 & age<=44, "35-44",
                                  ifelse(age>=45 & age<=54, "45-54",
                                       ifelse(age>=55 & age<=64, "55-64",
                                            ifelse(age>=65, "65+", NA))))))),
                  age_5yr_lab = as.factor(
                             ifelse(age>=15 & age<=19, "15-19",
                                ifelse(age>=20 & age<=24, "20-24",
                                    ifelse(age>=25 & age<=29, "25-29",
                                        ifelse(age>=30 & age<=34, "30-34",
                                             ifelse(age>=35 & age<=39, "35-39",
                                                  ifelse(age>=40 & age<=44, "40-44",
                                                         ifelse(age>=45 & age<=49, "45-49", 
                                                                ifelse(age>=50 & age<=54, "50-54",
                                                                       ifelse(age>=55 & age<=59, "55-59",
                                                                              ifelse(age>=60 & age<=64, "60-64",
                                                                                     ifelse(age>=65, "65+", NA)))))))))))),
                  educat_lab = as.factor(
                                  ifelse(educat=="0", "No formal schooling", 
                                     ifelse(educat=="1", "Primary school",
                                            ifelse(educat=="2", "Primary school",
                                            ifelse(educat=='3', 'High school or above', 
                                                   ifelse(educat=="4", "High school or above",NA)))))))

  dat.reg.dia$educat_lab <- factor(dat.reg.dia$educat_lab, levels = c("No formal schooling", "Primary school", "High school or above"))

###global
#no urban sample

#sex
  dat.reg.dia.global <- filter(dat.reg.dia, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.global %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.global <- x2 %>% left_join(dat.reg.dia.global)
  
  dat.reg.dia.global <- dat.reg.dia.global %>% mutate(
    country = as.character(country))
  dat.reg.dia.global <- dat.reg.dia.global %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.global <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.global, family=poisson(link="log"),design=svy.dia.pop.global )
  
  univar.dia.global.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.global.sex.rr)
  univar.dia.global.sex.rr <- as.data.frame(univar.dia.global.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.global.sex.rr$coef <- coefficients
  univar.dia.global.sex.rr <- univar.dia.global.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.global.sex.rr, "univar.dia.global.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global))
  univar.dia.global.sex.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.global.sex.ame, "univar.dia.global.sex.ame.xlsx")

#educat
  dat.reg.dia.global.edu <- filter(dat.reg.dia, is.na(educat_lab)==F)
  
  x2 <- dat.reg.dia.global.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.global.edu <- x2 %>% left_join(dat.reg.dia.global.edu)
  
  dat.reg.dia.global.edu <- dat.reg.dia.global.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.edu <- dat.reg.dia.global.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.global.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.global.edu, family=poisson(link="log"),design=svy.dia.pop.global.edu )
  
  univar.dia.global.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.global.edu.rr)
  univar.dia.global.edu.rr <- as.data.frame(univar.dia.global.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.global.edu.rr$coef <- coefficients
  univar.dia.global.edu.rr <- univar.dia.global.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.global.edu.rr, "univar.dia.global.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global.edu))
  univar.dia.global.edu.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.global.edu.ame, "univar.dia.global.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.dia.global.edu.sex <- filter(dat.reg.dia, is.na(educat_lab)==F)
  dat.reg.dia.global.edu.sex <- filter(dat.reg.dia.global.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.global.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.global.edu.sex <- x2 %>% left_join(dat.reg.dia.global.edu.sex)
  
  dat.reg.dia.global.edu.sex <- dat.reg.dia.global.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.edu.sex <- dat.reg.dia.global.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.global.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.dia.global.edu.sex, family=poisson(link="log"),design=svy.dia.pop.global.edu.sex )
  
  multivar.dia.global.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.global.rr)
  multivar.dia.global.rr <- as.data.frame(multivar.dia.global.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.global.rr$coef <- coefficients
  multivar.dia.global.rr <- multivar.dia.global.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.global.rr, "multivar.dia.global.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global.edu.sex))
  multivar.dia.global.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.global.ame, "multivar.dia.global.ame.xlsx")

#urban sample
#sex
  dat.reg.dia.global.urban.sex <- filter(dat.reg.dia, is.na(female_lab)==F)
  dat.reg.dia.global.urban.sex <- filter(dat.reg.dia.global.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.global.urban.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.global.urban.sex <- x2 %>% left_join(dat.reg.dia.global.urban.sex)
  
  dat.reg.dia.global.urban.sex <- dat.reg.dia.global.urban.sex %>%
    mutate(country=as.character(country))
  dat.reg.dia.global.urban.sex <- dat.reg.dia.global.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.urban.sex <- dat.reg.dia.global.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.global.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global.urban.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.global.urban.sex, family=poisson(link="log"),design=svy.dia.pop.global.urban.sex )
  
  univar.dia.global.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.global.sex.urban.rr)
  univar.dia.global.sex.urban.rr <- as.data.frame(univar.dia.global.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.global.sex.urban.rr$coef <- coefficients
  univar.dia.global.sex.urban.rr <- univar.dia.global.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.global.sex.urban.rr, "univar.dia.global.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global.urban.sex))
  univar.dia.global.sex.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.global.sex.urban.ame, "univar.dia.global.sex.urban.ame.xlsx")

#educat
  dat.reg.dia.global.urban.edu <- filter(dat.reg.dia, is.na(educat_lab)==F)
  dat.reg.dia.global.urban.edu <- filter(dat.reg.dia.global.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.global.urban.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.global.urban.edu <- x2 %>% left_join(dat.reg.dia.global.urban.edu)
  
  dat.reg.dia.global.urban.edu <- dat.reg.dia.global.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.urban.edu <- dat.reg.dia.global.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.global.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global.urban.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.global.urban.edu, family=poisson(link="log"),design=svy.dia.pop.global.urban.edu )
  
  univar.dia.global.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.global.edu.urban.rr)
  univar.dia.global.edu.urban.rr <- as.data.frame(univar.dia.global.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.global.edu.urban.rr$coef <- coefficients
  univar.dia.global.edu.urban.rr <- univar.dia.global.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.global.edu.urban.rr, "univar.dia.global.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global.urban.edu))
  univar.dia.global.edu.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.global.edu.urban.ame, "univar.dia.global.edu.urban.ame.xlsx")

#urban
  dat.reg.dia.global.urban <- filter(dat.reg.dia, is.na(urban_lab)==F)
  
    x2 <- dat.reg.dia.global.urban %>%
      group_by(country) %>%
      filter(all_dia==1) %>%
      summarise(comb=n()) %>%
      filter(any(comb>0)) %>%
      select(country) 
  
  dat.reg.dia.global.urban <- x2 %>% left_join(dat.reg.dia.global.urban)
  
  dat.reg.dia.global.urban <- dat.reg.dia.global.urban %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.urban <- dat.reg.dia.global.urban %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.urban <- dat.reg.dia.global.urban %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.global.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global.urban , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.dia.global.urban, family=poisson(link="log"),design=svy.dia.pop.global.urban )
  
  univar.dia.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.global.urban.rr)
  univar.dia.global.urban.rr <- as.data.frame(univar.dia.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.global.urban.rr$coef <- coefficients
  univar.dia.global.urban.rr <- univar.dia.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.global.urban.rr, "univar.dia.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global.urban))
  univar.dia.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.global.urban.ame, "univar.dia.global.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.dia.global.urban.edu.sex <- filter(dat.reg.dia, is.na(urban_lab)==F)
  dat.reg.dia.global.urban.edu.sex <- filter(dat.reg.dia.global.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.global.urban.edu.sex <- filter(dat.reg.dia.global.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.global.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.global.urban.edu.sex <- x2 %>% left_join(dat.reg.dia.global.urban.edu.sex)
  
  dat.reg.dia.global.urban.edu.sex <- dat.reg.dia.global.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.urban.edu.sex <- dat.reg.dia.global.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.global.urban.edu.sex <- dat.reg.dia.global.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.global.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.global.urban.edu.sex ,nest
                                            = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.dia.global.urban.edu.sex, family=poisson(link="log"),design=svy.dia.pop.global.urban.edu.sex )
  
  multivar.dia.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.global.urban.rr)
  multivar.dia.global.urban.rr <- as.data.frame(multivar.dia.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.global.urban.rr$coef <- coefficients
  multivar.dia.global.urban.rr <- multivar.dia.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.global.urban.rr, "multivar.dia.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.global.urban.edu.sex))
  multivar.dia.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.global.urban.ame, "multivar.dia.global.urban.ame.xlsx")

### Poor19
#no urban sample

#sex
  dat.reg.dia.poor19 <- dat.reg.dia %>% dplyr::filter(poor19==1) 
  dat.reg.dia.poor19 <- filter(dat.reg.dia.poor19, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor19 %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19 <- x2 %>% left_join(dat.reg.dia.poor19)
  
  dat.reg.dia.poor19 <- dat.reg.dia.poor19 %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19 <- dat.reg.dia.poor19 %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19 , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab, data=dat.reg.dia.poor19, family=poisson(link="log"),design=svy.dia.pop.poor19 )
  
  univar.dia.poor19.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor19.sex.rr)
  univar.dia.poor19.sex.rr <- as.data.frame(univar.dia.poor19.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor19.sex.rr$coef <- coefficients
  univar.dia.poor19.sex.rr <- univar.dia.poor19.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor19.sex.rr, "univar.dia.poor19.sex.rr.xlsx")

#to get AME
  models <- margins(models,design=svy.dia.pop.poor19)
  univar.dia.poor19.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor19.sex.ame, "univar.dia.poor19.sex.ame.xlsx")

#educat
  dat.reg.dia.poor19.edu <- dat.reg.dia %>% dplyr::filter(poor19==1) 
  dat.reg.dia.poor19.edu <- filter(dat.reg.dia.poor19.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.dia.poor19.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19.edu <- x2 %>% left_join(dat.reg.dia.poor19.edu)
  
  dat.reg.dia.poor19.edu <- dat.reg.dia.poor19.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19.edu <- dat.reg.dia.poor19.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor19.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor19.edu, family=poisson(link="log"),design=svy.dia.pop.poor19.edu )
  
  univar.dia.poor19.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor19.edu.rr)
  univar.dia.poor19.edu.rr <- as.data.frame(univar.dia.poor19.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor19.edu.rr$coef <- coefficients
  univar.dia.poor19.edu.rr <- univar.dia.poor19.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor19.edu.rr, "univar.dia.poor19.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor19.edu))
  univar.dia.poor19.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor19.edu.ame, "univar.dia.poor19.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.dia.poor19.edu.sex <- dat.reg.dia %>% dplyr::filter(poor19==1) 
  dat.reg.dia.poor19.edu.sex <- filter(dat.reg.dia.poor19.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor19.edu.sex <- filter(dat.reg.dia.poor19.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor19.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19.edu.sex <- x2 %>% left_join(dat.reg.dia.poor19.edu.sex)
  
  dat.reg.dia.poor19.edu.sex <- dat.reg.dia.poor19.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19.edu.sex <- dat.reg.dia.poor19.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor19.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.dia.poor19.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor19.edu.sex )
  
  multivar.dia.poor19.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor19.edu.sex.rr)
  multivar.dia.poor19.edu.sex.rr <- as.data.frame(multivar.dia.poor19.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor19.edu.sex.rr$coef <- coefficients
  multivar.dia.poor19.edu.sex.rr <- multivar.dia.poor19.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor19.edu.sex.rr, "multivar.dia.poor19.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor19.edu.sex))
  multivar.dia.poor19.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor19.edu.sex.ame, "multivar.dia.poor19.edu.sex.ame.xlsx")

#urban sample
#sex
  dat.reg.dia.poor19.urban.sex <- dat.reg.dia %>%dplyr::filter(poor19==1) 
  dat.reg.dia.poor19.urban.sex <- filter(dat.reg.dia.poor19.urban.sex, is.na(female_lab)==F)
  dat.reg.dia.poor19.urban.sex <- filter(dat.reg.dia.poor19.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor19.urban.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19.urban.sex <- x2 %>% left_join(dat.reg.dia.poor19.urban.sex)
  
  dat.reg.dia.poor19.urban.sex <- dat.reg.dia.poor19.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19.urban.sex <- dat.reg.dia.poor19.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor19.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19.urban.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor19.urban.sex, family=poisson(link="log"),design=svy.dia.pop.poor19.urban.sex )
  
  univar.dia.poor19.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor19.sex.urban.rr)
  univar.dia.poor19.sex.urban.rr <- as.data.frame(univar.dia.poor19.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor19.sex.urban.rr$coef <- coefficients
  univar.dia.poor19.sex.urban.rr <- univar.dia.poor19.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor19.sex.urban.rr, "univar.dia.poor19.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor19.urban.sex))
  univar.dia.poor19.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor19.sex.urban.ame, "univar.dia.poor19.sex.urban.ame.xlsx")

#educat
  dat.reg.dia.poor19.urban.edu <- dat.reg.dia %>%dplyr::filter(poor19==1) 
  dat.reg.dia.poor19.urban.edu <- filter(dat.reg.dia.poor19.urban.edu, is.na(educat_lab)==F)
  dat.reg.dia.poor19.urban.edu <- filter(dat.reg.dia.poor19.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor19.urban.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19.urban.edu <- x2 %>% left_join(dat.reg.dia.poor19.urban.edu)
  
  dat.reg.dia.poor19.urban.edu <- dat.reg.dia.poor19.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19.urban.edu <- dat.reg.dia.poor19.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor19.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19.urban.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor19.urban.edu, family=poisson(link="log"),design=svy.dia.pop.poor19.urban.edu )
  
  univar.dia.poor19.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor19.edu.urban.rr)
  univar.dia.poor19.edu.urban.rr <- as.data.frame(univar.dia.poor19.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor19.edu.urban.rr$coef <- coefficients
  univar.dia.poor19.edu.urban.rr <- univar.dia.poor19.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor19.edu.urban.rr, "univar.dia.poor19.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor19.urban.edu))
  univar.dia.poor19.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor19.edu.urban.ame, "univar.dia.poor19.edu.urban.ame.xlsx")

#urban
  dat.reg.dia.poor19.urban <- dat.reg.dia %>%dplyr::filter(poor19==1)  
  dat.reg.dia.poor19.urban <- filter(dat.reg.dia.poor19.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor19.urban %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19.urban <- x2 %>% left_join(dat.reg.dia.poor19.urban)
  
  dat.reg.dia.poor19.urban <- dat.reg.dia.poor19.urban %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19.urban <- dat.reg.dia.poor19.urban %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor19.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19.urban , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.dia.poor19.urban, family=poisson(link="log"),design=svy.dia.pop.poor19.urban )
  
  univar.dia.poor19.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor19.urban.rr)
  univar.dia.poor19.urban.rr <- as.data.frame(univar.dia.poor19.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor19.urban.rr$coef <- coefficients
  univar.dia.poor19.urban.rr <- univar.dia.poor19.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor19.urban.rr, "univar.dia.poor19.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor19.urban))
  univar.dia.poor19.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor19.urban.ame, "univar.dia.poor19.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.dia.poor19.urban.edu.sex <- dat.reg.dia %>% dplyr::filter(poor19==1)  
  dat.reg.dia.poor19.urban.edu.sex <- filter(dat.reg.dia.poor19.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.dia.poor19.urban.edu.sex <- filter(dat.reg.dia.poor19.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor19.urban.edu.sex <- filter(dat.reg.dia.poor19.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor19.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor19.urban.edu.sex <- x2 %>% left_join(dat.reg.dia.poor19.urban.edu.sex)
  
  dat.reg.dia.poor19.urban.edu.sex <- dat.reg.dia.poor19.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor19.urban.edu.sex <- dat.reg.dia.poor19.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor19.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor19.urban.edu.sex , 
                                                nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.dia.poor19.urban.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor19.urban.edu.sex )
  
  multivar.dia.poor19.urban.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor19.urban.edu.sex.rr)
  multivar.dia.poor19.urban.edu.sex.rr <- as.data.frame(multivar.dia.poor19.urban.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor19.urban.edu.sex.rr$coef <- coefficients
  multivar.dia.poor19.urban.edu.sex.rr <- multivar.dia.poor19.urban.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor19.urban.edu.sex.rr, "multivar.dia.poor19.urban.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor19.urban.edu.sex))
  multivar.dia.poor19.urban.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor19.urban.edu.sex.ame, "multivar.dia.poor19.urban.edu.sex.ame.xlsx")

### poor32
#no urban sample

#sex
  dat.reg.dia.poor32 <- dat.reg.dia %>% dplyr::filter(poor32==1) 
  dat.reg.dia.poor32 <- filter(dat.reg.dia.poor32, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor32 %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32 <- x2 %>% left_join(dat.reg.dia.poor32)
  
  dat.reg.dia.poor32 <- dat.reg.dia.poor32 %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32 <- dat.reg.dia.poor32 %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32 , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor32, family=poisson(link="log"),design=svy.dia.pop.poor32 )
  
  univar.dia.poor32.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor32.sex.rr)
  univar.dia.poor32.sex.rr <- as.data.frame(univar.dia.poor32.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor32.sex.rr$coef <- coefficients
  univar.dia.poor32.sex.rr <- univar.dia.poor32.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor32.sex.rr, "univar.dia.poor32.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32))
  univar.dia.poor32.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor32.sex.ame, "univar.dia.poor32.sex.ame.xlsx")

# educat
  dat.reg.dia.poor32.edu <- dat.reg.dia %>% dplyr::filter(poor32==1) 
  dat.reg.dia.poor32.edu <- filter(dat.reg.dia.poor32.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.dia.poor32.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32.edu <- x2 %>% left_join(dat.reg.dia.poor32.edu)
  
  dat.reg.dia.poor32.edu <- dat.reg.dia.poor32.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32.edu <- dat.reg.dia.poor32.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor32.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor32.edu, family=poisson(link="log"),design=svy.dia.pop.poor32.edu )
  
  univar.dia.poor32.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor32.edu.rr)
  univar.dia.poor32.edu.rr <- as.data.frame(univar.dia.poor32.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor32.edu.rr$coef <- coefficients
  univar.dia.poor32.edu.rr <- univar.dia.poor32.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor32.edu.rr, "univar.dia.poor32.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32.edu))
  univar.dia.poor32.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor32.edu.ame, "univar.dia.poor32.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.dia.poor32.edu.sex <- dat.reg.dia %>% dplyr::filter(poor32==1) 
  dat.reg.dia.poor32.edu.sex <- filter(dat.reg.dia.poor32.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor32.edu.sex <- filter(dat.reg.dia.poor32.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor32.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32.edu.sex <- x2 %>% left_join(dat.reg.dia.poor32.edu.sex)
  
  dat.reg.dia.poor32.edu.sex <- dat.reg.dia.poor32.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32.edu.sex <- dat.reg.dia.poor32.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor32.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.dia.poor32.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor32.edu.sex )
  
  multivar.dia.poor32.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor32.rr)
  multivar.dia.poor32.rr <- as.data.frame(multivar.dia.poor32.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor32.rr$coef <- coefficients
  multivar.dia.poor32.rr <- multivar.dia.poor32.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor32.rr, "multivar.dia.poor32.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32.edu.sex))
  multivar.dia.poor32.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor32.ame, "multivar.dia.poor32.ame.xlsx")

#urban sample
#sex
  dat.reg.dia.poor32.urban.sex <- dat.reg.dia %>%dplyr::filter(poor32==1) 
  dat.reg.dia.poor32.urban.sex <- filter(dat.reg.dia.poor32.urban.sex, is.na(female_lab)==F)
  dat.reg.dia.poor32.urban.sex <- filter(dat.reg.dia.poor32.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor32.urban.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32.urban.sex <- x2 %>% left_join(dat.reg.dia.poor32.urban.sex)
  
  dat.reg.dia.poor32.urban.sex <- dat.reg.dia.poor32.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32.urban.sex <- dat.reg.dia.poor32.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor32.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32.urban.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor32.urban.sex, family=poisson(link="log"),design=svy.dia.pop.poor32.urban.sex )
  
  univar.dia.poor32.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor32.sex.urban.rr)
  univar.dia.poor32.sex.urban.rr <- as.data.frame(univar.dia.poor32.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor32.sex.urban.rr$coef <- coefficients
  univar.dia.poor32.sex.urban.rr <- univar.dia.poor32.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor32.sex.urban.rr, "univar.dia.poor32.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32.urban.sex))
  univar.dia.poor32.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor32.sex.urban.ame, "univar.dia.poor32.sex.urban.ame.xls")

#educat
  dat.reg.dia.poor32.urban.edu <- dat.reg.dia %>%dplyr::filter(poor32==1) 
  dat.reg.dia.poor32.urban.edu <- filter(dat.reg.dia.poor32.urban.edu, is.na(educat_lab)==F)
  dat.reg.dia.poor32.urban.edu <- filter(dat.reg.dia.poor32.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor32.urban.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32.urban.edu <- x2 %>% left_join(dat.reg.dia.poor32.urban.edu)
  
  dat.reg.dia.poor32.urban.edu <- dat.reg.dia.poor32.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32.urban.edu <- dat.reg.dia.poor32.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor32.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32.urban.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor32.urban.edu, family=poisson(link="log"),design=svy.dia.pop.poor32.urban.edu )
  
  univar.dia.poor32.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor32.edu.urban.rr)
  univar.dia.poor32.edu.urban.rr <- as.data.frame(univar.dia.poor32.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor32.edu.urban.rr$coef <- coefficients
  univar.dia.poor32.edu.urban.rr <- univar.dia.poor32.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor32.edu.urban.rr, "univar.dia.poor32.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32.urban.edu))
  univar.dia.poor32.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor32.edu.urban.ame, "univar.dia.poor32.edu.urban.ame.xls")

#urban
  dat.reg.dia.poor32.urban <- dat.reg.dia %>%dplyr::filter(poor32==1)  
  dat.reg.dia.poor32.urban <- filter(dat.reg.dia.poor32.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor32.urban %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32.urban <- x2 %>% left_join(dat.reg.dia.poor32.urban)
  
  dat.reg.dia.poor32.urban <- dat.reg.dia.poor32.urban %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32.urban <- dat.reg.dia.poor32.urban %>% mutate(
    country = as.factor(country))
  
#run survey design  
  svy.dia.pop.poor32.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32.urban , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.dia.poor32.urban, family=poisson(link="log"),design=svy.dia.pop.poor32.urban )
  
  univar.dia.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor32.urban.rr)
  univar.dia.poor32.urban.rr <- as.data.frame(univar.dia.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor32.urban.rr$coef <- coefficients
  univar.dia.poor32.urban.rr <- univar.dia.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor32.urban.rr, "univar.dia.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32.urban))
  univar.dia.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor32.urban.ame, "univar.dia.poor32.urban.ame.xls")

###multivariate: edu, sex, urban
  dat.reg.dia.poor32.urban.edu.sex <- dat.reg.dia %>% dplyr::filter(poor32==1)  
  dat.reg.dia.poor32.urban.edu.sex <- filter(dat.reg.dia.poor32.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.dia.poor32.urban.edu.sex <- filter(dat.reg.dia.poor32.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor32.urban.edu.sex <- filter(dat.reg.dia.poor32.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor32.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor32.urban.edu.sex <- x2 %>% left_join(dat.reg.dia.poor32.urban.edu.sex)
  
  dat.reg.dia.poor32.urban.edu.sex <- dat.reg.dia.poor32.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor32.urban.edu.sex <- dat.reg.dia.poor32.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor32.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor32.urban.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.dia.poor32.urban.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor32.urban.edu.sex )
  
  multivar.dia.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor32.urban.rr)
  multivar.dia.poor32.urban.rr <- as.data.frame(multivar.dia.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor32.urban.rr$coef <- coefficients
  multivar.dia.poor32.urban.rr <- multivar.dia.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor32.urban.rr, "multivar.dia.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor32.urban.edu.sex))
  multivar.dia.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor32.urban.ame, "multivar.dia.poor32.urban.ame.xls")

###poor55
#no urban sample

#sex
  dat.reg.dia.poor55 <- dat.reg.dia %>% dplyr::filter(poor55==1) 
  dat.reg.dia.poor55 <- filter(dat.reg.dia.poor55, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor55 %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55 <- x2 %>% left_join(dat.reg.dia.poor55)
  
  dat.reg.dia.poor55 <- dat.reg.dia.poor55 %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55 <- dat.reg.dia.poor55 %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55 , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor55, family=poisson(link="log"),design=svy.dia.pop.poor55 )
  
  univar.dia.poor55.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor55.sex.rr)
  univar.dia.poor55.sex.rr <- as.data.frame(univar.dia.poor55.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor55.sex.rr$coef <- coefficients
  univar.dia.poor55.sex.rr <- univar.dia.poor55.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor55.sex.rr, "univar.dia.poor55.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55))
  univar.dia.poor55.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor55.sex.ame, "univar.dia.poor55.sex.ame.xls")

# educat
  dat.reg.dia.poor55.edu <- dat.reg.dia %>% dplyr::filter(poor55==1) 
  dat.reg.dia.poor55.edu <- filter(dat.reg.dia.poor55.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.dia.poor55.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55.edu <- x2 %>% left_join(dat.reg.dia.poor55.edu)
  
  dat.reg.dia.poor55.edu <- dat.reg.dia.poor55.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55.edu <- dat.reg.dia.poor55.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor55.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor55.edu, family=poisson(link="log"),design=svy.dia.pop.poor55.edu )
  
  univar.dia.poor55.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor55.edu.rr)
  univar.dia.poor55.edu.rr <- as.data.frame(univar.dia.poor55.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor55.edu.rr$coef <- coefficients
  univar.dia.poor55.edu.rr <- univar.dia.poor55.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor55.edu.rr, "univar.dia.poor55.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55.edu))
  univar.dia.poor55.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor55.edu.ame, "univar.dia.poor55.edu.ame.xls")

###multivariate: edu, sex
  dat.reg.dia.poor55.edu.sex <- dat.reg.dia %>% dplyr::filter(poor55==1) 
  dat.reg.dia.poor55.edu.sex <- filter(dat.reg.dia.poor55.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor55.edu.sex <- filter(dat.reg.dia.poor55.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor55.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55.edu.sex <- x2 %>% left_join(dat.reg.dia.poor55.edu.sex)
  
  dat.reg.dia.poor55.edu.sex <- dat.reg.dia.poor55.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55.edu.sex <- dat.reg.dia.poor55.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor55.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.dia.poor55.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor55.edu.sex )
  
  multivar.dia.poor55.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor55.rr)
  multivar.dia.poor55.rr <- as.data.frame(multivar.dia.poor55.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor55.rr$coef <- coefficients
  multivar.dia.poor55.rr <- multivar.dia.poor55.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor55.rr, "multivar.dia.poor55.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55.edu.sex))
  multivar.dia.poor55.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor55.ame, "multivar.dia.poor55.ame.xls")

#urban sample
#sex
  dat.reg.dia.poor55.urban.sex <- dat.reg.dia %>%dplyr::filter(poor55==1) 
  dat.reg.dia.poor55.urban.sex <- filter(dat.reg.dia.poor55.urban.sex, is.na(female_lab)==F)
  dat.reg.dia.poor55.urban.sex <- filter(dat.reg.dia.poor55.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor55.urban.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55.urban.sex <- x2 %>% left_join(dat.reg.dia.poor55.urban.sex)
  
  dat.reg.dia.poor55.urban.sex <- dat.reg.dia.poor55.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55.urban.sex <- dat.reg.dia.poor55.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor55.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55.urban.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor55.urban.sex, family=poisson(link="log"),design=svy.dia.pop.poor55.urban.sex )
  
  univar.dia.poor55.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor55.sex.urban.rr)
  univar.dia.poor55.sex.urban.rr <- as.data.frame(univar.dia.poor55.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor55.sex.urban.rr$coef <- coefficients
  univar.dia.poor55.sex.urban.rr <- univar.dia.poor55.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor55.sex.urban.rr, "univar.dia.poor55.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55.urban.sex))
  univar.dia.poor55.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor55.sex.urban.ame, "univar.dia.poor55.sex.urban.ame.xls")

#educat
  dat.reg.dia.poor55.urban.edu <- dat.reg.dia %>%dplyr::filter(poor55==1) 
  dat.reg.dia.poor55.urban.edu <- filter(dat.reg.dia.poor55.urban.edu, is.na(educat_lab)==F)
  dat.reg.dia.poor55.urban.edu <- filter(dat.reg.dia.poor55.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor55.urban.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55.urban.edu <- x2 %>% left_join(dat.reg.dia.poor55.urban.edu)
  
  dat.reg.dia.poor55.urban.edu <- dat.reg.dia.poor55.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55.urban.edu <- dat.reg.dia.poor55.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor55.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55.urban.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor55.urban.edu, family=poisson(link="log"),design=svy.dia.pop.poor55.urban.edu )
  
  univar.dia.poor55.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor55.edu.urban.rr)
  univar.dia.poor55.edu.urban.rr <- as.data.frame(univar.dia.poor55.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor55.edu.urban.rr$coef <- coefficients
  univar.dia.poor55.edu.urban.rr <- univar.dia.poor55.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor55.edu.urban.rr, "univar.dia.poor55.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55.urban.edu))
  univar.dia.poor55.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor55.edu.urban.ame, "univar.dia.poor55.edu.urban.ame.xls")

#urban
  dat.reg.dia.poor55.urban <- dat.reg.dia %>%dplyr::filter(poor55==1)  
  dat.reg.dia.poor55.urban <- filter(dat.reg.dia.poor55.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor55.urban %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55.urban <- x2 %>% left_join(dat.reg.dia.poor55.urban)
  
  dat.reg.dia.poor55.urban <- dat.reg.dia.poor55.urban %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55.urban <- dat.reg.dia.poor55.urban %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor55.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55.urban , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.dia.poor55.urban, family=poisson(link="log"),design=svy.dia.pop.poor55.urban )
  
  univar.dia.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor55.urban.rr)
  univar.dia.poor55.urban.rr <- as.data.frame(univar.dia.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor55.urban.rr$coef <- coefficients
  univar.dia.poor55.urban.rr <- univar.dia.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor55.urban.rr, "univar.dia.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55.urban))
  univar.dia.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor55.urban.ame, "univar.dia.poor55.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.dia.poor55.urban.edu.sex <- dat.reg.dia %>% dplyr::filter(poor55==1)  
  dat.reg.dia.poor55.urban.edu.sex <- filter(dat.reg.dia.poor55.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.dia.poor55.urban.edu.sex <- filter(dat.reg.dia.poor55.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor55.urban.edu.sex <- filter(dat.reg.dia.poor55.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor55.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor55.urban.edu.sex <- x2 %>% left_join(dat.reg.dia.poor55.urban.edu.sex)
  
  dat.reg.dia.poor55.urban.edu.sex <- dat.reg.dia.poor55.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor55.urban.edu.sex <- dat.reg.dia.poor55.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor55.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor55.urban.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.dia.poor55.urban.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor55.urban.edu.sex )
  
  multivar.dia.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor55.urban.rr)
  multivar.dia.poor55.urban.rr <- as.data.frame(multivar.dia.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor55.urban.rr$coef <- coefficients
  multivar.dia.poor55.urban.rr <- multivar.dia.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor55.urban.rr, "multivar.dia.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor55.urban.edu.sex))
  multivar.dia.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor55.urban.ame, "multivar.dia.poor55.urban.ame.xls")

###nonpoor
#no urban sample

#sex
  dat.reg.dia.poor0 <- dat.reg.dia %>% dplyr::filter(poor55==0) 
  dat.reg.dia.poor0 <- filter(dat.reg.dia.poor0, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor0 %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0 <- x2 %>% left_join(dat.reg.dia.poor0)
  
  dat.reg.dia.poor0 <- dat.reg.dia.poor0 %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0 <- dat.reg.dia.poor0 %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0 , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor0, family=poisson(link="log"),design=svy.dia.pop.poor0 )
  
  univar.dia.poor0.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor0.sex.rr)
  univar.dia.poor0.sex.rr <- as.data.frame(univar.dia.poor0.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor0.sex.rr$coef <- coefficients
  univar.dia.poor0.sex.rr <- univar.dia.poor0.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor0.sex.rr, "univar.dia.poor0.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0))
  univar.dia.poor0.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor0.sex.ame, "univar.dia.poor0.sex.ame.xls")

#educat
  dat.reg.dia.poor0.edu <- dat.reg.dia %>% dplyr::filter(poor55==0)  
  dat.reg.dia.poor0.edu <- filter(dat.reg.dia.poor0.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.dia.poor0.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0.edu <- x2 %>% left_join(dat.reg.dia.poor0.edu)
  
  dat.reg.dia.poor0.edu <- dat.reg.dia.poor0.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0.edu <- dat.reg.dia.poor0.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor0.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor0.edu, family=poisson(link="log"),design=svy.dia.pop.poor0.edu )
  
  univar.dia.poor0.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor0.edu.rr)
  univar.dia.poor0.edu.rr <- as.data.frame(univar.dia.poor0.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor0.edu.rr$coef <- coefficients
  univar.dia.poor0.edu.rr <- univar.dia.poor0.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor0.edu.rr, "univar.dia.poor0.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0.edu))
  univar.dia.poor0.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor0.edu.ame, "univar.dia.poor0.edu.ame.xls")

###multivariate: edu, sex
  dat.reg.dia.poor0.edu.sex <- dat.reg.dia %>% dplyr::filter(poor55==0) 
  dat.reg.dia.poor0.edu.sex <- filter(dat.reg.dia.poor0.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor0.edu.sex <- filter(dat.reg.dia.poor0.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor0.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0.edu.sex <- x2 %>% left_join(dat.reg.dia.poor0.edu.sex)
  
  dat.reg.dia.poor0.edu.sex <- dat.reg.dia.poor0.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0.edu.sex <- dat.reg.dia.poor0.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor0.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.dia.poor0.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor0.edu.sex )
  
  multivar.dia.poor0.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor0.rr)
  multivar.dia.poor0.rr <- as.data.frame(multivar.dia.poor0.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor0.rr$coef <- coefficients
  multivar.dia.poor0.rr <- multivar.dia.poor0.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor0.rr, "multivar.dia.poor0.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0.edu.sex))
  multivar.dia.poor0.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor0.ame, "multivar.dia.poor0.ame.xls")

#urban sample
#sex
  dat.reg.dia.poor0.urban.sex <- dat.reg.dia %>%dplyr::filter(poor55==0) 
  dat.reg.dia.poor0.urban.sex <- filter(dat.reg.dia.poor0.urban.sex, is.na(female_lab)==F)
  dat.reg.dia.poor0.urban.sex <- filter(dat.reg.dia.poor0.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor0.urban.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0.urban.sex <- x2 %>% left_join(dat.reg.dia.poor0.urban.sex)
  
  dat.reg.dia.poor0.urban.sex <- dat.reg.dia.poor0.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0.urban.sex <- dat.reg.dia.poor0.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor0.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0.urban.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.dia.poor0.urban.sex, family=poisson(link="log"),design=svy.dia.pop.poor0.urban.sex )
  
  univar.dia.poor0.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor0.sex.urban.rr)
  univar.dia.poor0.sex.urban.rr <- as.data.frame(univar.dia.poor0.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor0.sex.urban.rr$coef <- coefficients
  univar.dia.poor0.sex.urban.rr <- univar.dia.poor0.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor0.sex.urban.rr, "univar.dia.poor0.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0.urban.sex))
  univar.dia.poor0.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor0.sex.urban.ame, "univar.dia.poor0.sex.urban.ame.xls")

#educat
  dat.reg.dia.poor0.urban.edu <- dat.reg.dia %>%dplyr::filter(poor55==0)  
  dat.reg.dia.poor0.urban.edu <- filter(dat.reg.dia.poor0.urban.edu, is.na(educat_lab)==F)
  dat.reg.dia.poor0.urban.edu <- filter(dat.reg.dia.poor0.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor0.urban.edu %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0.urban.edu <- x2 %>% left_join(dat.reg.dia.poor0.urban.edu)
  
  dat.reg.dia.poor0.urban.edu <- dat.reg.dia.poor0.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0.urban.edu <- dat.reg.dia.poor0.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.dia.pop.poor0.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0.urban.edu , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.dia.poor0.urban.edu, family=poisson(link="log"),design=svy.dia.pop.poor0.urban.edu )
  
  univar.dia.poor0.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor0.edu.urban.rr)
  univar.dia.poor0.edu.urban.rr <- as.data.frame(univar.dia.poor0.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor0.edu.urban.rr$coef <- coefficients
  univar.dia.poor0.edu.urban.rr <- univar.dia.poor0.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor0.edu.urban.rr, "univar.dia.poor0.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0.urban.edu))
  univar.dia.poor0.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor0.edu.urban.ame, "univar.dia.poor0.edu.urban.ame.xls")

#urban
  dat.reg.dia.poor0.urban <- dat.reg.dia %>%dplyr::filter(poor55==0)   
  dat.reg.dia.poor0.urban <- filter(dat.reg.dia.poor0.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.dia.poor0.urban %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0.urban <- x2 %>% left_join(dat.reg.dia.poor0.urban)
  
  dat.reg.dia.poor0.urban <- dat.reg.dia.poor0.urban %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0.urban <- dat.reg.dia.poor0.urban %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor0.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0.urban , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.dia.poor0.urban, family=poisson(link="log"),design=svy.dia.pop.poor0.urban )
  
  univar.dia.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.dia.poor0.urban.rr)
  univar.dia.poor0.urban.rr <- as.data.frame(univar.dia.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.dia.poor0.urban.rr$coef <- coefficients
  univar.dia.poor0.urban.rr <- univar.dia.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.dia.poor0.urban.rr, "univar.dia.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0.urban))
  univar.dia.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.dia.poor0.urban.ame, "univar.dia.poor0.urban.ame.xls")

###multivariate: edu, sex, urban
  dat.reg.dia.poor0.urban.edu.sex <- dat.reg.dia %>% dplyr::filter(poor55==0)  
  dat.reg.dia.poor0.urban.edu.sex <- filter(dat.reg.dia.poor0.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.dia.poor0.urban.edu.sex <- filter(dat.reg.dia.poor0.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.dia.poor0.urban.edu.sex <- filter(dat.reg.dia.poor0.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.dia.poor0.urban.edu.sex %>%
    group_by(country) %>%
    filter(all_dia==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.dia.poor0.urban.edu.sex <- x2 %>% left_join(dat.reg.dia.poor0.urban.edu.sex)
  
  dat.reg.dia.poor0.urban.edu.sex <- dat.reg.dia.poor0.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.dia.poor0.urban.edu.sex <- dat.reg.dia.poor0.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.dia.pop.poor0.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.dia.poor0.urban.edu.sex , nest = T)
  
  models <- svyglm(all_dia ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.dia.poor0.urban.edu.sex, family=poisson(link="log"),design=svy.dia.pop.poor0.urban.edu.sex )
  
  multivar.dia.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.dia.poor0.urban.rr)
  multivar.dia.poor0.urban.rr <- as.data.frame(multivar.dia.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.dia.poor0.urban.rr$coef <- coefficients
  multivar.dia.poor0.urban.rr <- multivar.dia.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.dia.poor0.urban.rr, "multivar.dia.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.dia.pop.poor0.urban.edu.sex))
  multivar.dia.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.dia.poor0.urban.ame, "multivar.dia.poor0.urban.ame.xls")

```




```{r Regressions: overweight}

  overw_subset <- read.csv("~/overw_subset.csv", stringsAsFactors=F)
  overw_subset <- overw_subset[,-1]

#prepare regression  
  dat.reg.overw <- overw_subset %>% 
    dplyr::mutate(
      country = as.factor(country),
      region = as.factor(region),
      urban = as.factor(urban),
      sex = as.factor(sex))
  
  dat.reg.overw <- dat.reg.overw %>% 
    dplyr::mutate(female_lab = as.factor(
                            ifelse(sex=="1", "Female", 
                               ifelse(sex=="0", "Male", NA))),
                  urban_lab = as.factor(
                            ifelse(urban=="1", "urban", 
                               ifelse(urban=="0", "rural", NA))),
                  age_10yr_lab = as.factor(
                       ifelse(age>=15 & age<=24, "15-24",
                          ifelse(age>=25 & age<=34, "25-34",
                              ifelse(age>=35 & age<=44, "35-44",
                                  ifelse(age>=45 & age<=54, "45-54",
                                       ifelse(age>=55 & age<=64, "55-64",
                                            ifelse(age>=65, "65+", NA
                                                   ))))))),
                  age_5yr_lab = as.factor(
                             ifelse(age>=15 & age<=19, "15-19",
                                ifelse(age>=20 & age<=24, "20-24",
                                    ifelse(age>=25 & age<=29, "25-29",
                                        ifelse(age>=30 & age<=34, "30-34",
                                             ifelse(age>=35 & age<=39, "35-39",
                                                  ifelse(age>=40 & age<=44, "40-44",
                                                         ifelse(age>=45 & age<=49, "45-49", 
                                                                ifelse(age>=50 & age<=54, "50-54",
                                                                       ifelse(age>=55 & age<=59, "55-59",
                                                                              ifelse(age>=60 & age<=64, "60-64",
                                                                                     ifelse(age>=65, "65+", NA)))))))))))),
                  educat_lab = as.factor(
                            ifelse(educat=="0", "No formal schooling", 
                               ifelse(educat=="1", "Primary school",
                                      ifelse(educat=="2", "Primary school",
                                      ifelse(educat=='3', 'High school or above', 
                                             ifelse(educat=="4", "High school or above",NA)))))))

  dat.reg.overw$educat_lab <- factor(dat.reg.overw$educat_lab, levels = c("No formal schooling", "Primary school", "High school or above"))

###global
#no urban sample

#sex
  dat.reg.overw.global <- filter(dat.reg.overw, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.global %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global <- x2 %>% left_join(dat.reg.overw.global)
  
  dat.reg.overw.global <- dat.reg.overw.global %>% mutate(
    country = as.character(country))
  dat.reg.overw.global <- dat.reg.overw.global %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.global <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.global, family=poisson(link="log"),design=svy.overw.pop.global )
  
  univar.overw.global.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.global.sex.rr)
  univar.overw.global.sex.rr <- as.data.frame(univar.overw.global.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.global.sex.rr$coef <- coefficients
  univar.overw.global.sex.rr <- univar.overw.global.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.global.sex.rr, "univar.overw.global.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global))
  univar.overw.global.sex.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.global.sex.ame, "univar.overw.global.sex.ame.xlsx")

#educat
  dat.reg.overw.global.edu <- filter(dat.reg.overw, is.na(educat_lab)==F)
  
  x2 <- dat.reg.overw.global.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global.edu <- x2 %>% left_join(dat.reg.overw.global.edu)
  
  dat.reg.overw.global.edu <- dat.reg.overw.global.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.global.edu <- dat.reg.overw.global.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.global.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global.edu , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.global.edu, family=poisson(link="log"),design=svy.overw.pop.global.edu )
  
  univar.overw.global.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.global.edu.rr)
  univar.overw.global.edu.rr <- as.data.frame(univar.overw.global.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.global.edu.rr$coef <- coefficients
  univar.overw.global.edu.rr <- univar.overw.global.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.global.edu.rr, "univar.overw.global.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global.edu))
  univar.overw.global.edu.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.global.edu.ame, "univar.overw.global.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.overw.global.edu.sex <- filter(dat.reg.overw, is.na(educat_lab)==F)
  dat.reg.overw.global.edu.sex <- filter(dat.reg.overw.global.edu.sex, is.na(female_lab)==F)
  x2 <- dat.reg.overw.global.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global.edu.sex <- x2 %>% left_join(dat.reg.overw.global.edu.sex)
  
  dat.reg.overw.global.edu.sex <- dat.reg.overw.global.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.global.edu.sex <- dat.reg.overw.global.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.global.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.overw.global.edu.sex, family=poisson(link="log"),design=svy.overw.pop.global.edu.sex )
  
  multivar.overw.global.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.global.rr)
  multivar.overw.global.rr <- as.data.frame(multivar.overw.global.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.global.rr$coef <- coefficients
  multivar.overw.global.rr <- multivar.overw.global.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.global.rr, "multivar.overw.global.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global.edu.sex))
  multivar.overw.global.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.global.ame, "multivar.overw.global.ame.xlsx")

#urban sample
#sex
  dat.reg.overw.global.urban.sex <- filter(dat.reg.overw, is.na(female_lab)==F)
  dat.reg.overw.global.urban.sex <- filter(dat.reg.overw.global.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.global.urban.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global.urban.sex <- x2 %>% left_join(dat.reg.overw.global.urban.sex)
  
  dat.reg.overw.global.urban.sex <- dat.reg.overw.global.urban.sex %>%
    mutate(country=as.character(country))
  dat.reg.overw.global.urban.sex <- dat.reg.overw.global.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.global.urban.sex <- dat.reg.overw.global.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.global.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global.urban.sex , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.global.urban.sex, family=poisson(link="log"),design=svy.overw.pop.global.urban.sex )
  
  univar.overw.global.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.global.sex.urban.rr)
  univar.overw.global.sex.urban.rr <- as.data.frame(univar.overw.global.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.global.sex.urban.rr$coef <- coefficients
  univar.overw.global.sex.urban.rr <- univar.overw.global.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.global.sex.urban.rr, "univar.overw.global.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global.urban.sex))
  univar.overw.global.sex.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.global.sex.urban.ame, "univar.overw.global.sex.urban.ame.xlsx")

#educat
  dat.reg.overw.global.urban.edu <- filter(dat.reg.overw, is.na(educat_lab)==F)
  dat.reg.overw.global.urban.edu <- filter(dat.reg.overw.global.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.global.urban.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global.urban.edu <- x2 %>% left_join(dat.reg.overw.global.urban.edu)
  
  
  dat.reg.overw.global.urban.edu <- dat.reg.overw.global.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.global.urban.edu <- dat.reg.overw.global.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.global.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global.urban.edu , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.global.urban.edu, family=poisson(link="log"),design=svy.overw.pop.global.urban.edu )
  
  univar.overw.global.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.global.edu.urban.rr)
  univar.overw.global.edu.urban.rr <- as.data.frame(univar.overw.global.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.global.edu.urban.rr$coef <- coefficients
  univar.overw.global.edu.urban.rr <- univar.overw.global.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.global.edu.urban.rr, "univar.overw.global.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global.urban.edu))
  univar.overw.global.edu.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.global.edu.urban.ame, "univar.overw.global.edu.urban.ame.xlsx")

#urban
  dat.reg.overw.global.urban <- filter(dat.reg.overw, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.global.urban %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global.urban <- x2 %>% left_join(dat.reg.overw.global.urban)
  
  dat.reg.overw.global.urban <- dat.reg.overw.global.urban %>% mutate(
    country = as.character(country))%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design    
  svy.overw.pop.global.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global.urban , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.overw.global.urban, family=poisson(link="log"),design=svy.overw.pop.global.urban )
  
  univar.overw.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.global.urban.rr)
  univar.overw.global.urban.rr <- as.data.frame(univar.overw.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.global.urban.rr$coef <- coefficients
  univar.overw.global.urban.rr <- univar.overw.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.global.urban.rr, "univar.overw.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global.urban))
  univar.overw.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.global.urban.ame, "univar.overw.global.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.overw.global.urban.edu.sex <- filter(dat.reg.overw, is.na(urban_lab)==F)
  dat.reg.overw.global.urban.edu.sex <- filter(dat.reg.overw.global.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.global.urban.edu.sex <- filter(dat.reg.overw.global.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.global.urban.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.global.urban.edu.sex <- x2 %>% left_join(dat.reg.overw.global.urban.edu.sex)
  
  dat.reg.overw.global.urban.edu.sex <- dat.reg.overw.global.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.global.urban.edu.sex <- dat.reg.overw.global.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.global.urban.edu.sex <- dat.reg.overw.global.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.global.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.global.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.overw.global.urban.edu.sex, family=poisson(link="log"),design=svy.overw.pop.global.urban.edu.sex )
  
  multivar.overw.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.global.urban.rr)
  multivar.overw.global.urban.rr <- as.data.frame(multivar.overw.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.global.urban.rr$coef <- coefficients
  multivar.overw.global.urban.rr <- multivar.overw.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.global.urban.rr, "multivar.overw.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.global.urban.edu.sex))
  multivar.overw.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.global.urban.ame, "multivar.overw.global.urban.ame.xlsx")

### Poor19
#no urban sample

#sex
  dat.reg.overw.poor19 <- dat.reg.overw %>% dplyr::filter(poor19==1) 
  dat.reg.overw.poor19 <- filter(dat.reg.overw.poor19, is.na(female_lab)==F)
  
  
  x2 <- dat.reg.overw.poor19 %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19 <- x2 %>% left_join(dat.reg.overw.poor19)
  
  dat.reg.overw.poor19 <- dat.reg.overw.poor19 %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19 <- dat.reg.overw.poor19 %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19 , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab, data=dat.reg.overw.poor19, family=poisson(link="log"),design=svy.overw.pop.poor19 )
  
  univar.overw.poor19.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor19.sex.rr)
  univar.overw.poor19.sex.rr <- as.data.frame(univar.overw.poor19.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor19.sex.rr$coef <- coefficients
  univar.overw.poor19.sex.rr <- univar.overw.poor19.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor19.sex.rr, "univar.overw.poor19.sex.rr.xlsx")

#to get AME
  models <- margins(models,design=svy.overw.pop.poor19)
  univar.overw.poor19.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor19.sex.ame, "univar.overw.poor19.sex.ame.xlsx")

#educat
  dat.reg.overw.poor19.edu <- dat.reg.overw %>% dplyr::filter(poor19==1) 
  dat.reg.overw.poor19.edu <- filter(dat.reg.overw.poor19.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.overw.poor19.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19.edu <- x2 %>% left_join(dat.reg.overw.poor19.edu)
  dat.reg.overw.poor19.edu <- dat.reg.overw.poor19.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19.edu <- dat.reg.overw.poor19.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor19.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19.edu , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor19.edu, family=poisson(link="log"),design=svy.overw.pop.poor19.edu )
  
  univar.overw.poor19.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor19.edu.rr)
  univar.overw.poor19.edu.rr <- as.data.frame(univar.overw.poor19.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor19.edu.rr$coef <- coefficients
  univar.overw.poor19.edu.rr <- univar.overw.poor19.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor19.edu.rr, "univar.overw.poor19.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor19.edu))
  univar.overw.poor19.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor19.edu.ame, "univar.overw.poor19.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.overw.poor19.edu.sex <- dat.reg.overw %>% dplyr::filter(poor19==1) 
  dat.reg.overw.poor19.edu.sex <- filter(dat.reg.overw.poor19.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor19.edu.sex <- filter(dat.reg.overw.poor19.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor19.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19.edu.sex <- x2 %>% left_join(dat.reg.overw.poor19.edu.sex)
  dat.reg.overw.poor19.edu.sex <- dat.reg.overw.poor19.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19.edu.sex <- dat.reg.overw.poor19.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor19.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.overw.poor19.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor19.edu.sex )
  
  multivar.overw.poor19.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor19.edu.sex.rr)
  multivar.overw.poor19.edu.sex.rr <- as.data.frame(multivar.overw.poor19.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor19.edu.sex.rr$coef <- coefficients
  multivar.overw.poor19.edu.sex.rr <- multivar.overw.poor19.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor19.edu.sex.rr, "multivar.overw.poor19.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor19.edu.sex))
  multivar.overw.poor19.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor19.edu.sex.ame, "multivar.overw.poor19.edu.sex.ame.xlsx")

#urban sample
#sex
  dat.reg.overw.poor19.urban.sex <- dat.reg.overw %>%dplyr::filter(poor19==1) 
  dat.reg.overw.poor19.urban.sex <- filter(dat.reg.overw.poor19.urban.sex, is.na(female_lab)==F)
  dat.reg.overw.poor19.urban.sex <- filter(dat.reg.overw.poor19.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor19.urban.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19.urban.sex <- x2 %>% left_join(dat.reg.overw.poor19.urban.sex)
  dat.reg.overw.poor19.urban.sex <- dat.reg.overw.poor19.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19.urban.sex <- dat.reg.overw.poor19.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor19.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19.urban.sex , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor19.urban.sex, family=poisson(link="log"),design=svy.overw.pop.poor19.urban.sex )
  
  univar.overw.poor19.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor19.sex.urban.rr)
  univar.overw.poor19.sex.urban.rr <- as.data.frame(univar.overw.poor19.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor19.sex.urban.rr$coef <- coefficients
  univar.overw.poor19.sex.urban.rr <- univar.overw.poor19.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor19.sex.urban.rr, "univar.overw.poor19.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor19.urban.sex))
  univar.overw.poor19.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor19.sex.urban.ame, "univar.overw.poor19.sex.urban.ame.xlsx")

# educat
  dat.reg.overw.poor19.urban.edu <- dat.reg.overw %>%dplyr::filter(poor19==1) 
  dat.reg.overw.poor19.urban.edu <- filter(dat.reg.overw.poor19.urban.edu, is.na(educat_lab)==F)
  dat.reg.overw.poor19.urban.edu <- filter(dat.reg.overw.poor19.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor19.urban.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19.urban.edu <- x2 %>% left_join(dat.reg.overw.poor19.urban.edu)
  dat.reg.overw.poor19.urban.edu <- dat.reg.overw.poor19.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19.urban.edu <- dat.reg.overw.poor19.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor19.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19.urban.edu , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor19.urban.edu, family=poisson(link="log"),design=svy.overw.pop.poor19.urban.edu )
  
  univar.overw.poor19.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor19.edu.urban.rr)
  univar.overw.poor19.edu.urban.rr <- as.data.frame(univar.overw.poor19.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor19.edu.urban.rr$coef <- coefficients
  univar.overw.poor19.edu.urban.rr <- univar.overw.poor19.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor19.edu.urban.rr, "univar.overw.poor19.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor19.urban.edu))
  univar.overw.poor19.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor19.edu.urban.ame, "univar.overw.poor19.edu.urban.ame.xlsx")

#urban
  dat.reg.overw.poor19.urban <- dat.reg.overw %>%dplyr::filter(poor19==1)  
  dat.reg.overw.poor19.urban <- filter(dat.reg.overw.poor19.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor19.urban %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19.urban <- x2 %>% left_join(dat.reg.overw.poor19.urban)
  dat.reg.overw.poor19.urban <- dat.reg.overw.poor19.urban %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19.urban <- dat.reg.overw.poor19.urban %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor19.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19.urban , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.overw.poor19.urban, family=poisson(link="log"),design=svy.overw.pop.poor19.urban )
  
  univar.overw.poor19.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor19.urban.rr)
  univar.overw.poor19.urban.rr <- as.data.frame(univar.overw.poor19.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor19.urban.rr$coef <- coefficients
  univar.overw.poor19.urban.rr <- univar.overw.poor19.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor19.urban.rr, "univar.overw.poor19.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor19.urban))
  univar.overw.poor19.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor19.urban.ame, "univar.overw.poor19.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.overw.poor19.urban.edu.sex <- dat.reg.overw %>% dplyr::filter(poor19==1)  
  dat.reg.overw.poor19.urban.edu.sex <- filter(dat.reg.overw.poor19.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.overw.poor19.urban.edu.sex <- filter(dat.reg.overw.poor19.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor19.urban.edu.sex <- filter(dat.reg.overw.poor19.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor19.urban.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor19.urban.edu.sex <- x2 %>% left_join(dat.reg.overw.poor19.urban.edu.sex)
  dat.reg.overw.poor19.urban.edu.sex <- dat.reg.overw.poor19.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor19.urban.edu.sex <- dat.reg.overw.poor19.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor19.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor19.urban.edu.sex ,
                                                nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.overw.poor19.urban.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor19.urban.edu.sex )
  
  multivar.overw.poor19.urban.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor19.urban.edu.sex.rr)
  multivar.overw.poor19.urban.edu.sex.rr <- as.data.frame(multivar.overw.poor19.urban.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor19.urban.edu.sex.rr$coef <- coefficients
  multivar.overw.poor19.urban.edu.sex.rr <- multivar.overw.poor19.urban.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor19.urban.edu.sex.rr, "multivar.overw.poor19.urban.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor19.urban.edu.sex))
  multivar.overw.poor19.urban.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor19.urban.edu.sex.ame, "multivar.overw.poor19.urban.edu.sex.ame.xlsx")

### poor32
#no urban sample

#sex
  dat.reg.overw.poor32 <- dat.reg.overw %>% dplyr::filter(poor32==1) 
  dat.reg.overw.poor32 <- filter(dat.reg.overw.poor32, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor32 %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32 <- x2 %>% left_join(dat.reg.overw.poor32)
  dat.reg.overw.poor32 <- dat.reg.overw.poor32 %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32 <- dat.reg.overw.poor32 %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32 , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor32, family=poisson(link="log"),design=svy.overw.pop.poor32 )
  
  univar.overw.poor32.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor32.sex.rr)
  univar.overw.poor32.sex.rr <- as.data.frame(univar.overw.poor32.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor32.sex.rr$coef <- coefficients
  univar.overw.poor32.sex.rr <- univar.overw.poor32.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor32.sex.rr, "univar.overw.poor32.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32))
  univar.overw.poor32.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor32.sex.ame, "univar.overw.poor32.sex.ame.xlsx")

#educat
  dat.reg.overw.poor32.edu <- dat.reg.overw %>% dplyr::filter(poor32==1) 
  dat.reg.overw.poor32.edu <- filter(dat.reg.overw.poor32.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.overw.poor32.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32.edu <- x2 %>% left_join(dat.reg.overw.poor32.edu)
  dat.reg.overw.poor32.edu <- dat.reg.overw.poor32.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32.edu <- dat.reg.overw.poor32.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor32.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32.edu , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor32.edu, family=poisson(link="log"),design=svy.overw.pop.poor32.edu )
  
  univar.overw.poor32.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor32.edu.rr)
  univar.overw.poor32.edu.rr <- as.data.frame(univar.overw.poor32.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor32.edu.rr$coef <- coefficients
  univar.overw.poor32.edu.rr <- univar.overw.poor32.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor32.edu.rr, "univar.overw.poor32.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32.edu))
  univar.overw.poor32.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor32.edu.ame, "univar.overw.poor32.edu.ame.xlsx")

###multivariate: edu, sex
  dat.reg.overw.poor32.edu.sex <- dat.reg.overw %>% dplyr::filter(poor32==1) 
  dat.reg.overw.poor32.edu.sex <- filter(dat.reg.overw.poor32.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor32.edu.sex <- filter(dat.reg.overw.poor32.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor32.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32.edu.sex <- x2 %>% left_join(dat.reg.overw.poor32.edu.sex)
  dat.reg.overw.poor32.edu.sex <- dat.reg.overw.poor32.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32.edu.sex <- dat.reg.overw.poor32.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor32.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.overw.poor32.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor32.edu.sex )
  
  multivar.overw.poor32.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor32.rr)
  multivar.overw.poor32.rr <- as.data.frame(multivar.overw.poor32.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor32.rr$coef <- coefficients
  multivar.overw.poor32.rr <- multivar.overw.poor32.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor32.rr, "multivar.overw.poor32.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32.edu.sex))
  multivar.overw.poor32.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor32.ame, "multivar.overw.poor32.ame.xlsx")

#urban sample
#sex
  dat.reg.overw.poor32.urban.sex <- dat.reg.overw %>%dplyr::filter(poor32==1) 
  dat.reg.overw.poor32.urban.sex <- filter(dat.reg.overw.poor32.urban.sex, is.na(female_lab)==F)
  dat.reg.overw.poor32.urban.sex <- filter(dat.reg.overw.poor32.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor32.urban.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32.urban.sex <- x2 %>% left_join(dat.reg.overw.poor32.urban.sex)
  dat.reg.overw.poor32.urban.sex <- dat.reg.overw.poor32.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32.urban.sex <- dat.reg.overw.poor32.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor32.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32.urban.sex , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor32.urban.sex, family=poisson(link="log"),design=svy.overw.pop.poor32.urban.sex )
  
  univar.overw.poor32.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor32.sex.urban.rr)
  univar.overw.poor32.sex.urban.rr <- as.data.frame(univar.overw.poor32.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor32.sex.urban.rr$coef <- coefficients
  univar.overw.poor32.sex.urban.rr <- univar.overw.poor32.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor32.sex.urban.rr, "univar.overw.poor32.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32.urban.sex))
  univar.overw.poor32.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor32.sex.urban.ame, "univar.overw.poor32.sex.urban.ame.xls")

# educat
  dat.reg.overw.poor32.urban.edu <- dat.reg.overw %>%dplyr::filter(poor32==1) 
  dat.reg.overw.poor32.urban.edu <- filter(dat.reg.overw.poor32.urban.edu, is.na(educat_lab)==F)
  dat.reg.overw.poor32.urban.edu <- filter(dat.reg.overw.poor32.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor32.urban.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32.urban.edu <- x2 %>% left_join(dat.reg.overw.poor32.urban.edu)
  dat.reg.overw.poor32.urban.edu <- dat.reg.overw.poor32.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32.urban.edu <- dat.reg.overw.poor32.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor32.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32.urban.edu , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor32.urban.edu, family=poisson(link="log"),design=svy.overw.pop.poor32.urban.edu )
  
  univar.overw.poor32.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor32.edu.urban.rr)
  univar.overw.poor32.edu.urban.rr <- as.data.frame(univar.overw.poor32.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor32.edu.urban.rr$coef <- coefficients
  univar.overw.poor32.edu.urban.rr <- univar.overw.poor32.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor32.edu.urban.rr, "univar.overw.poor32.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32.urban.edu))
  univar.overw.poor32.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor32.edu.urban.ame, "univar.overw.poor32.edu.urban.ame.xls")

#urban
  dat.reg.overw.poor32.urban <- dat.reg.overw %>%dplyr::filter(poor32==1)  
  dat.reg.overw.poor32.urban <- filter(dat.reg.overw.poor32.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor32.urban %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32.urban <- x2 %>% left_join(dat.reg.overw.poor32.urban)
  dat.reg.overw.poor32.urban <- dat.reg.overw.poor32.urban %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32.urban <- dat.reg.overw.poor32.urban %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor32.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32.urban , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.overw.poor32.urban, family=poisson(link="log"),design=svy.overw.pop.poor32.urban )
  
  univar.overw.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor32.urban.rr)
  univar.overw.poor32.urban.rr <- as.data.frame(univar.overw.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor32.urban.rr$coef <- coefficients
  univar.overw.poor32.urban.rr <- univar.overw.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor32.urban.rr, "univar.overw.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32.urban))
  univar.overw.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor32.urban.ame, "univar.overw.poor32.urban.ame.xls")

###multivariate: edu, sex, urban
  dat.reg.overw.poor32.urban.edu.sex <- dat.reg.overw %>% dplyr::filter(poor32==1)  
  dat.reg.overw.poor32.urban.edu.sex <- filter(dat.reg.overw.poor32.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.overw.poor32.urban.edu.sex <- filter(dat.reg.overw.poor32.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor32.urban.edu.sex <- filter(dat.reg.overw.poor32.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor32.urban.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor32.urban.edu.sex <- x2 %>% left_join(dat.reg.overw.poor32.urban.edu.sex)
  dat.reg.overw.poor32.urban.edu.sex <- dat.reg.overw.poor32.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor32.urban.edu.sex <- dat.reg.overw.poor32.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor32.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor32.urban.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.overw.poor32.urban.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor32.urban.edu.sex )
  
  multivar.overw.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor32.urban.rr)
  multivar.overw.poor32.urban.rr <- as.data.frame(multivar.overw.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor32.urban.rr$coef <- coefficients
  multivar.overw.poor32.urban.rr <- multivar.overw.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor32.urban.rr, "multivar.overw.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor32.urban.edu.sex))
  multivar.overw.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor32.urban.ame, "multivar.overw.poor32.urban.ame.xls")

###poor55
#no urban sample

#sex
  dat.reg.overw.poor55 <- dat.reg.overw %>% dplyr::filter(poor55==1) 
  dat.reg.overw.poor55 <- filter(dat.reg.overw.poor55, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor55 %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55 <- x2 %>% left_join(dat.reg.overw.poor55)
  dat.reg.overw.poor55 <- dat.reg.overw.poor55 %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55 <- dat.reg.overw.poor55 %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55 , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor55, family=poisson(link="log"),design=svy.overw.pop.poor55 )
  
  univar.overw.poor55.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor55.sex.rr)
  univar.overw.poor55.sex.rr <- as.data.frame(univar.overw.poor55.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor55.sex.rr$coef <- coefficients
  univar.overw.poor55.sex.rr <- univar.overw.poor55.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor55.sex.rr, "univar.overw.poor55.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55))
  univar.overw.poor55.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor55.sex.ame, "univar.overw.poor55.sex.ame.xls")

#educat
  dat.reg.overw.poor55.edu <- dat.reg.overw %>% dplyr::filter(poor55==1) 
  dat.reg.overw.poor55.edu <- filter(dat.reg.overw.poor55.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.overw.poor55.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55.edu <- x2 %>% left_join(dat.reg.overw.poor55.edu)
  dat.reg.overw.poor55.edu <- dat.reg.overw.poor55.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55.edu <- dat.reg.overw.poor55.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor55.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55.edu , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor55.edu, family=poisson(link="log"),design=svy.overw.pop.poor55.edu )
  
  univar.overw.poor55.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor55.edu.rr)
  univar.overw.poor55.edu.rr <- as.data.frame(univar.overw.poor55.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor55.edu.rr$coef <- coefficients
  univar.overw.poor55.edu.rr <- univar.overw.poor55.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor55.edu.rr, "univar.overw.poor55.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55.edu))
  univar.overw.poor55.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor55.edu.ame, "univar.overw.poor55.edu.ame.xls")

###multivariate: edu, sex
  dat.reg.overw.poor55.edu.sex <- dat.reg.overw %>% dplyr::filter(poor55==1) 
  dat.reg.overw.poor55.edu.sex <- filter(dat.reg.overw.poor55.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor55.edu.sex <- filter(dat.reg.overw.poor55.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor55.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55.edu.sex <- x2 %>% left_join(dat.reg.overw.poor55.edu.sex)
  dat.reg.overw.poor55.edu.sex <- dat.reg.overw.poor55.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55.edu.sex <- dat.reg.overw.poor55.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor55.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.overw.poor55.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor55.edu.sex )
  
  multivar.overw.poor55.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor55.rr)
  multivar.overw.poor55.rr <- as.data.frame(multivar.overw.poor55.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor55.rr$coef <- coefficients
  multivar.overw.poor55.rr <- multivar.overw.poor55.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor55.rr, "multivar.overw.poor55.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55.edu.sex))
  multivar.overw.poor55.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor55.ame, "multivar.overw.poor55.ame.xls")

#urban sample
#sex
  dat.reg.overw.poor55.urban.sex <- dat.reg.overw %>%dplyr::filter(poor55==1) 
  dat.reg.overw.poor55.urban.sex <- filter(dat.reg.overw.poor55.urban.sex, is.na(female_lab)==F)
  dat.reg.overw.poor55.urban.sex <- filter(dat.reg.overw.poor55.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor55.urban.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55.urban.sex <- x2 %>% left_join(dat.reg.overw.poor55.urban.sex)
  dat.reg.overw.poor55.urban.sex <- dat.reg.overw.poor55.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55.urban.sex <- dat.reg.overw.poor55.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor55.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55.urban.sex , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor55.urban.sex, family=poisson(link="log"),design=svy.overw.pop.poor55.urban.sex )
  
  univar.overw.poor55.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor55.sex.urban.rr)
  univar.overw.poor55.sex.urban.rr <- as.data.frame(univar.overw.poor55.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor55.sex.urban.rr$coef <- coefficients
  univar.overw.poor55.sex.urban.rr <- univar.overw.poor55.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor55.sex.urban.rr, "univar.overw.poor55.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55.urban.sex))
  univar.overw.poor55.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor55.sex.urban.ame, "univar.overw.poor55.sex.urban.ame.xls")

#educat
  dat.reg.overw.poor55.urban.edu <- dat.reg.overw %>%dplyr::filter(poor55==1) 
  dat.reg.overw.poor55.urban.edu <- filter(dat.reg.overw.poor55.urban.edu, is.na(educat_lab)==F)
  dat.reg.overw.poor55.urban.edu <- filter(dat.reg.overw.poor55.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor55.urban.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55.urban.edu <- x2 %>% left_join(dat.reg.overw.poor55.urban.edu)
  dat.reg.overw.poor55.urban.edu <- dat.reg.overw.poor55.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55.urban.edu <- dat.reg.overw.poor55.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor55.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55.urban.edu , nest = 
                                                T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor55.urban.edu, family=poisson(link="log"),design=svy.overw.pop.poor55.urban.edu )
  
  univar.overw.poor55.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor55.edu.urban.rr)
  univar.overw.poor55.edu.urban.rr <- as.data.frame(univar.overw.poor55.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor55.edu.urban.rr$coef <- coefficients
  univar.overw.poor55.edu.urban.rr <- univar.overw.poor55.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor55.edu.urban.rr, "univar.overw.poor55.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55.urban.edu))
  univar.overw.poor55.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor55.edu.urban.ame, "univar.overw.poor55.edu.urban.ame.xls")

#urban
  dat.reg.overw.poor55.urban <- dat.reg.overw %>%dplyr::filter(poor55==1)  
  dat.reg.overw.poor55.urban <- filter(dat.reg.overw.poor55.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor55.urban %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55.urban <- x2 %>% left_join(dat.reg.overw.poor55.urban)
  dat.reg.overw.poor55.urban <- dat.reg.overw.poor55.urban %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55.urban <- dat.reg.overw.poor55.urban %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor55.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55.urban , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.overw.poor55.urban, family=poisson(link="log"),design=svy.overw.pop.poor55.urban )
  
  univar.overw.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor55.urban.rr)
  univar.overw.poor55.urban.rr <- as.data.frame(univar.overw.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor55.urban.rr$coef <- coefficients
  univar.overw.poor55.urban.rr <- univar.overw.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor55.urban.rr, "univar.overw.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55.urban))
  univar.overw.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor55.urban.ame, "univar.overw.poor55.urban.ame.xlsx")

###multivariate: edu, sex, urban
  dat.reg.overw.poor55.urban.edu.sex <- dat.reg.overw %>% dplyr::filter(poor55==1)  
  dat.reg.overw.poor55.urban.edu.sex <- filter(dat.reg.overw.poor55.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.overw.poor55.urban.edu.sex <- filter(dat.reg.overw.poor55.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor55.urban.edu.sex <- filter(dat.reg.overw.poor55.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor55.urban.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor55.urban.edu.sex <- x2 %>% left_join(dat.reg.overw.poor55.urban.edu.sex)
  dat.reg.overw.poor55.urban.edu.sex <- dat.reg.overw.poor55.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor55.urban.edu.sex <- dat.reg.overw.poor55.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor55.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor55.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.overw.poor55.urban.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor55.urban.edu.sex )
  
  multivar.overw.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor55.urban.rr)
  multivar.overw.poor55.urban.rr <- as.data.frame(multivar.overw.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor55.urban.rr$coef <- coefficients
  multivar.overw.poor55.urban.rr <- multivar.overw.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor55.urban.rr, "multivar.overw.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor55.urban.edu.sex))
  multivar.overw.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor55.urban.ame, "multivar.overw.poor55.urban.ame.xls")

###nonpoor
#no urban sample

#sex
  dat.reg.overw.poor0 <- dat.reg.overw %>% dplyr::filter(poor55==0) 
  dat.reg.overw.poor0 <- filter(dat.reg.overw.poor0, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor0 %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0 <- x2 %>% left_join(dat.reg.overw.poor0)
  dat.reg.overw.poor0 <- dat.reg.overw.poor0 %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0 <- dat.reg.overw.poor0 %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0 , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor0, family=poisson(link="log"),design=svy.overw.pop.poor0 )
  
  univar.overw.poor0.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor0.sex.rr)
  univar.overw.poor0.sex.rr <- as.data.frame(univar.overw.poor0.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor0.sex.rr$coef <- coefficients
  univar.overw.poor0.sex.rr <- univar.overw.poor0.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor0.sex.rr, "univar.overw.poor0.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0))
  univar.overw.poor0.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor0.sex.ame, "univar.overw.poor0.sex.ame.xls")

#educat
  dat.reg.overw.poor0.edu <- dat.reg.overw %>% dplyr::filter(poor55==0)  
  dat.reg.overw.poor0.edu <- filter(dat.reg.overw.poor0.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.overw.poor0.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0.edu <- x2 %>% left_join(dat.reg.overw.poor0.edu)
  dat.reg.overw.poor0.edu <- dat.reg.overw.poor0.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0.edu <- dat.reg.overw.poor0.edu %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor0.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0.edu , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor0.edu, family=poisson(link="log"),design=svy.overw.pop.poor0.edu )
  
  univar.overw.poor0.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor0.edu.rr)
  univar.overw.poor0.edu.rr <- as.data.frame(univar.overw.poor0.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor0.edu.rr$coef <- coefficients
  univar.overw.poor0.edu.rr <- univar.overw.poor0.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor0.edu.rr, "univar.overw.poor0.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0.edu))
  univar.overw.poor0.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor0.edu.ame, "univar.overw.poor0.edu.ame.xls")

###multivariate: edu, sex
  dat.reg.overw.poor0.edu.sex <- dat.reg.overw %>% dplyr::filter(poor55==0) 
  dat.reg.overw.poor0.edu.sex <- filter(dat.reg.overw.poor0.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor0.edu.sex <- filter(dat.reg.overw.poor0.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor0.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0.edu.sex <- x2 %>% left_join(dat.reg.overw.poor0.edu.sex)
  dat.reg.overw.poor0.edu.sex <- dat.reg.overw.poor0.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0.edu.sex <- dat.reg.overw.poor0.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor0.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.overw.poor0.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor0.edu.sex )
  
  multivar.overw.poor0.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor0.rr)
  multivar.overw.poor0.rr <- as.data.frame(multivar.overw.poor0.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor0.rr$coef <- coefficients
  multivar.overw.poor0.rr <- multivar.overw.poor0.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor0.rr, "multivar.overw.poor0.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0.edu.sex))
  multivar.overw.poor0.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor0.ame, "multivar.overw.poor0.ame.xls")

#urban sample
#sex
  dat.reg.overw.poor0.urban.sex <- dat.reg.overw %>%dplyr::filter(poor55==0) 
  dat.reg.overw.poor0.urban.sex <- filter(dat.reg.overw.poor0.urban.sex, is.na(female_lab)==F)
  dat.reg.overw.poor0.urban.sex <- filter(dat.reg.overw.poor0.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor0.urban.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0.urban.sex <- x2 %>% left_join(dat.reg.overw.poor0.urban.sex)
  dat.reg.overw.poor0.urban.sex <- dat.reg.overw.poor0.urban.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0.urban.sex <- dat.reg.overw.poor0.urban.sex %>% mutate(
    country = as.factor(country))

#run survey design    
  svy.overw.pop.poor0.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0.urban.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.overw.poor0.urban.sex, family=poisson(link="log"),design=svy.overw.pop.poor0.urban.sex )
  
  univar.overw.poor0.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor0.sex.urban.rr)
  univar.overw.poor0.sex.urban.rr <- as.data.frame(univar.overw.poor0.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor0.sex.urban.rr$coef <- coefficients
  univar.overw.poor0.sex.urban.rr <- univar.overw.poor0.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor0.sex.urban.rr, "univar.overw.poor0.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0.urban.sex))
  univar.overw.poor0.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor0.sex.urban.ame, "univar.overw.poor0.sex.urban.ame.xls")

#educat
  dat.reg.overw.poor0.urban.edu <- dat.reg.overw %>%dplyr::filter(poor55==0)  
  dat.reg.overw.poor0.urban.edu <- filter(dat.reg.overw.poor0.urban.edu, is.na(educat_lab)==F)
  dat.reg.overw.poor0.urban.edu <- filter(dat.reg.overw.poor0.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor0.urban.edu %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0.urban.edu <- x2 %>% left_join(dat.reg.overw.poor0.urban.edu)
  dat.reg.overw.poor0.urban.edu <- dat.reg.overw.poor0.urban.edu %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0.urban.edu <- dat.reg.overw.poor0.urban.edu %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor0.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0.urban.edu , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.overw.poor0.urban.edu, family=poisson(link="log"),design=svy.overw.pop.poor0.urban.edu )
  
  univar.overw.poor0.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor0.edu.urban.rr)
  univar.overw.poor0.edu.urban.rr <- as.data.frame(univar.overw.poor0.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor0.edu.urban.rr$coef <- coefficients
  univar.overw.poor0.edu.urban.rr <- univar.overw.poor0.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor0.edu.urban.rr, "univar.overw.poor0.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0.urban.edu))
  univar.overw.poor0.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor0.edu.urban.ame, "univar.overw.poor0.edu.urban.ame.xls")

#urban
  dat.reg.overw.poor0.urban <- dat.reg.overw %>%dplyr::filter(poor55==0)   
  dat.reg.overw.poor0.urban <- filter(dat.reg.overw.poor0.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.overw.poor0.urban %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0.urban <- x2 %>% left_join(dat.reg.overw.poor0.urban)
  dat.reg.overw.poor0.urban <- dat.reg.overw.poor0.urban %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0.urban <- dat.reg.overw.poor0.urban %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor0.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0.urban , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.overw.poor0.urban, family=poisson(link="log"),design=svy.overw.pop.poor0.urban )
  
  univar.overw.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.overw.poor0.urban.rr)
  univar.overw.poor0.urban.rr <- as.data.frame(univar.overw.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.overw.poor0.urban.rr$coef <- coefficients
  univar.overw.poor0.urban.rr <- univar.overw.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.overw.poor0.urban.rr, "univar.overw.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0.urban))
  univar.overw.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.overw.poor0.urban.ame, "univar.overw.poor0.urban.ame.xls")

###multivariate: edu, sex, urban
  dat.reg.overw.poor0.urban.edu.sex <- dat.reg.overw %>% dplyr::filter(poor55==0)  
  dat.reg.overw.poor0.urban.edu.sex <- filter(dat.reg.overw.poor0.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.overw.poor0.urban.edu.sex <- filter(dat.reg.overw.poor0.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.overw.poor0.urban.edu.sex <- filter(dat.reg.overw.poor0.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.overw.poor0.urban.edu.sex %>%
    group_by(country) %>%
    filter(overweight==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.overw.poor0.urban.edu.sex <- x2 %>% left_join(dat.reg.overw.poor0.urban.edu.sex)
  dat.reg.overw.poor0.urban.edu.sex <- dat.reg.overw.poor0.urban.edu.sex %>% mutate(
    country = as.character(country))
  dat.reg.overw.poor0.urban.edu.sex <- dat.reg.overw.poor0.urban.edu.sex %>% mutate(
    country = as.factor(country))

#run survey design  
  svy.overw.pop.poor0.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.overw.poor0.urban.edu.sex , nest = T)
  
  models <- svyglm(overweight ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.overw.poor0.urban.edu.sex, family=poisson(link="log"),design=svy.overw.pop.poor0.urban.edu.sex )
  
  multivar.overw.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.overw.poor0.urban.rr)
  multivar.overw.poor0.urban.rr <- as.data.frame(multivar.overw.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.overw.poor0.urban.rr$coef <- coefficients
  multivar.overw.poor0.urban.rr <- multivar.overw.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.overw.poor0.urban.rr, "multivar.overw.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.overw.pop.poor0.urban.edu.sex))
  multivar.overw.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.overw.poor0.urban.ame, "multivar.overw.poor0.urban.ame.xls")
  

```




```{r Regressions: obese}

  obese_subset <- read.csv("~/obese_subset.csv", stringsAsFactors=F)
  obese_subset <- obese_subset[,-1]


#prepare df  
  dat.reg.obese <- obese_subset %>% 
    dplyr::mutate(
      country = as.factor(country),
      region = as.factor(region),
      urban = as.factor(urban),
      sex = as.factor(sex)
      )
  
  dat.reg.obese <- dat.reg.obese %>% 
    dplyr::mutate(female_lab = as.factor(
                            ifelse(sex=="1", "Female", 
                               ifelse(sex=="0", "Male", NA))),
                  urban_lab = as.factor(
                            ifelse(urban=="1", "urban", 
                               ifelse(urban=="0", "rural", NA))),
                                           age_10yr_lab = as.factor(
                       ifelse(age>=15 & age<=24, "15-24",
                          ifelse(age>=25 & age<=34, "25-34",
                              ifelse(age>=35 & age<=44, "35-44",
                                  ifelse(age>=45 & age<=54, "45-54",
                                       ifelse(age>=55 & age<=64, "55-64",
                                            ifelse(age>=65, "65+", NA))))))),
                  age_5yr_lab = as.factor(ifelse(age>=15 & age<=19, "15-19",
                          ifelse(age>=20 & age<=24, "20-24",
                              ifelse(age>=25 & age<=29, "25-29",
                                  ifelse(age>=30 & age<=34, "30-34",
                                       ifelse(age>=35 & age<=39, "35-39",
                                            ifelse(age>=40 & age<=44, "40-44",
                                                   ifelse(age>=45 & age<=49, "45-49", 
                                                          ifelse(age>=50 & age<=54, "50-54",
                                                                 ifelse(age>=55 & age<=59, "55-59",
                                                                        ifelse(age>=60 & age<=64, "60-64",
                                                                               ifelse(age>=65, "65+", NA)))))))))))),
                  educat_lab = as.factor(ifelse(educat=="0", "No formal schooling", 
                               ifelse(educat=="1", "Primary school",
                                      ifelse(educat=="2", "Primary school",
                                      ifelse(educat=='3', 'High school or above', 
                                             ifelse(educat=="4", "High school or above",NA)))))))

  dat.reg.obese$educat_lab <- factor(dat.reg.obese$educat_lab, levels = c("No formal schooling", "Primary school", "High school or above"))

###global
#no urban sample

#sex
  dat.reg.obese.global <- filter(dat.reg.obese, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.global %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.global <- x2 %>% 
    left_join(dat.reg.obese.global)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.global <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.global, family=poisson(link="log"),design=svy.obese.pop.global )
  
  univar.obese.global.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.global.sex.rr)
  univar.obese.global.sex.rr <- as.data.frame(univar.obese.global.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.global.sex.rr$coef <- coefficients
  univar.obese.global.sex.rr <- univar.obese.global.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.global.sex.rr, "univar.obese.global.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global))
  univar.obese.global.sex.ame<- summary(models) %>% 
    mutate(AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.global.sex.ame, "univar.obese.global.sex.ame.xlsx")

#educat
  dat.reg.obese.global.edu <- filter(dat.reg.obese, is.na(educat_lab)==F)
  
  x2 <- dat.reg.obese.global.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.global.edu <-  x2 %>% 
      left_join(dat.reg.obese.global.edu)%>% 
      mutate(country = as.character(country))%>% 
      mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.global.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global.edu , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.global.edu, family=poisson(link="log"),design=svy.obese.pop.global.edu )
  
  univar.obese.global.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.global.edu.rr)
  univar.obese.global.edu.rr <- as.data.frame(univar.obese.global.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.global.edu.rr$coef <- coefficients
  univar.obese.global.edu.rr <- univar.obese.global.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.global.edu.rr, "univar.obese.global.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global.edu))
  univar.obese.global.edu.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.global.edu.ame, "univar.obese.global.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.obese.global.edu.sex <- filter(dat.reg.obese, is.na(educat_lab)==F)
  dat.reg.obese.global.edu.sex <- filter(dat.reg.obese.global.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.global.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.global.edu.sex <- x2 %>% 
    left_join(dat.reg.obese.global.edu.sex) %>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.global.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global.edu.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.obese.global.edu.sex, family=poisson(link="log"),design=svy.obese.pop.global.edu.sex )
  
  multivar.obese.global.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.global.rr)
  multivar.obese.global.rr <- as.data.frame(multivar.obese.global.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.global.rr$coef <- coefficients
  multivar.obese.global.rr <- multivar.obese.global.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.global.rr, "multivar.obese.global.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global.edu.sex))
  multivar.obese.global.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.global.ame, "multivar.obese.global.ame.xlsx")

###urban sample
#sex
  dat.reg.obese.global.urban.sex <- filter(dat.reg.obese, is.na(female_lab)==F)
  dat.reg.obese.global.urban.sex <- filter(dat.reg.obese.global.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.global.urban.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.global.urban.sex <- x2 %>% 
    left_join(dat.reg.obese.global.urban.sex) %>%
    mutate(country=as.character(country)) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.global.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global.urban.sex , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.global.urban.sex, family=poisson(link="log"),design=svy.obese.pop.global.urban.sex )
  
  univar.obese.global.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.global.sex.urban.rr)
  univar.obese.global.sex.urban.rr <- as.data.frame(univar.obese.global.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.global.sex.urban.rr$coef <- coefficients
  univar.obese.global.sex.urban.rr <- univar.obese.global.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.global.sex.urban.rr, "univar.obese.global.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global.urban.sex))
  univar.obese.global.sex.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.global.sex.urban.ame, "univar.obese.global.sex.urban.ame.xlsx")

#educat
  dat.reg.obese.global.urban.edu <- filter(dat.reg.obese, is.na(educat_lab)==F)
  dat.reg.obese.global.urban.edu <- filter(dat.reg.obese.global.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.global.urban.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.global.urban.edu <- x2 %>% 
    left_join(dat.reg.obese.global.urban.edu) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.global.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global.urban.edu , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.global.urban.edu, family=poisson(link="log"),design=svy.obese.pop.global.urban.edu )
  
  univar.obese.global.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.global.edu.urban.rr)
  univar.obese.global.edu.urban.rr <- as.data.frame(univar.obese.global.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.global.edu.urban.rr$coef <- coefficients
  univar.obese.global.edu.urban.rr <- univar.obese.global.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.global.edu.urban.rr, "univar.obese.global.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global.urban.edu))
  univar.obese.global.edu.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.global.edu.urban.ame, "univar.obese.global.edu.urban.ame.xlsx")

#urban
  dat.reg.obese.global.urban <- filter(dat.reg.obese, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.global.urban %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.global.urban <- x2 %>% 
    left_join(dat.reg.obese.global.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.global.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global.urban , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.obese.global.urban, family=poisson(link="log"),design=svy.obese.pop.global.urban )
  
  univar.obese.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.global.urban.rr)
  univar.obese.global.urban.rr <- as.data.frame(univar.obese.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.global.urban.rr$coef <- coefficients
  univar.obese.global.urban.rr <- univar.obese.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.global.urban.rr, "univar.obese.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global.urban))
  univar.obese.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.global.urban.ame, "univar.obese.global.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.obese.global.urban.edu.sex <- filter(dat.reg.obese, is.na(urban_lab)==F)
  dat.reg.obese.global.urban.edu.sex <- filter(dat.reg.obese.global.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.global.urban.edu.sex <- filter(dat.reg.obese.global.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.global.urban.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.global.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.obese.global.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.global.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.global.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.obese.global.urban.edu.sex, family=poisson(link="log"),design=svy.obese.pop.global.urban.edu.sex )
  
  multivar.obese.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.global.urban.rr)
  multivar.obese.global.urban.rr <- as.data.frame(multivar.obese.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.global.urban.rr$coef <- coefficients
  multivar.obese.global.urban.rr <- multivar.obese.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.global.urban.rr, "multivar.obese.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.global.urban.edu.sex))
  multivar.obese.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.global.urban.ame, "multivar.obese.global.urban.ame.xlsx")

###Poor19
#no urban sample
#sex
  dat.reg.obese.poor19 <- dat.reg.obese %>% dplyr::filter(poor19==1) 
  dat.reg.obese.poor19 <- filter(dat.reg.obese.poor19, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor19 %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor19 <- x2 %>% 
      left_join(dat.reg.obese.poor19)%>% 
      mutate(country = as.character(country))%>% 
      mutate(country = as.character(country)) %>% 
      mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19 , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab, data=dat.reg.obese.poor19, family=poisson(link="log"),design=svy.obese.pop.poor19 )
  
  univar.obese.poor19.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor19.sex.rr)
  univar.obese.poor19.sex.rr <- as.data.frame(univar.obese.poor19.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor19.sex.rr$coef <- coefficients
  univar.obese.poor19.sex.rr <- univar.obese.poor19.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor19.sex.rr, "univar.obese.poor19.sex.rr.xlsx")

#to get AME
  models <- margins(models,design=svy.obese.pop.poor19)
  univar.obese.poor19.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor19.sex.ame, "univar.obese.poor19.sex.ame.xlsx")

#educat
  dat.reg.obese.poor19.edu <- dat.reg.obese %>% dplyr::filter(poor19==1) 
  dat.reg.obese.poor19.edu <- filter(dat.reg.obese.poor19.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.obese.poor19.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor19.edu <- x2 %>% 
        left_join(dat.reg.obese.poor19.edu)%>% 
        mutate(country = as.character(country))%>% 
        mutate(country = as.character(country)) %>% 
        mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor19.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19.edu , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor19.edu, family=poisson(link="log"),design=svy.obese.pop.poor19.edu )
  
  univar.obese.poor19.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor19.edu.rr)
  univar.obese.poor19.edu.rr <- as.data.frame(univar.obese.poor19.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor19.edu.rr$coef <- coefficients
  univar.obese.poor19.edu.rr <- univar.obese.poor19.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor19.edu.rr, "univar.obese.poor19.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor19.edu))
  univar.obese.poor19.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor19.edu.ame, "univar.obese.poor19.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.obese.poor19.edu.sex <- dat.reg.obese %>% dplyr::filter(poor19==1) 
  dat.reg.obese.poor19.edu.sex <- filter(dat.reg.obese.poor19.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor19.edu.sex <- filter(dat.reg.obese.poor19.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor19.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor19.edu.sex <- x2 %>% 
          left_join(dat.reg.obese.poor19.edu.sex)%>% 
          mutate(country = as.character(country))%>% 
          mutate(country = as.character(country)) %>% 
          mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor19.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19.edu.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.obese.poor19.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor19.edu.sex )
  
  multivar.obese.poor19.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor19.edu.sex.rr)
  multivar.obese.poor19.edu.sex.rr <- as.data.frame(multivar.obese.poor19.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor19.edu.sex.rr$coef <- coefficients
  multivar.obese.poor19.edu.sex.rr <- multivar.obese.poor19.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor19.edu.sex.rr, "multivar.obese.poor19.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor19.edu.sex))
  multivar.obese.poor19.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor19.edu.sex.ame, "multivar.obese.poor19.edu.sex.ame.xlsx")

#urban sample
#sex
  dat.reg.obese.poor19.urban.sex <- dat.reg.obese %>%dplyr::filter(poor19==1) 
  dat.reg.obese.poor19.urban.sex <- filter(dat.reg.obese.poor19.urban.sex, is.na(female_lab)==F)
  dat.reg.obese.poor19.urban.sex <- filter(dat.reg.obese.poor19.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor19.urban.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor19.urban.sex <- x2 %>% 
            left_join(dat.reg.obese.poor19.urban.sex)%>% 
            mutate(country = as.character(country))%>% 
            mutate(country = as.character(country)) %>% 
            mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor19.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19.urban.sex , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor19.urban.sex, family=poisson(link="log"),design=svy.obese.pop.poor19.urban.sex )
  
  univar.obese.poor19.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor19.sex.urban.rr)
  univar.obese.poor19.sex.urban.rr <- as.data.frame(univar.obese.poor19.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor19.sex.urban.rr$coef <- coefficients
  univar.obese.poor19.sex.urban.rr <- univar.obese.poor19.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor19.sex.urban.rr, "univar.obese.poor19.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor19.urban.sex))
  univar.obese.poor19.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor19.sex.urban.ame, "univar.obese.poor19.sex.urban.ame.xlsx")

#educat
  dat.reg.obese.poor19.urban.edu <- dat.reg.obese %>%dplyr::filter(poor19==1) 
  dat.reg.obese.poor19.urban.edu <- filter(dat.reg.obese.poor19.urban.edu, is.na(educat_lab)==F)
  dat.reg.obese.poor19.urban.edu <- filter(dat.reg.obese.poor19.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor19.urban.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor19.urban.edu <- x2 %>% 
              left_join(dat.reg.obese.poor19.urban.edu)%>% 
              mutate(country = as.character(country))%>% 
              mutate(country = as.character(country)) %>% 
              mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor19.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19.urban.edu , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor19.urban.edu, family=poisson(link="log"),design=svy.obese.pop.poor19.urban.edu )
  
  univar.obese.poor19.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor19.edu.urban.rr)
  univar.obese.poor19.edu.urban.rr <- as.data.frame(univar.obese.poor19.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor19.edu.urban.rr$coef <- coefficients
  univar.obese.poor19.edu.urban.rr <- univar.obese.poor19.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor19.edu.urban.rr, "univar.obese.poor19.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor19.urban.edu))
  univar.obese.poor19.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor19.edu.urban.ame, "univar.obese.poor19.edu.urban.ame.xlsx")

#urban
  dat.reg.obese.poor19.urban <- dat.reg.obese %>%dplyr::filter(poor19==1)  
  dat.reg.obese.poor19.urban <- filter(dat.reg.obese.poor19.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor19.urban %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor19.urban <- x2 %>% 
                left_join(dat.reg.obese.poor19.urban)%>% 
                mutate(country = as.character(country))%>% 
                mutate(country = as.character(country)) %>% 
                mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor19.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19.urban , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.obese.poor19.urban, family=poisson(link="log"),design=svy.obese.pop.poor19.urban )
  
  univar.obese.poor19.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor19.urban.rr)
  univar.obese.poor19.urban.rr <- as.data.frame(univar.obese.poor19.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor19.urban.rr$coef <- coefficients
  univar.obese.poor19.urban.rr <- univar.obese.poor19.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor19.urban.rr, "univar.obese.poor19.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor19.urban))
  univar.obese.poor19.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor19.urban.ame, "univar.obese.poor19.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.obese.poor19.urban.edu.sex <- dat.reg.obese %>% dplyr::filter(poor19==1)  
  dat.reg.obese.poor19.urban.edu.sex <- filter(dat.reg.obese.poor19.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.obese.poor19.urban.edu.sex <- filter(dat.reg.obese.poor19.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor19.urban.edu.sex <- filter(dat.reg.obese.poor19.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor19.urban.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor19.urban.edu.sex <- x2  %>% 
                  left_join(dat.reg.obese.poor19.urban.edu.sex)%>% 
                  mutate(country = as.character(country))%>% 
                  mutate(country = as.character(country)) %>% 
                  mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor19.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor19.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.obese.poor19.urban.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor19.urban.edu.sex )
  
  multivar.obese.poor19.urban.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor19.urban.edu.sex.rr)
  multivar.obese.poor19.urban.edu.sex.rr <- as.data.frame(multivar.obese.poor19.urban.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor19.urban.edu.sex.rr$coef <- coefficients
  multivar.obese.poor19.urban.edu.sex.rr <- multivar.obese.poor19.urban.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor19.urban.edu.sex.rr, "multivar.obese.poor19.urban.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor19.urban.edu.sex))
  multivar.obese.poor19.urban.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor19.urban.edu.sex.ame, "multivar.obese.poor19.urban.edu.sex.ame.xlsx")

###poor32
#no urban sample
#sex
  dat.reg.obese.poor32 <- dat.reg.obese %>% dplyr::filter(poor32==1) 
  dat.reg.obese.poor32 <- filter(dat.reg.obese.poor32, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor32 %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor32 <- x2   %>% 
                    left_join(dat.reg.obese.poor32)%>% 
                    mutate(country = as.character(country))%>% 
                    mutate(country = as.character(country)) %>% 
                    mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32 , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor32, family=poisson(link="log"),design=svy.obese.pop.poor32 )
  
  univar.obese.poor32.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor32.sex.rr)
  univar.obese.poor32.sex.rr <- as.data.frame(univar.obese.poor32.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor32.sex.rr$coef <- coefficients
  univar.obese.poor32.sex.rr <- univar.obese.poor32.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor32.sex.rr, "univar.obese.poor32.sex.rr.xlsx")

#to get AME
    (models <- margins(models,design=svy.obese.pop.poor32))
    univar.obese.poor32.sex.ame <- summary(models) %>% mutate(
      AME = round(AME, 2),
      lower = round(lower, 2),
      upper = round(upper, 2),
      estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
      dplyr::select(factor, estimate, p)
    write.xlsx(univar.obese.poor32.sex.ame, "univar.obese.poor32.sex.ame.xlsx")

#educat
  dat.reg.obese.poor32.edu <- dat.reg.obese %>% dplyr::filter(poor32==1) 
  dat.reg.obese.poor32.edu <- filter(dat.reg.obese.poor32.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.obese.poor32.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor32.edu <- x2 %>%  
                      left_join(dat.reg.obese.poor32.edu)%>% 
                      mutate(country = as.character(country))%>% 
                      mutate(country = as.character(country)) %>% 
                      mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor32.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32.edu , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor32.edu, family=poisson(link="log"),design=svy.obese.pop.poor32.edu )
  
  univar.obese.poor32.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor32.edu.rr)
  univar.obese.poor32.edu.rr <- as.data.frame(univar.obese.poor32.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor32.edu.rr$coef <- coefficients
  univar.obese.poor32.edu.rr <- univar.obese.poor32.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor32.edu.rr, "univar.obese.poor32.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor32.edu))
  univar.obese.poor32.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor32.edu.ame, "univar.obese.poor32.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.obese.poor32.edu.sex <- dat.reg.obese %>% dplyr::filter(poor32==1) 
  dat.reg.obese.poor32.edu.sex <- filter(dat.reg.obese.poor32.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor32.edu.sex <- filter(dat.reg.obese.poor32.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor32.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor32.edu.sex <- x2 %>%  
                        left_join(dat.reg.obese.poor32.edu.sex)%>% 
                        mutate(country = as.character(country))%>% 
                        mutate(country = as.character(country)) %>% 
                        mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor32.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32.edu.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.obese.poor32.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor32.edu.sex )
  
  multivar.obese.poor32.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor32.rr)
  multivar.obese.poor32.rr <- as.data.frame(multivar.obese.poor32.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor32.rr$coef <- coefficients
  multivar.obese.poor32.rr <- multivar.obese.poor32.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor32.rr, "multivar.obese.poor32.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor32.edu.sex))
  multivar.obese.poor32.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor32.ame, "multivar.obese.poor32.ame.xlsx")

###urban sample
#sex
  dat.reg.obese.poor32.urban.sex <- dat.reg.obese %>%dplyr::filter(poor32==1) 
  dat.reg.obese.poor32.urban.sex <- filter(dat.reg.obese.poor32.urban.sex, is.na(female_lab)==F)
  dat.reg.obese.poor32.urban.sex <- filter(dat.reg.obese.poor32.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor32.urban.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor32.urban.sex <- x2 %>%  
                          left_join(dat.reg.obese.poor32.urban.sex)%>% 
                          mutate(country = as.character(country))%>% 
                          mutate(country = as.character(country)) %>% 
                          mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor32.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32.urban.sex , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor32.urban.sex, family=poisson(link="log"),design=svy.obese.pop.poor32.urban.sex )
  
  univar.obese.poor32.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor32.sex.urban.rr)
  univar.obese.poor32.sex.urban.rr <- as.data.frame(univar.obese.poor32.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor32.sex.urban.rr$coef <- coefficients
  univar.obese.poor32.sex.urban.rr <- univar.obese.poor32.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor32.sex.urban.rr, "univar.obese.poor32.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor32.urban.sex))
  univar.obese.poor32.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor32.sex.urban.ame, "univar.obese.poor32.sex.urban.ame.xls")

#educat
  dat.reg.obese.poor32.urban.edu <- dat.reg.obese %>%dplyr::filter(poor32==1) 
  dat.reg.obese.poor32.urban.edu <- filter(dat.reg.obese.poor32.urban.edu, is.na(educat_lab)==F)
  dat.reg.obese.poor32.urban.edu <- filter(dat.reg.obese.poor32.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor32.urban.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor32.urban.edu <- x2 %>%  
                            left_join(dat.reg.obese.poor32.urban.sex)%>% 
                            mutate(country = as.character(country))%>% 
                            mutate(country = as.character(country)) %>% 
                            mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor32.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32.urban.edu , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor32.urban.edu, family=poisson(link="log"),design=svy.obese.pop.poor32.urban.edu )
  
  univar.obese.poor32.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor32.edu.urban.rr)
  univar.obese.poor32.edu.urban.rr <- as.data.frame(univar.obese.poor32.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor32.edu.urban.rr$coef <- coefficients
  univar.obese.poor32.edu.urban.rr <- univar.obese.poor32.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor32.edu.urban.rr, "univar.obese.poor32.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor32.urban.edu))
  univar.obese.poor32.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor32.edu.urban.ame, "univar.obese.poor32.edu.urban.ame.xls")

#urban
  dat.reg.obese.poor32.urban <- dat.reg.obese %>%dplyr::filter(poor32==1)  
  dat.reg.obese.poor32.urban <- filter(dat.reg.obese.poor32.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor32.urban %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor32.urban <- x2 %>%  
                              left_join(dat.reg.obese.poor32.urban)%>% 
                              mutate(country = as.character(country))%>% 
                              mutate(country = as.character(country)) %>% 
                              mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor32.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32.urban , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.obese.poor32.urban, family=poisson(link="log"),design=svy.obese.pop.poor32.urban )
  
  univar.obese.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor32.urban.rr)
  univar.obese.poor32.urban.rr <- as.data.frame(univar.obese.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor32.urban.rr$coef <- coefficients
  univar.obese.poor32.urban.rr <- univar.obese.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor32.urban.rr, "univar.obese.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor32.urban))
  univar.obese.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor32.urban.ame, "univar.obese.poor32.urban.ame.xls")

#multivariate: edu, sex, urban
  dat.reg.obese.poor32.urban.edu.sex <- dat.reg.obese %>% dplyr::filter(poor32==1)  
  dat.reg.obese.poor32.urban.edu.sex <- filter(dat.reg.obese.poor32.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.obese.poor32.urban.edu.sex <- filter(dat.reg.obese.poor32.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor32.urban.edu.sex <- filter(dat.reg.obese.poor32.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor32.urban.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor32.urban.edu.sex <- x2 %>%  
                                left_join(dat.reg.obese.poor32.urban)%>% 
                                mutate(country = as.character(country))%>% 
                                mutate(country = as.character(country)) %>% 
                                mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor32.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor32.urban.edu.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.obese.poor32.urban.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor32.urban.edu.sex )
  
  multivar.obese.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor32.urban.rr)
  multivar.obese.poor32.urban.rr <- as.data.frame(multivar.obese.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor32.urban.rr$coef <- coefficients
  multivar.obese.poor32.urban.rr <- multivar.obese.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor32.urban.rr, "multivar.obese.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor32.urban.edu.sex))
  multivar.obese.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor32.urban.ame, "multivar.obese.poor32.urban.ame.xls")

###poor55
#no urban sample
#sex
  dat.reg.obese.poor55 <- dat.reg.obese %>% dplyr::filter(poor55==1) 
  dat.reg.obese.poor55 <- filter(dat.reg.obese.poor55, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor55 %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor55 <- x2 %>% left_join(dat.reg.obese.poor32.urban)%>% 
                                  mutate(country = as.character(country))%>% 
                                  mutate(country = as.character(country)) %>% 
                                  mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55 , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor55, family=poisson(link="log"),design=svy.obese.pop.poor55 )
  
  univar.obese.poor55.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor55.sex.rr)
  univar.obese.poor55.sex.rr <- as.data.frame(univar.obese.poor55.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor55.sex.rr$coef <- coefficients
  univar.obese.poor55.sex.rr <- univar.obese.poor55.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor55.sex.rr, "univar.obese.poor55.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor55))
  univar.obese.poor55.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor55.sex.ame, "univar.obese.poor55.sex.ame.xls")

#educat
  dat.reg.obese.poor55.edu <- dat.reg.obese %>% dplyr::filter(poor55==1) 
  dat.reg.obese.poor55.edu <- filter(dat.reg.obese.poor55.edu, is.na(educat_lab)==F)
  x2 <- dat.reg.obese.poor55.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor55.edu <- x2 %>% left_join(dat.reg.obese.poor55.edu)%>% 
                                    mutate(country = as.character(country))%>% 
                                    mutate(country = as.character(country)) %>% 
                                    mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor55.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55.edu , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor55.edu, family=poisson(link="log"),design=svy.obese.pop.poor55.edu )
  
  univar.obese.poor55.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor55.edu.rr)
  univar.obese.poor55.edu.rr <- as.data.frame(univar.obese.poor55.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor55.edu.rr$coef <- coefficients
  univar.obese.poor55.edu.rr <- univar.obese.poor55.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor55.edu.rr, "univar.obese.poor55.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor55.edu))
  univar.obese.poor55.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor55.edu.ame, "univar.obese.poor55.edu.ame.xls")

#multivariate: edu, sex
  dat.reg.obese.poor55.edu.sex <- dat.reg.obese %>% dplyr::filter(poor55==1) 
  dat.reg.obese.poor55.edu.sex <- filter(dat.reg.obese.poor55.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor55.edu.sex <- filter(dat.reg.obese.poor55.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor55.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor55.edu.sex <- x2 %>%  
                                    left_join(dat.reg.obese.poor55.edu)%>% 
                                    mutate(country = as.character(country))%>% 
                                    mutate(country = as.character(country)) %>% 
                                    mutate(country = as.factor(country))

#run survey design  
  svy.obese.pop.poor55.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55.edu.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.obese.poor55.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor55.edu.sex )
  
  multivar.obese.poor55.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor55.rr)
  multivar.obese.poor55.rr <- as.data.frame(multivar.obese.poor55.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor55.rr$coef <- coefficients
  multivar.obese.poor55.rr <- multivar.obese.poor55.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor55.rr, "multivar.obese.poor55.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor55.edu.sex))
  multivar.obese.poor55.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor55.ame, "multivar.obese.poor55.ame.xls")

#urban sample
#sex
  dat.reg.obese.poor55.urban.sex <- dat.reg.obese %>%dplyr::filter(poor55==1) 
  dat.reg.obese.poor55.urban.sex <- filter(dat.reg.obese.poor55.urban.sex, is.na(female_lab)==F)
  dat.reg.obese.poor55.urban.sex <- filter(dat.reg.obese.poor55.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor55.urban.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor55.urban.sex <- x2 %>%   
                                      left_join(dat.reg.obese.poor55.urban.sex)%>% 
                                      mutate(country = as.character(country))%>% 
                                      mutate(country = as.character(country)) %>% 
                                      mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor55.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55.urban.sex , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor55.urban.sex, family=poisson(link="log"),design=svy.obese.pop.poor55.urban.sex )
  
  univar.obese.poor55.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor55.sex.urban.rr)
  univar.obese.poor55.sex.urban.rr <- as.data.frame(univar.obese.poor55.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor55.sex.urban.rr$coef <- coefficients
  univar.obese.poor55.sex.urban.rr <- univar.obese.poor55.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor55.sex.urban.rr, "univar.obese.poor55.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor55.urban.sex))
  univar.obese.poor55.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor55.sex.urban.ame, "univar.obese.poor55.sex.urban.ame.xls")

#educat
  dat.reg.obese.poor55.urban.edu <- dat.reg.obese %>%dplyr::filter(poor55==1) 
  dat.reg.obese.poor55.urban.edu <- filter(dat.reg.obese.poor55.urban.edu, is.na(educat_lab)==F)
  dat.reg.obese.poor55.urban.edu <- filter(dat.reg.obese.poor55.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor55.urban.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.obese.poor55.urban.edu <- x2 %>%   
                                        left_join(dat.reg.obese.poor55.urban.edu)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))

#run survey design
  svy.obese.pop.poor55.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55.urban.edu , nest = 
                                                T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor55.urban.edu, family=poisson(link="log"),design=svy.obese.pop.poor55.urban.edu )
  
  univar.obese.poor55.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor55.edu.urban.rr)
  univar.obese.poor55.edu.urban.rr <- as.data.frame(univar.obese.poor55.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor55.edu.urban.rr$coef <- coefficients
  univar.obese.poor55.edu.urban.rr <- univar.obese.poor55.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor55.edu.urban.rr, "univar.obese.poor55.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor55.urban.edu))
  univar.obese.poor55.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor55.edu.urban.ame, "univar.obese.poor55.edu.urban.ame.xls")

#urban
  dat.reg.obese.poor55.urban <- dat.reg.obese %>%dplyr::filter(poor55==1)  
  dat.reg.obese.poor55.urban <- filter(dat.reg.obese.poor55.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor55.urban %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor55.urban <- x2 %>% left_join(dat.reg.obese.poor55.urban)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor55.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55.urban , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.obese.poor55.urban, family=poisson(link="log"),design=svy.obese.pop.poor55.urban )
  
  univar.obese.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor55.urban.rr)
  univar.obese.poor55.urban.rr <- as.data.frame(univar.obese.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor55.urban.rr$coef <- coefficients
  univar.obese.poor55.urban.rr <- univar.obese.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor55.urban.rr, "univar.obese.poor55.urban.rr.xlsx")

  #to get AME
  (models <- margins(models,design=svy.obese.pop.poor55.urban))
  univar.obese.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor55.urban.ame, "univar.obese.poor55.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.obese.poor55.urban.edu.sex <- dat.reg.obese %>% dplyr::filter(poor55==1)  
  dat.reg.obese.poor55.urban.edu.sex <- filter(dat.reg.obese.poor55.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.obese.poor55.urban.edu.sex <- filter(dat.reg.obese.poor55.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor55.urban.edu.sex <- filter(dat.reg.obese.poor55.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor55.urban.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor55.urban.edu.sex <- x2 %>% left_join(dat.reg.obese.poor55.urban.edu.sex)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor55.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor55.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.obese.poor55.urban.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor55.urban.edu.sex )
  
  multivar.obese.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor55.urban.rr)
  multivar.obese.poor55.urban.rr <- as.data.frame(multivar.obese.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor55.urban.rr$coef <- coefficients
  multivar.obese.poor55.urban.rr <- multivar.obese.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor55.urban.rr, "multivar.obese.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor55.urban.edu.sex))
  multivar.obese.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor55.urban.ame, "multivar.obese.poor55.urban.ame.xls")

###nonpoor
#no urban sample

#sex
  dat.reg.obese.poor0 <- dat.reg.obese %>% dplyr::filter(poor55==0) 
  dat.reg.obese.poor0 <- filter(dat.reg.obese.poor0, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor0 %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0 <- x2 %>% left_join(dat.reg.obese.poor0)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0 , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor0, family=poisson(link="log"),design=svy.obese.pop.poor0 )
  
  univar.obese.poor0.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor0.sex.rr)
  univar.obese.poor0.sex.rr <- as.data.frame(univar.obese.poor0.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor0.sex.rr$coef <- coefficients
  univar.obese.poor0.sex.rr <- univar.obese.poor0.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor0.sex.rr, "univar.obese.poor0.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0))
  univar.obese.poor0.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor0.sex.ame, "univar.obese.poor0.sex.ame.xls")

#educat
  dat.reg.obese.poor0.edu <- dat.reg.obese %>% dplyr::filter(poor55==0)  
  dat.reg.obese.poor0.edu <- filter(dat.reg.obese.poor0.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.obese.poor0.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0.edu <- x2 %>% left_join(dat.reg.obese.poor0)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0.edu , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor0.edu, family=poisson(link="log"),design=svy.obese.pop.poor0.edu )
  
  univar.obese.poor0.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor0.edu.rr)
  univar.obese.poor0.edu.rr <- as.data.frame(univar.obese.poor0.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor0.edu.rr$coef <- coefficients
  univar.obese.poor0.edu.rr <- univar.obese.poor0.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor0.edu.rr, "univar.obese.poor0.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0.edu))
  univar.obese.poor0.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor0.edu.ame, "univar.obese.poor0.edu.ame.xls")

#multivariate: edu, sex
  dat.reg.obese.poor0.edu.sex <- dat.reg.obese %>% dplyr::filter(poor55==0) 
  dat.reg.obese.poor0.edu.sex <- filter(dat.reg.obese.poor0.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor0.edu.sex <- filter(dat.reg.obese.poor0.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor0.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0.edu.sex <- x2 %>% left_join(dat.reg.obese.poor0)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0.edu.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.obese.poor0.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor0.edu.sex )
  
  multivar.obese.poor0.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor0.rr)
  multivar.obese.poor0.rr <- as.data.frame(multivar.obese.poor0.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor0.rr$coef <- coefficients
  multivar.obese.poor0.rr <- multivar.obese.poor0.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor0.rr, "multivar.obese.poor0.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0.edu.sex))
  multivar.obese.poor0.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor0.ame, "multivar.obese.poor0.ame.xls")

###urban sample
#sex
  dat.reg.obese.poor0.urban.sex <- dat.reg.obese %>%dplyr::filter(poor55==0) 
  dat.reg.obese.poor0.urban.sex <- filter(dat.reg.obese.poor0.urban.sex, is.na(female_lab)==F)
  dat.reg.obese.poor0.urban.sex <- filter(dat.reg.obese.poor0.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor0.urban.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0.urban.sex <- x2 %>%left_join(dat.reg.obese.poor0.urban.sex)%>% 
                                        mutate(country = as.character(country))%>% 
                                        mutate(country = as.character(country)) %>% 
                                        mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0.urban.sex , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.obese.poor0.urban.sex, family=poisson(link="log"),design=svy.obese.pop.poor0.urban.sex )
  
  univar.obese.poor0.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor0.sex.urban.rr)
  univar.obese.poor0.sex.urban.rr <- as.data.frame(univar.obese.poor0.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor0.sex.urban.rr$coef <- coefficients
  univar.obese.poor0.sex.urban.rr <- univar.obese.poor0.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor0.sex.urban.rr, "univar.obese.poor0.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0.urban.sex))
  univar.obese.poor0.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor0.sex.urban.ame, "univar.obese.poor0.sex.urban.ame.xls")

#educat
  dat.reg.obese.poor0.urban.edu <- dat.reg.obese %>%dplyr::filter(poor55==0)  
  dat.reg.obese.poor0.urban.edu <- filter(dat.reg.obese.poor0.urban.edu, is.na(educat_lab)==F)
  dat.reg.obese.poor0.urban.edu <- filter(dat.reg.obese.poor0.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor0.urban.edu %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0.urban.edu <- x2 %>%left_join(dat.reg.obese.poor0.urban.edu)%>% 
                                          mutate(country = as.character(country))%>% 
                                          mutate(country = as.character(country)) %>% 
                                          mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0.urban.edu , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.obese.poor0.urban.edu, family=poisson(link="log"),design=svy.obese.pop.poor0.urban.edu )
  
  univar.obese.poor0.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor0.edu.urban.rr)
  univar.obese.poor0.edu.urban.rr <- as.data.frame(univar.obese.poor0.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor0.edu.urban.rr$coef <- coefficients
  univar.obese.poor0.edu.urban.rr <- univar.obese.poor0.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor0.edu.urban.rr, "univar.obese.poor0.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0.urban.edu))
  univar.obese.poor0.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor0.edu.urban.ame, "univar.obese.poor0.edu.urban.ame.xls")

#urban
  dat.reg.obese.poor0.urban <- dat.reg.obese %>%dplyr::filter(poor55==0)   
  dat.reg.obese.poor0.urban <- filter(dat.reg.obese.poor0.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.obese.poor0.urban %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0.urban <- x2 %>%left_join(dat.reg.obese.poor0.urban)%>% 
                                            mutate(country = as.character(country))%>% 
                                            mutate(country = as.character(country)) %>% 
                                            mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0.urban , nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.obese.poor0.urban, family=poisson(link="log"),design=svy.obese.pop.poor0.urban )
  
  univar.obese.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.obese.poor0.urban.rr)
  univar.obese.poor0.urban.rr <- as.data.frame(univar.obese.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.obese.poor0.urban.rr$coef <- coefficients
  univar.obese.poor0.urban.rr <- univar.obese.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.obese.poor0.urban.rr, "univar.obese.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0.urban))
  univar.obese.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.obese.poor0.urban.ame, "univar.obese.poor0.urban.ame.xls")

#multivariate: edu, sex, urban
  dat.reg.obese.poor0.urban.edu.sex <- dat.reg.obese %>% dplyr::filter(poor55==0)  
  dat.reg.obese.poor0.urban.edu.sex <- filter(dat.reg.obese.poor0.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.obese.poor0.urban.edu.sex <- filter(dat.reg.obese.poor0.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.obese.poor0.urban.edu.sex <- filter(dat.reg.obese.poor0.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.obese.poor0.urban.edu.sex %>%
    group_by(country) %>%
    filter(obese==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.obese.poor0.urban.edu.sex <- x2 %>%left_join(dat.reg.obese.poor0.urban.edu.sex)%>% 
                                            mutate(country = as.character(country))%>% 
                                            mutate(country = as.character(country)) %>% 
                                            mutate(country = as.factor(country))
#run survey design
  svy.obese.pop.poor0.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.obese.poor0.urban.edu.sex , 
                                                 nest = T)
  
  models <- svyglm(obese ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.obese.poor0.urban.edu.sex, family=poisson(link="log"),design=svy.obese.pop.poor0.urban.edu.sex )
  
  multivar.obese.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.obese.poor0.urban.rr)
  multivar.obese.poor0.urban.rr <- as.data.frame(multivar.obese.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.obese.poor0.urban.rr$coef <- coefficients
  multivar.obese.poor0.urban.rr <- multivar.obese.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.obese.poor0.urban.rr, "multivar.obese.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.obese.pop.poor0.urban.edu.sex))
  multivar.obese.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.obese.poor0.urban.ame, "multivar.obese.poor0.urban.ame.xls")
  
```




```{r Regressions: smoking}

  smoke_subset <- read.csv("~/smoke_subset.csv", stringsAsFactors=F) 
  smoke_subset <- smoke_subset[,-1]

#prepare df  
  dat.reg.smoke <- smoke_subset %>% 
    dplyr::mutate(country = as.factor(country),
                  region = as.factor(region),
                  urban = as.factor(urban),
                  sex = as.factor(sex))

dat.reg.smoke <- dat.reg.smoke %>% 
  dplyr::mutate(female_lab = as.factor(ifelse(sex=="1", "Female", 
                             ifelse(sex=="0", "Male", NA))),
                urban_lab = as.factor(ifelse(urban=="1", "urban", 
                             ifelse(urban=="0", "rural", NA))),
                age_10yr_lab = as.factor(ifelse(age>=15 & age<=24, "15-24",
                        ifelse(age>=25 & age<=34, "25-34",
                            ifelse(age>=35 & age<=44, "35-44",
                                ifelse(age>=45 & age<=54, "45-54",
                                     ifelse(age>=55 & age<=64, "55-64",
                                          ifelse(age>=65, "65+", NA))))))),
                age_5yr_lab = as.factor(ifelse(age>=15 & age<=19, "15-19",
                        ifelse(age>=20 & age<=24, "20-24",
                            ifelse(age>=25 & age<=29, "25-29",
                                ifelse(age>=30 & age<=34, "30-34",
                                     ifelse(age>=35 & age<=39, "35-39",
                                          ifelse(age>=40 & age<=44, "40-44",
                                                 ifelse(age>=45 & age<=49, "45-49", 
                                                        ifelse(age>=50 & age<=54, "50-54",
                                                               ifelse(age>=55 & age<=59, "55-59",
                                                                      ifelse(age>=60 & age<=64, "60-64",
                                                                             ifelse(age>=65, "65+", NA)))))))))))),
                educat_lab = as.factor(ifelse(educat=="0", "No formal schooling", 
                             ifelse(educat=="1", "Primary school",
                                    ifelse(educat=="2", "Primary school",
                                       ifelse(educat=='3', 'High school or above', 
                                           ifelse(educat=="4", "High school or above",NA)))))))

  dat.reg.smoke$educat_lab <- factor(dat.reg.smoke$educat_lab, levels = c("No formal schooling", "Primary school", "High school or above"))

#global
#sex
  dat.reg.smoke.global <- filter(dat.reg.smoke, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.global %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global <- x2 %>% 
    left_join(dat.reg.smoke.global) %>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.global <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.global, family=poisson(link="log"),design=svy.smoke.pop.global )
  
  univar.smoke.global.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.global.sex.rr)
  univar.smoke.global.sex.rr <- as.data.frame(univar.smoke.global.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.global.sex.rr$coef <- coefficients
  univar.smoke.global.sex.rr <- univar.smoke.global.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.global.sex.rr, "univar.smoke.global.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global))
  univar.smoke.global.sex.ame<- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.global.sex.ame, "univar.smoke.global.sex.ame.xlsx")

#educat
  dat.reg.smoke.global.edu <- filter(dat.reg.smoke, is.na(educat_lab)==F)
  x2 <- dat.reg.smoke.global.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global.edu <- x2 %>% 
    left_join(dat.reg.smoke.global.edu)%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.global.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global.edu , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.global.edu, family=poisson(link="log"),design=svy.smoke.pop.global.edu )
  
  univar.smoke.global.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.global.edu.rr)
  univar.smoke.global.edu.rr <- as.data.frame(univar.smoke.global.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.global.edu.rr$coef <- coefficients
  univar.smoke.global.edu.rr <- univar.smoke.global.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.global.edu.rr, "univar.smoke.global.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global.edu))
  univar.smoke.global.edu.ame<- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.global.edu.ame, "univar.smoke.global.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.smoke.global.edu.sex <- filter(dat.reg.smoke, is.na(educat_lab)==F)
  dat.reg.smoke.global.edu.sex <- filter(dat.reg.smoke.global.edu.sex, is.na(female_lab)==F)
  x2 <- dat.reg.smoke.global.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.global.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.global.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global.edu.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.smoke.global.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.global.edu.sex )
  
  multivar.smoke.global.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.global.rr)
  multivar.smoke.global.rr <- as.data.frame(multivar.smoke.global.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.global.rr$coef <- coefficients
  multivar.smoke.global.rr <- multivar.smoke.global.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.global.rr, "multivar.smoke.global.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global.edu.sex))
  multivar.smoke.global.ame<- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(multivar.smoke.global.ame, "multivar.smoke.global.ame.xlsx")

#urban sample
#sex
  dat.reg.smoke.global.urban.sex <- filter(dat.reg.smoke, is.na(female_lab)==F)
  dat.reg.smoke.global.urban.sex <- filter(dat.reg.smoke.global.urban.sex, is.na(urban_lab)==F)
  x2 <- dat.reg.smoke.global.urban.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global.urban.sex <- x2 %>% 
    left_join(dat.reg.smoke.global.urban.sex)%>%
    mutate(country=as.character(country)) %>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.global.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global.urban.sex , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.global.urban.sex, family=poisson(link="log"),design=svy.smoke.pop.global.urban.sex )
  
  univar.smoke.global.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.global.sex.urban.rr)
  univar.smoke.global.sex.urban.rr <- as.data.frame(univar.smoke.global.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.global.sex.urban.rr$coef <- coefficients
  univar.smoke.global.sex.urban.rr <- univar.smoke.global.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.global.sex.urban.rr, "univar.smoke.global.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global.urban.sex))
  univar.smoke.global.sex.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.global.sex.urban.ame, "univar.smoke.global.sex.urban.ame.xlsx")

#educat
  dat.reg.smoke.global.urban.edu <- filter(dat.reg.smoke, is.na(educat_lab)==F)
  dat.reg.smoke.global.urban.edu <- filter(dat.reg.smoke.global.urban.edu, is.na(urban_lab)==F)
  x2 <- dat.reg.smoke.global.urban.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global.urban.edu <- x2 %>% 
    left_join(dat.reg.smoke.global.urban.edu) %>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.global.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global.urban.edu , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.global.urban.edu, family=poisson(link="log"),design=svy.smoke.pop.global.urban.edu )
  
  univar.smoke.global.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.global.edu.urban.rr)
  univar.smoke.global.edu.urban.rr <- as.data.frame(univar.smoke.global.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.global.edu.urban.rr$coef <- coefficients
  univar.smoke.global.edu.urban.rr <- univar.smoke.global.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.global.edu.urban.rr, "univar.smoke.global.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global.urban.edu))
  univar.smoke.global.edu.urban.ame<- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.global.edu.urban.ame, "univar.smoke.global.edu.urban.ame.xlsx")

#urban
  dat.reg.smoke.global.urban <- filter(dat.reg.smoke, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.global.urban %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global.urban <- x2 %>% 
    left_join(dat.reg.smoke.global.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.global.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global.urban , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.smoke.global.urban, family=poisson(link="log"),design=svy.smoke.pop.global.urban )
  
  univar.smoke.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.global.urban.rr)
  univar.smoke.global.urban.rr <- as.data.frame(univar.smoke.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.global.urban.rr$coef <- coefficients
  univar.smoke.global.urban.rr <- univar.smoke.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.global.urban.rr, "univar.smoke.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global.urban))
  univar.smoke.global.urban.ame<- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.global.urban.ame, "univar.smoke.global.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.smoke.global.urban.edu.sex <- filter(dat.reg.smoke, is.na(urban_lab)==F)
  dat.reg.smoke.global.urban.edu.sex <- filter(dat.reg.smoke.global.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.global.urban.edu.sex <- filter(dat.reg.smoke.global.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.global.urban.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.global.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.global.urban.edu.sex) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.global.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.global.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.smoke.global.urban.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.global.urban.edu.sex )
  
  multivar.smoke.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.global.urban.rr)
  multivar.smoke.global.urban.rr <- as.data.frame(multivar.smoke.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.global.urban.rr$coef <- coefficients
  multivar.smoke.global.urban.rr <- multivar.smoke.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.global.urban.rr, "multivar.smoke.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.global.urban.edu.sex))
  multivar.smoke.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.smoke.global.urban.ame, "multivar.smoke.global.urban.ame.xlsx")

### Poor19
#no urban sample

#sex
  dat.reg.smoke.poor19 <- dat.reg.smoke %>% dplyr::filter(poor19==1) 
  dat.reg.smoke.poor19 <- filter(dat.reg.smoke.poor19, is.na(female_lab)==F)

  x2 <- dat.reg.smoke.poor19 %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor19 <- x2 %>% 
    left_join(dat.reg.smoke.poor19)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19 , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab, data=dat.reg.smoke.poor19, family=poisson(link="log"),design=svy.smoke.pop.poor19 )
  
  univar.smoke.poor19.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor19.sex.rr)
  univar.smoke.poor19.sex.rr <- as.data.frame(univar.smoke.poor19.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor19.sex.rr$coef <- coefficients
  univar.smoke.poor19.sex.rr <- univar.smoke.poor19.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor19.sex.rr, "univar.smoke.poor19.sex.rr.xlsx")

#to get AME
  models <- margins(models,design=svy.smoke.pop.poor19)
  univar.smoke.poor19.sex.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor19.sex.ame, "univar.smoke.poor19.sex.ame.xlsx")

#educat
  dat.reg.smoke.poor19.edu <- dat.reg.smoke %>% dplyr::filter(poor19==1) 
  dat.reg.smoke.poor19.edu <- filter(dat.reg.smoke.poor19.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.smoke.poor19.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor19.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor19.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19.edu , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor19.edu, family=poisson(link="log"),design=svy.smoke.pop.poor19.edu )
  
  univar.smoke.poor19.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor19.edu.rr)
  univar.smoke.poor19.edu.rr <- as.data.frame(univar.smoke.poor19.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor19.edu.rr$coef <- coefficients
  univar.smoke.poor19.edu.rr <- univar.smoke.poor19.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor19.edu.rr, "univar.smoke.poor19.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor19.edu))
  univar.smoke.poor19.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor19.edu.ame, "univar.smoke.poor19.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.smoke.poor19.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor19==1) 
  dat.reg.smoke.poor19.edu.sex <- filter(dat.reg.smoke.poor19.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor19.edu.sex <- filter(dat.reg.smoke.poor19.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor19.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 

  dat.reg.smoke.poor19.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor19.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19.edu.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.smoke.poor19.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor19.edu.sex )
  
  multivar.smoke.poor19.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor19.edu.sex.rr)
  multivar.smoke.poor19.edu.sex.rr <- as.data.frame(multivar.smoke.poor19.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor19.edu.sex.rr$coef <- coefficients
  multivar.smoke.poor19.edu.sex.rr <- multivar.smoke.poor19.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor19.edu.sex.rr, "multivar.smoke.poor19.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor19.edu.sex))
  multivar.smoke.poor19.edu.sex.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor19.edu.sex.ame, "multivar.smoke.poor19.edu.sex.ame.xlsx")

#urban sample
#sex
  dat.reg.smoke.poor19.urban.sex <- dat.reg.smoke %>%dplyr::filter(poor19==1) 
  dat.reg.smoke.poor19.urban.sex <- filter(dat.reg.smoke.poor19.urban.sex, is.na(female_lab)==F)
  dat.reg.smoke.poor19.urban.sex <- filter(dat.reg.smoke.poor19.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor19.urban.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 

  dat.reg.smoke.poor19.urban.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor19.urban.sex)%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19.urban.sex , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor19.urban.sex, family=poisson(link="log"),design=svy.smoke.pop.poor19.urban.sex )
  
  univar.smoke.poor19.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor19.sex.urban.rr)
  univar.smoke.poor19.sex.urban.rr <- as.data.frame(univar.smoke.poor19.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor19.sex.urban.rr$coef <- coefficients
  univar.smoke.poor19.sex.urban.rr <- univar.smoke.poor19.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor19.sex.urban.rr, "univar.smoke.poor19.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor19.urban.sex))
  univar.smoke.poor19.sex.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor19.sex.urban.ame, "univar.smoke.poor19.sex.urban.ame.xlsx")

#educat
dat.reg.smoke.poor19.urban.edu <- dat.reg.smoke %>%dplyr::filter(poor19==1) 
dat.reg.smoke.poor19.urban.edu <- filter(dat.reg.smoke.poor19.urban.edu, is.na(educat_lab)==F)
dat.reg.smoke.poor19.urban.edu <- filter(dat.reg.smoke.poor19.urban.edu, is.na(urban_lab)==F)

x2 <- dat.reg.smoke.poor19.urban.edu %>%
  group_by(country) %>%
  filter(csmoke==1) %>%
  summarise(comb=n()) %>%
  filter(any(comb>0)) %>%
  select(country) 

dat.reg.smoke.poor19.urban.edu <- x2 %>% 
  left_join(dat.reg.smoke.poor19.urban.edu)%>% 
  mutate(country = as.character(country))%>% 
  mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19.urban.edu , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor19.urban.edu, family=poisson(link="log"),design=svy.smoke.pop.poor19.urban.edu )
  
  univar.smoke.poor19.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor19.edu.urban.rr)
  univar.smoke.poor19.edu.urban.rr <- as.data.frame(univar.smoke.poor19.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor19.edu.urban.rr$coef <- coefficients
  univar.smoke.poor19.edu.urban.rr <- univar.smoke.poor19.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor19.edu.urban.rr, "univar.smoke.poor19.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor19.urban.edu))
  univar.smoke.poor19.edu.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor19.edu.urban.ame, "univar.smoke.poor19.edu.urban.ame.xlsx")

#urban
  dat.reg.smoke.poor19.urban <- dat.reg.smoke %>%dplyr::filter(poor19==1)  
  dat.reg.smoke.poor19.urban <- filter(dat.reg.smoke.poor19.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor19.urban %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 

  dat.reg.smoke.poor19.urban <- x2 %>% 
    left_join(dat.reg.smoke.poor19.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19.urban , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.smoke.poor19.urban, family=poisson(link="log"),design=svy.smoke.pop.poor19.urban )
  
  univar.smoke.poor19.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor19.urban.rr)
  univar.smoke.poor19.urban.rr <- as.data.frame(univar.smoke.poor19.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor19.urban.rr$coef <- coefficients
  univar.smoke.poor19.urban.rr <- univar.smoke.poor19.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor19.urban.rr, "univar.smoke.poor19.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor19.urban))
  univar.smoke.poor19.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor19.urban.ame, "univar.smoke.poor19.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.smoke.poor19.urban.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor19==1)  
  dat.reg.smoke.poor19.urban.edu.sex <- filter(dat.reg.smoke.poor19.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.smoke.poor19.urban.edu.sex <- filter(dat.reg.smoke.poor19.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor19.urban.edu.sex <- filter(dat.reg.smoke.poor19.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor19.urban.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor19.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor19.urban.edu.sex)%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor19.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor19.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.smoke.poor19.urban.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor19.urban.edu.sex )
  
  multivar.smoke.poor19.urban.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor19.urban.edu.sex.rr)
  multivar.smoke.poor19.urban.edu.sex.rr <- as.data.frame(multivar.smoke.poor19.urban.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor19.urban.edu.sex.rr$coef <- coefficients
  multivar.smoke.poor19.urban.edu.sex.rr <- multivar.smoke.poor19.urban.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor19.urban.edu.sex.rr, "multivar.smoke.poor19.urban.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor19.urban.edu.sex))
  multivar.smoke.poor19.urban.edu.sex.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor19.urban.edu.sex.ame, "multivar.smoke.poor19.urban.edu.sex.ame.xlsx")

###POOR32
#no urban sample

#sex
  dat.reg.smoke.poor32 <- dat.reg.smoke %>% dplyr::filter(poor32==1) 
  dat.reg.smoke.poor32 <- filter(dat.reg.smoke.poor32, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor32 %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor32 <- x2 %>% 
    left_join(dat.reg.smoke.poor32)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32 , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor32, family=poisson(link="log"),design=svy.smoke.pop.poor32 )
  
  univar.smoke.poor32.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor32.sex.rr)
  univar.smoke.poor32.sex.rr <- as.data.frame(univar.smoke.poor32.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor32.sex.rr$coef <- coefficients
  univar.smoke.poor32.sex.rr <- univar.smoke.poor32.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor32.sex.rr, "univar.smoke.poor32.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32))
  univar.smoke.poor32.sex.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor32.sex.ame, "univar.smoke.poor32.sex.ame.xlsx")

#educat
  dat.reg.smoke.poor32.edu <- dat.reg.smoke %>% dplyr::filter(poor32==1) 
  dat.reg.smoke.poor32.edu <- filter(dat.reg.smoke.poor32.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.smoke.poor32.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor32.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor32.edu)%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32.edu , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor32.edu, family=poisson(link="log"),design=svy.smoke.pop.poor32.edu )
  
  univar.smoke.poor32.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor32.edu.rr)
  univar.smoke.poor32.edu.rr <- as.data.frame(univar.smoke.poor32.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor32.edu.rr$coef <- coefficients
  univar.smoke.poor32.edu.rr <- univar.smoke.poor32.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor32.edu.rr, "univar.smoke.poor32.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32.edu))
  univar.smoke.poor32.edu.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor32.edu.ame, "univar.smoke.poor32.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.smoke.poor32.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor32==1) 
  dat.reg.smoke.poor32.edu.sex <- filter(dat.reg.smoke.poor32.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor32.edu.sex <- filter(dat.reg.smoke.poor32.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor32.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor32.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor32.edu.sex) %>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32.edu.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.smoke.poor32.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor32.edu.sex )
  
  multivar.smoke.poor32.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor32.rr)
  multivar.smoke.poor32.rr <- as.data.frame(multivar.smoke.poor32.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor32.rr$coef <- coefficients
  multivar.smoke.poor32.rr <- multivar.smoke.poor32.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor32.rr, "multivar.smoke.poor32.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32.edu.sex))
  multivar.smoke.poor32.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor32.ame, "multivar.smoke.poor32.ame.xlsx")

#urban sample
#sex
  dat.reg.smoke.poor32.urban.sex <- dat.reg.smoke %>%dplyr::filter(poor32==1) 
  dat.reg.smoke.poor32.urban.sex <- filter(dat.reg.smoke.poor32.urban.sex, is.na(female_lab)==F)
  dat.reg.smoke.poor32.urban.sex <- filter(dat.reg.smoke.poor32.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor32.urban.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor32.urban.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor32.urban.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32.urban.sex , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor32.urban.sex, family=poisson(link="log"),design=svy.smoke.pop.poor32.urban.sex )
  
  univar.smoke.poor32.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor32.sex.urban.rr)
  univar.smoke.poor32.sex.urban.rr <- as.data.frame(univar.smoke.poor32.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor32.sex.urban.rr$coef <- coefficients
  univar.smoke.poor32.sex.urban.rr <- univar.smoke.poor32.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor32.sex.urban.rr, "univar.smoke.poor32.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32.urban.sex))
  univar.smoke.poor32.sex.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor32.sex.urban.ame, "univar.smoke.poor32.sex.urban.ame.xls")

#educat
  dat.reg.smoke.poor32.urban.edu <- dat.reg.smoke %>%dplyr::filter(poor32==1) 
  dat.reg.smoke.poor32.urban.edu <- filter(dat.reg.smoke.poor32.urban.edu, is.na(educat_lab)==F)
  dat.reg.smoke.poor32.urban.edu <- filter(dat.reg.smoke.poor32.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor32.urban.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor32.urban.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor32.urban.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32.urban.edu , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor32.urban.edu, family=poisson(link="log"),design=svy.smoke.pop.poor32.urban.edu )
  
  univar.smoke.poor32.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor32.edu.urban.rr)
  univar.smoke.poor32.edu.urban.rr <- as.data.frame(univar.smoke.poor32.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor32.edu.urban.rr$coef <- coefficients
  univar.smoke.poor32.edu.urban.rr <- univar.smoke.poor32.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor32.edu.urban.rr, "univar.smoke.poor32.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32.urban.edu))
  univar.smoke.poor32.edu.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor32.edu.urban.ame, "univar.smoke.poor32.edu.urban.ame.xls")

#urban
  dat.reg.smoke.poor32.urban <- dat.reg.smoke %>%dplyr::filter(poor32==1)  
  dat.reg.smoke.poor32.urban <- filter(dat.reg.smoke.poor32.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor32.urban %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor32.urban <- x2 %>% 
    left_join(dat.reg.smoke.poor32.urban)%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32.urban , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.smoke.poor32.urban, family=poisson(link="log"),design=svy.smoke.pop.poor32.urban )
  
  univar.smoke.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor32.urban.rr)
  univar.smoke.poor32.urban.rr <- as.data.frame(univar.smoke.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor32.urban.rr$coef <- coefficients
  univar.smoke.poor32.urban.rr <- univar.smoke.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor32.urban.rr, "univar.smoke.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32.urban))
  univar.smoke.poor32.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(univar.smoke.poor32.urban.ame, "univar.smoke.poor32.urban.ame.xls")

#multivariate: edu, sex, urban
  dat.reg.smoke.poor32.urban.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor32==1)  
  dat.reg.smoke.poor32.urban.edu.sex <- filter(dat.reg.smoke.poor32.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.smoke.poor32.urban.edu.sex <- filter(dat.reg.smoke.poor32.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor32.urban.edu.sex <- filter(dat.reg.smoke.poor32.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor32.urban.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 

  dat.reg.smoke.poor32.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor32.urban.edu.sex) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor32.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor32.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.smoke.poor32.urban.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor32.urban.edu.sex )
  
  multivar.smoke.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor32.urban.rr)
  multivar.smoke.poor32.urban.rr <- as.data.frame(multivar.smoke.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor32.urban.rr$coef <- coefficients
  multivar.smoke.poor32.urban.rr <- multivar.smoke.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor32.urban.rr, "multivar.smoke.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor32.urban.edu.sex))
  multivar.smoke.poor32.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor32.urban.ame, "multivar.smoke.poor32.urban.ame.xls")

###POOR55
#no urban sample

#sex
  dat.reg.smoke.poor55 <- dat.reg.smoke %>% dplyr::filter(poor55==1) 
  dat.reg.smoke.poor55 <- filter(dat.reg.smoke.poor55, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor55 %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor55 <- x2 %>% 
    left_join(dat.reg.smoke.poor55)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55 , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor55, family=poisson(link="log"),design=svy.smoke.pop.poor55 )
  
  univar.smoke.poor55.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor55.sex.rr)
  univar.smoke.poor55.sex.rr <- as.data.frame(univar.smoke.poor55.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor55.sex.rr$coef <- coefficients
  univar.smoke.poor55.sex.rr <- univar.smoke.poor55.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor55.sex.rr, "univar.smoke.poor55.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55))
  univar.smoke.poor55.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor55.sex.ame, "univar.smoke.poor55.sex.ame.xls")

#educat
  dat.reg.smoke.poor55.edu <- dat.reg.smoke %>% dplyr::filter(poor55==1) 
  dat.reg.smoke.poor55.edu <- filter(dat.reg.smoke.poor55.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.smoke.poor55.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor55.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor55.edu) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor55.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55.edu , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor55.edu, family=poisson(link="log"),design=svy.smoke.pop.poor55.edu )
  
  univar.smoke.poor55.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor55.edu.rr)
  univar.smoke.poor55.edu.rr <- as.data.frame(univar.smoke.poor55.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor55.edu.rr$coef <- coefficients
  univar.smoke.poor55.edu.rr <- univar.smoke.poor55.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor55.edu.rr, "univar.smoke.poor55.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55.edu))
  univar.smoke.poor55.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor55.edu.ame, "univar.smoke.poor55.edu.ame.xls")

#multivariate: edu, sex
  dat.reg.smoke.poor55.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor55==1) 
  dat.reg.smoke.poor55.edu.sex <- filter(dat.reg.smoke.poor55.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor55.edu.sex <- filter(dat.reg.smoke.poor55.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor55.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor55.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor55.edu.sex) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor55.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55.edu.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.smoke.poor55.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor55.edu.sex )
  
  multivar.smoke.poor55.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor55.rr)
  multivar.smoke.poor55.rr <- as.data.frame(multivar.smoke.poor55.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor55.rr$coef <- coefficients
  multivar.smoke.poor55.rr <- multivar.smoke.poor55.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor55.rr, "multivar.smoke.poor55.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55.edu.sex))
  multivar.smoke.poor55.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor55.ame, "multivar.smoke.poor55.ame.xls")

#urban sample
#sex
  dat.reg.smoke.poor55.urban.sex <- dat.reg.smoke %>%dplyr::filter(poor55==1) 
  dat.reg.smoke.poor55.urban.sex <- filter(dat.reg.smoke.poor55.urban.sex, is.na(female_lab)==F)
  dat.reg.smoke.poor55.urban.sex <- filter(dat.reg.smoke.poor55.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor55.urban.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor55.urban.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor55.urban.sex)%>% 
    mutate(country = as.character(country)) %>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor55.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55.urban.sex , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor55.urban.sex, family=poisson(link="log"),design=svy.smoke.pop.poor55.urban.sex )
  
  univar.smoke.poor55.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor55.sex.urban.rr)
  univar.smoke.poor55.sex.urban.rr <- as.data.frame(univar.smoke.poor55.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor55.sex.urban.rr$coef <- coefficients
  univar.smoke.poor55.sex.urban.rr <- univar.smoke.poor55.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor55.sex.urban.rr, "univar.smoke.poor55.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55.urban.sex))
  univar.smoke.poor55.sex.urban.ame <- summary(models) %>% 
    mutate(AME = round(AME, 2),
          lower = round(lower, 2),
          upper = round(upper, 2),
          estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor55.sex.urban.ame, "univar.smoke.poor55.sex.urban.ame.xls")

#educat
  dat.reg.smoke.poor55.urban.edu <- dat.reg.smoke %>%dplyr::filter(poor55==1) 
  dat.reg.smoke.poor55.urban.edu <- filter(dat.reg.smoke.poor55.urban.edu, is.na(educat_lab)==F)
  dat.reg.smoke.poor55.urban.edu <- filter(dat.reg.smoke.poor55.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor55.urban.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor55.urban.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor55.urban.edu) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor55.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55.urban.edu , nest = 
                                                T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor55.urban.edu, family=poisson(link="log"),design=svy.smoke.pop.poor55.urban.edu )
  
  univar.smoke.poor55.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor55.edu.urban.rr)
  univar.smoke.poor55.edu.urban.rr <- as.data.frame(univar.smoke.poor55.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor55.edu.urban.rr$coef <- coefficients
  univar.smoke.poor55.edu.urban.rr <- univar.smoke.poor55.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor55.edu.urban.rr, "univar.smoke.poor55.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55.urban.edu))
  univar.smoke.poor55.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor55.edu.urban.ame, "univar.smoke.poor55.edu.urban.ame.xls")

#urban
  dat.reg.smoke.poor55.urban <- dat.reg.smoke %>%dplyr::filter(poor55==1)  
  dat.reg.smoke.poor55.urban <- filter(dat.reg.smoke.poor55.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor55.urban %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor55.urban <- x2 %>% 
    left_join(dat.reg.smoke.poor55.urban) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor55.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55.urban , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.smoke.poor55.urban, family=poisson(link="log"),design=svy.smoke.pop.poor55.urban )
  
  univar.smoke.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor55.urban.rr)
  univar.smoke.poor55.urban.rr <- as.data.frame(univar.smoke.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor55.urban.rr$coef <- coefficients
  univar.smoke.poor55.urban.rr <- univar.smoke.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor55.urban.rr, "univar.smoke.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55.urban))
  univar.smoke.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor55.urban.ame, "univar.smoke.poor55.urban.ame.xlsx")

#multivariate: edu, sex, urban
dat.reg.smoke.poor55.urban.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor55==1)  
dat.reg.smoke.poor55.urban.edu.sex <- filter(dat.reg.smoke.poor55.urban.edu.sex, is.na(urban_lab)==F)
dat.reg.smoke.poor55.urban.edu.sex <- filter(dat.reg.smoke.poor55.urban.edu.sex, is.na(educat_lab)==F)
dat.reg.smoke.poor55.urban.edu.sex <- filter(dat.reg.smoke.poor55.urban.edu.sex, is.na(female_lab)==F)

x2 <- dat.reg.smoke.poor55.urban.edu.sex %>%
  group_by(country) %>%
  filter(csmoke==1) %>%
  summarise(comb=n()) %>%
  filter(any(comb>0)) %>%
  select(country) 

dat.reg.smoke.poor55.urban.edu.sex <- x2 %>% 
  left_join(dat.reg.smoke.poor55.urban.edu.sex)%>% 
  mutate(country = as.character(country)) %>% 
  mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor55.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor55.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.smoke.poor55.urban.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor55.urban.edu.sex )
  
  multivar.smoke.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor55.urban.rr)
  multivar.smoke.poor55.urban.rr <- as.data.frame(multivar.smoke.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor55.urban.rr$coef <- coefficients
  multivar.smoke.poor55.urban.rr <- multivar.smoke.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor55.urban.rr, "multivar.smoke.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor55.urban.edu.sex))
  multivar.smoke.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor55.urban.ame, "multivar.smoke.poor55.urban.ame.xls")

###NONPOOR
#no urban sample

#sex
  dat.reg.smoke.poor0 <- dat.reg.smoke %>% dplyr::filter(poor55==0) 
  dat.reg.smoke.poor0 <- filter(dat.reg.smoke.poor0, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor0 %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor0 <- x2 %>% 
    left_join(dat.reg.smoke.poor0) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0 , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor0, family=poisson(link="log"),design=svy.smoke.pop.poor0 )
  
  univar.smoke.poor0.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor0.sex.rr)
  univar.smoke.poor0.sex.rr <- as.data.frame(univar.smoke.poor0.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor0.sex.rr$coef <- coefficients
  univar.smoke.poor0.sex.rr <- univar.smoke.poor0.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor0.sex.rr, "univar.smoke.poor0.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0))
  univar.smoke.poor0.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor0.sex.ame, "univar.smoke.poor0.sex.ame.xls")

#educat
  dat.reg.smoke.poor0.edu <- dat.reg.smoke %>% dplyr::filter(poor55==0)  
  dat.reg.smoke.poor0.edu <- filter(dat.reg.smoke.poor0.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.smoke.poor0.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor0.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor0.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor0.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0.edu , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor0.edu, family=poisson(link="log"),design=svy.smoke.pop.poor0.edu )
  
  univar.smoke.poor0.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor0.edu.rr)
  univar.smoke.poor0.edu.rr <- as.data.frame(univar.smoke.poor0.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor0.edu.rr$coef <- coefficients
  univar.smoke.poor0.edu.rr <- univar.smoke.poor0.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor0.edu.rr, "univar.smoke.poor0.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0.edu))
  univar.smoke.poor0.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor0.edu.ame, "univar.smoke.poor0.edu.ame.xls")

#multivariate: edu, sex
  dat.reg.smoke.poor0.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor55==0) 
  dat.reg.smoke.poor0.edu.sex <- filter(dat.reg.smoke.poor0.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor0.edu.sex <- filter(dat.reg.smoke.poor0.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor0.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor0.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor0.edu.sex) %>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.poor0.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0.edu.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.smoke.poor0.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor0.edu.sex )
  
  multivar.smoke.poor0.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor0.rr)
  multivar.smoke.poor0.rr <- as.data.frame(multivar.smoke.poor0.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor0.rr$coef <- coefficients
  multivar.smoke.poor0.rr <- multivar.smoke.poor0.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor0.rr, "multivar.smoke.poor0.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0.edu.sex))
  multivar.smoke.poor0.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor0.ame, "multivar.smoke.poor0.ame.xls")

#urban sample
#sex
  dat.reg.smoke.poor0.urban.sex <- dat.reg.smoke %>%dplyr::filter(poor55==0) 
  dat.reg.smoke.poor0.urban.sex <- filter(dat.reg.smoke.poor0.urban.sex, is.na(female_lab)==F)
  dat.reg.smoke.poor0.urban.sex <- filter(dat.reg.smoke.poor0.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor0.urban.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor0.urban.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor0.urban.sex)%>%
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design  
  svy.smoke.pop.poor0.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0.urban.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.smoke.poor0.urban.sex, family=poisson(link="log"),design=svy.smoke.pop.poor0.urban.sex )
  
  univar.smoke.poor0.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor0.sex.urban.rr)
  univar.smoke.poor0.sex.urban.rr <- as.data.frame(univar.smoke.poor0.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor0.sex.urban.rr$coef <- coefficients
  univar.smoke.poor0.sex.urban.rr <- univar.smoke.poor0.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor0.sex.urban.rr, "univar.smoke.poor0.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0.urban.sex))
  univar.smoke.poor0.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor0.sex.urban.ame, "univar.smoke.poor0.sex.urban.ame.xls")

#educat
  dat.reg.smoke.poor0.urban.edu <- dat.reg.smoke %>%dplyr::filter(poor55==0)  
  dat.reg.smoke.poor0.urban.edu <- filter(dat.reg.smoke.poor0.urban.edu, is.na(educat_lab)==F)
  dat.reg.smoke.poor0.urban.edu <- filter(dat.reg.smoke.poor0.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor0.urban.edu %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor0.urban.edu <- x2 %>% 
    left_join(dat.reg.smoke.poor0.urban.edu)%>%
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design 
  svy.smoke.pop.poor0.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0.urban.edu , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.smoke.poor0.urban.edu, family=poisson(link="log"),design=svy.smoke.pop.poor0.urban.edu )
  
  univar.smoke.poor0.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor0.edu.urban.rr)
  univar.smoke.poor0.edu.urban.rr <- as.data.frame(univar.smoke.poor0.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor0.edu.urban.rr$coef <- coefficients
  univar.smoke.poor0.edu.urban.rr <- univar.smoke.poor0.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor0.edu.urban.rr, "univar.smoke.poor0.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0.urban.edu))
  univar.smoke.poor0.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor0.edu.urban.ame, "univar.smoke.poor0.edu.urban.ame.xls")

#urban
  dat.reg.smoke.poor0.urban <- dat.reg.smoke %>%dplyr::filter(poor55==0)   
  dat.reg.smoke.poor0.urban <- filter(dat.reg.smoke.poor0.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.smoke.poor0.urban %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.smoke.poor0.urban <- x2 %>% 
    left_join(dat.reg.smoke.poor0.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor0.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0.urban , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.smoke.poor0.urban, family=poisson(link="log"),design=svy.smoke.pop.poor0.urban )
  
  univar.smoke.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.smoke.poor0.urban.rr)
  univar.smoke.poor0.urban.rr <- as.data.frame(univar.smoke.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.smoke.poor0.urban.rr$coef <- coefficients
  univar.smoke.poor0.urban.rr <- univar.smoke.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.smoke.poor0.urban.rr, "univar.smoke.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0.urban))
  univar.smoke.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.smoke.poor0.urban.ame, "univar.smoke.poor0.urban.ame.xls")

#multivariate: edu, sex, urban
  dat.reg.smoke.poor0.urban.edu.sex <- dat.reg.smoke %>% dplyr::filter(poor55==0)  
  dat.reg.smoke.poor0.urban.edu.sex <- filter(dat.reg.smoke.poor0.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.smoke.poor0.urban.edu.sex <- filter(dat.reg.smoke.poor0.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.smoke.poor0.urban.edu.sex <- filter(dat.reg.smoke.poor0.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.smoke.poor0.urban.edu.sex %>%
    group_by(country) %>%
    filter(csmoke==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.smoke.poor0.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.smoke.poor0.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.smoke.pop.poor0.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.smoke.poor0.urban.edu.sex , nest = T)
  
  models <- svyglm(csmoke ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.smoke.poor0.urban.edu.sex, family=poisson(link="log"),design=svy.smoke.pop.poor0.urban.edu.sex )
  
  multivar.smoke.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.smoke.poor0.urban.rr)
  multivar.smoke.poor0.urban.rr <- as.data.frame(multivar.smoke.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.smoke.poor0.urban.rr$coef <- coefficients
  multivar.smoke.poor0.urban.rr <- multivar.smoke.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.smoke.poor0.urban.rr, "multivar.smoke.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.smoke.pop.poor0.urban.edu.sex))
  multivar.smoke.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.smoke.poor0.urban.ame, "multivar.smoke.poor0.urban.ame.xls")

```

```{r Regressions: lipids}

  lipid_subset <- read.csv("~/lipid_subset.csv", stringsAsFactors=F)

  dat.reg.lipids <- lipid_subset %>% 
    mutate(country = as.factor(country),
          region = as.factor(region),
          urban = as.factor(urban),
          sex = as.factor(sex)) %>% 
    mutate(female_lab = as.factor(
                            ifelse(sex=="1", "Female", 
                               ifelse(sex=="0", "Male", NA))),
           urban_lab = as.factor(ifelse(urban=="1", "urban", 
                               ifelse(urban=="0", "rural", NA))),
           age_10yr_lab = as.factor(ifelse(age>=15 & age<=24, "15-24",
                          ifelse(age>=25 & age<=34, "25-34",
                              ifelse(age>=35 & age<=44, "35-44",
                                  ifelse(age>=45 & age<=54, "45-54",
                                       ifelse(age>=55 & age<=64, "55-64",
                                            ifelse(age>=65, "65+", NA))))))),
           age_5yr_lab = as.factor(ifelse(age>=15 & age<=19, "15-19",
                          ifelse(age>=20 & age<=24, "20-24",
                              ifelse(age>=25 & age<=29, "25-29",
                                  ifelse(age>=30 & age<=34, "30-34",
                                       ifelse(age>=35 & age<=39, "35-39",
                                            ifelse(age>=40 & age<=44, "40-44",
                                                   ifelse(age>=45 & age<=49, "45-49", 
                                                          ifelse(age>=50 & age<=54, "50-54",
                                                                 ifelse(age>=55 & age<=59, "55-59",
                                                                        ifelse(age>=60 & age<=64, "60-64",
                                                                               ifelse(age>=65, "65+", NA)))))))))))),
           educat_lab = as.factor(ifelse(educat=="0", "No formal schooling", 
                               ifelse(educat=="1", "Primary school",
                                      ifelse(educat=="2", "Primary school",
                                         ifelse(educat=='3', 'High school or above', 
                                             ifelse(educat=="4", "High school or above",NA)))))))
  
  dat.reg.lipids$educat_lab <- factor(dat.reg.lipids$educat_lab, levels = c("No formal schooling", "Primary school", "High school or above"))


###GLOBAL
#no urban sample

#sex
  dat.reg.lipids.global <- filter(dat.reg.lipids, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.global %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.global <- x2 %>% 
    left_join(dat.reg.lipids.global)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.global, family=poisson(link="log"),design=svy.lipids.pop.global )
  
  univar.lipids.global.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.global.sex.rr)
  univar.lipids.global.sex.rr <- as.data.frame(univar.lipids.global.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.global.sex.rr$coef <- coefficients
  univar.lipids.global.sex.rr <- univar.lipids.global.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.global.sex.rr, "univar.lipids.global.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global))
  univar.lipids.global.sex.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.global.sex.ame, "univar.lipids.global.sex.ame.xlsx")

#educat
  dat.reg.lipids.global.edu <- filter(dat.reg.lipids, is.na(educat_lab)==F)
  
  x2 <- dat.reg.lipids.global.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.global.edu <- x2 %>% left_join(dat.reg.lipids.global.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global.edu , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.global.edu, family=poisson(link="log"),design=svy.lipids.pop.global.edu )
  
  univar.lipids.global.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.global.edu.rr)
  univar.lipids.global.edu.rr <- as.data.frame(univar.lipids.global.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.global.edu.rr$coef <- coefficients
  univar.lipids.global.edu.rr <- univar.lipids.global.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.global.edu.rr, "univar.lipids.global.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global.edu))
  univar.lipids.global.edu.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.global.edu.ame, "univar.lipids.global.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.lipids.global.edu.sex <- filter(dat.reg.lipids, is.na(educat_lab)==F)
  dat.reg.lipids.global.edu.sex <- filter(dat.reg.lipids.global.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.global.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.global.edu.sex <- x2 %>% left_join(dat.reg.lipids.global.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global.edu.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.lipids.global.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.global.edu.sex )
  
  multivar.lipids.global.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.global.rr)
  multivar.lipids.global.rr <- as.data.frame(multivar.lipids.global.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.global.rr$coef <- coefficients
  multivar.lipids.global.rr <- multivar.lipids.global.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.global.rr, "multivar.lipids.global.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global.edu.sex))
  multivar.lipids.global.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.global.ame, "multivar.lipids.global.ame.xlsx")

#urban sample
#sex
  dat.reg.lipids.global.urban.sex <- filter(dat.reg.lipids, is.na(female_lab)==F)
  dat.reg.lipids.global.urban.sex <- filter(dat.reg.lipids.global.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.global.urban.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.global.urban.sex <- x2 %>% 
    left_join(dat.reg.lipids.global.urban.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global.urban.sex , nest 
                                               = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.global.urban.sex, family=poisson(link="log"),design=svy.lipids.pop.global.urban.sex )
  
  univar.lipids.global.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.global.sex.urban.rr)
  univar.lipids.global.sex.urban.rr <- as.data.frame(univar.lipids.global.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.global.sex.urban.rr$coef <- coefficients
  univar.lipids.global.sex.urban.rr <- univar.lipids.global.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.global.sex.urban.rr, "univar.lipids.global.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global.urban.sex))
  univar.lipids.global.sex.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.global.sex.urban.ame, "univar.lipids.global.sex.urban.ame.xlsx")

#educat
  dat.reg.lipids.global.urban.edu <- filter(dat.reg.lipids, is.na(educat_lab)==F)
  dat.reg.lipids.global.urban.edu <- filter(dat.reg.lipids.global.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.global.urban.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.global.urban.edu <- x2 %>% 
    left_join(dat.reg.lipids.global.urban.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global.urban.edu , nest 
                                               = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.global.urban.edu, family=poisson(link="log"),design=svy.lipids.pop.global.urban.edu )
  
  univar.lipids.global.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.global.edu.urban.rr)
  univar.lipids.global.edu.urban.rr <- as.data.frame(univar.lipids.global.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.global.edu.urban.rr$coef <- coefficients
  univar.lipids.global.edu.urban.rr <- univar.lipids.global.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.global.edu.urban.rr, "univar.lipids.global.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global.urban.edu))
  univar.lipids.global.edu.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.global.edu.urban.ame, "univar.lipids.global.edu.urban.ame.xlsx")

#urban
  dat.reg.lipids.global.urban <- filter(dat.reg.lipids, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.global.urban %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.global.urban <- x2 %>% 
    left_join(dat.reg.lipids.global.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global.urban , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.lipids.global.urban, family=poisson(link="log"),design=svy.lipids.pop.global.urban )
  
  univar.lipids.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.global.urban.rr)
  univar.lipids.global.urban.rr <- as.data.frame(univar.lipids.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.global.urban.rr$coef <- coefficients
  univar.lipids.global.urban.rr <- univar.lipids.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.global.urban.rr, "univar.lipids.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global.urban))
  univar.lipids.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.global.urban.ame, "univar.lipids.global.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.lipids.global.urban.edu.sex <- filter(dat.reg.lipids, is.na(urban_lab)==F)
  dat.reg.lipids.global.urban.edu.sex <- filter(dat.reg.lipids.global.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.global.urban.edu.sex <- filter(dat.reg.lipids.global.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.global.urban.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  
  dat.reg.lipids.global.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.global.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.global.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.global.urban.edu.sex
                                                   , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.lipids.global.urban.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.global.urban.edu.sex )
  
  multivar.lipids.global.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.global.urban.rr)
  multivar.lipids.global.urban.rr <- as.data.frame(multivar.lipids.global.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.global.urban.rr$coef <- coefficients
  multivar.lipids.global.urban.rr <- multivar.lipids.global.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.global.urban.rr, "multivar.lipids.global.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.global.urban.edu.sex))
  multivar.lipids.global.urban.ame<- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.global.urban.ame, "multivar.lipids.global.urban.ame.xlsx")

###POOR19
#no urban sample

#sex
  dat.reg.lipids.poor19 <- dat.reg.lipids %>% dplyr::filter(poor19==1) 
  dat.reg.lipids.poor19 <- filter(dat.reg.lipids.poor19, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor19 %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19 <- x2 %>% 
    left_join(dat.reg.lipids.poor19)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19 , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab, data=dat.reg.lipids.poor19, family=poisson(link="log"),design=svy.lipids.pop.poor19 )
  
  univar.lipids.poor19.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor19.sex.rr)
  univar.lipids.poor19.sex.rr <- as.data.frame(univar.lipids.poor19.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor19.sex.rr$coef <- coefficients
  univar.lipids.poor19.sex.rr <- univar.lipids.poor19.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor19.sex.rr, "univar.lipids.poor19.sex.rr.xlsx")

#to get AME
  models <- margins(models,design=svy.lipids.pop.poor19)
  univar.lipids.poor19.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor19.sex.ame, "univar.lipids.poor19.sex.ame.xlsx")

#educat
  dat.reg.lipids.poor19.edu <- dat.reg.lipids %>% dplyr::filter(poor19==1) 
  dat.reg.lipids.poor19.edu <- filter(dat.reg.lipids.poor19.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.lipids.poor19.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor19.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19.edu , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor19.edu, family=poisson(link="log"),design=svy.lipids.pop.poor19.edu )
  
  univar.lipids.poor19.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor19.edu.rr)
  univar.lipids.poor19.edu.rr <- as.data.frame(univar.lipids.poor19.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor19.edu.rr$coef <- coefficients
  univar.lipids.poor19.edu.rr <- univar.lipids.poor19.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor19.edu.rr, "univar.lipids.poor19.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor19.edu))
  univar.lipids.poor19.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor19.edu.ame, "univar.lipids.poor19.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.lipids.poor19.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor19==1) 
  dat.reg.lipids.poor19.edu.sex <- filter(dat.reg.lipids.poor19.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor19.edu.sex <- filter(dat.reg.lipids.poor19.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor19.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor19.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19.edu.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.lipids.poor19.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor19.edu.sex )
  
  multivar.lipids.poor19.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor19.edu.sex.rr)
  multivar.lipids.poor19.edu.sex.rr <- as.data.frame(multivar.lipids.poor19.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor19.edu.sex.rr$coef <- coefficients
  multivar.lipids.poor19.edu.sex.rr <- multivar.lipids.poor19.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor19.edu.sex.rr, "multivar.lipids.poor19.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor19.edu.sex))
  multivar.lipids.poor19.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor19.edu.sex.ame, "multivar.lipids.poor19.edu.sex.ame.xlsx")

#urban sample
#sex
  dat.reg.lipids.poor19.urban.sex <- dat.reg.lipids %>%dplyr::filter(poor19==1) 
  dat.reg.lipids.poor19.urban.sex <- filter(dat.reg.lipids.poor19.urban.sex, is.na(female_lab)==F)
  dat.reg.lipids.poor19.urban.sex <- filter(dat.reg.lipids.poor19.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor19.urban.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19.urban.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor19.urban.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19.urban.sex , nest 
                                               = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor19.urban.sex, family=poisson(link="log"),design=svy.lipids.pop.poor19.urban.sex )
  
  univar.lipids.poor19.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor19.sex.urban.rr)
  univar.lipids.poor19.sex.urban.rr <- as.data.frame(univar.lipids.poor19.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor19.sex.urban.rr$coef <- coefficients
  univar.lipids.poor19.sex.urban.rr <- univar.lipids.poor19.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor19.sex.urban.rr, "univar.lipids.poor19.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor19.urban.sex))
  univar.lipids.poor19.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor19.sex.urban.ame, "univar.lipids.poor19.sex.urban.ame.xlsx")

#educat
  dat.reg.lipids.poor19.urban.edu <- dat.reg.lipids %>%dplyr::filter(poor19==1) 
  dat.reg.lipids.poor19.urban.edu <- filter(dat.reg.lipids.poor19.urban.edu, is.na(educat_lab)==F)
  dat.reg.lipids.poor19.urban.edu <- filter(dat.reg.lipids.poor19.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor19.urban.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19.urban.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor19.urban.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19.urban.edu , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor19.urban.edu, family=poisson(link="log"),design=svy.lipids.pop.poor19.urban.edu )
  
  univar.lipids.poor19.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor19.edu.urban.rr)
  univar.lipids.poor19.edu.urban.rr <- as.data.frame(univar.lipids.poor19.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor19.edu.urban.rr$coef <- coefficients
  univar.lipids.poor19.edu.urban.rr <- univar.lipids.poor19.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor19.edu.urban.rr, "univar.lipids.poor19.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor19.urban.edu))
  univar.lipids.poor19.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor19.edu.urban.ame, "univar.lipids.poor19.edu.urban.ame.xlsx")

#urban
  dat.reg.lipids.poor19.urban <- dat.reg.lipids %>%dplyr::filter(poor19==1)  
  dat.reg.lipids.poor19.urban <- filter(dat.reg.lipids.poor19.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor19.urban %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19.urban <- x2 %>% 
    left_join(dat.reg.lipids.poor19.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19.urban , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.lipids.poor19.urban, family=poisson(link="log"),design=svy.lipids.pop.poor19.urban )
  
  univar.lipids.poor19.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor19.urban.rr)
  univar.lipids.poor19.urban.rr <- as.data.frame(univar.lipids.poor19.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor19.urban.rr$coef <- coefficients
  univar.lipids.poor19.urban.rr <- univar.lipids.poor19.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor19.urban.rr, "univar.lipids.poor19.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor19.urban))
  univar.lipids.poor19.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor19.urban.ame, "univar.lipids.poor19.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.lipids.poor19.urban.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor19==1)  
  dat.reg.lipids.poor19.urban.edu.sex <- filter(dat.reg.lipids.poor19.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.lipids.poor19.urban.edu.sex <- filter(dat.reg.lipids.poor19.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor19.urban.edu.sex <- filter(dat.reg.lipids.poor19.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor19.urban.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor19.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor19.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor19.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor19.urban.edu.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.lipids.poor19.urban.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor19.urban.edu.sex )
  
  multivar.lipids.poor19.urban.edu.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor19.urban.edu.sex.rr)
  multivar.lipids.poor19.urban.edu.sex.rr <- as.data.frame(multivar.lipids.poor19.urban.edu.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor19.urban.edu.sex.rr$coef <- coefficients
  multivar.lipids.poor19.urban.edu.sex.rr <- multivar.lipids.poor19.urban.edu.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor19.urban.edu.sex.rr, "multivar.lipids.poor19.urban.edu.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor19.urban.edu.sex))
  multivar.lipids.poor19.urban.edu.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor19.urban.edu.sex.ame, "multivar.lipids.poor19.urban.edu.sex.ame.xlsx")

###POOR32
#no urban sample

#sex
  dat.reg.lipids.poor32 <- dat.reg.lipids %>% dplyr::filter(poor32==1) 
  dat.reg.lipids.poor32 <- filter(dat.reg.lipids.poor32, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor32 %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32 <- x2 %>% 
    left_join(dat.reg.lipids.poor32)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32 , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor32, family=poisson(link="log"),design=svy.lipids.pop.poor32 )
  
  univar.lipids.poor32.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor32.sex.rr)
  univar.lipids.poor32.sex.rr <- as.data.frame(univar.lipids.poor32.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor32.sex.rr$coef <- coefficients
  univar.lipids.poor32.sex.rr <- univar.lipids.poor32.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor32.sex.rr, "univar.lipids.poor32.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32))
  univar.lipids.poor32.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor32.sex.ame, "univar.lipids.poor32.sex.ame.xlsx")

#educat
  dat.reg.lipids.poor32.edu <- dat.reg.lipids %>% dplyr::filter(poor32==1) 
  dat.reg.lipids.poor32.edu <- filter(dat.reg.lipids.poor32.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.lipids.poor32.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor32.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32.edu , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor32.edu, family=poisson(link="log"),design=svy.lipids.pop.poor32.edu )
  
  univar.lipids.poor32.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor32.edu.rr)
  univar.lipids.poor32.edu.rr <- as.data.frame(univar.lipids.poor32.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor32.edu.rr$coef <- coefficients
  univar.lipids.poor32.edu.rr <- univar.lipids.poor32.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor32.edu.rr, "univar.lipids.poor32.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32.edu))
  univar.lipids.poor32.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor32.edu.ame, "univar.lipids.poor32.edu.ame.xlsx")

#multivariate: edu, sex
  dat.reg.lipids.poor32.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor32==1) 
  dat.reg.lipids.poor32.edu.sex <- filter(dat.reg.lipids.poor32.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor32.edu.sex <- filter(dat.reg.lipids.poor32.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor32.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor32.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32.edu.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.lipids.poor32.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor32.edu.sex )
  
  multivar.lipids.poor32.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor32.rr)
  multivar.lipids.poor32.rr <- as.data.frame(multivar.lipids.poor32.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor32.rr$coef <- coefficients
  multivar.lipids.poor32.rr <- multivar.lipids.poor32.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor32.rr, "multivar.lipids.poor32.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32.edu.sex))
  multivar.lipids.poor32.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor32.ame, "multivar.lipids.poor32.ame.xlsx")

#urban sample
#sex
  dat.reg.lipids.poor32.urban.sex <- dat.reg.lipids %>%dplyr::filter(poor32==1) 
  dat.reg.lipids.poor32.urban.sex <- filter(dat.reg.lipids.poor32.urban.sex, is.na(female_lab)==F)
  dat.reg.lipids.poor32.urban.sex <- filter(dat.reg.lipids.poor32.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor32.urban.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32.urban.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor32.urban.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32.urban.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor32.urban.sex, family=poisson(link="log"),design=svy.lipids.pop.poor32.urban.sex )
  
  univar.lipids.poor32.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor32.sex.urban.rr)
  univar.lipids.poor32.sex.urban.rr <- as.data.frame(univar.lipids.poor32.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor32.sex.urban.rr$coef <- coefficients
  univar.lipids.poor32.sex.urban.rr <- univar.lipids.poor32.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor32.sex.urban.rr, "univar.lipids.poor32.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32.urban.sex))
  univar.lipids.poor32.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor32.sex.urban.ame, "univar.lipids.poor32.sex.urban.ame.xls")

#educat
  dat.reg.lipids.poor32.urban.edu <- dat.reg.lipids %>%dplyr::filter(poor32==1) 
  dat.reg.lipids.poor32.urban.edu <- filter(dat.reg.lipids.poor32.urban.edu, is.na(educat_lab)==F)
  dat.reg.lipids.poor32.urban.edu <- filter(dat.reg.lipids.poor32.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor32.urban.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32.urban.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor32.urban.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32.urban.edu , nest 
                                               = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor32.urban.edu, family=poisson(link="log"),design=svy.lipids.pop.poor32.urban.edu )
  
  univar.lipids.poor32.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor32.edu.urban.rr)
  univar.lipids.poor32.edu.urban.rr <- as.data.frame(univar.lipids.poor32.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor32.edu.urban.rr$coef <- coefficients
  univar.lipids.poor32.edu.urban.rr <- univar.lipids.poor32.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor32.edu.urban.rr, "univar.lipids.poor32.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32.urban.edu))
  univar.lipids.poor32.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor32.edu.urban.ame, "univar.lipids.poor32.edu.urban.ame.xls")

#urban
  dat.reg.lipids.poor32.urban <- dat.reg.lipids %>%dplyr::filter(poor32==1)  
  dat.reg.lipids.poor32.urban <- filter(dat.reg.lipids.poor32.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor32.urban %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32.urban <- x2 %>% 
    left_join(dat.reg.lipids.poor32.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32.urban , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.lipids.poor32.urban, family=poisson(link="log"),design=svy.lipids.pop.poor32.urban )
  
  univar.lipids.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor32.urban.rr)
  univar.lipids.poor32.urban.rr <- as.data.frame(univar.lipids.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor32.urban.rr$coef <- coefficients
  univar.lipids.poor32.urban.rr <- univar.lipids.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor32.urban.rr, "univar.lipids.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32.urban))
  univar.lipids.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor32.urban.ame, "univar.lipids.poor32.urban.ame.xls")

#multivariate: edu, sex, urban
  dat.reg.lipids.poor32.urban.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor32==1)  
  dat.reg.lipids.poor32.urban.edu.sex <- filter(dat.reg.lipids.poor32.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.lipids.poor32.urban.edu.sex <- filter(dat.reg.lipids.poor32.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor32.urban.edu.sex <- filter(dat.reg.lipids.poor32.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor32.urban.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor32.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor32.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor32.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor32.urban.edu.sex
                                                   , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.lipids.poor32.urban.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor32.urban.edu.sex )
  
  multivar.lipids.poor32.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor32.urban.rr)
  multivar.lipids.poor32.urban.rr <- as.data.frame(multivar.lipids.poor32.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor32.urban.rr$coef <- coefficients
  multivar.lipids.poor32.urban.rr <- multivar.lipids.poor32.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor32.urban.rr, "multivar.lipids.poor32.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor32.urban.edu.sex))
  multivar.lipids.poor32.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor32.urban.ame, "multivar.lipids.poor32.urban.ame.xls")

###POOR55
#no urban sample

#sex
  dat.reg.lipids.poor55 <- dat.reg.lipids %>% dplyr::filter(poor55==1) 
  dat.reg.lipids.poor55 <- filter(dat.reg.lipids.poor55, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor55 %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55 <- x2 %>% 
    left_join(dat.reg.lipids.poor55)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55 , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor55, family=poisson(link="log"),design=svy.lipids.pop.poor55 )
  
  univar.lipids.poor55.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor55.sex.rr)
  univar.lipids.poor55.sex.rr <- as.data.frame(univar.lipids.poor55.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor55.sex.rr$coef <- coefficients
  univar.lipids.poor55.sex.rr <- univar.lipids.poor55.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor55.sex.rr, "univar.lipids.poor55.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55))
  univar.lipids.poor55.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor55.sex.ame, "univar.lipids.poor55.sex.ame.xls")

#educat
  dat.reg.lipids.poor55.edu <- dat.reg.lipids %>% dplyr::filter(poor55==1) 
  dat.reg.lipids.poor55.edu <- filter(dat.reg.lipids.poor55.edu, is.na(educat_lab)==F)
  x2 <- dat.reg.lipids.poor55.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor55.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55.edu , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor55.edu, family=poisson(link="log"),design=svy.lipids.pop.poor55.edu )
  
  univar.lipids.poor55.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor55.edu.rr)
  univar.lipids.poor55.edu.rr <- as.data.frame(univar.lipids.poor55.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor55.edu.rr$coef <- coefficients
  univar.lipids.poor55.edu.rr <- univar.lipids.poor55.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor55.edu.rr, "univar.lipids.poor55.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55.edu))
  univar.lipids.poor55.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor55.edu.ame, "univar.lipids.poor55.edu.ame.xls")

#multivariate: edu, sex
  dat.reg.lipids.poor55.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor55==1) 
  dat.reg.lipids.poor55.edu.sex <- filter(dat.reg.lipids.poor55.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor55.edu.sex <- filter(dat.reg.lipids.poor55.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor55.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor55.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55.edu.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.lipids.poor55.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor55.edu.sex )
  
  multivar.lipids.poor55.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor55.rr)
  multivar.lipids.poor55.rr <- as.data.frame(multivar.lipids.poor55.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor55.rr$coef <- coefficients
  multivar.lipids.poor55.rr <- multivar.lipids.poor55.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor55.rr, "multivar.lipids.poor55.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55.edu.sex))
  multivar.lipids.poor55.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor55.ame, "multivar.lipids.poor55.ame.xls")

#urban sample
#sex
  dat.reg.lipids.poor55.urban.sex <- dat.reg.lipids %>%dplyr::filter(poor55==1) 
  dat.reg.lipids.poor55.urban.sex <- filter(dat.reg.lipids.poor55.urban.sex, is.na(female_lab)==F)
  dat.reg.lipids.poor55.urban.sex <- filter(dat.reg.lipids.poor55.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor55.urban.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55.urban.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor55.urban.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55.urban.sex , nest 
                                               = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor55.urban.sex, family=poisson(link="log"),design=svy.lipids.pop.poor55.urban.sex )
  
  univar.lipids.poor55.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor55.sex.urban.rr)
  univar.lipids.poor55.sex.urban.rr <- as.data.frame(univar.lipids.poor55.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor55.sex.urban.rr$coef <- coefficients
  univar.lipids.poor55.sex.urban.rr <- univar.lipids.poor55.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor55.sex.urban.rr, "univar.lipids.poor55.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55.urban.sex))
  univar.lipids.poor55.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor55.sex.urban.ame, "univar.lipids.poor55.sex.urban.ame.xls")

#educat
  dat.reg.lipids.poor55.urban.edu <- dat.reg.lipids %>%dplyr::filter(poor55==1) 
  dat.reg.lipids.poor55.urban.edu <- filter(dat.reg.lipids.poor55.urban.edu, is.na(educat_lab)==F)
  dat.reg.lipids.poor55.urban.edu <- filter(dat.reg.lipids.poor55.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor55.urban.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55.urban.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor55.urban.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55.urban.edu , nest 
                                               = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor55.urban.edu, family=poisson(link="log"),design=svy.lipids.pop.poor55.urban.edu )
  
  univar.lipids.poor55.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor55.edu.urban.rr)
  univar.lipids.poor55.edu.urban.rr <- as.data.frame(univar.lipids.poor55.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor55.edu.urban.rr$coef <- coefficients
  univar.lipids.poor55.edu.urban.rr <- univar.lipids.poor55.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor55.edu.urban.rr, "univar.lipids.poor55.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55.urban.edu))
  univar.lipids.poor55.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor55.edu.urban.ame, "univar.lipids.poor55.edu.urban.ame.xls")

#urban
  dat.reg.lipids.poor55.urban <- dat.reg.lipids %>%dplyr::filter(poor55==1)  
  dat.reg.lipids.poor55.urban <- filter(dat.reg.lipids.poor55.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor55.urban %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55.urban <- x2 %>% 
    left_join(dat.reg.lipids.poor55.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55.urban , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.lipids.poor55.urban, family=poisson(link="log"),design=svy.lipids.pop.poor55.urban )
  
  univar.lipids.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor55.urban.rr)
  univar.lipids.poor55.urban.rr <- as.data.frame(univar.lipids.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor55.urban.rr$coef <- coefficients
  univar.lipids.poor55.urban.rr <- univar.lipids.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor55.urban.rr, "univar.lipids.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55.urban))
  univar.lipids.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor55.urban.ame, "univar.lipids.poor55.urban.ame.xlsx")

#multivariate: edu, sex, urban
  dat.reg.lipids.poor55.urban.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor55==1)  
  dat.reg.lipids.poor55.urban.edu.sex <- filter(dat.reg.lipids.poor55.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.lipids.poor55.urban.edu.sex <- filter(dat.reg.lipids.poor55.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor55.urban.edu.sex <- filter(dat.reg.lipids.poor55.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor55.urban.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor55.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor55.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor55.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor55.urban.edu.sex
                                                   , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.lipids.poor55.urban.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor55.urban.edu.sex )
  
  multivar.lipids.poor55.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor55.urban.rr)
  multivar.lipids.poor55.urban.rr <- as.data.frame(multivar.lipids.poor55.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor55.urban.rr$coef <- coefficients
  multivar.lipids.poor55.urban.rr <- multivar.lipids.poor55.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor55.urban.rr, "multivar.lipids.poor55.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor55.urban.edu.sex))
  multivar.lipids.poor55.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor55.urban.ame, "multivar.lipids.poor55.urban.ame.xls")

###NONPOOR
#no urban sample

#sex
  dat.reg.lipids.poor0 <- dat.reg.lipids %>% dplyr::filter(poor55==0) 
  dat.reg.lipids.poor0 <- filter(dat.reg.lipids.poor0, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor0 %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0 <- x2 %>% 
    left_join(dat.reg.lipids.poor0)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0 , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor0, family=poisson(link="log"),design=svy.lipids.pop.poor0 )
  
  univar.lipids.poor0.sex.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor0.sex.rr)
  univar.lipids.poor0.sex.rr <- as.data.frame(univar.lipids.poor0.sex.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor0.sex.rr$coef <- coefficients
  univar.lipids.poor0.sex.rr <- univar.lipids.poor0.sex.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor0.sex.rr, "univar.lipids.poor0.sex.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0))
  univar.lipids.poor0.sex.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor0.sex.ame, "univar.lipids.poor0.sex.ame.xls")

#educat
  dat.reg.lipids.poor0.edu <- dat.reg.lipids %>% dplyr::filter(poor55==0)  
  dat.reg.lipids.poor0.edu <- filter(dat.reg.lipids.poor0.edu, is.na(educat_lab)==F)
  
  x2 <- dat.reg.lipids.poor0.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor0.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0.edu , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor0.edu, family=poisson(link="log"),design=svy.lipids.pop.poor0.edu )
  
  univar.lipids.poor0.edu.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor0.edu.rr)
  univar.lipids.poor0.edu.rr <- as.data.frame(univar.lipids.poor0.edu.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor0.edu.rr$coef <- coefficients
  univar.lipids.poor0.edu.rr <- univar.lipids.poor0.edu.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor0.edu.rr, "univar.lipids.poor0.edu.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0.edu))
  univar.lipids.poor0.edu.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor0.edu.ame, "univar.lipids.poor0.edu.ame.xls")

#multivariate: edu, sex
  dat.reg.lipids.poor0.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor55==0) 
  dat.reg.lipids.poor0.edu.sex <- filter(dat.reg.lipids.poor0.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor0.edu.sex <- filter(dat.reg.lipids.poor0.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor0.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor0.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0.edu.sex , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab + female_lab
                           , data=dat.reg.lipids.poor0.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor0.edu.sex )
  
  multivar.lipids.poor0.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor0.rr)
  multivar.lipids.poor0.rr <- as.data.frame(multivar.lipids.poor0.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor0.rr$coef <- coefficients
  multivar.lipids.poor0.rr <- multivar.lipids.poor0.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor0.rr, "multivar.lipids.poor0.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0.edu.sex))
  multivar.lipids.poor0.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor0.ame, "multivar.lipids.poor0.ame.xls")

#urban sample
#sex
  dat.reg.lipids.poor0.urban.sex <- dat.reg.lipids %>%dplyr::filter(poor55==0) 
  dat.reg.lipids.poor0.urban.sex <- filter(dat.reg.lipids.poor0.urban.sex, is.na(female_lab)==F)
  dat.reg.lipids.poor0.urban.sex <- filter(dat.reg.lipids.poor0.urban.sex, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor0.urban.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0.urban.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor0.urban.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0.urban.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0.urban.sex , nest = 
                                                T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + female_lab 
                           , data=dat.reg.lipids.poor0.urban.sex, family=poisson(link="log"),design=svy.lipids.pop.poor0.urban.sex )
  
  univar.lipids.poor0.sex.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor0.sex.urban.rr)
  univar.lipids.poor0.sex.urban.rr <- as.data.frame(univar.lipids.poor0.sex.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor0.sex.urban.rr$coef <- coefficients
  univar.lipids.poor0.sex.urban.rr <- univar.lipids.poor0.sex.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor0.sex.urban.rr, "univar.lipids.poor0.sex.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0.urban.sex))
  univar.lipids.poor0.sex.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor0.sex.urban.ame, "univar.lipids.poor0.sex.urban.ame.xls")

#educat
  dat.reg.lipids.poor0.urban.edu <- dat.reg.lipids %>%dplyr::filter(poor55==0)  
  dat.reg.lipids.poor0.urban.edu <- filter(dat.reg.lipids.poor0.urban.edu, is.na(educat_lab)==F)
  dat.reg.lipids.poor0.urban.edu <- filter(dat.reg.lipids.poor0.urban.edu, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor0.urban.edu %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0.urban.edu <- x2 %>% 
    left_join(dat.reg.lipids.poor0.urban.edu)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0.urban.edu <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0.urban.edu , nest = 
                                                T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + educat_lab 
                           , data=dat.reg.lipids.poor0.urban.edu, family=poisson(link="log"),design=svy.lipids.pop.poor0.urban.edu )
  
  univar.lipids.poor0.edu.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor0.edu.urban.rr)
  univar.lipids.poor0.edu.urban.rr <- as.data.frame(univar.lipids.poor0.edu.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor0.edu.urban.rr$coef <- coefficients
  univar.lipids.poor0.edu.urban.rr <- univar.lipids.poor0.edu.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor0.edu.urban.rr, "univar.lipids.poor0.edu.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0.urban.edu))
  univar.lipids.poor0.edu.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor0.edu.urban.ame, "univar.lipids.poor0.edu.urban.ame.xls")

#urban
  dat.reg.lipids.poor0.urban <- dat.reg.lipids %>%dplyr::filter(poor55==0)   
  dat.reg.lipids.poor0.urban <- filter(dat.reg.lipids.poor0.urban, is.na(urban_lab)==F)
  
  x2 <- dat.reg.lipids.poor0.urban %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0.urban <- x2 %>% 
    left_join(dat.reg.lipids.poor0.urban)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0.urban <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0.urban , nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab 
                           , data=dat.reg.lipids.poor0.urban, family=poisson(link="log"),design=svy.lipids.pop.poor0.urban )
  
  univar.lipids.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(univar.lipids.poor0.urban.rr)
  univar.lipids.poor0.urban.rr <- as.data.frame(univar.lipids.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  univar.lipids.poor0.urban.rr$coef <- coefficients
  univar.lipids.poor0.urban.rr <- univar.lipids.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(univar.lipids.poor0.urban.rr, "univar.lipids.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0.urban))
  univar.lipids.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(univar.lipids.poor0.urban.ame, "univar.lipids.poor0.urban.ame.xls")

#multivariate: edu, sex, urban
  dat.reg.lipids.poor0.urban.edu.sex <- dat.reg.lipids %>% dplyr::filter(poor55==0)  
  dat.reg.lipids.poor0.urban.edu.sex <- filter(dat.reg.lipids.poor0.urban.edu.sex, is.na(urban_lab)==F)
  dat.reg.lipids.poor0.urban.edu.sex <- filter(dat.reg.lipids.poor0.urban.edu.sex, is.na(educat_lab)==F)
  dat.reg.lipids.poor0.urban.edu.sex <- filter(dat.reg.lipids.poor0.urban.edu.sex, is.na(female_lab)==F)
  
  x2 <- dat.reg.lipids.poor0.urban.edu.sex %>%
    group_by(country) %>%
    filter(dyslipid==1) %>%
    summarise(comb=n()) %>%
    filter(any(comb>0)) %>%
    select(country) 
  
  dat.reg.lipids.poor0.urban.edu.sex <- x2 %>% 
    left_join(dat.reg.lipids.poor0.urban.edu.sex)%>% 
    mutate(country = as.character(country))%>% 
    mutate(country = as.factor(country))

#run survey design
  svy.lipids.pop.poor0.urban.edu.sex <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_lipid_poor19_age, data=dat.reg.lipids.poor0.urban.edu.sex ,
                                                  nest = T)
  
  models <- svyglm(dyslipid ~  rcs(age,5) + country + urban_lab + educat_lab + female_lab
                           , data=dat.reg.lipids.poor0.urban.edu.sex, family=poisson(link="log"),design=svy.lipids.pop.poor0.urban.edu.sex )
  
  multivar.lipids.poor0.urban.rr <- cbind(coef(models), exp(confint(models)), 
                           summary(models)$coefficients[,4]); 
  coefficients <- rownames(multivar.lipids.poor0.urban.rr)
  multivar.lipids.poor0.urban.rr <- as.data.frame(multivar.lipids.poor0.urban.rr) %>%
    dplyr::mutate(Estimate = exp(V1),
                  p = V4)
  multivar.lipids.poor0.urban.rr$coef <- coefficients
  multivar.lipids.poor0.urban.rr <- multivar.lipids.poor0.urban.rr %>% 
    dplyr::mutate(
      estimate = round(Estimate, 2),
      min = round(`2.5 %`, 2),
      max = round(`97.5 %`, 2),
      p = round(p, 4),
      estimate_ci = str_c(as.character(estimate), " (", as.character(min), "-", as.character(max), ")", sep=""))  %>%
     dplyr::select(coef, estimate_ci, p)
  write.xlsx(multivar.lipids.poor0.urban.rr, "multivar.lipids.poor0.urban.rr.xlsx")

#to get AME
  (models <- margins(models,design=svy.lipids.pop.poor0.urban.edu.sex))
  multivar.lipids.poor0.urban.ame <- summary(models) %>% mutate(
    AME = round(AME, 2),
    lower = round(lower, 2),
    upper = round(upper, 2),
    estimate = str_c(as.character(AME), " (", as.character(lower), "-", as.character(upper), ")", sep="")) %>% 
    dplyr::select(factor, estimate, p)
  write.xlsx(multivar.lipids.poor0.urban.ame, "multivar.lipids.poor0.urban.ame.xls")


```

```{r Figures: Prevalences by age groups}

### eFigure 5 (Prevalence by agegroup) - one figure for each risk factor

### a) HYPERTENSION
        prev.hypt.agegroups <- read.csv("~/prev.hypt.agegroups.csv", stringsAsFactors=F)
        prev.hypt.agegroups <- prev.hypt.agegroups[,-1]
        prev.hypt.agegroups <- prev.hypt.agegroups %>% 
          mutate(total = ifelse(agegroups=="15-24", "5.71 (5.38-6.06)",
                         ifelse(agegroups=="25-34", "11.67 (11.24-12.12)",
                         ifelse(agegroups=="35-44", "19.79 (19.01-20.60)",
                         ifelse(agegroups=="45-54", "31.21 (30.03-32.42)",
                         ifelse(agegroups=="55-64", "42.22 (40.27-44.20)",
                         ifelse(agegroups==">=65", "55.4 (53.0-57.8)", NA)))))))        
        prev.hypt.agegroups <- prev.hypt.agegroups %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
        prev.hypt.agegroups$prevalence <- gsub('--', '-', prev.hypt.agegroups$prevalence)  
        prev.hypt.agegroups <- tidyr::separate(prev.hypt.agegroups, prevalence, c("all_hypt", "V2"), "\\s(?:.+\\s)?")
        prev.hypt.agegroups$V2  <- gsub("[()]", "", prev.hypt.agegroups$V2 )
        prev.hypt.agegroups <- tidyr::separate(prev.hypt.agegroups, V2, c("cil_hypt", "ciu_hypt"), "\\-")
        prev.hypt.agegroups $'agegroups' <- as.factor(prev.hypt.agegroups $'agegroups')
        prev.hypt.agegroups$agegroups <- prev.hypt.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.hypt.agegroups$pov_group <- prev.hypt.agegroups$pov_group %>% factor(c("Prev_poor19", "Prev_poor32",  "Prev_poor55", "Prev_poor0", 
                                                                                    "total"))
        prev.hypt.agegroups $'all_hypt' <- as.numeric(as.character(prev.hypt.agegroups $'all_hypt'))
        prev.hypt.agegroups $'cil_hypt' <- as.numeric(as.character(prev.hypt.agegroups $'cil_hypt'))
        prev.hypt.agegroups $'ciu_hypt' <- as.numeric(as.character(prev.hypt.agegroups $'ciu_hypt'))
        
        cols <- c("Prev_poor19" = "#FEE8C8", "Prev_poor32" = "#FDD49E", "Prev_poor55" = "#FDBB84", "Prev_poor0" = "#EF6548", "total" = "black")
        
#create figure        
      hypt.age <- prev.hypt.agegroups %>% 
                  ggplot() +
                  geom_col(aes(y=all_hypt, x=pov_group, fill=pov_group), alpha=0.9) +
                  geom_errorbar(aes(ymin=cil_hypt, ymax=ciu_hypt, x=pov_group), 
                                width=0.3, show.legend = F) +
                  labs(title = paste0("Hypertension"),
                       x = "",
                       y = "%",
                       fill="") + 
                  theme(axis.text.y=element_text(size=18, colour = "black"),
                          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
                          axis.title=element_text(size=23, face="bold"),
                          legend.text=element_text(size=10, family="Times"),
                          legend.title = element_blank(),
                          legend.position="none",
                          axis.title.x = element_text(margin = margin(t = 20)),
                          axis.title.y = element_text(margin = margin(r = 20)),
                          strip.text.x = element_text(size=28, face="bold"),
                          strip.background = element_blank(),
                          panel.spacing = unit(2, "lines"),
                          title = element_text(size=15, face="bold", family="Times")) + 
                  scale_fill_manual(values = cols) +
                  scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
                  scale_x_discrete(labels = c("Prev_poor19" = "<$1.90/day", "Prev_poor32" = "<$3.20/day", "Prev_poor55" = "<$5.50/day", "Prev_poor0" = 
                                                ">$5.50/day", "total" = "Total")) +
                  facet_wrap(~agegroups) +
                  theme(strip.text.x = element_text(size = 15)) +
                  coord_fixed(5/100) 
                hypt.age
                ggsave("hypt.age.pdf", height = 12, width = 12)

###b) DIABETES
  prev.dia.agegroups <- read.csv("~/prev.dia.agegroups.csv", stringsAsFactors=F)
  prev.dia.agegroups <- prev.dia.agegroups[,-1]
  prev.dia.agegroups <- prev.dia.agegroups %>% 
    mutate(total = ifelse(agegroups=="15-24", "2.5 (2.2-2.8)",
                   ifelse(agegroups=="25-34", "3.3 (2.9-3.6)",
                   ifelse(agegroups=="35-44", "5.5 (5.1-6.0)",
                   ifelse(agegroups=="45-54", "9.1 (7.9-10.4",
                   ifelse(agegroups=="55-64", "11.7 (10.3-13.3)",
                   ifelse(agegroups==">=65", "14.2 (12.6-16.0)", NA)))))))
  prev.dia.agegroups <- prev.dia.agegroups %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
  prev.dia.agegroups$prevalence <- gsub('--', '-', prev.dia.agegroups$prevalence)  
  prev.dia.agegroups <- tidyr::separate(prev.dia.agegroups, prevalence, c("all_dia", "V2"), "\\s(?:.+\\s)?")
  prev.dia.agegroups$V2  <- gsub("[()]", "", prev.dia.agegroups$V2 )
  prev.dia.agegroups <- tidyr::separate(prev.dia.agegroups, V2, c("cil_dia", "ciu_dia"), "\\-")
  prev.dia.agegroups $'agegroups' <- as.factor(prev.dia.agegroups $'agegroups')
  prev.dia.agegroups$agegroups <- prev.dia.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  prev.dia.agegroups$pov_group <- prev.dia.agegroups$pov_group %>% factor(c("Prev_poor19", "Prev_poor32",  "Prev_poor55", "Prev_poor0", "total"))
  prev.dia.agegroups $'all_dia' <- as.numeric(as.character(prev.dia.agegroups $'all_dia'))
  prev.dia.agegroups $'cil_dia' <- as.numeric(as.character(prev.dia.agegroups $'cil_dia'))
  prev.dia.agegroups $'ciu_dia' <- as.numeric(as.character(prev.dia.agegroups $'ciu_dia'))

  cols <- c("Prev_poor19" = "#FEE8C8", "Prev_poor32" = "#FDD49E", "Prev_poor55" = "#FDBB84", "Prev_poor0" = "#EF6548", "total" = "black")

#create figure  
  dia.age <- prev.dia.agegroups %>% 
    ggplot() +
    geom_col(aes(y=all_dia, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_dia, ymax=ciu_dia, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Diabetes"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
            scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
            scale_x_discrete(labels = c("Prev_poor19" = "<$1.90/day", "Prev_poor32" = "<$3.20/day", "Prev_poor55" = "<$5.50/day", "Prev_poor0" = 
                                          ">$5.50/day", "total" = "Total")) +
            facet_wrap(~agegroups) +
            theme(strip.text.x = element_text(size = 15)) +
            coord_fixed(5/100) 
    dia.age
    ggsave("dia.age.png", height = 12, width = 12)
 
###d) OBESITY 
        prev.obese.agegroups <- read.csv("~/prev.obese.agegroups.csv", stringsAsFactors=F)
        prev.obese.agegroups <- prev.obese.agegroups[,-1]
        prev.obese.agegroups <- prev.obese.agegroups %>% 
          mutate(total = ifelse(agegroups=="15-24", "3.72 (3.47--3.99)",
                         ifelse(agegroups=="25-34", "10.48 (9.97--11.02)",
                         ifelse(agegroups=="35-44", "13.60 (12.79--14.44)",
                         ifelse(agegroups=="45-54", "13.37 (12.42--14.38)",
                         ifelse(agegroups=="55-64", "8.61 (7.63--9.71)",
                         ifelse(agegroups==">=65", "8.79 (7.68--10.05)", NA)))))))        
        prev.obese.agegroups <- prev.obese.agegroups %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
        prev.obese.agegroups$prevalence <- gsub('--', '-', prev.obese.agegroups$prevalence)  
        prev.obese.agegroups <- tidyr::separate(prev.obese.agegroups, prevalence, c("all_obese", "V2"), "\\s(?:.+\\s)?")
        prev.obese.agegroups$V2  <- gsub("[()]", "", prev.obese.agegroups$V2 )
        prev.obese.agegroups <- tidyr::separate(prev.obese.agegroups, V2, c("cil_obese", "ciu_obese"), "\\-")
        prev.obese.agegroups $'agegroups' <- as.factor(prev.obese.agegroups $'agegroups')
        prev.obese.agegroups$agegroups <- prev.obese.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.obese.agegroups$pov_group <- prev.obese.agegroups$pov_group %>% factor(c("Prev_poor19", "Prev_poor32",  "Prev_poor55", "Prev_poor0", 
                                                                                      "total"))
        prev.obese.agegroups $'all_obese' <- as.numeric(as.character(prev.obese.agegroups $'all_obese'))
        prev.obese.agegroups $'cil_obese' <- as.numeric(as.character(prev.obese.agegroups $'cil_obese'))
        prev.obese.agegroups $'ciu_obese' <- as.numeric(as.character(prev.obese.agegroups $'ciu_obese'))
        
        cols <- c("Prev_poor19" = "#FEE8C8", "Prev_poor32" = "#FDD49E", "Prev_poor55" = "#FDBB84", "Prev_poor0" = "#EF6548", "total" = "black")
        
#create figure      
        obese.age <- prev.obese.agegroups %>% 
        ggplot() +
        geom_col(aes(y=all_obese, x=pov_group, fill=pov_group), alpha=0.9) +
        geom_errorbar(aes(ymin=cil_obese, ymax=ciu_obese, x=pov_group), 
                        width=0.3, show.legend = F) +
        labs(title = paste0("Obesity"),
              x = "",
              y = "%",
              fill="") + 
        theme(axis.text.y=element_text(size=18, colour = "black"),
              axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
              axis.title=element_text(size=23, face="bold"),
              legend.text=element_text(size=10, family="Times"),
              legend.title = element_blank(),
              legend.position="none",
              axis.title.x = element_text(margin = margin(t = 20)),
              axis.title.y = element_text(margin = margin(r = 20)),
              strip.text.x = element_text(size=28, face="bold"),
              strip.background = element_blank(),
              panel.spacing = unit(2, "lines"),
              title = element_text(size=15, face="bold", family="Times")) + 
        scale_fill_manual(values = cols) +
              scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
              scale_x_discrete(labels = c("Prev_poor19" = "<$1.90/day", "Prev_poor32" = "<$3.20/day", "Prev_poor55" = "<$5.50/day", "Prev_poor0" = 
                                              ">$5.50/day", "total" = "Total")) +
              facet_wrap(~agegroups) +
              theme(strip.text.x = element_text(size = 15)) +
              coord_fixed(5/100) 
        obese.age
        ggsave("obese.age.png", height = 12, width = 12)

###e) SMOKING 
        prev.smoke.agegroups <- read.csv("~/Prevalences Agegroups - Smoking.csv", stringsAsFactors=F)
        prev.smoke.agegroups <- prev.smoke.agegroups[-7,]
        prev.smoke.agegroups <- prev.smoke.agegroups %>% 
          rename(total = "Prev_allpov",
                 agegroups = "X")      
        prev.smoke.agegroups <- prev.smoke.agegroups %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
        prev.smoke.agegroups$prevalence <- gsub('--', '-', prev.smoke.agegroups$prevalence)  
        prev.smoke.agegroups <- tidyr::separate(prev.smoke.agegroups, prevalence, c("all_smoke", "V2"), "\\s(?:.+\\s)?")
        prev.smoke.agegroups$V2  <- gsub("[()]", "", prev.smoke.agegroups$V2 )
        prev.smoke.agegroups <- tidyr::separate(prev.smoke.agegroups, V2, c("cil_smoke", "ciu_smoke"), "\\-")
        prev.smoke.agegroups $'agegroups' <- as.factor(prev.smoke.agegroups $'agegroups')
        prev.smoke.agegroups$agegroups <- prev.smoke.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.smoke.agegroups$pov_group <- prev.smoke.agegroups$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.smoke.agegroups $'all_smoke' <- as.numeric(as.character(prev.smoke.agegroups $'all_smoke'))
        prev.smoke.agegroups $'cil_smoke' <- as.numeric(as.character(prev.smoke.agegroups $'cil_smoke'))
        prev.smoke.agegroups $'ciu_smoke' <- as.numeric(as.character(prev.smoke.agegroups $'ciu_smoke'))
        
        cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "total" = "black")
        
        smoke.age <- prev.smoke.agegroups %>% 
          ggplot() +
          geom_col(aes(y=all_smoke, x=pov_group, fill=pov_group), alpha=0.9) +
          geom_errorbar(aes(ymin=cil_smoke, ymax=ciu_smoke, x=pov_group), 
                        width=0.3, show.legend = F) +
        labs(title = paste0("Smoking"),
             x = "",
             y = "%",
             fill="") + 
        theme(axis.text.y=element_text(size=18, colour = "black"),
              axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
              axis.title=element_text(size=23, face="bold"),
              legend.text=element_text(size=10, family="Times"),
              legend.title = element_blank(),
              legend.position="none",
              axis.title.x = element_text(margin = margin(t = 20)),
              axis.title.y = element_text(margin = margin(r = 20)),
              strip.text.x = element_text(size=28, face="bold"),
              strip.background = element_blank(),
              panel.spacing = unit(2, "lines"),
              title = element_text(size=15, face="bold", family="Times")) + 
         scale_fill_manual(values = cols) +
         scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
         scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) 
          +
         facet_wrap(~agegroups) +
         theme(strip.text.x = element_text(size = 15)) +
         coord_fixed(5/100)  
        smoke.age
        ggsave("smoke.age.png", height = 12, width = 12)

### LIPIDS 
        prev.lipids.agegroups <- read.csv("~/Prevalences Agegroups - Lipids.csv", stringsAsFactors=F)
        prev.lipids.agegroups <- prev.lipids.agegroups[-7,]
        prev.lipids.agegroups <- prev.lipids.agegroups %>% 
          rename(total = "all.pov.groups",
                 agegroups = "X")      
        prev.lipids.agegroups <- prev.lipids.agegroups %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
        prev.lipids.agegroups$prevalence <- gsub('--', '-', prev.lipids.agegroups$prevalence)  
        prev.lipids.agegroups <- tidyr::separate(prev.lipids.agegroups, prevalence, c("all_lipids", "V2"), "\\s(?:.+\\s)?")
        prev.lipids.agegroups$V2  <- gsub("[()]", "", prev.lipids.agegroups$V2 )
        prev.lipids.agegroups <- tidyr::separate(prev.lipids.agegroups, V2, c("cil_lipids", "ciu_lipids"), "\\-")
        prev.lipids.agegroups $'agegroups' <- as.factor(prev.lipids.agegroups $'agegroups')
        prev.lipids.agegroups$agegroups <- prev.lipids.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.lipids.agegroups$pov_group <- prev.lipids.agegroups$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.lipids.agegroups $'all_lipids' <- as.numeric(as.character(prev.lipids.agegroups $'all_lipids'))
        prev.lipids.agegroups $'cil_lipids' <- as.numeric(as.character(prev.lipids.agegroups $'cil_lipids'))
        prev.lipids.agegroups $'ciu_lipids' <- as.numeric(as.character(prev.lipids.agegroups $'ciu_lipids'))
        
        cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "total" = "black")
   
#create figures             
        lipids.age <- prev.lipids.agegroups %>% 
          ggplot() +
          geom_col(aes(y=all_lipids, x=pov_group, fill=pov_group), alpha=0.9) +
          geom_errorbar(aes(ymin=cil_lipids, ymax=ciu_lipids, x=pov_group), 
                        width=0.3, show.legend = F) +
          labs(title = paste0("Dyslipidemia"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=18, colour = "black"),
                axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=10, family="Times"),
                legend.title = element_blank(),
                legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20)),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=15, face="bold", family="Times")) + 
            scale_fill_manual(values = cols) +
            scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
            scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = 
                                          "Total")) +
            facet_wrap(~agegroups) +
            theme(strip.text.x = element_text(size = 15)) +
            coord_fixed(5/100) 
         lipids.age
         ggsave("lipids.age.png", height = 12, width = 12)
 
### FIGURES7: Prevalence by region --------------------------------------------------------------------------------------------------------
         
### HYPERTENSION
  prev.hypt.region <- read.csv("~/by regions - Hypertension.csv", stringsAsFactors=F)
  prev.hypt.region <- prev.hypt.region %>%
    filter(region!="total")
  prev.hypt.region <- prev.hypt.region %>% pivot_longer(!region, names_to = "pov_group", values_to = "prevalence")
  prev.hypt.region$prevalence <- gsub('--', '-', prev.hypt.region$prevalence)  
  prev.hypt.region <- tidyr::separate(prev.hypt.region, prevalence, c("all_hypt", "V2"), "\\s(?:.+\\s)?")
  prev.hypt.region$V2  <- gsub("[()]", "", prev.hypt.region$V2 )
  prev.hypt.region <- tidyr::separate(prev.hypt.region, V2, c("cil_hypt", "ciu_hypt"), "\\-")
  prev.hypt.region$region[prev.hypt.region$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
  prev.hypt.region$region[prev.hypt.region$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
  prev.hypt.region$region[prev.hypt.region$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
  prev.hypt.region$region[prev.hypt.region$region == "Middle East and North Africa"] <- "M.East & N.Africa"
  prev.hypt.region$region[prev.hypt.region$region == "South Asia"] <- "S.Asia"
  prev.hypt.region$region[prev.hypt.region$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
  prev.hypt.region $'region' <- as.factor(prev.hypt.region $'region')
  prev.hypt.region$region <- prev.hypt.region$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & N.Africa", 
                                                                  "S.Asia", "Sub-S.Africa"))
  prev.hypt.region$pov_group <- prev.hypt.region$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.hypt.region $'all_hypt' <- as.numeric(as.character(prev.hypt.region $'all_hypt'))
  prev.hypt.region $'cil_hypt' <- as.numeric(as.character(prev.hypt.region $'cil_hypt'))
  prev.hypt.region $'ciu_hypt' <- as.numeric(as.character(prev.hypt.region $'ciu_hypt'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
  hypt.region <- prev.hypt.region %>% 
    ggplot() +
    geom_col(aes(y=all_hypt, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_hypt, ymax=ciu_hypt, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Hypertension"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) + 
     scale_fill_manual(values = cols) +
     scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
     scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = 
                                   "Total")) +
     facet_wrap(~region) +
     theme(strip.text.x = element_text(size = 15)) +
     coord_fixed(5/100)
  hypt.region
  
  ggsave("hypt.region.png", height = 12, width = 12)

### DIABETES 
  prev.dia.region <- read.csv("~by regions - Diabetes.csv", stringsAsFactors=F)
  prev.dia.region <- prev.dia.region %>%
    filter(region!="total")
  prev.dia.region <- prev.dia.region %>% pivot_longer(!region, names_to = "pov_group", values_to = "prevalence")
  prev.dia.region$prevalence <- gsub('--', '-', prev.dia.region$prevalence)  
  prev.dia.region <- tidyr::separate(prev.dia.region, prevalence, c("all_dia", "V2"), "\\s(?:.+\\s)?")
  prev.dia.region$V2  <- gsub("[()]", "", prev.dia.region$V2 )
  prev.dia.region <- tidyr::separate(prev.dia.region, V2, c("cil_dia", "ciu_dia"), "\\-")
  prev.dia.region$region[prev.dia.region$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
  prev.dia.region$region[prev.dia.region$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
  prev.dia.region$region[prev.dia.region$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
  prev.dia.region$region[prev.dia.region$region == "Middle East and North Africa"] <- "M.East & N.Africa"
  prev.dia.region$region[prev.dia.region$region == "South Asia"] <- "S.Asia"
  prev.dia.region$region[prev.dia.region$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
  prev.dia.region $'region' <- as.factor(prev.dia.region $'region')
  prev.dia.region$region <- prev.dia.region$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & N.Africa", "S.Asia",
                                                                "Sub-S.Africa"))
  prev.dia.region$pov_group <- prev.dia.region$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.dia.region $'all_dia' <- as.numeric(as.character(prev.dia.region $'all_dia'))
  prev.dia.region $'cil_dia' <- as.numeric(as.character(prev.dia.region $'cil_dia'))
  prev.dia.region $'ciu_dia' <- as.numeric(as.character(prev.dia.region $'ciu_dia'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  dia.region <- prev.dia.region %>% 
    ggplot() +
    geom_col(aes(y=all_dia, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_dia, ymax=ciu_dia, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Diabetes"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total"))
  +
    facet_wrap(~region) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100)
  dia.region
  ggsave("dia.region.png", height = 12, width = 12)

### OBESITY 
  prev.obese.region <- read.csv("~/by regions - Obesity.csv", stringsAsFactors=F)
  prev.obese.region <- prev.obese.region %>%
    filter(region!="total")
  prev.obese.region <- prev.obese.region %>% pivot_longer(!region, names_to = "pov_group", values_to = "prevalence")
  prev.obese.region$prevalence <- gsub('--', '-', prev.obese.region$prevalence)  
  prev.obese.region <- tidyr::separate(prev.obese.region, prevalence, c("all_obese", "V2"), "\\s(?:.+\\s)?")
  prev.obese.region$V2  <- gsub("[()]", "", prev.obese.region$V2 )
  prev.obese.region <- tidyr::separate(prev.obese.region, V2, c("cil_obese", "ciu_obese"), "\\-")
  prev.obese.region$region[prev.obese.region$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
  prev.obese.region$region[prev.obese.region$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
  prev.obese.region$region[prev.obese.region$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
  prev.obese.region$region[prev.obese.region$region == "Middle East and North Africa"] <- "M.East & N.Africa"
  prev.obese.region$region[prev.obese.region$region == "South Asia"] <- "S.Asia"
  prev.obese.region$region[prev.obese.region$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
  prev.obese.region $'region' <- as.factor(prev.obese.region $'region')
  prev.obese.region$region <- prev.obese.region$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & N.Africa", 
                                                                    "S.Asia", "Sub-S.Africa"))
  prev.obese.region$pov_group <- prev.obese.region$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.obese.region $'all_obese' <- as.numeric(as.character(prev.obese.region $'all_obese'))
  prev.obese.region $'cil_obese' <- as.numeric(as.character(prev.obese.region $'cil_obese'))
  prev.obese.region $'ciu_obese' <- as.numeric(as.character(prev.obese.region $'ciu_obese'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  obese.region <- prev.obese.region %>% 
    ggplot() +
    geom_col(aes(y=all_obese, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_obese, ymax=ciu_obese, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Obesity"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) + 
      scale_fill_manual(values = cols) +
      scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
      scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = 
                                    "Total")) +
      facet_wrap(~region) +
      theme(strip.text.x = element_text(size = 15)) +
      coord_fixed(5/100)
  obese.region
  ggsave("obese.region.png", height = 12, width = 12)

### SMOKING 
  prev.smoke.region <- read.csv("~/by regions - Smoking.csv", stringsAsFactors=F)
  prev.smoke.region <- prev.smoke.region %>%
    filter(region!="total")
  prev.smoke.region <- prev.smoke.region %>% pivot_longer(!region, names_to = "pov_group", values_to = "prevalence")
  prev.smoke.region$prevalence <- gsub('--', '-', prev.smoke.region$prevalence)  
  prev.smoke.region <- tidyr::separate(prev.smoke.region, prevalence, c("all_smoke", "V2"), "\\s(?:.+\\s)?")
  prev.smoke.region$V2  <- gsub("[()]", "", prev.smoke.region$V2 )
  prev.smoke.region <- tidyr::separate(prev.smoke.region, V2, c("cil_smoke", "ciu_smoke"), "\\-")
  prev.smoke.region$region[prev.smoke.region$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
  prev.smoke.region$region[prev.smoke.region$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
  prev.smoke.region$region[prev.smoke.region$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
  prev.smoke.region$region[prev.smoke.region$region == "Middle East and North Africa"] <- "M.East & N.Africa"
  prev.smoke.region$region[prev.smoke.region$region == "South Asia"] <- "S.Asia"
  prev.smoke.region$region[prev.smoke.region$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
  prev.smoke.region $'region' <- as.factor(prev.smoke.region $'region')
  prev.smoke.region$region <- prev.smoke.region$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & N.Africa", 
                                                                    "S.Asia", "Sub-S.Africa"))
  prev.smoke.region$pov_group <- prev.smoke.region$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.smoke.region $'all_smoke' <- as.numeric(as.character(prev.smoke.region $'all_smoke'))
  prev.smoke.region $'cil_smoke' <- as.numeric(as.character(prev.smoke.region $'cil_smoke'))
  prev.smoke.region $'ciu_smoke' <- as.numeric(as.character(prev.smoke.region $'ciu_smoke'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  smoke.region <- prev.smoke.region %>% 
    ggplot() +
    geom_col(aes(y=all_smoke, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_smoke, ymax=ciu_smoke, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Smoking"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) + 
     scale_fill_manual(values = cols) +
     scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
     scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = 
                                   "Total")) +
     facet_wrap(~region) +
     theme(strip.text.x = element_text(size = 15)) +
     coord_fixed(5/100)
  smoke.region
  ggsave("smoke.region.png", height = 12, width = 12)

###LIPIDS
  prev.lipids.region <- read.csv("~/by regions - Lipids.csv", stringsAsFactors=F)
  prev.lipids.region <- prev.lipids.region %>%
    filter(region!="total")
  prev.lipids.region <- prev.lipids.region %>% pivot_longer(!region, names_to = "pov_group", values_to = "prevalence")
  prev.lipids.region$prevalence <- gsub('--', '-', prev.lipids.region$prevalence)  
  prev.lipids.region <- tidyr::separate(prev.lipids.region, prevalence, c("all_lipids", "V2"), "\\s(?:.+\\s)?")
  prev.lipids.region$V2  <- gsub("[()]", "", prev.lipids.region$V2 )
  prev.lipids.region <- tidyr::separate(prev.lipids.region, V2, c("cil_lipids", "ciu_lipids"), "\\-")
  prev.lipids.region$region[prev.lipids.region$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
  prev.lipids.region$region[prev.lipids.region$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
  prev.lipids.region$region[prev.lipids.region$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
  prev.lipids.region$region[prev.lipids.region$region == "Middle East and North Africa"] <- "M.East & N.Africa"
  prev.lipids.region$region[prev.lipids.region$region == "South Asia"] <- "S.Asia"
  prev.lipids.region$region[prev.lipids.region$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
  prev.lipids.region $'region' <- as.factor(prev.lipids.region $'region')
  prev.lipids.region$region <- prev.lipids.region$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & N.Africa", "S.Asia", "Sub-S.Africa"))
  prev.lipids.region$pov_group <- prev.lipids.region$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.lipids.region $'all_lipids' <- as.numeric(as.character(prev.lipids.region $'all_lipids'))
  prev.lipids.region $'cil_lipids' <- as.numeric(as.character(prev.lipids.region $'cil_lipids'))
  prev.lipids.region $'ciu_lipids' <- as.numeric(as.character(prev.lipids.region $'ciu_lipids'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
  lipids.region <- prev.lipids.region %>% 
    ggplot() +
    geom_col(aes(y=all_lipids, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_lipids, ymax=ciu_lipids, x=pov_group), 
                  width=0.3, show.legend = F) +
    #theme_classic() + 
    labs(title = paste0("Dyslipidemia"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70))  +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total")) +
    facet_wrap(~region) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100)
  lipids.region
  ggsave("lipids.region.png", height = 12, width = 12)
 
```

``` {r FIGURE: prevalence by income group}
#Age-standardized prevalence (in percent) of CVD risk factors by poverty level in low-income, lower middle-income, and upper middle-income countries

### HYPERTESION 
  prev.hypt.income_group <- read.csv("~/by income group - Hypertension.csv", stringsAsFactors=F)
  prev.hypt.income_group <- prev.hypt.income_group %>%
    filter(income_group!="total")
  prev.hypt.income_group <- prev.hypt.income_group %>% pivot_longer(!income_group, names_to = "pov_group", values_to = "prevalence")
  prev.hypt.income_group$prevalence <- gsub('--', '-', prev.hypt.income_group$prevalence)  
  prev.hypt.income_group <- tidyr::separate(prev.hypt.income_group, prevalence, c("all_hypt", "V2"), "\\s(?:.+\\s)?")
  prev.hypt.income_group$V2  <- gsub("[()]", "", prev.hypt.income_group$V2 )
  prev.hypt.income_group <- tidyr::separate(prev.hypt.income_group, V2, c("cil_hypt", "ciu_hypt"), "\\-")
  prev.hypt.income_group$income_group[prev.hypt.income_group$income_group == "Low income"] <- "Low-inc. countries"
  prev.hypt.income_group$income_group[prev.hypt.income_group$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
  prev.hypt.income_group$income_group[prev.hypt.income_group$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
  prev.hypt.income_group $'income_group' <- as.factor(prev.hypt.income_group $'income_group')
  prev.hypt.income_group$income_group <- prev.hypt.income_group$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", "Upper 
                                                                                          middle-inc. countries"))
  prev.hypt.income_group$pov_group <- prev.hypt.income_group$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.hypt.income_group $'all_hypt' <- as.numeric(as.character(prev.hypt.income_group $'all_hypt'))
  prev.hypt.income_group $'cil_hypt' <- as.numeric(as.character(prev.hypt.income_group $'cil_hypt'))
  prev.hypt.income_group $'ciu_hypt' <- as.numeric(as.character(prev.hypt.income_group $'ciu_hypt'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  hypt.income_group <- prev.hypt.income_group %>% 
    ggplot() +
    geom_col(aes(y=all_hypt, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_hypt, ymax=ciu_hypt, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Hypertension"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=20, colour = "black"),
          axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=20, family="Times", face="bold"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=20, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=30, by=10), limits=c(0, 30)) +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total"))
  + 
    facet_wrap(~income_group) +
    theme(strip.text.x = element_text(size = 16)) +
    coord_fixed(5/30)
  hypt.income_group
  
  ggsave("hypt.income_group.png", height = 12, width = 12)

###DIABETES
  prev.dia.income_group <- read.csv("~/by income group - Diabetes.csv", stringsAsFactors=F)
  prev.dia.income_group <- prev.dia.income_group %>%
    filter(income_group!="total")
  prev.dia.income_group <- prev.dia.income_group %>% pivot_longer(!income_group, names_to = "pov_group", values_to = "prevalence")
  prev.dia.income_group$prevalence <- gsub('--', '-', prev.dia.income_group$prevalence)  
  prev.dia.income_group <- tidyr::separate(prev.dia.income_group, prevalence, c("all_dia", "V2"), "\\s(?:.+\\s)?")
  prev.dia.income_group$V2  <- gsub("[()]", "", prev.dia.income_group$V2 )
  prev.dia.income_group <- tidyr::separate(prev.dia.income_group, V2, c("cil_dia", "ciu_dia"), "\\-")
  prev.dia.income_group$income_group[prev.dia.income_group$income_group == "Low income"] <- "Low-inc. countries"
  prev.dia.income_group$income_group[prev.dia.income_group$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
  prev.dia.income_group$income_group[prev.dia.income_group$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
  prev.dia.income_group $'income_group' <- as.factor(prev.dia.income_group $'income_group')
  prev.dia.income_group$income_group <- prev.dia.income_group$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", "Upper 
                                                                                        middle-inc. countries"))
  prev.dia.income_group$pov_group <- prev.dia.income_group$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.dia.income_group $'all_dia' <- as.numeric(as.character(prev.dia.income_group $'all_dia'))
  prev.dia.income_group $'cil_dia' <- as.numeric(as.character(prev.dia.income_group $'cil_dia'))
  prev.dia.income_group $'ciu_dia' <- as.numeric(as.character(prev.dia.income_group $'ciu_dia'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  dia.income_group <- prev.dia.income_group %>% 
    ggplot() +
    geom_col(aes(y=all_dia, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_dia, ymax=ciu_dia, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Diabetes"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=20, colour = "black"),
          axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=20, family="Times", face="bold"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=20, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=30, by=10), limits=c(0, 30)) +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total"))
  + 
    facet_wrap(~income_group) +
    theme(strip.text.x = element_text(size = 16)) +
    coord_fixed(5/30)
  dia.income_group
  ggsave("dia.income_group.png", height = 12, width = 12)

### OBESITY 
  prev.obese.income_group <- read.csv("~/by income group - Obesity.csv", stringsAsFactors=F)
  prev.obese.income_group <- prev.obese.income_group %>%
    filter(income_group!="total")
  prev.obese.income_group <- prev.obese.income_group %>% pivot_longer(!income_group, names_to = "pov_group", values_to = "prevalence")
  prev.obese.income_group$prevalence <- gsub('--', '-', prev.obese.income_group$prevalence)  
  prev.obese.income_group <- tidyr::separate(prev.obese.income_group, prevalence, c("all_obese", "V2"), "\\s(?:.+\\s)?")
  prev.obese.income_group$V2  <- gsub("[()]", "", prev.obese.income_group$V2 )
  prev.obese.income_group <- tidyr::separate(prev.obese.income_group, V2, c("cil_obese", "ciu_obese"), "\\-")
  prev.obese.income_group$income_group[prev.obese.income_group$income_group == "Low income"] <- "Low-inc. countries"
  prev.obese.income_group$income_group[prev.obese.income_group$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
  prev.obese.income_group$income_group[prev.obese.income_group$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
  prev.obese.income_group $'income_group' <- as.factor(prev.obese.income_group $'income_group')
  prev.obese.income_group$income_group <- prev.obese.income_group$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", "Upper 
                                                                                            middle-inc. countries"))
  prev.obese.income_group$pov_group <- prev.obese.income_group$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.obese.income_group $'all_obese' <- as.numeric(as.character(prev.obese.income_group $'all_obese'))
  prev.obese.income_group $'cil_obese' <- as.numeric(as.character(prev.obese.income_group $'cil_obese'))
  prev.obese.income_group $'ciu_obese' <- as.numeric(as.character(prev.obese.income_group $'ciu_obese'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  obese.income_group <- prev.obese.income_group %>% 
    ggplot() +
    geom_col(aes(y=all_obese, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_obese, ymax=ciu_obese, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Obesity"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=20, colour = "black"),
          axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=20, family="Times", face="bold"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=20, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=30, by=10), limits=c(0, 30)) +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total"))
  + 
    facet_wrap(~income_group) +
    theme(strip.text.x = element_text(size = 16)) +
    coord_fixed(5/30)
  obese.income_group
  ggsave("obese.income_group.png", height = 12, width = 12)

### SMOKING 
  prev.smoke.income_group <- read.csv("~/by income group - Smoking.csv", stringsAsFactors=F)
  prev.smoke.income_group <- prev.smoke.income_group %>%
    filter(income_group!="total") %>%
    filter(income_group!="High income")
  prev.smoke.income_group <- prev.smoke.income_group %>% pivot_longer(!income_group, names_to = "pov_group", values_to = "prevalence")
  prev.smoke.income_group$prevalence <- gsub('--', '-', prev.smoke.income_group$prevalence)  
  prev.smoke.income_group <- tidyr::separate(prev.smoke.income_group, prevalence, c("all_smoke", "V2"), "\\s(?:.+\\s)?")
  prev.smoke.income_group$V2  <- gsub("[()]", "", prev.smoke.income_group$V2 )
  prev.smoke.income_group <- tidyr::separate(prev.smoke.income_group, V2, c("cil_smoke", "ciu_smoke"), "\\-")
  prev.smoke.income_group$income_group[prev.smoke.income_group$income_group == "Low income"] <- "Low-inc. countries"
  prev.smoke.income_group$income_group[prev.smoke.income_group$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
  prev.smoke.income_group$income_group[prev.smoke.income_group$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
  prev.smoke.income_group $'income_group' <- as.factor(prev.smoke.income_group $'income_group')
  prev.smoke.income_group$income_group <- prev.smoke.income_group$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", "Upper middle-inc. countries"))
  prev.smoke.income_group$pov_group <- prev.smoke.income_group$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.smoke.income_group $'all_smoke' <- as.numeric(as.character(prev.smoke.income_group $'all_smoke'))
  prev.smoke.income_group $'cil_smoke' <- as.numeric(as.character(prev.smoke.income_group $'cil_smoke'))
  prev.smoke.income_group $'ciu_smoke' <- as.numeric(as.character(prev.smoke.income_group $'ciu_smoke'))

cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")

#create figure
  smoke.income_group <- prev.smoke.income_group %>% 
    ggplot() +
    geom_col(aes(y=all_smoke, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_smoke, ymax=ciu_smoke, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Smoking"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=20, colour = "black"),
          axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=20, family="Times", face="bold"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=20, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=30, by=10), limits=c(0, 30)) +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total")) + 
    facet_wrap(~income_group) +
    theme(strip.text.x = element_text(size = 16)) +
    coord_fixed(5/30)
  smoke.income_group
  ggsave("smoke.income_group.png", height = 12, width = 12)

####LIPIDS
  prev.lipids.income_group <- read.csv("~/by income group - Lipids(1).csv", stringsAsFactors=F)
  prev.lipids.income_group <- prev.lipids.income_group %>%
    filter(income_group!="total")
  prev.lipids.income_group <- prev.lipids.income_group %>% pivot_longer(!income_group, names_to = "pov_group", values_to = "prevalence")
  prev.lipids.income_group$prevalence <- gsub('--', '-', prev.lipids.income_group$prevalence)  
  prev.lipids.income_group <- tidyr::separate(prev.lipids.income_group, prevalence, c("all_lipids", "V2"), "\\s(?:.+\\s)?")
  prev.lipids.income_group$V2  <- gsub("[()]", "", prev.lipids.income_group$V2 )
  prev.lipids.income_group <- tidyr::separate(prev.lipids.income_group, V2, c("cil_lipids", "ciu_lipids"), "\\-")
  prev.lipids.income_group$income_group[prev.lipids.income_group$income_group == "Low income"] <- "Low-inc. countries"
  prev.lipids.income_group$income_group[prev.lipids.income_group$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
  prev.lipids.income_group$income_group[prev.lipids.income_group$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
  prev.lipids.income_group $'income_group' <- as.factor(prev.lipids.income_group $'income_group')
  prev.lipids.income_group$income_group <- prev.lipids.income_group$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", 
                                                                                              "Upper middle-inc. countries"))
  prev.lipids.income_group$pov_group <- prev.lipids.income_group$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "Prev_allpov"))
  prev.lipids.income_group $'all_lipids' <- as.numeric(as.character(prev.lipids.income_group $'all_lipids'))
  prev.lipids.income_group $'cil_lipids' <- as.numeric(as.character(prev.lipids.income_group $'cil_lipids'))
  prev.lipids.income_group $'ciu_lipids' <- as.numeric(as.character(prev.lipids.income_group $'ciu_lipids'))

  cols <- c("Pov19" = "#FEE8C8", "Pov32" = "#FDD49E", "Pov55" = "#FDBB84", "Pov0" = "#EF6548", "Prev_allpov" = "black")
  
#create figure  
  lipids.income_group <- prev.lipids.income_group %>% 
    ggplot() +
    geom_col(aes(y=all_lipids, x=pov_group, fill=pov_group), alpha=0.9) +
    geom_errorbar(aes(ymin=cil_lipids, ymax=ciu_lipids, x=pov_group), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Dyslipidemia"),
         x = "",
         y = "%",
         fill="") + 
   theme(axis.text.y=element_text(size=20, colour = "black"),
          axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=20, family="Times", face="bold"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=20, face="bold", family="Times")) + 
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=30, by=10), limits=c(0, 30)) +
    scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "Prev_allpov" = "Total")) + 
    facet_wrap(~income_group) +
    theme(strip.text.x = element_text(size = 16)) +
    coord_fixed(5/30)
  lipids.income_group
  
  ggsave("lipids.income_group.png", height = 12, width = 12)

### FIGURE S6 - BY AGEGROUP AND SEX -------------------------------------------------------------------------------------------------------------

###HYPERTESION
          prev.hypt.agegroups <- read.csv("~/Prevalences agegroups and sex - Hypertension.csv", stringsAsFactors=F)
          prev.hypt.agegroups <- prev.hypt.agegroups %>% 
            rename(total = "Prev_allpov",
              agegroups = "agegroup") %>% 
              filter(agegroups!="all")     
          prev.hypt.agegroups <- prev.hypt.agegroups %>% pivot_longer(cols = -c(agegroups, sex), names_to = "pov_group", values_to = "prevalence")
          prev.hypt.agegroups <- tidyr::separate(prev.hypt.agegroups, prevalence, c("all_hypt", "V2"), "\\s(?:.+\\s)?")
          prev.hypt.agegroups$V2  <- gsub("[()]", "", prev.hypt.agegroups$V2 )
          prev.hypt.agegroups <- tidyr::separate(prev.hypt.agegroups, V2, c("cil_hypt", "ciu_hypt"), "\\-")
          prev.hypt.agegroups $'agegroups' <- as.factor(prev.hypt.agegroups $'agegroups')
          prev.hypt.agegroups$agegroups <- prev.hypt.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
          prev.hypt.agegroups$sex <- prev.hypt.agegroups$sex %>% factor(c("0", "1"))
          prev.hypt.agegroups$pov_group <- prev.hypt.agegroups$pov_group %>% factor(c("pov19", "pov32",  "pov55", "pov0", "total"))
          prev.hypt.agegroups $'all_hypt' <- as.numeric(as.character(prev.hypt.agegroups $'all_hypt'))
          prev.hypt.agegroups $'cil_hypt' <- as.numeric(as.character(prev.hypt.agegroups $'cil_hypt'))
          prev.hypt.agegroups $'ciu_hypt' <- as.numeric(as.character(prev.hypt.agegroups $'ciu_hypt'))
 
          hypt.age.sex <- prev.hypt.agegroups %>% 
            ggplot(aes(x=pov_group, y=all_hypt, fill=sex)) +
            geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                  geom_errorbar(aes(ymin=cil_hypt, ymax=ciu_hypt), width=.2,
                           position=position_dodge(.9), show.legend = F) +
            labs(title = paste0("Hypertension"),
                 x = "",
                 y = "%",
                 fill="") + 
            theme(axis.text.y=element_text(size=20, colour = "black"),
                  axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                  axis.title=element_text(size=23, face="bold"),
                  legend.text=element_text(size=20, family="Times", face="bold"),
                  legend.title = element_blank(),
                  #legend.position="none",
                  axis.title.x = element_text(margin = margin(t = 20)),
                  axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                  strip.text.x = element_text(size=28, face="bold"),
                  strip.background = element_blank(),
                  panel.spacing = unit(2, "lines"),
                  title = element_text(size=20, face="bold", family="Times")) + 
            scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
            scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
            scale_x_discrete(labels = c("pov19" = "<$1.90/day", "pov32" = "<$3.20/day", "pov55" = "<$5.50/day", "pov0" = ">$5.50/day", "total" = 
                                          "Total")) + 
            facet_wrap(~agegroups) +
            theme(strip.text.x = element_text(size = 16)) +
            coord_fixed(5/100) 
          hypt.age.sex
          ggsave("hypt.age.sex.png", height = 12, width = 12) 
 
###DIABETES
        prev.dia.agegroups <- read.csv("~/Prevalences agegroups and sex - Diabetes.csv", stringsAsFactors=F)
        prev.dia.agegroups <- prev.dia.agegroups %>% 
          rename(total = "Prev_allpov",
                agegroups = "agegroup") %>% 
                filter(agegroups!="all")     
        prev.dia.agegroups <- prev.dia.agegroups %>% pivot_longer(cols = -c(agegroups, sex), names_to = "pov_group", values_to = "prevalence")
        prev.dia.agegroups <- tidyr::separate(prev.dia.agegroups, prevalence, c("all_dia", "V2"), "\\s(?:.+\\s)?")
        prev.dia.agegroups$V2  <- gsub("[()]", "", prev.dia.agegroups$V2 )
        prev.dia.agegroups <- tidyr::separate(prev.dia.agegroups, V2, c("cil_dia", "ciu_dia"), "\\-")
        prev.dia.agegroups $'agegroups' <- as.factor(prev.dia.agegroups $'agegroups')
        prev.dia.agegroups$agegroups <- prev.dia.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.dia.agegroups$sex <- prev.dia.agegroups$sex %>% factor(c("0", "1"))
        prev.dia.agegroups$pov_group <- prev.dia.agegroups$pov_group %>% factor(c("pov19", "pov32",  "pov55", "pov0", "total"))
        prev.dia.agegroups $'all_dia' <- as.numeric(as.character(prev.dia.agegroups $'all_dia'))
        prev.dia.agegroups $'cil_dia' <- as.numeric(as.character(prev.dia.agegroups $'cil_dia'))
        prev.dia.agegroups $'ciu_dia' <- as.numeric(as.character(prev.dia.agegroups $'ciu_dia'))
 
        dia.age.sex <- prev.dia.agegroups %>% 
          ggplot(aes(x=pov_group, y=all_dia, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_dia, ymax=ciu_dia), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Diabetes"),
               x = "",
               y = "%",
               fill="") + 
         theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("pov19" = "<$1.90/day", "pov32" = "<$3.20/day", "pov55" = "<$5.50/day", "pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~agegroups) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100) 
        dia.age.sex
        ggsave("dia.age.sex.png", height = 12, width = 12) 

###OBESITY
        prev.obese.agegroups <- read.csv("~/Prevalences agegroups and sex - Obesity.csv", stringsAsFactors=F)
        prev.obese.agegroups <- prev.obese.agegroups %>% 
          rename(total = "Prev_allpov",
                 agegroups = "agegroup") %>% 
                 filter(agegroups!="all")     
        prev.obese.agegroups <- prev.obese.agegroups %>% pivot_longer(cols = -c(agegroups, sex), names_to = "pov_group", values_to = "prevalence")
        prev.obese.agegroups <- tidyr::separate(prev.obese.agegroups, prevalence, c("all_obese", "V2"), "\\s(?:.+\\s)?")
        prev.obese.agegroups$V2  <- gsub("[()]", "", prev.obese.agegroups$V2 )
        prev.obese.agegroups <- tidyr::separate(prev.obese.agegroups, V2, c("cil_obese", "ciu_obese"), "\\-")
        
        prev.obese.agegroups $'agegroups' <- as.factor(prev.obese.agegroups $'agegroups')
        prev.obese.agegroups$agegroups <- prev.obese.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.obese.agegroups$sex <- prev.obese.agegroups$sex %>% factor(c("0", "1"))
        prev.obese.agegroups$pov_group <- prev.obese.agegroups$pov_group %>% factor(c("pov19", "pov32",  "pov55", "pov0", "total"))
        prev.obese.agegroups $'all_obese' <- as.numeric(as.character(prev.obese.agegroups $'all_obese'))
        prev.obese.agegroups $'cil_obese' <- as.numeric(as.character(prev.obese.agegroups $'cil_obese'))
        prev.obese.agegroups $'ciu_obese' <- as.numeric(as.character(prev.obese.agegroups $'ciu_obese'))

        obese.age.sex <- prev.obese.agegroups %>% 
          ggplot(aes(x=pov_group, y=all_obese, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_obese, ymax=ciu_obese), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Obesity"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("pov19" = "<$1.90/day", "pov32" = "<$3.20/day", "pov55" = "<$5.50/day", "pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~agegroups) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100)  
        obese.age.sex
        ggsave("obese.age.sex.png", height = 12, width = 12) 

### SMOKING 
        prev.smoke.agegroups <- read.csv("~/Prevalences agegroups and sex - Smoking.csv", stringsAsFactors=F)
        prev.smoke.agegroups <- prev.smoke.agegroups %>% rename(
          total = "Prev_allpov",
          agegroups = "agegroup") %>% 
          filter(agegroups!="all")     
        prev.smoke.agegroups <- prev.smoke.agegroups %>% pivot_longer(cols = -c(agegroups, sex), names_to = "pov_group", values_to = "prevalence")
        prev.smoke.agegroups <- tidyr::separate(prev.smoke.agegroups, prevalence, c("all_smoke", "V2"), "\\s(?:.+\\s)?")
        prev.smoke.agegroups$V2  <- gsub("[()]", "", prev.smoke.agegroups$V2 )
        prev.smoke.agegroups <- tidyr::separate(prev.smoke.agegroups, V2, c("cil_smoke", "ciu_smoke"), "\\-")
        prev.smoke.agegroups $'agegroups' <- as.factor(prev.smoke.agegroups $'agegroups')
        prev.smoke.agegroups$agegroups <- prev.smoke.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.smoke.agegroups$sex <- prev.smoke.agegroups$sex %>% factor(c("0", "1"))
        prev.smoke.agegroups$pov_group <- prev.smoke.agegroups$pov_group %>% factor(c("pov19", "pov32",  "pov55", "pov0", "total"))
        prev.smoke.agegroups $'all_smoke' <- as.numeric(as.character(prev.smoke.agegroups $'all_smoke'))
        prev.smoke.agegroups $'cil_smoke' <- as.numeric(as.character(prev.smoke.agegroups $'cil_smoke'))
        prev.smoke.agegroups $'ciu_smoke' <- as.numeric(as.character(prev.smoke.agegroups $'ciu_smoke'))
 
  smoke.age.sex <- prev.smoke.agegroups %>% 
    ggplot(aes(x=pov_group, y=all_smoke, fill=sex)) +
    geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
          geom_errorbar(aes(ymin=cil_smoke, ymax=ciu_smoke), width=.2,
                   position=position_dodge(.9), show.legend = F) +
    labs(title = paste0("Smoking"),
         x = "",
         y = "%",
         fill="") + 
   theme(axis.text.y=element_text(size=20, colour = "black"),
          axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=20, family="Times", face="bold"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=20, face="bold", family="Times")) + 
    scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
    scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
    scale_x_discrete(labels = c("pov19" = "<$1.90/day", "pov32" = "<$3.20/day", "pov55" = "<$5.50/day", "pov0" = ">$5.50/day", "total" = "Total")) + 
    facet_wrap(~agegroups) +
    theme(strip.text.x = element_text(size = 16)) +
    coord_fixed(5/100) 
  smoke.age.sex
  ggsave("smoke.age.sex.png", height = 12, width = 12) 

###LIPIDS
        prev.lipids.agegroups <- read.csv("~/Prevalences agegroups and sex - Lipids.csv", stringsAsFactors=F)
        prev.lipids.agegroups <- prev.lipids.agegroups %>% 
          rename(total = "Prev_allpov",
                 agegroups = "agegroup") %>% 
                 filter(agegroups!="all")     
        prev.lipids.agegroups <- prev.lipids.agegroups %>% pivot_longer(cols = -c(agegroups, sex), names_to = "pov_group", values_to = "prevalence")
        prev.lipids.agegroups <- tidyr::separate(prev.lipids.agegroups, prevalence, c("all_lipids", "V2"), "\\s(?:.+\\s)?")
        prev.lipids.agegroups$V2  <- gsub("[()]", "", prev.lipids.agegroups$V2 )
        prev.lipids.agegroups <- tidyr::separate(prev.lipids.agegroups, V2, c("cil_lipids", "ciu_lipids"), "\\-")
        prev.lipids.agegroups $'agegroups' <- as.factor(prev.lipids.agegroups $'agegroups')
        prev.lipids.agegroups$agegroups <- prev.lipids.agegroups$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
        prev.lipids.agegroups$sex <- prev.lipids.agegroups$sex %>% factor(c("0", "1"))
        prev.lipids.agegroups$pov_group <- prev.lipids.agegroups$pov_group %>% factor(c("pov19", "pov32",  "pov55", "pov0", "total"))
        prev.lipids.agegroups $'all_lipids' <- as.numeric(as.character(prev.lipids.agegroups $'all_lipids'))
        prev.lipids.agegroups $'cil_lipids' <- as.numeric(as.character(prev.lipids.agegroups $'cil_lipids'))
        prev.lipids.agegroups $'ciu_lipids' <- as.numeric(as.character(prev.lipids.agegroups $'ciu_lipids'))
     
    lipids.age.sex <- prev.lipids.agegroups %>% 
      ggplot(aes(x=pov_group, y=all_lipids, fill=sex)) +
      geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
            geom_errorbar(aes(ymin=cil_lipids, ymax=ciu_lipids), width=.2,
                     position=position_dodge(.9), show.legend = F) +
      labs(title = paste0("Dyslipidemia"),
           x = "",
           y = "%",
           fill="") + 
      theme(axis.text.y=element_text(size=20, colour = "black"),
            axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
            axis.title=element_text(size=23, face="bold"),
            legend.text=element_text(size=20, family="Times", face="bold"),
            legend.title = element_blank(),
            #legend.position="none",
            axis.title.x = element_text(margin = margin(t = 20)),
            axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
            strip.text.x = element_text(size=28, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            title = element_text(size=20, face="bold", family="Times")) + 
      scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
      scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
      scale_x_discrete(labels = c("pov19" = "<$1.90/day", "pov32" = "<$3.20/day", "pov55" = "<$5.50/day", "pov0" = ">$5.50/day", "total" = "Total")) + 
      facet_wrap(~agegroups) +
      theme(strip.text.x = element_text(size = 16)) +
      coord_fixed(5/100) 
    lipids.age.sex
    ggsave("lipids.age.sex.png", height = 12, width = 12) 

```

```{r FIGURE S8: Prevalence by region and sex}

###HYPERTENSION
        prev.hypt.region.sex <- read.csv("~/by region and sex - Hypertension.csv", stringsAsFactors=F)
        prev.hypt.region.sex <- prev.hypt.region.sex %>% rename(
          total = "Prev_allpov") %>% 
          filter(region!="all")     
        prev.hypt.region.sex <- prev.hypt.region.sex %>% pivot_longer(cols = -c(region, sex), names_to = "pov_group", values_to = "prevalence")
        prev.hypt.region.sex <- tidyr::separate(prev.hypt.region.sex, prevalence, c("all_hypt", "V2"), "\\s(?:.+\\s)?")
        prev.hypt.region.sex$V2  <- gsub("[()]", "", prev.hypt.region.sex$V2 )
        prev.hypt.region.sex <- tidyr::separate(prev.hypt.region.sex, V2, c("cil_hypt", "ciu_hypt"), "\\--")
        prev.hypt.region.sex$region[prev.hypt.region.sex$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
        prev.hypt.region.sex$region[prev.hypt.region.sex$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
        prev.hypt.region.sex$region[prev.hypt.region.sex$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
        prev.hypt.region.sex$region[prev.hypt.region.sex$region == "Middle East and North Africa"] <- "M.East & N.Africa"
        prev.hypt.region.sex$region[prev.hypt.region.sex$region == "South Asia"] <- "S.Asia"
        prev.hypt.region.sex$region[prev.hypt.region.sex$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
        prev.hypt.region.sex $'region' <- as.factor(prev.hypt.region.sex $'region')
        prev.hypt.region.sex$region <- prev.hypt.region.sex$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & 
                                                                                N.Africa", "S.Asia", "Sub-S.Africa"))
        prev.hypt.region.sex$sex <- prev.hypt.region.sex$sex %>% factor(c("0", "1"))
        prev.hypt.region.sex$pov_group <- prev.hypt.region.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.hypt.region.sex $'all_hypt' <- as.numeric(as.character(prev.hypt.region.sex $'all_hypt'))
        prev.hypt.region.sex $'cil_hypt' <- as.numeric(as.character(prev.hypt.region.sex $'cil_hypt'))
        prev.hypt.region.sex $'ciu_hypt' <- as.numeric(as.character(prev.hypt.region.sex $'ciu_hypt'))
 
        hypt.region.sex <- prev.hypt.region.sex %>% 
          ggplot(aes(x=pov_group, y=all_hypt, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_hypt, ymax=ciu_hypt), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Hypertension"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=80, by=20), limits=c(0, 80)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~region) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100) 

        hypt.region.sex
        ggsave("hypt.region.sex.png", height = 12, width = 12) 

###DIABETES
        prev.dia.region.sex <- read.csv("~/by region and sex - Diabetes.csv", stringsAsFactors=F)
        prev.dia.region.sex <- prev.dia.region.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(region!="all") %>% 
          mutate(Pov19 = ifelse(region=="Middle East and North Africa" & sex=="0", NA, 
                           ifelse(region=="Middle East and North Africa" & sex=="1", NA, Pov19)))
        prev.dia.region.sex <- prev.dia.region.sex %>% pivot_longer(cols = -c(region, sex), names_to = "pov_group", values_to = "prevalence")
        prev.dia.region.sex <- tidyr::separate(prev.dia.region.sex, prevalence, c("all_dia", "V2"), "\\s(?:.+\\s)?")
        prev.dia.region.sex$V2  <- gsub("[()]", "", prev.dia.region.sex$V2 )
        prev.dia.region.sex <- tidyr::separate(prev.dia.region.sex, V2, c("cil_dia", "ciu_dia"), "\\--")
        prev.dia.region.sex$region[prev.dia.region.sex$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
        prev.dia.region.sex$region[prev.dia.region.sex$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
        prev.dia.region.sex$region[prev.dia.region.sex$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
        prev.dia.region.sex$region[prev.dia.region.sex$region == "Middle East and North Africa"] <- "M.East & N.Africa"
        prev.dia.region.sex$region[prev.dia.region.sex$region == "South Asia"] <- "S.Asia"
        prev.dia.region.sex$region[prev.dia.region.sex$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
        prev.dia.region.sex $'region' <- as.factor(prev.dia.region.sex $'region')
        prev.dia.region.sex$region <- prev.dia.region.sex$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & 
                                                                              N.Africa", "S.Asia", "Sub-S.Africa"))
        prev.dia.region.sex$sex <- prev.dia.region.sex$sex %>% factor(c("0", "1"))
        prev.dia.region.sex$pov_group <- prev.dia.region.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.dia.region.sex $'all_dia' <- as.numeric(as.character(prev.dia.region.sex $'all_dia'))
        prev.dia.region.sex $'cil_dia' <- as.numeric(as.character(prev.dia.region.sex $'cil_dia'))
        prev.dia.region.sex $'ciu_dia' <- as.numeric(as.character(prev.dia.region.sex $'ciu_dia'))
 
        dia.region.sex <- prev.dia.region.sex %>% 
          ggplot(aes(x=pov_group, y=all_dia, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_dia, ymax=ciu_dia), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Diabetes"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=80, by=20), limits=c(0, 80)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~region) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100) 
        
        dia.region.sex
        ggsave("dia.region.sex.png", height = 12, width = 12)

###OBESITY 
        prev.obese.region.sex <- read.csv("~/by region and sex - Obesity.csv", stringsAsFactors=F)
        prev.obese.region.sex <- prev.obese.region.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(region!="all") %>%  
          mutate(Pov19 = ifelse(region=="Middle East and North Africa" & sex=="0", NA, 
                        ifelse(region=="South Asia" & sex=="0", NA, Pov19)))    
        prev.obese.region.sex <- prev.obese.region.sex %>% pivot_longer(cols = -c(region, sex), names_to = "pov_group", values_to = "prevalence")
        prev.obese.region.sex <- tidyr::separate(prev.obese.region.sex, prevalence, c("all_obese", "V2"), "\\s(?:.+\\s)?")
        prev.obese.region.sex$V2  <- gsub("[()]", "", prev.obese.region.sex$V2 )
        prev.obese.region.sex <- tidyr::separate(prev.obese.region.sex, V2, c("cil_obese", "ciu_obese"), "\\--")
        prev.obese.region.sex$region[prev.obese.region.sex$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
        prev.obese.region.sex$region[prev.obese.region.sex$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
        prev.obese.region.sex$region[prev.obese.region.sex$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
        prev.obese.region.sex$region[prev.obese.region.sex$region == "Middle East and North Africa"] <- "M.East & N.Africa"
        prev.obese.region.sex$region[prev.obese.region.sex$region == "South Asia"] <- "S.Asia"
        prev.obese.region.sex$region[prev.obese.region.sex$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
        prev.obese.region.sex $'region' <- as.factor(prev.obese.region.sex $'region')
        prev.obese.region.sex$region <- prev.obese.region.sex$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & 
                                                                                  N.Africa", "S.Asia", "Sub-S.Africa"))
        prev.obese.region.sex$sex <- prev.obese.region.sex$sex %>% factor(c("0", "1"))
        prev.obese.region.sex$pov_group <- prev.obese.region.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.obese.region.sex $'all_obese' <- as.numeric(as.character(prev.obese.region.sex $'all_obese'))
        prev.obese.region.sex $'cil_obese' <- as.numeric(as.character(prev.obese.region.sex $'cil_obese'))
        prev.obese.region.sex $'ciu_obese' <- as.numeric(as.character(prev.obese.region.sex $'ciu_obese'))
 
        obese.region.sex <- prev.obese.region.sex %>% 
          ggplot(aes(x=pov_group, y=all_obese, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_obese, ymax=ciu_obese), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Obesity"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=80, by=20), limits=c(0, 80)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~region) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100)  
        
        obese.region.sex
        ggsave("obese.region.sex.png", height = 12, width = 12)

###SMOKING 
        prev.smoking.region.sex <- read.csv("~/by region and sex - Smoking.csv", stringsAsFactors=F)
        prev.smoking.region.sex <- prev.smoking.region.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(region!="all")     
        prev.smoking.region.sex <- prev.smoking.region.sex %>% pivot_longer(cols = -c(region, sex), names_to = "pov_group", values_to = "prevalence")
        prev.smoking.region.sex <- tidyr::separate(prev.smoking.region.sex, prevalence, c("all_smoking", "V2"), "\\s(?:.+\\s)?")
        prev.smoking.region.sex$V2  <- gsub("[()]", "", prev.smoking.region.sex$V2 )
        prev.smoking.region.sex <- tidyr::separate(prev.smoking.region.sex, V2, c("cil_smoking", "ciu_smoking"), "\\--")
        prev.smoking.region.sex$region[prev.smoking.region.sex$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
        prev.smoking.region.sex$region[prev.smoking.region.sex$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
        prev.smoking.region.sex$region[prev.smoking.region.sex$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
        prev.smoking.region.sex$region[prev.smoking.region.sex$region == "Middle East and North Africa"] <- "M.East & N.Africa"
        prev.smoking.region.sex$region[prev.smoking.region.sex$region == "South Asia"] <- "S.Asia"
        prev.smoking.region.sex$region[prev.smoking.region.sex$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
        prev.smoking.region.sex $'region' <- as.factor(prev.smoking.region.sex $'region')
        prev.smoking.region.sex$region <- prev.smoking.region.sex$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East 
                                                                                      & N.Africa", "S.Asia", "Sub-S.Africa"))
        prev.smoking.region.sex$sex <- prev.smoking.region.sex$sex %>% factor(c("0", "1"))
        prev.smoking.region.sex$pov_group <- prev.smoking.region.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.smoking.region.sex $'all_smoking' <- as.numeric(as.character(prev.smoking.region.sex $'all_smoking'))
        prev.smoking.region.sex $'cil_smoking' <- as.numeric(as.character(prev.smoking.region.sex $'cil_smoking'))
        prev.smoking.region.sex $'ciu_smoking' <- as.numeric(as.character(prev.smoking.region.sex $'ciu_smoking'))

        smoking.region.sex <- prev.smoking.region.sex %>% 
          ggplot(aes(x=pov_group, y=all_smoking, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_smoking, ymax=ciu_smoking), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Smoking"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=80, by=20), limits=c(0, 80)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~region) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100)  
        
        smoking.region.sex
        ggsave("smoking.region.sex.png", height = 12, width = 12)

###LIPIDS
        prev.lipids.region.sex <- read.csv("~/by region and sex - Lipids.csv", stringsAsFactors=F)
        prev.lipids.region.sex <- prev.lipids.region.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(region!="all")  %>%
          mutate(Pov19 = ifelse(region=="Europe and Central Asia" & sex=="0", NA, 
                        ifelse(region=="Middle East and North Africa" & sex=="0", NA, 
                          ifelse(region=="Europe and Central Asia" & sex=="1", NA,
                                 ifelse(region=="Middle East and North Africa" & sex=="1", NA,
                                        ifelse(region=="South Asia" & sex=="1", NA, Pov19))))),
                Pov32 = ifelse(region=="Middle East and North Africa" & sex=="0", NA,
                           ifelse(region=="Middle East and North Africa" & sex=="1", NA, Pov32)))          
        prev.lipids.region.sex <- prev.lipids.region.sex %>% pivot_longer(cols = -c(region, sex), names_to = "pov_group", values_to = "prevalence")
        prev.lipids.region.sex <- tidyr::separate(prev.lipids.region.sex, prevalence, c("all_lipids", "V2"), "\\s(?:.+\\s)?")
        prev.lipids.region.sex$V2  <- gsub("[()]", "", prev.lipids.region.sex$V2 )
        prev.lipids.region.sex <- tidyr::separate(prev.lipids.region.sex, V2, c("cil_lipids", "ciu_lipids"), "\\--")
        prev.lipids.region.sex$region[prev.lipids.region.sex$region == "East Asia and Pacific"] <- "E.Asia & Pacific"
        prev.lipids.region.sex$region[prev.lipids.region.sex$region == "Europe and Central Asia"] <- "Eur. & C.Asia"
        prev.lipids.region.sex$region[prev.lipids.region.sex$region == "Latin America and the Caribbean"] <- "Lat.Am. & Caribb."
        prev.lipids.region.sex$region[prev.lipids.region.sex$region == "Middle East and North Africa"] <- "M.East & N.Africa"
        prev.lipids.region.sex$region[prev.lipids.region.sex$region == "South Asia"] <- "S.Asia"
        prev.lipids.region.sex$region[prev.lipids.region.sex$region == "Sub-Saharan Africa"] <- "Sub-S.Africa"
        prev.lipids.region.sex $'region' <- as.factor(prev.lipids.region.sex $'region')
        prev.lipids.region.sex$region <- prev.lipids.region.sex$region %>% factor(c("E.Asia & Pacific", "Eur. & C.Asia", "Lat.Am. & Caribb.", "M.East & 
                                                                                    N.Africa", "S.Asia", "Sub-S.Africa"))
        prev.lipids.region.sex$sex <- prev.lipids.region.sex$sex %>% factor(c("0", "1"))
        prev.lipids.region.sex$pov_group <- prev.lipids.region.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.lipids.region.sex $'all_lipids' <- as.numeric(as.character(prev.lipids.region.sex $'all_lipids'))
        prev.lipids.region.sex $'cil_lipids' <- as.numeric(as.character(prev.lipids.region.sex $'cil_lipids'))
        prev.lipids.region.sex $'ciu_lipids' <- as.numeric(as.character(prev.lipids.region.sex $'ciu_lipids'))
        
        lipids.region.sex <- prev.lipids.region.sex %>% 
          ggplot(aes(x=pov_group, y=all_lipids, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_lipids, ymax=ciu_lipids), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Dyslipidemia"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~region) +
          theme(strip.text.x = element_text(size = 16)) +
          coord_fixed(5/100) 

        lipids.region.sex
        ggsave("lipids.region.sex.png", height = 12, width = 12)

 
```

```{r FIGURE S9: Prevalence by income group and sex}

###HYPERTESION
        prev.hypt.wbgroup.sex <- read.csv("~/by income group and sex - Hypertension.csv", stringsAsFactors=F)
        prev.hypt.wbgroup.sex <- prev.hypt.wbgroup.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(income_group!="all")     
        prev.hypt.wbgroup.sex <- prev.hypt.wbgroup.sex %>% pivot_longer(cols = -c(income_group, sex), names_to = "pov_group", values_to = "prevalence")
        prev.hypt.wbgroup.sex <- tidyr::separate(prev.hypt.wbgroup.sex, prevalence, c("all_hypt", "V2"), "\\s(?:.+\\s)?")
        prev.hypt.wbgroup.sex$V2  <- gsub("[()]", "", prev.hypt.wbgroup.sex$V2 )
        prev.hypt.wbgroup.sex <- tidyr::separate(prev.hypt.wbgroup.sex, V2, c("cil_hypt", "ciu_hypt"), "\\--")
        prev.hypt.wbgroup.sex$income_group[prev.hypt.wbgroup.sex$income_group == "Low income"] <- "Low-inc. countries"
        prev.hypt.wbgroup.sex$income_group[prev.hypt.wbgroup.sex$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
        prev.hypt.wbgroup.sex$income_group[prev.hypt.wbgroup.sex$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
        prev.hypt.wbgroup.sex $'income_group' <- as.factor(prev.hypt.wbgroup.sex $'income_group')
        prev.hypt.wbgroup.sex$income_group <- prev.hypt.wbgroup.sex$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", 
                                                                                              "Upper middle-inc. countries"))
        prev.hypt.wbgroup.sex$sex <- prev.hypt.wbgroup.sex$sex %>% factor(c("0", "1"))
        prev.hypt.wbgroup.sex$pov_group <- prev.hypt.wbgroup.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.hypt.wbgroup.sex $'all_hypt' <- as.numeric(as.character(prev.hypt.wbgroup.sex $'all_hypt'))
        prev.hypt.wbgroup.sex $'cil_hypt' <- as.numeric(as.character(prev.hypt.wbgroup.sex $'cil_hypt'))
        prev.hypt.wbgroup.sex $'ciu_hypt' <- as.numeric(as.character(prev.hypt.wbgroup.sex $'ciu_hypt'))
 
#create figure        
        hypt.wbgroup.sex <- prev.hypt.wbgroup.sex %>% 
          ggplot(aes(x=pov_group, y=all_hypt, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_hypt, ymax=ciu_hypt), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          #theme_classic() + 
          labs(title = paste0("Hypertension"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~income_group) +
          theme(strip.text.x = element_text(size = 15)) +
          coord_fixed(5/100) 
        hypt.wbgroup.sex
        ggsave("hypt.wbgroup.sex.png", height = 12, width = 12) 

###DIABETES
        prev.dia.wbgroup.sex <- read.csv("~/by income group and sex - Diabetes.csv", stringsAsFactors=F)
        prev.dia.wbgroup.sex <- prev.dia.wbgroup.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(income_group!="all")     
        prev.dia.wbgroup.sex <- prev.dia.wbgroup.sex %>% pivot_longer(cols = -c(income_group, sex), names_to = "pov_group", values_to = "prevalence")
        prev.dia.wbgroup.sex <- tidyr::separate(prev.dia.wbgroup.sex, prevalence, c("all_dia", "V2"), "\\s(?:.+\\s)?")
        prev.dia.wbgroup.sex$V2  <- gsub("[()]", "", prev.dia.wbgroup.sex$V2 )
        prev.dia.wbgroup.sex <- tidyr::separate(prev.dia.wbgroup.sex, V2, c("cil_dia", "ciu_dia"), "\\--")
        prev.dia.wbgroup.sex$income_group[prev.dia.wbgroup.sex$income_group == "Low income"] <- "Low-inc. countries"
        prev.dia.wbgroup.sex$income_group[prev.dia.wbgroup.sex$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
        prev.dia.wbgroup.sex$income_group[prev.dia.wbgroup.sex$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
        prev.dia.wbgroup.sex $'income_group' <- as.factor(prev.dia.wbgroup.sex $'income_group')
        prev.dia.wbgroup.sex$income_group <- prev.dia.wbgroup.sex$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", "Upper 
                                                                                            middle-inc. countries"))
        prev.dia.wbgroup.sex$sex <- prev.dia.wbgroup.sex$sex %>% factor(c("0", "1"))
        prev.dia.wbgroup.sex$pov_group <- prev.dia.wbgroup.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.dia.wbgroup.sex $'all_dia' <- as.numeric(as.character(prev.dia.wbgroup.sex $'all_dia'))
        prev.dia.wbgroup.sex $'cil_dia' <- as.numeric(as.character(prev.dia.wbgroup.sex $'cil_dia'))
        prev.dia.wbgroup.sex $'ciu_dia' <- as.numeric(as.character(prev.dia.wbgroup.sex $'ciu_dia'))
        
#create figure         
        dia.wbgroup.sex <- prev.dia.wbgroup.sex %>% 
          ggplot(aes(x=pov_group, y=all_dia, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_dia, ymax=ciu_dia), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Diabetes"),
               x = "",
               y = "%",
               fill="") + 
         theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total"))
        + 
          facet_wrap(~income_group) +
          theme(strip.text.x = element_text(size = 15)) +
          coord_fixed(5/100) 
        dia.wbgroup.sex
        ggsave("dia.wbgroup.sex.png", height = 12, width = 12) 

###OBESITY
        prev.obese.wbgroup.sex <- read.csv("~/by income group and sex - Obesity.csv", stringsAsFactors=F)
        prev.obese.wbgroup.sex <- prev.obese.wbgroup.sex %>%
          rename(total = "Prev_allpov") %>% 
          filter(income_group!="all")  %>%
          mutate(Pov0 = ifelse(income_group=="Low income" & sex=="0", NA, Pov0)) 
        prev.obese.wbgroup.sex <- prev.obese.wbgroup.sex %>% pivot_longer(cols = -c(income_group, sex), names_to = "pov_group", values_to = 
                                                                            "prevalence")
        prev.obese.wbgroup.sex <- tidyr::separate(prev.obese.wbgroup.sex, prevalence, c("all_obese", "V2"), "\\s(?:.+\\s)?")
        prev.obese.wbgroup.sex$V2  <- gsub("[()]", "", prev.obese.wbgroup.sex$V2 )
        prev.obese.wbgroup.sex <- tidyr::separate(prev.obese.wbgroup.sex, V2, c("cil_obese", "ciu_obese"), "\\--")
        prev.obese.wbgroup.sex$income_group[prev.obese.wbgroup.sex$income_group == "Low income"] <- "Low-inc. countries"
        prev.obese.wbgroup.sex$income_group[prev.obese.wbgroup.sex$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
        prev.obese.wbgroup.sex$income_group[prev.obese.wbgroup.sex$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
        prev.obese.wbgroup.sex $'income_group' <- as.factor(prev.obese.wbgroup.sex $'income_group')
        prev.obese.wbgroup.sex$income_group <- prev.obese.wbgroup.sex$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", 
                                                                                                "Upper middle-inc. countries"))
        prev.obese.wbgroup.sex$sex <- prev.obese.wbgroup.sex$sex %>% factor(c("0", "1"))
        prev.obese.wbgroup.sex$pov_group <- prev.obese.wbgroup.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.obese.wbgroup.sex $'all_obese' <- as.numeric(as.character(prev.obese.wbgroup.sex $'all_obese'))
        prev.obese.wbgroup.sex $'cil_obese' <- as.numeric(as.character(prev.obese.wbgroup.sex $'cil_obese'))
        prev.obese.wbgroup.sex $'ciu_obese' <- as.numeric(as.character(prev.obese.wbgroup.sex $'ciu_obese'))

#create figure         
        obese.wbgroup.sex <- prev.obese.wbgroup.sex %>% 
          ggplot(aes(x=pov_group, y=all_obese, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_obese, ymax=ciu_obese), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Obesity"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~income_group) +
          theme(strip.text.x = element_text(size = 15)) +
          coord_fixed(5/100)  
        obese.wbgroup.sex
        ggsave("obese.wbgroup.sex.png", height = 12, width = 12) 

###SMOKING
        prev.smoking.wbgroup.sex <- read.csv("~/by income group and sex - Smoking.csv", stringsAsFactors=F)
        prev.smoking.wbgroup.sex <- prev.smoking.wbgroup.sex %>% 
          rename(total = "Prev_allpov") %>% 
          filter(income_group!="all")     
        prev.smoking.wbgroup.sex <- prev.smoking.wbgroup.sex %>% pivot_longer(cols = -c(income_group, sex), names_to = "pov_group", values_to = 
                                                                                "prevalence")
        prev.smoking.wbgroup.sex <- tidyr::separate(prev.smoking.wbgroup.sex, prevalence, c("all_smoking", "V2"), "\\s(?:.+\\s)?")
        prev.smoking.wbgroup.sex$V2  <- gsub("[()]", "", prev.smoking.wbgroup.sex$V2 )
        prev.smoking.wbgroup.sex <- tidyr::separate(prev.smoking.wbgroup.sex, V2, c("cil_smoking", "ciu_smoking"), "\\--")
        prev.smoking.wbgroup.sex$income_group[prev.smoking.wbgroup.sex$income_group == "Low income"] <- "Low-inc. countries"
        prev.smoking.wbgroup.sex$income_group[prev.smoking.wbgroup.sex$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
        prev.smoking.wbgroup.sex$income_group[prev.smoking.wbgroup.sex$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
        prev.smoking.wbgroup.sex $'income_group' <- as.factor(prev.smoking.wbgroup.sex $'income_group')
        prev.smoking.wbgroup.sex$income_group <- prev.smoking.wbgroup.sex$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries",
                                                                                                    "Upper middle-inc. countries"))
        prev.smoking.wbgroup.sex$sex <- prev.smoking.wbgroup.sex$sex %>% factor(c("0", "1"))
        prev.smoking.wbgroup.sex$pov_group <- prev.smoking.wbgroup.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.smoking.wbgroup.sex $'all_smoking' <- as.numeric(as.character(prev.smoking.wbgroup.sex $'all_smoking'))
        prev.smoking.wbgroup.sex $'cil_smoking' <- as.numeric(as.character(prev.smoking.wbgroup.sex $'cil_smoking'))
        prev.smoking.wbgroup.sex $'ciu_smoking' <- as.numeric(as.character(prev.smoking.wbgroup.sex $'ciu_smoking'))

#create figure         
        smoking.wbgroup.sex <- prev.smoking.wbgroup.sex %>% 
          ggplot(aes(x=pov_group, y=all_smoking, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_smoking, ymax=ciu_smoking), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Smoking"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~income_group) +
          theme(strip.text.x = element_text(size = 15)) +
          coord_fixed(5/100)  
        smoking.wbgroup.sex
        ggsave("smoking.wbgroup.sex.png", height = 12, width = 12) 

###LIPIDS
        prev.lipids.wbgroup.sex <- read.csv("~/by income group and sex - Lipids.csv", stringsAsFactors=F)
        prev.lipids.wbgroup.sex <- prev.lipids.wbgroup.sex %>% rename(
          total = "Prev_allpov") %>% 
          filter(income_group!="all")     
        prev.lipids.wbgroup.sex <- prev.lipids.wbgroup.sex %>% pivot_longer(cols = -c(income_group, sex), names_to = "pov_group", values_to = 
                                                                              "prevalence")
        prev.lipids.wbgroup.sex <- tidyr::separate(prev.lipids.wbgroup.sex, prevalence, c("all_lipids", "V2"), "\\s(?:.+\\s)?")
        prev.lipids.wbgroup.sex$V2  <- gsub("[()]", "", prev.lipids.wbgroup.sex$V2 )
        prev.lipids.wbgroup.sex <- tidyr::separate(prev.lipids.wbgroup.sex, V2, c("cil_lipids", "ciu_lipids"), "\\--")
        prev.lipids.wbgroup.sex$income_group[prev.lipids.wbgroup.sex$income_group == "Low income"] <- "Low-inc. countries"
        prev.lipids.wbgroup.sex$income_group[prev.lipids.wbgroup.sex$income_group == "Lower middle income"] <- "Lower middle-inc. countries"
        prev.lipids.wbgroup.sex$income_group[prev.lipids.wbgroup.sex$income_group == "Upper middle income"] <- "Upper middle-inc. countries"
        prev.lipids.wbgroup.sex $'income_group' <- as.factor(prev.lipids.wbgroup.sex $'income_group')
        prev.lipids.wbgroup.sex$income_group <- prev.lipids.wbgroup.sex$income_group %>% factor(c("Low-inc. countries", "Lower middle-inc. countries", 
                                                                                                  "Upper middle-inc. countries"))
        prev.lipids.wbgroup.sex$sex <- prev.lipids.wbgroup.sex$sex %>% factor(c("0", "1"))
        prev.lipids.wbgroup.sex$pov_group <- prev.lipids.wbgroup.sex$pov_group %>% factor(c("Pov19", "Pov32",  "Pov55", "Pov0", "total"))
        prev.lipids.wbgroup.sex $'all_lipids' <- as.numeric(as.character(prev.lipids.wbgroup.sex $'all_lipids'))
        prev.lipids.wbgroup.sex $'cil_lipids' <- as.numeric(as.character(prev.lipids.wbgroup.sex $'cil_lipids'))
        prev.lipids.wbgroup.sex $'ciu_lipids' <- as.numeric(as.character(prev.lipids.wbgroup.sex $'ciu_lipids'))
        
        lipids.wbgroup.sex <- prev.lipids.wbgroup.sex %>% 
          ggplot(aes(x=pov_group, y=all_lipids, fill=sex)) +
          geom_bar(stat = "identity", alpha=0.9, position = "dodge") +
                geom_errorbar(aes(ymin=cil_lipids, ymax=ciu_lipids), width=.2,
                         position=position_dodge(.9), show.legend = F) +
          labs(title = paste0("Dyslipidemia"),
               x = "",
               y = "%",
               fill="") + 
          theme(axis.text.y=element_text(size=20, colour = "black"),
                axis.text.x=element_text(size=20, angle = 60, hjust = 1, colour = "black"),
                axis.title=element_text(size=23, face="bold"),
                legend.text=element_text(size=20, family="Times", face="bold"),
                legend.title = element_blank(),
                #legend.position="none",
                axis.title.x = element_text(margin = margin(t = 20)),
                axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
                strip.text.x = element_text(size=28, face="bold"),
                strip.background = element_blank(),
                panel.spacing = unit(2, "lines"),
                title = element_text(size=20, face="bold", family="Times")) + 
          scale_fill_manual(values = c("#990000", "#FDBB84"), name = "Sex", labels=c("Male", "Female")) +
          scale_y_continuous(breaks = seq(from=0, to=70, by=20), limits=c(0, 70)) +
          scale_x_discrete(labels = c("Pov19" = "<$1.90/day", "Pov32" = "<$3.20/day", "Pov55" = "<$5.50/day", "Pov0" = ">$5.50/day", "total" = "Total")) + 
          facet_wrap(~income_group) +
          theme(strip.text.x = element_text(size = 15)) +
          coord_fixed(5/100)  
        
        lipids.wbgroup.sex
        ggsave("lipids.wbgroup.sex.png", height = 12, width = 12)
```


```{r FIGURES10 by region (extremely  poor only (<1.90USD))}

###HYPERTENSION
  prev.hypt <- read.csv("~/Prev.regions - Hypertension(1).csv", stringsAsFactors=F)
  prev.hypt <- prev.hypt %>% 
    select(Region, agegroup, prev, cil, ciu) %>%
    rename(region = Region)
  prev.hypt $'region' <- as.character(prev.hypt $'region')
  prev.hypt <- prev.hypt %>%
    filter(is.na(prev)==F)

#remove prevalences from samples <50
  prev.hypt<-prev.hypt[!(prev.hypt$region=='Europe and Central Asia' & prev.hypt$agegroup=='>=65'),]
  prev.hypt<-prev.hypt[!(prev.hypt$region=='Middle East and North Africa' & prev.hypt$agegroup=='>=65'),]
  prev.hypt<-prev.hypt[!(prev.hypt$region=='Middle East and North Africa' & prev.hypt$agegroup=='55-64'),]

#add overall prevalences for each age group
  prev.hypt[nrow(prev.hypt) + 1,] = c("All regions","15-24", "5.8", "5.4", "6.1") 
  prev.hypt[nrow(prev.hypt) + 1,] = c("All regions","25-34", "12.2", "11.6", "12.8")  
  prev.hypt[nrow(prev.hypt) + 1,] = c("All regions","35-44", "18.8", "18.1", "19.6") 
  prev.hypt[nrow(prev.hypt) + 1,] = c("All regions","45-54", "29.8", "28.5", "31.2")  
  prev.hypt[nrow(prev.hypt) + 1,] = c("All regions","55-64", "47.9", "45.0", "50.8")  
  prev.hypt[nrow(prev.hypt) + 1,] = c("All regions",">=65", "51.9", "46.8", "57.0") 
  
  prev.hypt $'prev' <- as.numeric(as.character(prev.hypt $'prev'))
  prev.hypt $'cil' <- as.numeric(as.character(prev.hypt $'cil'))
  prev.hypt $'ciu' <- as.numeric(as.character(prev.hypt $'ciu'))

  prev.hypt $'agegroup' <- as.factor(prev.hypt $'agegroup')
  prev.hypt$agegroup <- prev.hypt$agegroup %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  prev.hypt$region <- prev.hypt$region %>% factor(c("East Asia and Pacific", "Europe and Central Asia",  "Latin America and the Caribbean", "Middle East
                                                    and North Africa", "South Asia", "Sub-Saharan Africa", "All regions"))
   
  cols <- c("East Asia and Pacific" = "#FEE8C8", "Europe and Central Asia" = "#FDD49E", "Latin America and the Caribbean" = "#FDBB84", "Middle East and 
            North Africa" = "#EF6548", "South Asia" = "#D7301F", "Sub-Saharan Africa" = "#990000", "All regions" = "black")

#create figure  
  hypt.age.pooronly <- prev.hypt %>% 
    ggplot() +
    geom_col(aes(y=prev, x=region, fill=region), alpha=0.9) +
    geom_errorbar(aes(ymin=cil, ymax=ciu, x=region), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Hypertension"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) +  
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=80, by=20), limits=c(0, 80))  +
    scale_x_discrete(labels = c("Europe and Central Asia" = "Eur. & C.Asia", "Latin America and the Caribbean" = "Lat. Amer. & Caribb.", "Middle East 
                                and North Africa" = "M.East & N.Africa", "Sub-Saharan Africa" = "Sub-S.Africa", "East Asia and Pacific" = "E.Asia & 
                                Pacific", "South Asia" = "S. Asia", "All regions" = "All regions")) + 
    facet_wrap(~agegroup) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100) 
  hypt.age.pooronly
  ggsave("hypt.age.pooronly.png", height = 12, width = 12)
 
###DIABETES
   prev.dia <- read.csv("~/Prev.regions - Diabetes.csv", stringsAsFactors=F)
   prev.dia <- prev.dia %>% 
    select(Region, agegroup, prev, cil, ciu) %>%
    rename(region = Region)
   prev.dia $'region' <- as.character(prev.dia $'region')
   prev.dia <- prev.dia %>%
    filter(is.na(prev)==F)

#remove prevalence from samples <50
  prev.dia<-prev.dia[!(prev.dia$region=='Europe and Central Asia' & prev.dia$agegroup=='15-24'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Middle East and North Africa' & prev.dia$agegroup=='15-24'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Latin America and the Caribbean' & prev.dia$agegroup=='15-24'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Europe and Central Asia' & prev.dia$agegroup=='25-34'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Middle East and North Africa' & prev.dia$agegroup=='25-34'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Latin America and the Caribbean' & prev.dia$agegroup=='25-34'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Middle East and North Africa' & prev.dia$agegroup=='35-44'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Latin America and the Caribbean' & prev.dia$agegroup=='35-44'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Middle East and North Africa' & prev.dia$agegroup=='45-54'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Middle East and North Africa' & prev.dia$agegroup=='55-64'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Europe and Central Asia' & prev.dia$agegroup=='>=65'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Latin America and the Caribbean' & prev.dia$agegroup=='>=65'),]
  prev.dia<-prev.dia[!(prev.dia$region=='Middle East and North Africa' & prev.dia$agegroup=='>=65'),]

#add overall prevalences for each age group
  prev.dia[nrow(prev.dia) + 1,] = c("All regions","15-24", "2.1", "1.9", "2.3")   
  prev.dia[nrow(prev.dia) + 1,] = c("All regions","25-34", "2.7", "2.4", "3.0")    
  prev.dia[nrow(prev.dia) + 1,] = c("All regions","35-44", "3.6", "3.3", "4.0")  
  prev.dia[nrow(prev.dia) + 1,] = c("All regions","45-54", "5.5", "4.9", "6.2")   
  prev.dia[nrow(prev.dia) + 1,] = c("All regions","55-64", "5.5", "4.5", "6.8")   
  prev.dia[nrow(prev.dia) + 1,] = c("All regions",">=65", "8.8", "5.4", "14.1") 
  
  prev.dia $'prev' <- as.numeric(as.character(prev.dia $'prev'))
  prev.dia $'cil' <- as.numeric(as.character(prev.dia $'cil'))
  prev.dia $'ciu' <- as.numeric(as.character(prev.dia $'ciu'))


  prev.dia $'agegroup' <- as.factor(prev.dia $'agegroup')
  prev.dia$agegroup <- prev.dia$agegroup %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  prev.dia$region <- prev.dia$region %>% factor(c("East Asia and Pacific", "Europe and Central Asia",  "Latin America and the Caribbean", "Middle East 
                                                  and North Africa", "South Asia", "Sub-Saharan Africa", "All regions"))
   
  cols <- c("East Asia and Pacific" = "#FEE8C8", "Europe and Central Asia" = "#FDD49E", "Latin America and the Caribbean" = "#FDBB84", "Middle East and 
            North Africa" = "#EF6548", "South Asia" = "#D7301F", "Sub-Saharan Africa" = "#990000", "All regions" = "black")

#create figure    
  dia.age.pooronly <- prev.dia %>% 
    ggplot() +
    geom_col(aes(y=prev, x=region, fill=region), alpha=0.9) +
    geom_errorbar(aes(ymin=cil, ymax=ciu, x=region), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Diabetes"),
         x = "",
         y = "%",
         fill="") + 
   theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) +  
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=100, by=20), limits=c(0, 100))  +
    scale_x_discrete(labels = c("Europe and Central Asia" = "Eur. & C.Asia", "Latin America and the Caribbean" = "Lat. Amer. & Caribb.", "Middle East 
                                and North Africa" = "M.East & N.Africa", "Sub-Saharan Africa" = "Sub-S.Africa", "East Asia and Pacific" = "E.Asia & 
                                Pacific", "South Asia" = "S. Asia", "All regions" = "All regions")) + 
    facet_wrap(~agegroup) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100) 
  dia.age.pooronly
  ggsave("dia.age.pooronly.png", height = 12, width = 12)
 
###OBESITY 
  prev.obese <- read.csv("~/Prev.regions - Obesity.csv", stringsAsFactors=F)
  prev.obese <- prev.obese %>% 
    select(Region, agegroup, prev, cil, ciu) %>%
    rename(region = Region)
  prev.obese $'region' <- as.character(prev.obese $'region')
  prev.obese <- prev.obese %>%
    filter(is.na(prev)==F)

#remove prevalences from samples <50
  prev.obese<-prev.obese[!(prev.obese$region=='Europe and Central Asia' & prev.obese$agegroup=='>=65'),]
  prev.obese<-prev.obese[!(prev.obese$region=='Middle East and North Africa' & prev.obese$agegroup=='>=65'),]
  prev.obese<-prev.obese[!(prev.obese$region=='Middle East and North Africa' & prev.obese$agegroup=='55-64'),]
  
  prev.obese[nrow(prev.obese) + 1,] = c("All regions","15-24", "1.8", "1.6", "2.0")  
  prev.obese[nrow(prev.obese) + 1,] = c("All regions","25-34", "2.8", "2.6", "3.1")  
  prev.obese[nrow(prev.obese) + 1,] = c("All regions","35-44", "4.1", "3.7", "4.5") 
  prev.obese[nrow(prev.obese) + 1,] = c("All regions","45-54", "5.3", "4.7", "6.0")   
  prev.obese[nrow(prev.obese) + 1,] = c("All regions","55-64", "13.0", "9.3", "18.0")   
  prev.obese[nrow(prev.obese) + 1,] = c("All regions",">=65", "9.0", "5.6", "14.1")  
  
  prev.obese $'prev' <- as.numeric(as.character(prev.obese $'prev'))
  prev.obese $'cil' <- as.numeric(as.character(prev.obese $'cil'))
  prev.obese $'ciu' <- as.numeric(as.character(prev.obese $'ciu'))
  
  prev.obese $'agegroup' <- as.factor(prev.obese $'agegroup')
  prev.obese$agegroup <- prev.obese$agegroup %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  prev.obese$region <- prev.obese$region %>% factor(c("East Asia and Pacific", "Europe and Central Asia",  "Latin America and the Caribbean", "Middle 
                                                      East and North Africa", "South Asia", "Sub-Saharan Africa", "All regions"))
 
  cols <- c("East Asia and Pacific" = "#FEE8C8", "Europe and Central Asia" = "#FDD49E", "Latin America and the Caribbean" = "#FDBB84", "Middle East and 
            North Africa" = "#EF6548", "South Asia" = "#D7301F", "Sub-Saharan Africa" = "#990000", "All regions" = "black")

#create figure  
  obese.age.pooronly <- prev.obese %>% 
    ggplot() +
    geom_col(aes(y=prev, x=region, fill=region), alpha=0.9) +
    geom_errorbar(aes(ymin=cil, ymax=ciu, x=region), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Obesity"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) +  
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=100, by=20), limits=c(0, 100))  +
    scale_x_discrete(labels = c("Europe and Central Asia" = "Eur. & C.Asia", "Latin America and the Caribbean" = "Lat. Amer. & Caribb.", "Middle East 
                                and North Africa" = "M.East & N.Africa", "Sub-Saharan Africa" = "Sub-S.Africa", "East Asia and Pacific" = "E.Asia & 
                                Pacific", "South Asia" = "S. Asia", "All regions" = "All regions")) + 
    facet_wrap(~agegroup) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100) 
  obese.age.pooronly
  ggsave("obese.age.pooronly.png", height = 12, width = 12)

###SMOKING
   prev.smoke <- read.csv("~/Prev.regions - Smoking.csv", stringsAsFactors=F)
   prev.smoke <- prev.smoke %>% 
    select(Region, agegroup, prev, cil, ciu) %>%
    rename(region = Region)
   prev.smoke $'region' <- as.character(prev.smoke $'region')
   prev.smoke <- prev.smoke %>%
    filter(is.na(prev)==F)

#remove prevalences from samples <50
  prev.smoke<-prev.smoke[!(prev.smoke$region=='Europe and Central Asia' & prev.smoke$agegroup=='>=65'),]

#add total prevalences for each age group
  prev.smoke[nrow(prev.smoke) + 1,] = c("All regions","15-24", "4.6", "3.6", "6.0")   
  prev.smoke[nrow(prev.smoke) + 1,] = c("All regions","25-34", "13.5", "11.7", "15.5")  
  prev.smoke[nrow(prev.smoke) + 1,] = c("All regions","35-44", "16.9", "15.1", "18.8") 
  prev.smoke[nrow(prev.smoke) + 1,] = c("All regions","45-54", "19.4", "17.2", "21.8")   
  prev.smoke[nrow(prev.smoke) + 1,] = c("All regions","55-64", "21.4", "18.7", "24.3")  
  prev.smoke[nrow(prev.smoke) + 1,] = c("All regions",">=65", "19.6", "16.9", "22.7")  
  
  prev.smoke $'prev' <- as.numeric(as.character(prev.smoke $'prev'))
  prev.smoke $'cil' <- as.numeric(as.character(prev.smoke $'cil'))
  prev.smoke $'ciu' <- as.numeric(as.character(prev.smoke $'ciu'))
  
  prev.smoke $'agegroup' <- as.factor(prev.smoke $'agegroup')
  prev.smoke$agegroup <- prev.smoke$agegroup %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  prev.smoke$region <- prev.smoke$region %>% factor(c("East Asia and Pacific", "Europe and Central Asia",  "Latin America and the Caribbean", "Middle 
                                                      East and North Africa", "South Asia", "Sub-Saharan Africa", "All regions"))
   
  cols <- c("East Asia and Pacific" = "#FEE8C8", "Europe and Central Asia" = "#FDD49E", "Latin America and the Caribbean" = "#FDBB84", "Middle East and 
            North Africa" = "#EF6548", "South Asia" = "#D7301F", "Sub-Saharan Africa" = "#990000", "All regions" = "black")

#create figure    
  smoke.age.pooronly <- prev.smoke %>% 
    ggplot() +
    geom_col(aes(y=prev, x=region, fill=region), alpha=0.9) +
    geom_errorbar(aes(ymin=cil, ymax=ciu, x=region), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Smoking"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) +  
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=100, by=20), limits=c(0, 100))  +
    scale_x_discrete(labels = c("Europe and Central Asia" = "Eur. & C.Asia", "Latin America and the Caribbean" = "Lat. Amer. & Caribb.", "Middle East 
                                and North Africa" = "M.East & N.Africa", "Sub-Saharan Africa" = "Sub-S.Africa", "East Asia and Pacific" = "E.Asia & 
                                Pacific", "South Asia" = "S. Asia", "All regions" = "All regions")) + 
    facet_wrap(~agegroup) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100) 
    ggsave("smoke.age.pooronly.png", height = 12, width = 12)

###LIPIDS
  prev.lipid <- read.csv("~/Prev.regions - Lipids(1).csv", stringsAsFactors=F)
  prev.lipid <- prev.lipid %>% 
    select(Region, agegroup, prev, cil, ciu) %>%
    rename(region = Region)
  prev.lipid $'region' <- as.character(prev.lipid $'region')
  prev.lipid <- prev.lipid %>%
    filter(is.na(prev)==F)

#remove prevalences from samples <50
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Europe and Central Asia' & prev.lipid$agegroup=='>=65'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Middle East and North Africa' & prev.lipid$agegroup=='>=65'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Latin America and the Caribbean' & prev.lipid$agegroup=='>=65'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='South Asia' & prev.lipid$agegroup=='>=65'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Middle East and North Africa' & prev.lipid$agegroup=='55-64'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Europe and Central Asia' & prev.lipid$agegroup=='55-64'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Europe and Central Asia' & prev.lipid$agegroup=='45-54'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Middle East and North Africa' & prev.lipid$agegroup=='45-54'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Middle East and North Africa' & prev.lipid$agegroup=='35-44'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Latin America and the Caribbean' & prev.lipid$agegroup=='35-44'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Middle East and North Africa' & prev.lipid$agegroup=='25-34'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Latin America and the Caribbean' & prev.lipid$agegroup=='25-34'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Europe and Central Asia' & prev.lipid$agegroup=='25-34'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Europe and Central Asia' & prev.lipid$agegroup=='15-24'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Middle East and North Africa' & prev.lipid$agegroup=='15-24'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='Latin America and the Caribbean' & prev.lipid$agegroup=='15-24'),]
  prev.lipid<-prev.lipid[!(prev.lipid$region=='South Asia' & prev.lipid$agegroup=='15-24'),]

  prev.lipid[nrow(prev.lipid) + 1,] = c("All regions","15-24", "0.7", "0.4", "1.3")  
  prev.lipid[nrow(prev.lipid) + 1,] = c("All regions","25-34", "0.8", "0.4", "1.4")   
  prev.lipid[nrow(prev.lipid) + 1,] = c("All regions","35-44", "1.6", "0.9", "2.9")  
  prev.lipid[nrow(prev.lipid) + 1,] = c("All regions","45-54", "6.5", "3.3", "12.4")  
  prev.lipid[nrow(prev.lipid) + 1,] = c("All regions","55-64", "10.5", "6.0", "18.0")   
  prev.lipid[nrow(prev.lipid) + 1,] = c("All regions",">=65", "7.4", "3.4", "15.6")  
  
  prev.lipid $'prev' <- as.numeric(as.character(prev.lipid $'prev'))
  prev.lipid $'cil' <- as.numeric(as.character(prev.lipid $'cil'))
  prev.lipid $'ciu' <- as.numeric(as.character(prev.lipid $'ciu'))

  prev.lipid $'agegroup' <- as.factor(prev.lipid $'agegroup')
  prev.lipid$agegroup <- prev.lipid$agegroup %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  prev.lipid$region <- prev.lipid$region %>% factor(c("East Asia and Pacific", "Europe and Central Asia",  "Latin America and the Caribbean", "Middle 
                                                      East and North Africa", "South Asia", "Sub-Saharan Africa", "All regions"))
   
  cols <- c("East Asia and Pacific" = "#FEE8C8", "Europe and Central Asia" = "#FDD49E", "Latin America and the Caribbean" = "#FDBB84", "Middle East and 
            North Africa" = "#EF6548", "South Asia" = "#D7301F", "Sub-Saharan Africa" = "#990000", "All regions" = "black")

#create figure    
  lipids.age.pooronly <- prev.lipid %>% 
    ggplot() +
    geom_col(aes(y=prev, x=region, fill=region), alpha=0.9) +
    geom_errorbar(aes(ymin=cil, ymax=ciu, x=region), 
                  width=0.3, show.legend = F) +
    labs(title = paste0("Dyslipidemia"),
         x = "",
         y = "%",
         fill="") + 
    theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=23, face="bold"),
          legend.text=element_text(size=10, family="Times"),
          legend.title = element_blank(),
          legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=28, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=15, face="bold", family="Times")) +  
    scale_fill_manual(values = cols) +
    scale_y_continuous(breaks = seq(from=0, to=100, by=20), limits=c(0, 100))  +
    scale_x_discrete(labels = c("Europe and Central Asia" = "Eur. & C.Asia", "Latin America and the Caribbean" = "Lat. Amer. & Caribb.", "Middle East 
                                and North Africa" = "M.East & N.Africa", "Sub-Saharan Africa" = "Sub-S.Africa", "East Asia and Pacific" = "E.Asia & 
                                Pacific", "South Asia" = "S. Asia", "All regions" = "All regions")) + 
    facet_wrap(~agegroup) +
    theme(strip.text.x = element_text(size = 15)) +
    coord_fixed(5/100) 

  ggsave("lipids.age.pooronly.png", height = 12, width = 12)

```


```{r FIGURE: Cascades for hypertension and diabetes}

#plot proportion of extreme poor with hypertension who take meds
  bb_allpovgroups_hypt <- read.csv("~/bb_allpovgroupsnew_hypt.csv", stringsAsFactors=F)
  bb_allpovgroups_dia <- read.csv("~/bb_allpovgroupsnew_dia.csv", stringsAsFactors=F)
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt[,-1]
  bb_allpovgroups_dia <- bb_allpovgroups_dia[,-1]
  
#create age groupss
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))
  
  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% mutate(
    agegroups = ifelse(age>=15 & age<=24, '15-24',
                ifelse(age>=25 & age<=34, '25-34',
                       ifelse(age>=35 & age<=44, '35-44',
                              ifelse(age>=45 & age<=54, '45-54',
                                     ifelse(age>=55 & age<=64, '55-64',
                                            ifelse(age>=65, '>=65', NA
  )))))))

#prepare survey design for each risk factor 
  bb_allpovgroups_hypt$stratum <- as.factor(bb_allpovgroups_hypt$stratum)
  bb_allpovgroups_hypt$country <- as.factor(bb_allpovgroups_hypt$country)
  bb_allpovgroups_hypt$region <- as.factor(bb_allpovgroups_hypt$region)
  bb_allpovgroups_hypt$psu <- as.factor(bb_allpovgroups_hypt$psu)
  bb_allpovgroups_hypt$hh_id <- as.factor(bb_allpovgroups_hypt$hh_id)
  
  bb_allpovgroups_dia$stratum <- as.factor(bb_allpovgroups_dia$stratum)
  bb_allpovgroups_dia$country <- as.factor(bb_allpovgroups_dia$country)
  bb_allpovgroups_dia$region <- as.factor(bb_allpovgroups_dia$region)
  bb_allpovgroups_dia$psu <- as.factor(bb_allpovgroups_dia$psu)
  bb_allpovgroups_dia$hh_id <- as.factor(bb_allpovgroups_dia$hh_id)
  
#add regions and income group
  CLASS <- read_excel("~/CLASS.xlsx") #see above for more info on where to derive income groups
  CLASS <- CLASS %>% 
    rename(country = 'Economy',
            region = 'Region',
            income_group = 'Income group') %>% 
    select(country, income_group)
  
  bb_allpovgroups_hypt <- bb_allpovgroups_hypt %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                            ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income", income_group))))))))) 

  bb_allpovgroups_dia <- bb_allpovgroups_dia %>% 
    left_join(CLASS) %>% 
    mutate(income_group = ifelse(country=='Egypt', "Lower middle income",
                            ifelse(country=='Gambia', "Low income",
                                   ifelse(country=='Iran', "Lower middle income",
                                          ifelse(country=='Laos', "Lower middle income",
                                                 ifelse(country=='Sao Tome and Principe', "Lower middle income",
                                                        ifelse(country=='Swaziland', "Lower middle income",
                                                               ifelse(country=='Timor Leste', "Lower middle income",
                                                                      ifelse(country=='Zanzibar', "Lower middle income", income_group))))))))) 

  
#create subset for cascades
  hypt_cascades_subset <- select(bb_allpovgroups_hypt, country, year, svy, sex, age, agegroups, income_group, all_hypt, hypt_treat, hypt_ctrl, 
                                 w_hypt_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  dia_cascades_subset <- select(bb_allpovgroups_dia, country, sex, year, svy, age, agegroups,income_group, dia_treat, dia_ctrl, w_dia_poor19_age, psu, 
                                stratum, hh_id, poor19, poor32, poor55, csmoke, sbp_ave, all_dia, tchol_mmoll, subregion, mi, statin)

#define surveys for countries which have multiple surveys
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Myanmar' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Timor Leste' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Kyrgyz Republic' & hypt_cascades_subset$year=='2013'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Tajikistan' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Albania' & hypt_cascades_subset$year=='2017-2018'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Egypt' & hypt_cascades_subset$year=='2014'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='India' & hypt_cascades_subset$year=='2017'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Ghana' & hypt_cascades_subset$year=='2014'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Kenya' & hypt_cascades_subset$year=='2014'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Niger' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Rwanda' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Tanzania' & hypt_cascades_subset$year=='2015-2016'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Togo' & hypt_cascades_subset$year=='2013-2014'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Mozambique' & hypt_cascades_subset$year=='2011'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Comoros' & hypt_cascades_subset$year=='2012'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Guinea' & hypt_cascades_subset$year=='2012'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Gambia' & hypt_cascades_subset$year=='2013'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Malawi' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Uganda' & hypt_cascades_subset$svy=='DHS'),]
    hypt_cascades_subset<-hypt_cascades_subset[!(hypt_cascades_subset$country=='Zambia' & hypt_cascades_subset$svy=='DHS'),]

    hypt_cascades_subset <- filter(hypt_cascades_subset, age<=95)
      
###DIABETES

#define surveys for countries which have multiple surveys
     dia_cascades_subset<- dia_cascades_subset[!(dia_cascades_subset$country=='Myanmar' & dia_cascades_subset$svy=='DHS'),] 
     dia_cascades_subset<- dia_cascades_subset[!(dia_cascades_subset$country=='Kyrgyz Republic' & dia_cascades_subset$svy=='DHS'),] 
     dia_cascades_subset<- dia_cascades_subset[!(dia_cascades_subset$country=='Tajikistan' & dia_cascades_subset$svy=='DHS'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Timor Leste' &  dia_cascades_subset$svy=='DHS'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='India' &  dia_cascades_subset$year=='2017'),]
     dia_cascades_subset<- dia_cascades_subset[!(dia_cascades_subset$country=='Comoros' & dia_cascades_subset$year=='2012'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Mozambique' &  dia_cascades_subset$year=='2011'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Niger' &  dia_cascades_subset$year=='2012'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Rwanda' &  dia_cascades_subset$svy=='DHS'),]
     dia_cascades_subset<- dia_cascades_subset[!(dia_cascades_subset$country=='Kenya' &  dia_cascades_subset$year=='2014'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Tanzania' &  dia_cascades_subset$year=='2015-2016'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Togo' &  dia_cascades_subset$year=='2013-2014'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Malawi' &  dia_cascades_subset$svy=='DHS'),]
     dia_cascades_subset<- dia_cascades_subset[!( dia_cascades_subset$country=='Uganda' &  dia_cascades_subset$svy=='DHS'),]

###HYPERTESTION TREATMENT
    hypt_meds <- select(hypt_cascades_subset, country, sex, income_group, age, agegroups, all_hypt, hypt_treat, w_hypt_poor19_age, psu, stratum, hh_id, 
                        poor19, poor32, poor55)
    hypt_meds <- filter(hypt_meds, is.na(all_hypt)==F)
    hypt_meds <- filter(hypt_meds, all_hypt==1)
    hypt_meds <- filter(hypt_meds, is.na(hypt_treat)==F)
    hypt_meds <- filter(hypt_meds, is.na(w_hypt_poor19_age)==F)
    hypt_meds <- filter(hypt_meds, is.na(poor19)==F)
    hypt_meds <- hypt_meds %>% 
      mutate(psu = ifelse(is.na(psu==T), 1, psu),
            age = as.integer(age),
            hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
            stratum = ifelse(is.na(stratum==T), 1, stratum))
    
    table(hypt_meds$poor19, hypt_meds$hypt_treat, hypt_meds$agegroups)
    table(hypt_meds$poor32, hypt_meds$hypt_treat, hypt_meds$agegroups)
    table(hypt_meds$poor55, hypt_meds$hypt_treat, hypt_meds$agegroups)

#for each poverty group
  risk.hypt.pov19.cascades <- hypt_meds %>% filter(poor19==1)
  risk.hypt.pov19.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19.cascades, nest = T)
  
  risk.hypt.pov32.cascades <- hypt_meds %>% filter(poor32==1)
  risk.hypt.pov32.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32.cascades, nest = T)
  
  risk.hypt.pov55.cascades <- hypt_meds %>% filter(poor55==1)
  risk.hypt.pov55.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55.cascades, nest = T)
  
  risk.hypt.pov0.cascades <- hypt_meds %>% filter(poor55==0)
  risk.hypt.pov0.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0.cascades, nest = T)
  
  risk.hypt.all_povgroups.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_meds, nest = T)

#to get the total for all age groupss
  prev.hypt.pov19.cascades <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov19.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype
                                    = "ci")
  prev.hypt.pov19.cascades <- unite_ci(prev.hypt.pov19.cascades, "Prev_poor19", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.cascades <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov32.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype
                                    = "ci")
  prev.hypt.pov32.cascades <- unite_ci(prev.hypt.pov32.cascades, "Prev_poor32", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.cascades <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov55.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype
                                    = "ci")
  prev.hypt.pov55.cascades <- unite_ci(prev.hypt.pov55.cascades, "Prev_poor55", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.cascades <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov0.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype =
                                     "ci")
  prev.hypt.pov0.cascades <- unite_ci(prev.hypt.pov0.cascades, "Prev_poor0", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.cascades <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.all_povgroups.cascades, svyciprop, proportion=TRUE, 
                                     prop_method="asin", vartype = "ci")
  prev.hypt.allpov.cascades <- unite_ci(prev.hypt.allpov.cascades, "Prev_allpov", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.hypt.agegroups.cascades <- prev.hypt.pov19.cascades %>% 
    left_join(prev.hypt.pov32.cascades) %>% 
    left_join(prev.hypt.pov55.cascades) %>% 
    left_join(prev.hypt.pov0.cascades)
  
#bring into right format     
    prev.hypt.agegroups.cascades <- prev.hypt.agegroups.cascades %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.hypt.agegroups.cascades$prevalence <- gsub('--', '-', prev.hypt.agegroups.cascades$prevalence)  
    prev.hypt.agegroups.cascades <- tidyr::separate(prev.hypt.agegroups.cascades, prevalence, c("hypt_treat", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.agegroups.cascades$V2  <- gsub("[()]", "", prev.hypt.agegroups.cascades$V2 )
    prev.hypt.agegroups.cascades <- tidyr::separate(prev.hypt.agegroups.cascades, V2, c("cil_hypt", "ciu_hypt"), "\\-") 
    prev.hypt.agegroups.cascades <- prev.hypt.agegroups.cascades %>% 
      mutate(hypt_treat = as.numeric(hypt_treat),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_treat = str_c(as.character(hypt_treat), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_treat)  %>% pivot_wider(names_from = pov_group, values_from = hypt_treat)
  
    write.csv(prev.hypt.agegroups.cascades, "~/prev.hypt.agegroups.cascades.csv")
    
#bring into right format 
    prev.hypt.allpov.cascades <- prev.hypt.allpov.cascades %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.hypt.allpov.cascades$prevalence <- gsub('--', '-', prev.hypt.allpov.cascades$prevalence)  
    prev.hypt.allpov.cascades <- tidyr::separate(prev.hypt.allpov.cascades, prevalence, c("hypt_treat", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.allpov.cascades$V2  <- gsub("[()]", "", prev.hypt.allpov.cascades$V2 )
    prev.hypt.allpov.cascades <- tidyr::separate(prev.hypt.allpov.cascades, V2, c("cil_hypt", "ciu_hypt"), "\\-")
    prev.hypt.allpov.cascades <- prev.hypt.allpov.cascades %>% 
      mutate(hypt_treat = as.numeric(hypt_treat),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_treat = str_c(as.character(hypt_treat), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_treat) %>% pivot_wider(names_from = pov_group, values_from = hypt_treat)
        
    write.csv(prev.hypt.allpov.cascades, "~/prev.hypt.allpov.cascades.csv")
  
#to get total for each risk factor
  svymean(~hypt_treat, risk.hypt.pov19.cascades, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov19.cascades, level = 0.95))  
  
  svymean(~hypt_treat, risk.hypt.pov32.cascades, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov32.cascades, level = 0.95))
  
  svymean(~hypt_treat, risk.hypt.pov55.cascades, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov55.cascades, level = 0.95)) 
  
  svymean(~hypt_treat, risk.hypt.pov0.cascades, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov0.cascades, level = 0.95)) 
  
  svymean(~hypt_treat, risk.hypt.all_povgroups.cascades, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.all_povgroups.cascades, level = 0.95)) 
  
###check if difference between poor and non-poor is significant: get p-values
#agegroups
  hypt_meds <- hypt_meds %>% mutate(
  poor0 = ifelse(poor55==0, 1, 0))
  
  age1 <- filter(hypt_meds, agegroups=='15-24')
  hypt.meds.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age1, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age1) #p-value = 0.5392
  svychisq(~hypt_treat + poor32, hypt.meds.age1) #0.2141
  svychisq(~hypt_treat + poor55, hypt.meds.age1) #0.07604
  svychisq(~hypt_treat + poor0, hypt.meds.age1)#0.07604
  
  age2 <- filter(hypt_meds, agegroups=='25-34')
  hypt.meds.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age2, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age2) #3.66e-14
  svychisq(~hypt_treat + poor32, hypt.meds.age2) #0.0002775
  svychisq(~hypt_treat + poor55, hypt.meds.age2) #0.1986
  svychisq(~hypt_treat + poor0, hypt.meds.age2)#0.1986
  
  age3 <- filter(hypt_meds, agegroups=='35-44')
  hypt.meds.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age3, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age3) #6.154e-05
  svychisq(~hypt_treat + poor32, hypt.meds.age3) #1.172e-05
  svychisq(~hypt_treat + poor55, hypt.meds.age3) #0.001957
  svychisq(~hypt_treat + poor0, hypt.meds.age3)#0.001957
  
  age4 <- filter(hypt_meds, agegroups=='45-54')
  hypt.meds.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age4, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age4) #4.016e-07
  svychisq(~hypt_treat + poor32, hypt.meds.age4) #1.047e-10
  svychisq(~hypt_treat + poor55, hypt.meds.age4) #7.922e-09
  svychisq(~hypt_treat + poor0, hypt.meds.age4)#7.922e-09

  age5 <- filter(hypt_meds, agegroups=='55-64')
  hypt.meds.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age5, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age5) #3.652e-05
  svychisq(~hypt_treat + poor32, hypt.meds.age5) #2.13e-06
  svychisq(~hypt_treat + poor55, hypt.meds.age5) #1.521e-12
  svychisq(~hypt_treat + poor0, hypt.meds.age5)#1.521e-12
  
  age6 <- filter(hypt_meds, agegroups=='>=65')
  hypt.meds.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age6, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age6) #0.0001496
  svychisq(~hypt_treat + poor32, hypt.meds.age6) #2.988e-05
  svychisq(~hypt_treat + poor55, hypt.meds.age6) #6.496e-06
  svychisq(~hypt_treat + poor0, hypt.meds.age6)#6.496e-06

###CASCADE 2) HYPERTENSIVES WHO ACHIEVED CONTROL 

#get prevalence
  hypt_control <- select(hypt_cascades_subset, income_group, country, sex, age, agegroups, all_hypt, hypt_ctrl, w_hypt_poor19_age, psu, stratum, hh_id, 
                         poor19, poor32, poor55)
  hypt_control <- filter(hypt_control, is.na(all_hypt)==F)
  hypt_control <- filter(hypt_control, all_hypt==1)
  hypt_control <- filter(hypt_control, is.na(hypt_ctrl)==F)
  hypt_control <- filter(hypt_control, is.na(w_hypt_poor19_age)==F)
  hypt_control <- filter(hypt_control, is.na(poor19)==F)
  hypt_control <- hypt_control %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  
  table(hypt_control$poor19, hypt_control$hypt_ctrl, hypt_control$agegroups)
  table(hypt_control$poor32, hypt_control$hypt_ctrl, hypt_control$agegroups)
  table(hypt_control$poor55, hypt_control$hypt_ctrl, hypt_control$agegroups)

#for each poverty group
  risk.hypt.pov19.cascades.ctrl <- hypt_control %>% filter(poor19==1)
  risk.hypt.pov19.cascades.ctrl <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19.cascades.ctrl, nest = T)
  
  risk.hypt.pov32.cascades.ctrl <- hypt_control %>% filter(poor32==1)
  risk.hypt.pov32.cascades.ctrl <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32.cascades.ctrl, nest = T)
  
  risk.hypt.pov55.cascades.ctrl <- hypt_control %>% filter(poor55==1)
  risk.hypt.pov55.cascades.ctrl <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55.cascades.ctrl, nest = T)
  
  risk.hypt.pov0.cascades.ctrl <- hypt_control %>% filter(poor55==0)
  risk.hypt.pov0.cascades.ctrl <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0.cascades.ctrl, nest = T)
  
  risk.hypt.all_povgroups.cascades.ctrl <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_control, nest = T)

#to get the total for all age groupss
  prev.hypt.pov19.cascades.ctrl <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov19.cascades.ctrl, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.hypt.pov19.cascades.ctrl <- unite_ci(prev.hypt.pov19.cascades.ctrl, "Prev_poor19", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.cascades.ctrl <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov32.cascades.ctrl, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.hypt.pov32.cascades.ctrl <- unite_ci(prev.hypt.pov32.cascades.ctrl, "Prev_poor32", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.cascades.ctrl <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov55.cascades.ctrl, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.hypt.pov55.cascades.ctrl <- unite_ci(prev.hypt.pov55.cascades.ctrl, "Prev_poor55", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.cascades.ctrl <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov0.cascades.ctrl, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.hypt.pov0.cascades.ctrl <- unite_ci(prev.hypt.pov0.cascades.ctrl, "Prev_poor0", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.cascades.ctrl <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.all_povgroups.cascades.ctrl, svyciprop, proportion=TRUE, 
                                          prop_method="asin", vartype = "ci")
  prev.hypt.allpov.cascades.ctrl <- unite_ci(prev.hypt.allpov.cascades.ctrl, "Prev_allpov", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalence by agegroups
  prev.hypt.agegroups.cascades.ctrl <- prev.hypt.pov19.cascades.ctrl %>% 
    left_join(prev.hypt.pov32.cascades.ctrl) %>% 
    left_join(prev.hypt.pov55.cascades.ctrl) %>% 
    left_join(prev.hypt.pov0.cascades.ctrl)

#bring into right format     
    prev.hypt.agegroups.cascades.ctrl <- prev.hypt.agegroups.cascades.ctrl %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                              "prevalence")
    prev.hypt.agegroups.cascades.ctrl$prevalence <- gsub('--', '-', prev.hypt.agegroups.cascades.ctrl$prevalence)  
    prev.hypt.agegroups.cascades.ctrl <- tidyr::separate(prev.hypt.agegroups.cascades.ctrl, prevalence, c("hypt_ctrl", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.agegroups.cascades.ctrl$V2  <- gsub("[()]", "", prev.hypt.agegroups.cascades.ctrl$V2 )
    prev.hypt.agegroups.cascades.ctrl <- tidyr::separate(prev.hypt.agegroups.cascades.ctrl, V2, c("cil_hypt", "ciu_hypt"), "\\-") 
    prev.hypt.agegroups.cascades.ctrl <- prev.hypt.agegroups.cascades.ctrl %>% 
      mutate(hypt_ctrl = as.numeric(hypt_ctrl),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt_ctrl = str_c(as.character(hypt_ctrl), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_ctrl)  %>% pivot_wider(names_from = pov_group, values_from = hypt_ctrl)
  
    write.csv(prev.hypt.agegroups.cascades.ctrl, "~/prev.hypt.agegroups.cascades.ctrl.csv")
    
#bring into right format 
    prev.hypt.allpov.cascades.ctrl <- prev.hypt.allpov.cascades.ctrl %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.hypt.allpov.cascades.ctrl$prevalence <- gsub('--', '-', prev.hypt.allpov.cascades.ctrl$prevalence)  
    prev.hypt.allpov.cascades.ctrl <- tidyr::separate(prev.hypt.allpov.cascades.ctrl, prevalence, c("hypt_ctrl", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.allpov.cascades.ctrl$V2  <- gsub("[()]", "", prev.hypt.allpov.cascades.ctrl$V2 )
    prev.hypt.allpov.cascades.ctrl <- tidyr::separate(prev.hypt.allpov.cascades.ctrl, V2, c("cil_hypt", "ciu_hypt"), "\\-")
    prev.hypt.allpov.cascades.ctrl <- prev.hypt.allpov.cascades.ctrl %>% 
      mutate(hypt_ctrl = as.numeric(hypt_ctrl),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_ctrl = str_c(as.character(hypt_ctrl), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_ctrl) %>% pivot_wider(names_from = pov_group, values_from = hypt_ctrl)
        
    write.csv(prev.hypt.allpov.cascades.ctrl, "~/prev.hypt.allpov.cascades.ctrl.csv")
  
#to get total for each risk factor
  svymean(~hypt_ctrl, risk.hypt.pov19.cascades.ctrl, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov19.cascades.ctrl, level = 0.95))  
  
  svymean(~hypt_ctrl, risk.hypt.pov32.cascades.ctrl, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov32.cascades.ctrl, level = 0.95))
  
  svymean(~hypt_ctrl, risk.hypt.pov55.cascades.ctrl, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov55.cascades.ctrl, level = 0.95)) 
  
  svymean(~hypt_ctrl, risk.hypt.pov0.cascades.ctrl, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov0.cascades.ctrl, level = 0.95)) 
  
  svymean(~hypt_ctrl, risk.hypt.all_povgroups.cascades.ctrl, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.all_povgroups.cascades.ctrl, level = 0.95)) 

#get p-values
  hypt_control <- hypt_control %>% mutate(
    poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(hypt_control, agegroups=='15-24')
  hypt.control.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age1, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age1) #0.5493
  svychisq(~hypt_ctrl + poor32, hypt.control.age1) #0.03089
  svychisq(~hypt_ctrl + poor55, hypt.control.age1) #0.01307
  svychisq(~hypt_ctrl + poor0, hypt.control.age1)#0.01307
  
  age2 <- filter(hypt_control, agegroups=='25-34')
  hypt.control.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age2, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age2) #1.434e-09
  svychisq(~hypt_ctrl + poor32, hypt.control.age2) #0.1428
  svychisq(~hypt_ctrl + poor55, hypt.control.age2) #0.3057
  svychisq(~hypt_ctrl + poor0, hypt.control.age2) #0.3057
  
  age3 <- filter(hypt_control, agegroups=='35-44')
  hypt.control.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age3, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age3) # 0.002816
  svychisq(~hypt_ctrl + poor32, hypt.control.age3) #4.519e-06
  svychisq(~hypt_ctrl + poor55, hypt.control.age3) #0.008339
  svychisq(~hypt_ctrl + poor0, hypt.control.age3)#0.008339
  
  age4 <- filter(hypt_control, agegroups=='45-54')
  hypt.control.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age4, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age4) #0.102
  svychisq(~hypt_ctrl + poor32, hypt.control.age4) #0.00318
  svychisq(~hypt_ctrl + poor55, hypt.control.age4) #2.445e-05
  svychisq(~hypt_ctrl + poor0, hypt.control.age4)#2.445e-05
  
  age5 <- filter(hypt_control, agegroups=='55-64')
  hypt.control.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age5, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age5) #0.001242
  svychisq(~hypt_ctrl + poor32, hypt.control.age5) #0.0001445
  svychisq(~hypt_ctrl + poor55, hypt.control.age5) #1.42e-07
  svychisq(~hypt_ctrl + poor0, hypt.control.age5)#1.42e-07
  
  age6 <- filter(hypt_control, agegroups=='>=65')
  hypt.control.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age6, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age6) #0.009072
  svychisq(~hypt_ctrl + poor32, hypt.control.age6) #0.002671
  svychisq(~hypt_ctrl + poor55, hypt.control.age6) # 0.0003019
  svychisq(~hypt_ctrl + poor0, hypt.control.age6)# 0.0003019

###CASCADE 3: DIABETES MEDS 
#plot proportion with diabetes who takes medication
  dia_meds <- select(dia_cascades_subset, country, sex, age, agegroups, all_dia, dia_treat, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, 
                     poor55)
  dia_meds <- filter(dia_meds, is.na(all_dia)==F)
  dia_meds <- filter(dia_meds, all_dia==1)
  dia_meds <- filter(dia_meds, is.na(dia_treat)==F)
  dia_meds <- filter(dia_meds, is.na(w_dia_poor19_age)==F)
  dia_meds <- filter(dia_meds, is.na(poor19)==F)
  dia_meds <- dia_meds %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  
  table(dia_meds$poor19, dia_meds$dia_treat, dia_meds$agegroups)
  table(dia_meds$poor32, dia_meds$dia_treat, dia_meds$agegroups)
  table(dia_meds$poor55, dia_meds$dia_treat, dia_meds$agegroups)

#no further exclusions except for those aged 95 and older
  dia_meds <- filter(dia_meds, age<=95)

#for each poverty group
  risk.dia.pov19.cascades <- dia_meds %>% filter(poor19==1)
  risk.dia.pov19.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov19.cascades, nest = T)
  
  risk.dia.pov32.cascades <- dia_meds %>% filter(poor32==1)
  risk.dia.pov32.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov32.cascades, nest = T)
  
  risk.dia.pov55.cascades <- dia_meds %>% filter(poor55==1)
  risk.dia.pov55.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov55.cascades, nest = T)
  
  risk.dia.pov0.cascades <- dia_meds %>% filter(poor55==0)
  risk.dia.pov0.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov0.cascades, nest = T)
  
  risk.dia.all_povgroups.cascades <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia_meds, nest = T)

#to get the total for all age groupss
  prev.dia.pov19.cascades <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov19.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  prev.dia.pov19.cascades <- unite_ci(prev.dia.pov19.cascades, "Prev_poor19", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.cascades <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov32.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  prev.dia.pov32.cascades <- unite_ci(prev.dia.pov32.cascades, "Prev_poor32", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.cascades <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov55.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  prev.dia.pov55.cascades <- unite_ci(prev.dia.pov55.cascades, "Prev_poor55", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.cascades <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov0.cascades, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                    "ci")
  prev.dia.pov0.cascades <- unite_ci(prev.dia.pov0.cascades, "Prev_poor0", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.cascades <- svyby(~dia_treat, by=~agegroups, design=risk.dia.all_povgroups.cascades, svyciprop, proportion=TRUE, prop_method="asin", 
                                    vartype = "ci")
  prev.dia.allpov.cascades <- unite_ci(prev.dia.allpov.cascades, "Prev_allpov", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.dia.agegroups.cascades <- prev.dia.pov19.cascades %>% 
    left_join(prev.dia.pov32.cascades) %>% 
    left_join(prev.dia.pov55.cascades) %>% 
    left_join(prev.dia.pov0.cascades)
  
#bring into right format  
    prev.dia.agegroups.cascades <- prev.dia.agegroups.cascades %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.dia.agegroups.cascades$prevalence <- gsub('--', '-', prev.dia.agegroups.cascades$prevalence)  
    prev.dia.agegroups.cascades <- tidyr::separate(prev.dia.agegroups.cascades, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
    prev.dia.agegroups.cascades$V2  <- gsub("[()]", "", prev.dia.agegroups.cascades$V2 )
    prev.dia.agegroups.cascades <- tidyr::separate(prev.dia.agegroups.cascades, V2, c("cil_dia", "ciu_dia"), "\\-") 
    prev.dia.agegroups.cascades <- prev.dia.agegroups.cascades %>% 
      mutate(dia_treat = as.numeric(dia_treat),
            cil_dia = as.numeric(cil_dia),
            ciu_dia = as.numeric(ciu_dia))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
      select(agegroups, pov_group, dia_treat)  %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
  
    write.csv(prev.dia.agegroups.cascades, "~/prev.dia.agegroups.cascades.csv")
    
#bring into right format 
    prev.dia.allpov.cascades <- prev.dia.allpov.cascades %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.dia.allpov.cascades$prevalence <- gsub('--', '-', prev.dia.allpov.cascades$prevalence)  
    prev.dia.allpov.cascades <- tidyr::separate(prev.dia.allpov.cascades, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
    prev.dia.allpov.cascades$V2  <- gsub("[()]", "", prev.dia.allpov.cascades$V2 )
    prev.dia.allpov.cascades <- tidyr::separate(prev.dia.allpov.cascades, V2, c("cil_dia", "ciu_dia"), "\\-")
    prev.dia.allpov.cascades <- prev.dia.allpov.cascades %>% 
      mutate(dia_treat = as.numeric(dia_treat),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
      select(agegroups, pov_group, dia_treat) %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
        
    write.csv(prev.dia.allpov.cascades, "~/prev.dia.allpov.cascades.csv")
  
#to get total for each poverty group
  svymean(~dia_treat, risk.dia.pov19.cascades, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov19.cascades, level = 0.95))  
  
  svymean(~dia_treat, risk.dia.pov32.cascades, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov32.cascades, level = 0.95))
  
  svymean(~dia_treat, risk.dia.pov55.cascades, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov55.cascades, level = 0.95)) 
  
  svymean(~dia_treat, risk.dia.pov0.cascades, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov0.cascades, level = 0.95)) 
  
  svymean(~dia_treat, risk.dia.all_povgroups.cascades, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.all_povgroups.cascades, level = 0.95)) 

#get p-values
  dia_meds <- dia_meds %>% mutate(
    poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(dia_meds, agegroups=='15-24')
  dia.treat.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age1, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age1) #0.635
  svychisq(~dia_treat + poor32, dia.treat.age1) #0.6615
  svychisq(~dia_treat + poor55, dia.treat.age1) #0.005627
  svychisq(~dia_treat + poor0, dia.treat.age1) #0.005627
  
  
  age2 <- filter(dia_meds, agegroups=='25-34')
  dia.treat.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age2, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age2) #0.04367
  svychisq(~dia_treat + poor32, dia.treat.age2) #0.1645
  svychisq(~dia_treat + poor55, dia.treat.age2) #0.5544
  svychisq(~dia_treat + poor0, dia.treat.age2) #0.5544
  
  age3 <- filter(dia_meds, agegroups=='35-44')
  dia.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age3) #0.003646
  svychisq(~dia_treat + poor32, dia.treat.age3) #0.01198
  svychisq(~dia_treat + poor55, dia.treat.age3) #3.105e-05
  svychisq(~dia_treat + poor0, dia.treat.age3) #3.105e-05
  
  age4 <- filter(dia_meds, agegroups=='45-54')
  dia.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age4) #0.03367
  svychisq(~dia_treat + poor32, dia.treat.age4) #6.042e-07
  svychisq(~dia_treat + poor55, dia.treat.age4) #6.662e-05
  svychisq(~dia_treat + poor0, dia.treat.age4) #.662e-05
  
  age5 <- filter(dia_meds, agegroups=='55-64')
  dia.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age5) #3.279e-06
  svychisq(~dia_treat + poor32, dia.treat.age5) #1.833e-09
  svychisq(~dia_treat + poor55, dia.treat.age5) #< 2.2e-16
  svychisq(~dia_treat + poor0, dia.treat.age5) # < 2.2e-16
  
  age6 <- filter(dia_meds, agegroups=='>=65')
  dia.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age6) #7.509e-07
  svychisq(~dia_treat + poor32, dia.treat.age6) #1.232e-07
  svychisq(~dia_treat + poor55, dia.treat.age6) #1.674e-11
  svychisq(~dia_treat + poor0, dia.treat.age6) #1.674e-11

###STATIN TREATMENT 
#use weights for diabetes and restrict to non-pregnant, use the WHO risk package. This package requires that countries are allocated to subregions
     
#remove unrealistic values for smoking, age, BP and cholesterol   
  cvd_risk_sample <- select(dia_cascades_subset, country, psu, age, sex, stratum, hh_id, csmoke, sbp_ave, all_dia, tchol_mmoll, subregion, mi, statin, 
                            w_dia_poor19_age, poor19, poor32, poor55)
  
  cvd_risk_sample <- cvd_risk_sample %>% mutate(
           age = ifelse(age<19 | age>100, NA, age),
           csmoke = ifelse(csmoke>1, NA, csmoke),
           sbp_ave = ifelse(sbp_ave<90 | sbp_ave>250 , NA, sbp_ave),
           tchol_mmoll = ifelse(tchol_mmoll>10, NA, tchol_mmoll)) %>% drop_na()
  
#AMR_B
    cvd_risk_amr_b_sample <- cvd_risk_sample %>% filter(subregion=='"AMR_B"')
    cvd_risk_amr_b <- WHO_ISH_Risk(cvd_risk_amr_b_sample$age, cvd_risk_amr_b_sample$sex, cvd_risk_amr_b_sample$csmoke, cvd_risk_amr_b_sample$sbp_ave, 
                                   cvd_risk_amr_b_sample$all_dia, cvd_risk_amr_b_sample$tchol_mmoll, "AMR_B")
    cvd_risk_amr_b_sample <- bind_cols(cvd_risk_amr_b_sample, cvd_risk_amr_b)
    cvd_risk_amr_b_sample <- cvd_risk_amr_b_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#AFR_D 
    cvd_risk_afr_d_sample <- cvd_risk_sample %>% filter(subregion=='"AFR_D"')
    cvd_risk_afr_d <- WHO_ISH_Risk(cvd_risk_afr_d_sample$age, cvd_risk_afr_d_sample$sex, cvd_risk_afr_d_sample$csmoke, cvd_risk_afr_d_sample$sbp_ave, 
                                   cvd_risk_afr_d_sample$all_dia, cvd_risk_afr_d_sample$tchol_mmoll, "AFR_D")
    cvd_risk_afr_d_sample <- bind_cols(cvd_risk_afr_d_sample, cvd_risk_afr_d)  
    cvd_risk_afr_d_sample <- cvd_risk_afr_d_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#AFR_E
    cvd_risk_afr_e_sample <- cvd_risk_sample %>% filter(subregion=='"AFR_E"')
    cvd_risk_afr_e <- WHO_ISH_Risk(cvd_risk_afr_e_sample$age, cvd_risk_afr_e_sample$sex, cvd_risk_afr_e_sample$csmoke, cvd_risk_afr_e_sample$sbp_ave, 
                                   cvd_risk_afr_e_sample$all_dia, cvd_risk_afr_e_sample$tchol_mmoll, "AFR_E")
    cvd_risk_afr_e_sample <- bind_cols(cvd_risk_afr_e_sample, cvd_risk_afr_e) 
    cvd_risk_afr_e_sample <- cvd_risk_afr_e_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#AMR_D
    cvd_risk_amr_d_sample <- cvd_risk_sample %>% filter(subregion=='"AMR_D"')
    cvd_risk_amr_d <- WHO_ISH_Risk(cvd_risk_amr_d_sample$age, cvd_risk_amr_d_sample$sex, cvd_risk_amr_d_sample$csmoke, cvd_risk_amr_d_sample$sbp_ave, 
                                   cvd_risk_amr_d_sample$all_dia, cvd_risk_amr_d_sample$tchol_mmoll, "AMR_D")
    cvd_risk_amr_d_sample <- bind_cols(cvd_risk_amr_d_sample, cvd_risk_amr_d) 
    cvd_risk_amr_d_sample <- cvd_risk_amr_d_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#EMR_B
    cvd_risk_emr_b_sample <- cvd_risk_sample %>% filter(subregion=='"EMR_B"')
    cvd_risk_emr_b <- WHO_ISH_Risk(cvd_risk_emr_b_sample$age, cvd_risk_emr_b_sample$sex, cvd_risk_emr_b_sample$csmoke, cvd_risk_emr_b_sample$sbp_ave, 
                                   cvd_risk_emr_b_sample$all_dia, cvd_risk_emr_b_sample$tchol_mmoll, "EMR_B")
    cvd_risk_emr_b_sample <- bind_cols(cvd_risk_emr_b_sample, cvd_risk_emr_b) 
    cvd_risk_emr_b_sample <- cvd_risk_emr_b_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#EMR_D
    cvd_risk_emr_d_sample <- cvd_risk_sample %>% filter(subregion=='"EMR_D"')
    cvd_risk_emr_d <- WHO_ISH_Risk(cvd_risk_emr_d_sample$age, cvd_risk_emr_d_sample$sex, cvd_risk_emr_d_sample$csmoke, cvd_risk_emr_d_sample$sbp_ave, 
                                   cvd_risk_emr_d_sample$all_dia, cvd_risk_emr_d_sample$tchol_mmoll, "EMR_D")
    cvd_risk_emr_d_sample <- bind_cols(cvd_risk_emr_d_sample, cvd_risk_emr_d) 
    cvd_risk_emr_d_sample <- cvd_risk_emr_d_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#EUR_B
    cvd_risk_eur_b_sample <- cvd_risk_sample %>% filter(subregion=='"EUR_B"')
    cvd_risk_eur_b <- WHO_ISH_Risk(cvd_risk_eur_b_sample$age, cvd_risk_eur_b_sample$sex, cvd_risk_eur_b_sample$csmoke, cvd_risk_eur_b_sample$sbp_ave, 
                                   cvd_risk_eur_b_sample$all_dia, cvd_risk_eur_b_sample$tchol_mmoll, "EUR_B")
    cvd_risk_eur_b_sample <- bind_cols(cvd_risk_eur_b_sample, cvd_risk_eur_b) 
    cvd_risk_eur_b_sample <- cvd_risk_eur_b_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#EUR_C
    cvd_risk_eur_c_sample <- cvd_risk_sample %>% filter(subregion=='"EUR_C"')
    cvd_risk_eur_c <- WHO_ISH_Risk(cvd_risk_eur_c_sample$age, cvd_risk_eur_c_sample$sex, cvd_risk_eur_c_sample$csmoke, cvd_risk_eur_c_sample$sbp_ave, 
                                   cvd_risk_eur_c_sample$all_dia, cvd_risk_eur_c_sample$tchol_mmoll, "EUR_C")
    cvd_risk_eur_c_sample <- bind_cols(cvd_risk_eur_c_sample, cvd_risk_eur_c) 
    cvd_risk_eur_c_sample <- cvd_risk_eur_c_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#SEAR_B
    cvd_risk_sear_b_sample <- cvd_risk_sample %>% filter(subregion=='"SEAR_B"')
    cvd_risk_sear_b <- WHO_ISH_Risk(cvd_risk_sear_b_sample$age, cvd_risk_sear_b_sample$sex, cvd_risk_sear_b_sample$csmoke, 
                                    cvd_risk_sear_b_sample$sbp_ave, cvd_risk_sear_b_sample$all_dia, cvd_risk_sear_b_sample$tchol_mmoll, "SEAR_B")
    cvd_risk_sear_b_sample <- bind_cols(cvd_risk_sear_b_sample, cvd_risk_sear_b) 
    cvd_risk_sear_b_sample <- cvd_risk_sear_b_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#SEAR_D
    cvd_risk_sear_d_sample <- cvd_risk_sample %>% filter(subregion=='"SEAR_D"')
    cvd_risk_sear_d <- WHO_ISH_Risk(cvd_risk_sear_d_sample$age, cvd_risk_sear_d_sample$sex, cvd_risk_sear_d_sample$csmoke, 
                                    cvd_risk_sear_d_sample$sbp_ave, cvd_risk_sear_d_sample$all_dia, cvd_risk_sear_d_sample$tchol_mmoll, "SEAR_D")
    cvd_risk_sear_d_sample <- bind_cols(cvd_risk_sear_d_sample, cvd_risk_sear_d) 
    cvd_risk_sear_d_sample <- cvd_risk_sear_d_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#WPR_B
    cvd_risk_wpr_b_sample <- cvd_risk_sample %>% filter(subregion=='"WPR_B"')
    cvd_risk_wpr_b <- WHO_ISH_Risk(cvd_risk_wpr_b_sample$age, cvd_risk_wpr_b_sample$sex, cvd_risk_wpr_b_sample$csmoke, cvd_risk_wpr_b_sample$sbp_ave, 
                                   cvd_risk_wpr_b_sample$all_dia, cvd_risk_wpr_b_sample$tchol_mmoll, "WPR_B")
    cvd_risk_wpr_b_sample <- bind_cols(cvd_risk_wpr_b_sample, cvd_risk_wpr_b) 
    cvd_risk_wpr_b_sample <- cvd_risk_wpr_b_sample %>% rename(
    cvd_risk =  "...18"
    )
    
#append    
  cvd_risk_comb <- bind_rows(cvd_risk_amr_b_sample, cvd_risk_afr_d_sample, cvd_risk_afr_e_sample, cvd_risk_amr_d_sample, cvd_risk_emr_b_sample, 
                             cvd_risk_emr_d_sample, cvd_risk_eur_b_sample, cvd_risk_eur_c_sample, cvd_risk_sear_b_sample, cvd_risk_sear_d_sample, 
                             cvd_risk_wpr_b_sample)    
  
#define cut-off at 20% risk following WHO guidelines  
  cvd_risk_comb <- cvd_risk_comb %>% 
    mutate(risk_above_20 = ifelse(cvd_risk=="<10%" | cvd_risk=="10% to <20%", 0,
                        ifelse(cvd_risk=="20% to <30%" | cvd_risk=="30% to <40%" | cvd_risk==">=40%", 1, NA)))  
                         
#primary prevention denominator
  cvd_risk_comb  <- cvd_risk_comb %>% 
    mutate(samp_pri_statin  =  ifelse(age>39 & age<70 & mi==0 & is.na(statin)==F & (risk_above_20==1 | all_dia==1), 1,
                                  ifelse(age>39 & age<70 & mi==0 & is.na(statin)==F & risk_above_20==0 & all_dia==0, 0, NA)))

#secondary prevention denominator
  cvd_risk_comb  <- cvd_risk_comb %>% 
    mutate(samp_sec_statin = ifelse((age>39 & age<70) & mi==1 & is.na(statin)==F, 1,
                                  ifelse((age>39 & age<70) & mi==0 & is.na(statin)==F, 0, NA)))     
  
###generate outcomes

#Primary CVD prevention
  cvd_risk_comb  <- cvd_risk_comb %>% 
    mutate(statin_pri = ifelse(samp_pri_statin==1 & statin==0, 0,
                            ifelse(samp_pri_statin==1 & statin==1, 1, NA)))

#Secondary CVD prevention
  cvd_risk_comb  <- cvd_risk_comb %>% 
    mutate(statin_sec  = ifelse(samp_sec_statin==1 & statin==0, 0,
                             ifelse(samp_sec_statin==1 & statin==1, 1, NA)))

#calculate prevalences for primary prevention
  statins.primary <- select(cvd_risk_comb, country, statin_pri, sex, age, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  statins.primary <- filter(statins.primary, is.na(statin_pri)==F)
  statins.primary <- filter(statins.primary, is.na(w_dia_poor19_age)==F)
  statins.primary <- filter(statins.primary, is.na(poor19)==F)
  statins.primary <- statins.primary %>% mutate(
        psu = ifelse(is.na(psu==T), 1, psu),
        age = as.integer(age),
        hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
        stratum = ifelse(is.na(stratum==T), 1, stratum))

  statins.primary <-statins.primary %>% mutate(
    agegroup = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#limit to samples with denominator >50 respondents and nominator >5 respondents
 
#for poor32
  statins.risk.32 <- statins.primary %>% filter(poor32==1)
  statins.risk.32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.32, nest = T)
  svymean(~statin_pri, statins.risk.32, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.32, level = 0.95))

#for poor55
  statins.risk.55 <- statins.primary %>% filter(poor55==1)
  #statins.risk.55<-statins.risk.55[!(statins.risk.55$poor55==1 & statins.risk.55$agegroup=='35-44'),] #nominator
  statins.risk.55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.55, nest = T)
  statins.prev.55 <- svyby(~statin_pri, by=~agegroup, design=statins.risk.55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.55 <- unite_ci(statins.prev.55, "Prev_poor55", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor0
  statins.risk.0 <- statins.primary %>% filter(poor55==0)
  statins.risk.0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.0, nest = T)
  statins.prev.0 <- svyby(~statin_pri, by=~agegroup, design=statins.risk.0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.0 <- unite_ci(statins.prev.0, "Prev_poor0", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#for all povgroups
  statins.risk.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.primary, nest = T)
  statins.prev.all <- svyby(~statin_pri, by=~agegroup, design=statins.risk.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.all <- unite_ci(statins.prev.all, "Prev_poorall", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#append  
  statins.primary.comb <- statins.prev.19 %>%
    left_join(statins.prev.55) %>%
    left_join(statins.prev.0) 

#bring into right format
        statins.primary.comb <- statins.primary.comb %>% pivot_longer(!agegroup, names_to = "pov_group", values_to = "prevalence")
        statins.primary.comb$prevalence <- gsub('--', '-', statins.primary.comb$prevalence)  
        statins.primary.comb <- tidyr::separate(statins.primary.comb, prevalence, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.primary.comb$V2  <- gsub("[()]", "", statins.primary.comb$V2 )
        statins.primary.comb <- tidyr::separate(statins.primary.comb, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\-") 
        statins.primary.comb <- statins.primary.comb %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate( statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                            ")", sep="")) %>%
          select(agegroup, pov_group, statin_treat_prim)  %>% pivot_wider(names_from = pov_group, values_from = statin_treat_prim)
        write.csv(statins.primary.comb, "~/statins.primary.comb.csv")
    
#bring into right format 
        statins.prev.all <- tidyr::separate(statins.prev.all, Prev_poorall, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.prev.all$V2  <- gsub("[()]", "", statins.prev.all$V2 )
        statins.prev.all <- tidyr::separate(statins.prev.all, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\--")
        statins.prev.all <- statins.prev.all %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, statin_treat_prim)
         write.csv(statins.prev.all, "~/statins.prev.all.csv")

#to get total for each risk factor
  svymean(~statin_pri, statins.risk.55, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.55, level = 0.95)) 
  
  svymean(~statin_pri, statins.risk.0, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.0, level = 0.95)) 
  
  svymean(~statin_pri, statins.risk.all, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.all, level = 0.95)) 
  
#get p-value for each age group
  statins.primary <- statins.primary %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
  
  age3 <- filter(statins.primary, agegroup=='35-44')
  statin.primary.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~statin_pri + poor0, statin.primary.treat.age3) #0.004095
  
  age4 <- filter(statins.primary, agegroup=='45-54')
  statin.primary.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age4) #8.151e-05
  svychisq(~statin_pri + poor0, statin.primary.treat.age4) #8.151e-05
  
  age5 <- filter(statins.primary, agegroup=='55-64')
  statin.primary.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age5) #5.913e-13
  svychisq(~statin_pri + poor0, statin.primary.treat.age5) #5.913e-13
  
  age6 <- filter(statins.primary, agegroup=='>=65')
  statin.primary.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age6) #8.998e-13
  svychisq(~statin_pri + poor0, statin.primary.treat.age6)#8.998e-13
  
###secondary prevention
  statins.second <- select(cvd_risk_comb, country, statin_sec, sex, age, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  statins.second <- filter(statins.second, is.na(statin_sec)==F)
  statins.second <- filter(statins.second, is.na(w_dia_poor19_age)==F)
  statins.second <- filter(statins.second, is.na(poor19)==F)
  statins.second <- statins.second %>% mutate(
        psu = ifelse(is.na(psu==T), 1, psu),
        age = as.integer(age),
        hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
        stratum = ifelse(is.na(stratum==T), 1, stratum))
  
  statins.second <-statins.second %>% mutate(
    agegroup = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))
  
#limit to samples with denominator >50 respondents and nominator >5 respondents
  
#for poor19  
  statins.risk.19 <- statins.second %>% filter(poor19==1)
  statins.risk.19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.19, nest = T)
  svymean(~statin_sec, statins.risk.19, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.19, level = 0.95))
  
#for poor32  
  statins.risk.32 <- statins.second %>% filter(poor32==1)
  #statins.risk.32<-statins.risk.32[!(statins.risk.32$poor32==1& statins.risk.32$agegroup=='35-44'),]
  statins.risk.32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.32, nest = T)
  statins.prev.32 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.32 <- unite_ci(statins.prev.32, "Prev_poor32", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor55
  statins.risk.55 <- statins.second %>% filter(poor55==1)
  statins.risk.55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.55, nest = T)
  statins.prev.55 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.55 <- unite_ci(statins.prev.55, "Prev_poor55", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor0
  statins.risk.0 <- statins.second %>% filter(poor55==0)
  statins.risk.0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.0, nest = T)
  statins.prev.0 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.0 <- unite_ci(statins.prev.0, "Prev_poor0", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for all povgroups
  statins.risk.second.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.second, nest = T)
  statins.prev.second.all <- svyby(~statin_sec, by=~agegroup, design=statins.risk.second.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  statins.prev.second.all <- unite_ci(statins.prev.second.all, "Prev_poorall", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#append
  statins.second.comb <- statins.prev.32 %>%
    left_join(statins.prev.55) %>%
    left_join(statins.prev.0) 

#bring into right format
        statins.second.comb <- statins.second.comb %>% pivot_longer(!agegroup, names_to = "pov_group", values_to = "prevalence")
        statins.second.comb$prevalence <- gsub('--', '-', statins.second.comb$prevalence)  
        statins.second.comb <- tidyr::separate(statins.second.comb, prevalence, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.second.comb$V2  <- gsub("[()]", "", statins.second.comb$V2 )
        statins.second.comb <- tidyr::separate(statins.second.comb, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\-") 
        statins.second.comb <- statins.second.comb %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, pov_group, statin_treat_prim)  %>% pivot_wider(names_from = pov_group, values_from = statin_treat_prim)
        write.csv(statins.second.comb, "~/statins.second.comb.csv")
    
#bring into right format 
        statins.prev.second.all <- tidyr::separate(statins.prev.second.all, Prev_poorall, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.prev.second.all$V2  <- gsub("[()]", "", statins.prev.second.all$V2 )
        statins.prev.second.all <- tidyr::separate(statins.prev.second.all, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\--")
        statins.prev.second.all <- statins.prev.second.all %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1) %>% 
          mutate( statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                            ")", sep="")) %>%
          select(agegroup, statin_treat_prim)
        write.csv(statins.prev.second.all, "~/statins.prev.second.all.csv")

#to get total for each risk factor
  svymean(~statin_sec, statins.risk.19, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.19, level = 0.95))  
  
  svymean(~statin_sec, statins.risk.32, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.32, level = 0.95))
  
  svymean(~statin_sec, statins.risk.55, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.55, level = 0.95)) 
  
  svymean(~statin_sec, statins.risk.0, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.0, level = 0.95)) 
  
  svymean(~statin_sec, statins.risk.second.all, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.second.all, level = 0.95)) 

#get significance level
  statins.second <- statins.second %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
    
  age3 <- filter(statins.second, agegroup=='35-44')
  statin.primary.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~statin_sec + poor55, statin.primary.treat.age3) #0.00411
  svychisq(~statin_sec + poor0, statin.primary.treat.age3) #0.00411
  
  age4 <- filter(statins.second, agegroup=='45-54')
  statin.primary.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~statin_sec + poor32, statin.primary.treat.age4) #6.378e-12
  svychisq(~statin_sec + poor55, statin.primary.treat.age4) #0.001801
  svychisq(~statin_sec + poor0, statin.primary.treat.age4) #0.001801
  
  age5 <- filter(statins.second, agegroup=='55-64')
  statin.primary.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~statin_sec + poor32, statin.primary.treat.age5) #9.169e-06
  svychisq(~statin_sec + poor55, statin.primary.treat.age5) #1.851e-08
  svychisq(~statin_sec + poor0, statin.primary.treat.age5) #1.851e-08
  
  age6 <- filter(statins.second, agegroup=='>=65')
  statin.primary.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~statin_sec + poor32, statin.primary.treat.age6) #3.516e-09
  svychisq(~statin_sec + poor55, statin.primary.treat.age6) #1.699e-15
  svychisq(~statin_sec + poor0, statin.primary.treat.age6)#1.699e-15

#bring required datasets into long format
  hypt_treat <- hypt_treat %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "hypt treated") 
  hypt_control <- hypt_control %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "hypt controlled") 
  dia_treat <- dia_treat %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "dia treated") 
  statin_primary <- statin_primary %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "statin primary") 
  statin_secondary <- statin_secondary %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "statin secondary") 

#merge
  plot.all <- hypt_treat %>% 
    left_join(hypt_control) %>% 
    left_join(dia_treat) %>% 
    left_join(statin_primary) %>% 
    left_join(statin_secondary)

#create Figure 4
  plot.all <- plot.all %>% 
    gather(`hypt treated`, `hypt controlled`, `dia treated`, `statin primary`, `statin secondary`, key="step", value="temp")   
  plot.all <- tidyr::separate(plot.all, temp, c("est", "V2"), "\\s(?:.+\\s)?")
  plot.all$V2  <- gsub("[()]", "", plot.all$V2 )
  plot.all <- tidyr::separate(plot.all, V2, c("lowci", "highci"), "\\-") 
  plot.all <- plot.all %>% 
    mutate(step = fct_relevel(step, 
           "hypt treated", "hypt controlled", "dia treated", "statin primary", "statin secondary"),
          est = as.numeric(est),
          lowci = as.numeric(lowci),
          highci = as.numeric(highci),
          pov_group = as.character(pov_group))
  plot.all$agegroups <- plot.all$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65"))
  plot.all$pov_group <- plot.all$pov_group %>% factor(c("poor19", "poor32", "poor55", "poor0", "allpov"))
  
  cols <- c("poor19" = "#FEE8C8", "poor32" = "#FDD49E", "poor55" = "#FDBB84", "poor0" = "#EF6548", "allpov" = "black")

  cascades.all <- ggplot(plot.all, aes(x=step, y=est, fill=pov_group)) +
        geom_bar(stat='identity', position='dodge')+
        geom_errorbar(aes(ymin=lowci, ymax=highci), width=.2,
                   position=position_dodge(.9), show.legend = F) +
        theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=18, face="bold"),
          legend.text=element_text(size=18, family="Times"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=18, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=18, face="bold", family="Times")) + 
        scale_y_continuous(breaks = c(0, 20, 40, 60, 80)) +
        coord_cartesian(ylim=c(0, 80)) +
        facet_wrap(~agegroup) +
        labs(x = "",
           y = "%",
           fill="") +
        scale_fill_manual(values = c("#FEE8C8", "#FDD49E", "#FDBB84", "#EF6548", "black"), labels=c("poor19" = "<$1.90/day", "poor32" = "<$3.20/day", 
                                                                                                    "poor55" = "<$5.50/day", "poor0" = ">$5.50/day", 
                                                                                                    "allpov" = "Total")) +
        coord_fixed(5/80) 
        ggsave("cascades.all.png", height = 12, width = 16)

#Version 2: limit to complete agegroups
  plot.all <- plot.all %>% 
    gather(`hypt treated`, `hypt controlled`, `dia treated`, `statin primary`, `statin secondary`, key="step", value="temp")    
  plot.all <- tidyr::separate(plot.all, temp, c("est", "V2"), "\\s(?:.+\\s)?")
  plot.all$V2  <- gsub("[()]", "", plot.all$V2 )
  plot.all <- tidyr::separate(plot.all, V2, c("lowci", "highci"), "\\-") 
  plot.all <- plot.all %>% 
    mutate(step = fct_relevel(step, 
           "hypt treated", "hypt controlled", "dia treated", "statin primary", "statin secondary"),
      est = as.numeric(est),
      lowci = as.numeric(lowci),
      highci = as.numeric(highci),
      pov_group = as.character(pov_group))
  
  plot.all <- filter(plot.all, agegroups!='15-24')
  plot.all <- filter(plot.all, agegroups!='25-34')
  plot.all <- filter(plot.all, agegroups!='35-44')
  plot.all$agegroups <- plot.all$agegroups %>% factor(c("45-54", "55-64", ">=65"))
  plot.all$pov_group <- plot.all$pov_group %>% factor(c("poor19", "poor32", "poor55", "poor0", "allpov"))

  cols <- c("poor19" = "#FEE8C8", "poor32" = "#FDD49E", "poor55" = "#FDBB84", "poor0" = "#EF6548", "allpov" = "black")

  cascades.all.completeage.only <- ggplot(plot.all, aes(x=step, y=est, fill=pov_group)) +
      geom_bar(stat='identity', position='dodge')+
        geom_errorbar(aes(ymin=lowci, ymax=highci), width=.2,
                   position=position_dodge(.9), show.legend = F) +
  theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=18, face="bold"),
          legend.text=element_text(size=18, family="Times"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=18, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=18, face="bold", family="Times")) + 
   scale_y_continuous(breaks = c(0, 20, 40, 60, 80)) +
   coord_cartesian(ylim=c(0, 80)) +
   facet_wrap(~agegroups) +
   labs(x = "",
         y = "%",
         fill="") +
   scale_fill_manual(values = c("#FEE8C8", "#FDD49E", "#FDBB84", "#EF6548", "black"), labels=c("poor19" = "<$1.90/day", "poor32" = "<$3.20/day", 
                                                                                               "poor55" = "<$5.50/day", "poor0" = ">$5.50/day", "allpov"
                                                                                               = "Total")) +
   coord_fixed(5/80) 
   ggsave("cascades.all.completeage.only.png", height = 12, width = 16)

### SAME PROCEDURE BY SEX: WOMEN
  hypt_meds.women <- select(hypt_cascades_subset, country, sex, age, all_hypt, hypt_treat, w_hypt_poor19_age, psu, stratum, hh_id, poor19, poor32, 
                            poor55)
  hypt_meds.women <- filter(hypt_meds.women, is.na(all_hypt)==F)
  hypt_meds.women <- filter(hypt_meds.women, all_hypt==1)
  hypt_meds.women <- filter(hypt_meds.women, is.na(hypt_treat)==F)
  hypt_meds.women <- filter(hypt_meds.women, is.na(w_hypt_poor19_age)==F)
  hypt_meds.women <- filter(hypt_meds.women, is.na(poor19)==F)
  hypt_meds.women <- filter(hypt_meds.women, sex==1)
  hypt_meds.women <- hypt_meds.women %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  hypt_meds.women <- filter(hypt_meds.women, age<=95)
  hypt_meds.women <-hypt_meds.women %>% 
    mutate(agegroups = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))
  
#for each poverty group
  risk.hypt.pov19.cascades.women <- hypt_meds.women %>% filter(poor19==1)
  risk.hypt.pov19.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19.cascades.women, nest = T)
  
  risk.hypt.pov32.cascades.women <- hypt_meds.women %>% filter(poor32==1)
  risk.hypt.pov32.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32.cascades.women, nest = T)
  
  risk.hypt.pov55.cascades.women <- hypt_meds.women %>% filter(poor55==1)
  risk.hypt.pov55.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55.cascades.women, nest = T)
  
  risk.hypt.pov0.cascades.women <- hypt_meds.women %>% filter(poor55==0)
  risk.hypt.pov0.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0.cascades.women, nest = T)
  
  risk.hypt.all_povgroups.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_meds.women, nest = T)

#to get the total for all age groupss
  prev.hypt.pov19.cascades.women <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov19.cascades.women, svyciprop, proportion=TRUE, 
                                          prop_method="asin", vartype = "ci")
  prev.hypt.pov19.cascades.women <- unite_ci(prev.hypt.pov19.cascades.women, "Prev_poor19", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.cascades.women <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov32.cascades.women, svyciprop, proportion=TRUE, 
                                          prop_method="asin", vartype = "ci")
  prev.hypt.pov32.cascades.women <- unite_ci(prev.hypt.pov32.cascades.women, "Prev_poor32", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.cascades.women <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov55.cascades.women, svyciprop, proportion=TRUE, 
                                          prop_method="asin", vartype = "ci")
  prev.hypt.pov55.cascades.women <- unite_ci(prev.hypt.pov55.cascades.women, "Prev_poor55", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.cascades.women <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov0.cascades.women, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.hypt.pov0.cascades.women <- unite_ci(prev.hypt.pov0.cascades.women, "Prev_poor0", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.cascades.women <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.all_povgroups.cascades.women, svyciprop, proportion=TRUE, 
                                           prop_method="asin", vartype = "ci")
  prev.hypt.allpov.cascades.women <- unite_ci(prev.hypt.allpov.cascades.women, "Prev_allpov", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.hypt.agegroups.cascades.women <- prev.hypt.pov19.cascades.women %>% 
    left_join(prev.hypt.pov32.cascades.women) %>% 
    left_join(prev.hypt.pov55.cascades.women) %>% 
    left_join(prev.hypt.pov0.cascades.women)
  
#bring into right format     
    prev.hypt.agegroups.cascades.women <- prev.hypt.agegroups.cascades.women %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                                "prevalence")
    prev.hypt.agegroups.cascades.women$prevalence <- gsub('--', '-', prev.hypt.agegroups.cascades.women$prevalence)  
    prev.hypt.agegroups.cascades.women <- tidyr::separate(prev.hypt.agegroups.cascades.women, prevalence, c("hypt_treat", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.agegroups.cascades.women$V2  <- gsub("[()]", "", prev.hypt.agegroups.cascades.women$V2 )
    prev.hypt.agegroups.cascades.women <- tidyr::separate(prev.hypt.agegroups.cascades.women, V2, c("cil_hypt", "ciu_hypt"), "\\-") 
    prev.hypt.agegroups.cascades.women <- prev.hypt.agegroups.cascades.women %>% 
      mutate(hypt_treat = as.numeric(hypt_treat),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_treat = str_c(as.character(hypt_treat), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_treat)  %>% pivot_wider(names_from = pov_group, values_from = hypt_treat)
  
    write.csv(prev.hypt.agegroups.cascades.women, "~/prev.hypt.agegroups.cascades.women.csv")
    
#bring into right format 
    prev.hypt.allpov.cascades.women <- prev.hypt.allpov.cascades.women %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.hypt.allpov.cascades.women$prevalence <- gsub('--', '-', prev.hypt.allpov.cascades.women$prevalence)  
    prev.hypt.allpov.cascades.women <- tidyr::separate(prev.hypt.allpov.cascades.women, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.allpov.cascades.women$V2  <- gsub("[()]", "", prev.hypt.allpov.cascades.women$V2 )
    prev.hypt.allpov.cascades.women <- tidyr::separate(prev.hypt.allpov.cascades.women, V2, c("cil_dia", "ciu_dia"), "\\-")
    prev.hypt.allpov.cascades.women <- prev.hypt.allpov.cascades.women %>% 
      mutate(dia_treat = as.numeric(dia_treat),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
      select(agegroups, pov_group, dia_treat) %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
        
    write.csv(prev.hypt.allpov.cascades.women, "~/prev.hypt.allpov.cascades.women.csv")
  
#to get total for each risk factor
  svymean(~hypt_treat, risk.hypt.pov19.cascades.women, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov19.cascades.women, level = 0.95))  
  
  svymean(~hypt_treat, risk.hypt.pov32.cascades.women, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov32.cascades.women, level = 0.95))
  
  svymean(~hypt_treat, risk.hypt.pov55.cascades.women, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov55.cascades.women, level = 0.95)) 
  
  svymean(~hypt_treat, risk.hypt.pov0.cascades.women, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov0.cascades.women, level = 0.95)) 
  
  svymean(~hypt_treat, risk.hypt.all_povgroups.cascades.women, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.all_povgroups.cascades.women, level = 0.95)) 
  

#check if difference between poor and non-poor is significant: get p-values; by agegroup
  hypt_meds.women <- hypt_meds.women %>% mutate(
    poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(hypt_meds.women, agegroups=='15-24')
  hypt.meds.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age1, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age1) #0.281
  svychisq(~hypt_treat + poor32, hypt.meds.age1) #0.457
  svychisq(~hypt_treat + poor55, hypt.meds.age1) #0.223
  svychisq(~hypt_treat + poor0, hypt.meds.age1)#0.223
  
  age2 <- filter(hypt_meds.women, agegroups=='25-34')
  hypt.meds.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age2, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age2) #8.142e-12
  svychisq(~hypt_treat + poor32, hypt.meds.age2) #0.002486
  svychisq(~hypt_treat + poor55, hypt.meds.age2) #0.5711
  svychisq(~hypt_treat + poor0, hypt.meds.age2)#0.5711
  
  age3 <- filter(hypt_meds.women, agegroups=='35-44')
  hypt.meds.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age3, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age3) #6.327e-11
  svychisq(~hypt_treat + poor32, hypt.meds.age3) #9.288e-08
  svychisq(~hypt_treat + poor55, hypt.meds.age3) #0.0003053
  svychisq(~hypt_treat + poor0, hypt.meds.age3)#0.0003053
  
  age4 <- filter(hypt_meds.women, agegroups=='45-54')
  hypt.meds.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age4, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age4) #7.388e-07
  svychisq(~hypt_treat + poor32, hypt.meds.age4) #6.622e-09
  svychisq(~hypt_treat + poor55, hypt.meds.age4) #3.196e-09
  svychisq(~hypt_treat + poor0, hypt.meds.age4)#3.196e-09
  
  age5 <- filter(hypt_meds.women, agegroups=='55-64')
  hypt.meds.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age5, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age5) #5.169e-07
  svychisq(~hypt_treat + poor32, hypt.meds.age5) #6.656e-06
  svychisq(~hypt_treat + poor55, hypt.meds.age5) #6.64e-08
  svychisq(~hypt_treat + poor0, hypt.meds.age5)#6.64e-08
  
  age6 <- filter(hypt_meds.women, agegroups=='>=65')
  hypt.meds.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age6, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age6) #0.01727
  svychisq(~hypt_treat + poor32, hypt.meds.age6) #0.007141
  svychisq(~hypt_treat + poor55, hypt.meds.age6) #0.002673
  svychisq(~hypt_treat + poor0, hypt.meds.age6)#0.002673

###CASCADE 2: hypertensive who achieved control (females only)
  hypt_control.women <- select(hypt_cascades_subset, country, sex, age, all_hypt, hypt_ctrl, w_hypt_poor19_age, psu, stratum, hh_id, poor19, poor32, 
                               poor55)
  hypt_control.women <- filter(hypt_control.women, is.na(all_hypt)==F)
  hypt_control.women <- filter(hypt_control.women, all_hypt==1)
  hypt_control.women <- filter(hypt_control.women, is.na(hypt_ctrl)==F)
  hypt_control.women <- filter(hypt_control.women, is.na(w_hypt_poor19_age)==F)
  hypt_control.women <- filter(hypt_control.women, is.na(poor19)==F)
  hypt_control.women <- filter(hypt_control.women, sex==1)
  hypt_control.women <- hypt_control.women %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  hypt_control.women <-hypt_control.women %>% 
    mutate(agegroups = ifelse(age>=15 & age<=24, '15-24',
                        ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#for each poverty group
  risk.hypt.pov19.cascades.ctrl.women <- hypt_control.women %>% filter(poor19==1)
  risk.hypt.pov19.cascades.ctrl.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19.cascades.ctrl.women,
                                                   nest = T)
  
  risk.hypt.pov32.cascades.ctrl.women <- hypt_control.women %>% filter(poor32==1)
  risk.hypt.pov32.cascades.ctrl.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32.cascades.ctrl.women,
                                                   nest = T)
  
  risk.hypt.pov55.cascades.ctrl.women <- hypt_control.women %>% filter(poor55==1)
  risk.hypt.pov55.cascades.ctrl.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55.cascades.ctrl.women,
                                                   nest = T)
  
  risk.hypt.pov0.cascades.ctrl.women <- hypt_control.women %>% filter(poor55==0)
  risk.hypt.pov0.cascades.ctrl.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0.cascades.ctrl.women, 
                                                  nest = T)
  
  risk.hypt.all_povgroups.cascades.ctrl.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_control.women, nest = 
                                                             T)

#to get the total for all age groupss
  prev.hypt.pov19.cascades.ctrl.women <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov19.cascades.ctrl.women, svyciprop, proportion=TRUE, 
                                               prop_method="asin", vartype = "ci")
  prev.hypt.pov19.cascades.ctrl.women <- unite_ci(prev.hypt.pov19.cascades.ctrl.women, "Prev_poor19", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.cascades.ctrl.women <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov32.cascades.ctrl.women, svyciprop, proportion=TRUE, 
                                               prop_method="asin", vartype = "ci")
  prev.hypt.pov32.cascades.ctrl.women <- unite_ci(prev.hypt.pov32.cascades.ctrl.women, "Prev_poor32", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.cascades.ctrl.women <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov55.cascades.ctrl.women, svyciprop, proportion=TRUE, 
                                               prop_method="asin", vartype = "ci")
  prev.hypt.pov55.cascades.ctrl.women <- unite_ci(prev.hypt.pov55.cascades.ctrl.women, "Prev_poor55", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.cascades.ctrl.women <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov0.cascades.ctrl.women, svyciprop, proportion=TRUE, 
                                              prop_method="asin", vartype = "ci")
  prev.hypt.pov0.cascades.ctrl.women <- unite_ci(prev.hypt.pov0.cascades.ctrl.women, "Prev_poor0", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.cascades.ctrl.women <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.all_povgroups.cascades.ctrl.women, svyciprop, 
                                                proportion=TRUE, prop_method="asin", vartype = "ci")
  prev.hypt.allpov.cascades.ctrl.women <- unite_ci(prev.hypt.allpov.cascades.ctrl.women, "Prev_allpov", hypt_ctrl, ci_l, ci_u, m100 = T, percent = 
                                                     FALSE)
  
#merge prevalences by agegroups
  prev.hypt.agegroups.cascades.ctrl.women <- prev.hypt.pov19.cascades.ctrl.women %>% 
    left_join(prev.hypt.pov32.cascades.ctrl.women) %>% 
    left_join(prev.hypt.pov55.cascades.ctrl.women) %>% 
    left_join(prev.hypt.pov0.cascades.ctrl.women)

#bring into right format     
    prev.hypt.agegroups.cascades.ctrl.women <- prev.hypt.agegroups.cascades.ctrl.women %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                                          "prevalence")
    prev.hypt.agegroups.cascades.ctrl.women$prevalence <- gsub('--', '-', prev.hypt.agegroups.cascades.ctrl.women$prevalence)  
    prev.hypt.agegroups.cascades.ctrl.women <- tidyr::separate(prev.hypt.agegroups.cascades.ctrl.women, prevalence, c("hypt_ctrl", "V2"), 
                                                               "\\s(?:.+\\s)?")
    prev.hypt.agegroups.cascades.ctrl.women$V2  <- gsub("[()]", "", prev.hypt.agegroups.cascades.ctrl.women$V2 )
    prev.hypt.agegroups.cascades.ctrl.women <- tidyr::separate(prev.hypt.agegroups.cascades.ctrl.women, V2, c("cil_hypt", "ciu_hypt"), "\\-") 
    prev.hypt.agegroups.cascades.ctrl.women <- prev.hypt.agegroups.cascades.ctrl.women %>% 
      mutate(hypt_ctrl = as.numeric(hypt_ctrl),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_ctrl = str_c(as.character(hypt_ctrl), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_ctrl)  %>% pivot_wider(names_from = pov_group, values_from = hypt_ctrl)
  
    write.csv(prev.hypt.agegroups.cascades.ctrl.women, "~/prev.hypt.agegroups.cascades.ctrl.women.csv")
    
#bring into right format 
    prev.hypt.allpov.cascades.ctrl.women <- prev.hypt.allpov.cascades.ctrl.women %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                                    "prevalence")
    prev.hypt.allpov.cascades.ctrl.women$prevalence <- gsub('--', '-', prev.hypt.allpov.cascades.ctrl.women$prevalence)  
    prev.hypt.allpov.cascades.ctrl.women <- tidyr::separate(prev.hypt.allpov.cascades.ctrl.women, prevalence, c("hypt_ctrl", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.allpov.cascades.ctrl.women$V2  <- gsub("[()]", "", prev.hypt.allpov.cascades.ctrl.women$V2 )
    prev.hypt.allpov.cascades.ctrl.women <- tidyr::separate(prev.hypt.allpov.cascades.ctrl.women, V2, c("cil_dia", "ciu_dia"), "\\-")
    prev.hypt.allpov.cascades.ctrl.women <- prev.hypt.allpov.cascades.ctrl.women %>% 
      mutate(hypt_ctrl = as.numeric(hypt_ctrl),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_ctrl = str_c(as.character(hypt_ctrl), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_ctrl) %>% pivot_wider(names_from = pov_group, values_from = hypt_ctrl)
        
    write.csv(prev.hypt.allpov.cascades.ctrl.women, "~/prev.hypt.allpov.cascades.ctrl.women.csv")
  
#to get total for each risk factor
  svymean(~hypt_ctrl, risk.hypt.pov19.cascades.ctrl.women, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov19.cascades.ctrl.women, level = 0.95))  
  
  svymean(~hypt_ctrl, risk.hypt.pov32.cascades.ctrl.women, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov32.cascades.ctrl.women, level = 0.95))
  
  svymean(~hypt_ctrl, risk.hypt.pov55.cascades.ctrl.women, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov55.cascades.ctrl.women, level = 0.95)) 
  
  svymean(~hypt_ctrl, risk.hypt.pov0.cascades.ctrl.women, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov0.cascades.ctrl.women, level = 0.95)) 
  
  svymean(~hypt_ctrl, risk.hypt.all_povgroups.cascades.ctrl.women, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.all_povgroups.cascades.ctrl.women, level = 0.95)) 
  
#get p-values
  hypt_control.women <- hypt_control.women %>% mutate(
    poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(hypt_control.women, agegroups=='15-24')
  hypt.control.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age1, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age1) #0.1712
  svychisq(~hypt_ctrl + poor32, hypt.control.age1) #0.951
  svychisq(~hypt_ctrl + poor55, hypt.control.age1) #0.2661
  svychisq(~hypt_ctrl + poor0, hypt.control.age1)#0.2661
  
  age2 <- filter(hypt_control.women, agegroups=='25-34')
  hypt.control.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age2, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age2) #3.689e-10
  svychisq(~hypt_ctrl + poor32, hypt.control.age2) #0.03612
  svychisq(~hypt_ctrl + poor55, hypt.control.age2) #0.1709
  svychisq(~hypt_ctrl + poor0, hypt.control.age2) #0.1709
  
  age3 <- filter(hypt_control.women, agegroups=='35-44')
  hypt.control.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age3, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age3) #4.797e-12
  svychisq(~hypt_ctrl + poor32, hypt.control.age3) #1.811e-09
  svychisq(~hypt_ctrl + poor55, hypt.control.age3) #6.253e-05
  svychisq(~hypt_ctrl + poor0, hypt.control.age3)#6.253e-05
  
  age4 <- filter(hypt_control.women, agegroups=='45-54')
  hypt.control.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age4, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age4) #0.2358
  svychisq(~hypt_ctrl + poor32, hypt.control.age4) #0.0004712
  svychisq(~hypt_ctrl + poor55, hypt.control.age4) #4.362e-05
  svychisq(~hypt_ctrl + poor0, hypt.control.age4)#4.362e-05
  
  age5 <- filter(hypt_control.women, agegroups=='55-64')
  hypt.control.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age5, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age5) #0.001285
  svychisq(~hypt_ctrl + poor32, hypt.control.age5) #0.00463
  svychisq(~hypt_ctrl + poor55, hypt.control.age5) #0.0004381
  svychisq(~hypt_ctrl + poor0, hypt.control.age5)#0.0004381
  
  age6 <- filter(hypt_control.women, agegroups=='>=65')
  hypt.control.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age6, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age6) #0.1137
  svychisq(~hypt_ctrl + poor32, hypt.control.age6) #0.0883
  svychisq(~hypt_ctrl + poor55, hypt.control.age6) #0.005807
  svychisq(~hypt_ctrl + poor0, hypt.control.age6)#0.005807

###CASCADE 3: diabetes meds 
#plot proportion  with diabetes who take medication

  dia_meds.women <- select(dia_cascades_subset, country, sex, age, all_dia, dia_treat, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  dia_meds.women <- filter(dia_meds.women, is.na(all_dia)==F)
  dia_meds.women <- filter(dia_meds.women, all_dia==1)
  dia_meds.women <- filter(dia_meds.women, is.na(dia_treat)==F)
  dia_meds.women <- filter(dia_meds.women, is.na(w_dia_poor19_age)==F)
  dia_meds.women <- filter(dia_meds.women, is.na(poor19)==F)
  dia_meds.women <- filter(dia_meds.women, sex==1)
  dia_meds.women <- dia_meds.women %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  dia_meds.women <- filter(dia_meds.women, age<=95) 
  dia_meds.women <-dia_meds.women %>% 
    mutate(agegroups = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA))))))) 

#for each poverty group
  risk.dia.pov19.cascades.women <- dia_meds.women %>% filter(poor19==1)
  risk.dia.pov19.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov19.cascades.women, nest = T)
  
  risk.dia.pov32.cascades.women <- dia_meds.women %>% filter(poor32==1)
  risk.dia.pov32.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov32.cascades.women, nest = T)
  
  risk.dia.pov55.cascades.women <- dia_meds.women %>% filter(poor55==1)
  risk.dia.pov55.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov55.cascades.women, nest = T)
  
  risk.dia.pov0.cascades.women <- dia_meds.women %>% filter(poor55==0)
  risk.dia.pov0.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov0.cascades.women, nest = T)
  
  risk.dia.all_povgroups.cascades.women <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia_meds.women, nest = T)

#to get the total for all age groupss
  prev.dia.pov19.cascades.women <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov19.cascades.women, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.dia.pov19.cascades.women <- unite_ci(prev.dia.pov19.cascades.women, "Prev_poor19", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.cascades.women <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov32.cascades.women, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.dia.pov32.cascades.women <- unite_ci(prev.dia.pov32.cascades.women, "Prev_poor32", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.cascades.women <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov55.cascades.women, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.dia.pov55.cascades.women <- unite_ci(prev.dia.pov55.cascades.women, "Prev_poor55", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.cascades.women <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov0.cascades.women, svyciprop, proportion=TRUE, prop_method="asin", 
                                        vartype = "ci")
  prev.dia.pov0.cascades.women <- unite_ci(prev.dia.pov0.cascades.women, "Prev_poor0", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.cascades.women <- svyby(~dia_treat, by=~agegroups, design=risk.dia.all_povgroups.cascades.women, svyciprop, proportion=TRUE, 
                                          prop_method="asin", vartype = "ci")
  prev.dia.allpov.cascades.women <- unite_ci(prev.dia.allpov.cascades.women, "Prev_allpov", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalence by agegroups
  prev.dia.agegroups.cascades.women <- prev.dia.pov19.cascades.women %>% 
    left_join(prev.dia.pov32.cascades.women) %>% 
    left_join(prev.dia.pov55.cascades.women) %>% 
    left_join(prev.dia.pov0.cascades.women)
  
#bring into right format  
        prev.dia.agegroups.cascades.women <- prev.dia.agegroups.cascades.women %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                                  "prevalence")
        prev.dia.agegroups.cascades.women$prevalence <- gsub('--', '-', prev.dia.agegroups.cascades.women$prevalence)  
        prev.dia.agegroups.cascades.women <- tidyr::separate(prev.dia.agegroups.cascades.women, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
        prev.dia.agegroups.cascades.women$V2  <- gsub("[()]", "", prev.dia.agegroups.cascades.women$V2 )
        prev.dia.agegroups.cascades.women <- tidyr::separate(prev.dia.agegroups.cascades.women, V2, c("cil_dia", "ciu_dia"), "\\-") 
        prev.dia.agegroups.cascades.women <- prev.dia.agegroups.cascades.women %>% 
          mutate(dia_treat = as.numeric(dia_treat),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
          select(agegroups, pov_group, dia_treat)  %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
  
    write.csv(prev.dia.agegroups.cascades.women, "~/prev.dia.agegroups.cascades.women.csv")
    
#bring into right format 
        prev.dia.allpov.cascades.women <- prev.dia.allpov.cascades.women %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
        prev.dia.allpov.cascades.women$prevalence <- gsub('--', '-', prev.dia.allpov.cascades.women$prevalence)  
        prev.dia.allpov.cascades.women <- tidyr::separate(prev.dia.allpov.cascades.women, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
        prev.dia.allpov.cascades.women$V2  <- gsub("[()]", "", prev.dia.allpov.cascades.women$V2 )
        prev.dia.allpov.cascades.women <- tidyr::separate(prev.dia.allpov.cascades.women, V2, c("cil_dia", "ciu_dia"), "\\-")
        prev.dia.allpov.cascades.women <- prev.dia.allpov.cascades.women %>% 
          mutate(dia_treat = as.numeric(dia_treat),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
          select(agegroups, pov_group, dia_treat) %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
        
    write.csv(prev.dia.allpov.cascades.women, "~/prev.dia.allpov.cascades.women.csv")
  
#to get total for each poverty group
  svymean(~dia_treat, risk.dia.pov19.cascades.women, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov19.cascades.women, level = 0.95))  
  
  svymean(~dia_treat, risk.dia.pov32.cascades.women, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov32.cascades.women, level = 0.95))
  
  svymean(~dia_treat, risk.dia.pov55.cascades.women, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov55.cascades.women, level = 0.95)) 
  
  svymean(~dia_treat, risk.dia.pov0.cascades.women, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov0.cascades.women, level = 0.95)) 
  
  svymean(~dia_treat, risk.dia.all_povgroups.cascades.women, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.all_povgroups.cascades.women, level = 0.95)) 
  
#get p-values
  dia_meds.women <- dia_meds.women %>% mutate(
  poor0 = ifelse(poor55==0, 1, 0))
  
  age1 <- filter(dia_meds.women, agegroups=='15-24')
  dia.treat.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age1, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age1) #0.866
  svychisq(~dia_treat + poor32, dia.treat.age1) #0.6033
  svychisq(~dia_treat + poor55, dia.treat.age1) #0.002248
  svychisq(~dia_treat + poor0, dia.treat.age1) # 0.002248
  
  age2 <- filter(dia_meds.women, agegroups=='25-34')
  dia.treat.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age2, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age2) #0.06423
  svychisq(~dia_treat + poor32, dia.treat.age2) #0.1447
  svychisq(~dia_treat + poor55, dia.treat.age2) #0.3598
  svychisq(~dia_treat + poor0, dia.treat.age2) #0.3598
  
  age3 <- filter(dia_meds.women, agegroups=='35-44')
  dia.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age3) #0.03159
  svychisq(~dia_treat + poor32, dia.treat.age3) #0.03159
  svychisq(~dia_treat + poor55, dia.treat.age3) #0.0001324
  svychisq(~dia_treat + poor0, dia.treat.age3) #0.0001324
  
  age4 <- filter(dia_meds.women, agegroups=='45-54')
  dia.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age4) #0.0768
  svychisq(~dia_treat + poor32, dia.treat.age4) #1.332e-05
  svychisq(~dia_treat + poor55, dia.treat.age4) #0.001483
  svychisq(~dia_treat + poor0, dia.treat.age4) #0.001483
  
  age5 <- filter(dia_meds.women, agegroups=='55-64')
  dia.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age5) #0.0003009
  svychisq(~dia_treat + poor32, dia.treat.age5) #1.502e-06
  svychisq(~dia_treat + poor55, dia.treat.age5) #4.492e-11
  svychisq(~dia_treat + poor0, dia.treat.age5) #4.492e-11
  
  age6 <- filter(dia_meds.women, agegroups=='>=65')
  dia.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age6) #7.132e-05
  svychisq(~dia_treat + poor32, dia.treat.age6) #4.268e-06
  svychisq(~dia_treat + poor55, dia.treat.age6) #7.393e-09
  svychisq(~dia_treat + poor0, dia.treat.age6) #7.393e-09

### statins
#calculate prevalence for primary prevention
  statins.primary.women <- select(cvd_risk_comb, country, statin_pri, sex, age, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  statins.primary.women <- filter(statins.primary.women, is.na(statin_pri)==F)
  statins.primary.women <- filter(statins.primary.women, is.na(w_dia_poor19_age)==F)
  statins.primary.women <- filter(statins.primary.women, is.na(poor19)==F)
  statins.primary.women <- filter(statins.primary.women, sex==1)
  statins.primary.women <- statins.primary.women %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  
  statins.primary.women <-statins.primary.women %>% 
    mutate(agegroup = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))
#limit to samples of sufficient size
#for poor55
  statins.risk.55 <- statins.primary.women %>% filter(poor55==1)
  #statins.risk.55<-statins.risk.55[!(statins.risk.55$poor55==1 & statins.risk.55$agegroup=='35-44'),]
  statins.risk.55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.55, nest = T)
  statins.prev.55 <- svyby(~statin_pri, by=~agegroup, design=statins.risk.55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.55 <- unite_ci(statins.prev.55, "Prev_poor55", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor0
  statins.risk.0 <- statins.primary.women %>% filter(poor55==0)
  statins.risk.0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.0, nest = T)
  statins.prev.0 <- svyby(~statin_pri, by=~agegroup, design=statins.risk.0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.0 <- unite_ci(statins.prev.0, "Prev_poor0", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#for all povgroups
  statins.risk.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.primary.women, nest = T)
  statins.prev.all <- svyby(~statin_pri, by=~agegroup, design=statins.risk.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.all <- unite_ci(statins.prev.all, "Prev_poorall", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

  statins.primary.comb <- statins.prev.0 %>%
    left_join(statins.prev.55) 

#bring into right format
        statins.primary.comb <- statins.primary.comb %>% pivot_longer(!agegroup, names_to = "pov_group", values_to = "prevalence")
        statins.primary.comb$prevalence <- gsub('--', '-', statins.primary.comb$prevalence)  
        statins.primary.comb <- tidyr::separate(statins.primary.comb, prevalence, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.primary.comb$V2  <- gsub("[()]", "", statins.primary.comb$V2 )
        statins.primary.comb <- tidyr::separate(statins.primary.comb, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\-") 
        statins.primary.comb <- statins.primary.comb %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, pov_group, statin_treat_prim)  %>% pivot_wider(names_from = pov_group, values_from = statin_treat_prim)
  
        write.csv(statins.primary.comb, "~/statins.primary.comb.csv")
    
#bring into right format 
        statins.prev.all <- tidyr::separate(statins.prev.all, Prev_poorall, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.prev.all$V2  <- gsub("[()]", "", statins.prev.all$V2 )
        statins.prev.all <- tidyr::separate(statins.prev.all, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\--")
        statins.prev.all <- statins.prev.all %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1) %>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, statin_treat_prim)
        
         write.csv(statins.prev.all, "~/statins.prev.all.csv")

#to get total for each risk factor
  svymean(~statin_pri, statins.risk.55, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.55, level = 0.95)) 
  
  svymean(~statin_pri, statins.risk.0, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.0, level = 0.95)) 
  
  svymean(~statin_pri, statins.risk.all, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.all, level = 0.95)) 

#get significance level
  statins.primary.women <- statins.primary.women %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
      
  age3 <- filter(statins.primary.women, agegroup=='35-44')
  svychisq(~statin_pri + poor0, statin.primary.treat.age3) #0.004095
  
  age4 <- filter(statins.primary.women, agegroup=='45-54')
  statin.primary.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age4) #9.325e-05
  svychisq(~statin_pri + poor0, statin.primary.treat.age4) #9.325e-05
  
  age5 <- filter(statins.primary.women, agegroup=='55-64')
  statin.primary.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age5) #3.102e-08
  svychisq(~statin_pri + poor0, statin.primary.treat.age5) #3.102e-08
  
  age6 <- filter(statins.primary.women, agegroup=='>=65')
  statin.primary.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age6) #2.869e-07
  svychisq(~statin_pri + poor0, statin.primary.treat.age6) #2.869e-07

###secondary prevention
  statins.second.women <- select(cvd_risk_comb, country, statin_sec, sex, age, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  statins.second.women <- filter(statins.second.women, is.na(statin_sec)==F)
  statins.second.women <- filter(statins.second.women, is.na(w_dia_poor19_age)==F)
  statins.second.women <- filter(statins.second.women, is.na(poor19)==F)
  statins.second.women <- filter(statins.second.women, sex==1)
  statins.second.women <- statins.second.women %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
        age = as.integer(age),
        hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
        stratum = ifelse(is.na(stratum==T), 1, stratum))%>% 
    mutate(agegroup = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#limit to samples with denominator >50 respondents and nominator >5 respondents
#for poor19  
  statins.risk.19 <- statins.second.women %>% filter(poor19==1)
  statins.risk.19 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.19, nest = T)
  svymean(~statin_sec, statins.risk.19, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.19, level = 0.95))

#for poor32  
  statins.risk.32 <- statins.second.women %>% filter(poor32==1)
  #statins.risk.32<-statins.risk.32[!(statins.risk.32$poor32==1& statins.risk.32$agegroup=='35-44'),]
  #statins.risk.32<-statins.risk.32[!(statins.risk.32$poor32==1& statins.risk.32$agegroup=='>=65'),]#nominator
  statins.risk.32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.32, nest = T)
  statins.prev.32 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.32, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.32 <- unite_ci(statins.prev.32, "Prev_poor32", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor55
  statins.risk.55 <- statins.second.women %>% filter(poor55==1)
  statins.risk.55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.55, nest = T)
  statins.prev.55 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.55 <- unite_ci(statins.prev.55, "Prev_poor55", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor0
  statins.risk.0 <- statins.second.women %>% filter(poor55==0)
  statins.risk.0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.0, nest = T)
  statins.prev.0 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.0 <- unite_ci(statins.prev.0, "Prev_poor0", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for all povgroups
  statins.risk.second.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.second.women, nest = T)
  statins.prev.second.all <- svyby(~statin_sec, by=~agegroup, design=statins.risk.second.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  statins.prev.second.all <- unite_ci(statins.prev.second.all, "Prev_poorall", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#append
  statins.second.comb <- statins.prev.0 %>%
    left_join(statins.prev.55) %>%
    left_join(statins.prev.32) 

#bring into right format
        statins.second.comb <- statins.second.comb %>% pivot_longer(!agegroup, names_to = "pov_group", values_to = "prevalence")
        statins.second.comb$prevalence <- gsub('--', '-', statins.second.comb$prevalence)  
        statins.second.comb <- tidyr::separate(statins.second.comb, prevalence, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.second.comb$V2  <- gsub("[()]", "", statins.second.comb$V2 )
        statins.second.comb <- tidyr::separate(statins.second.comb, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\-") 
        statins.second.comb <- statins.second.comb %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, pov_group, statin_treat_prim)  %>% pivot_wider(names_from = pov_group, values_from = statin_treat_prim)
  
        write.csv(statins.second.comb, "~/statins.second.comb.csv")
    
#bring into right format 
        statins.prev.second.all <- tidyr::separate(statins.prev.second.all, Prev_poorall, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.prev.second.all$V2  <- gsub("[()]", "", statins.prev.second.all$V2 )
        statins.prev.second.all <- tidyr::separate(statins.prev.second.all, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\--")
        statins.prev.second.all <- statins.prev.second.all %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, statin_treat_prim)
        
        write.csv(statins.prev.second.all, "~/statins.prev.second.all.csv")

#to get total for each risk factor
  svymean(~statin_sec, statins.risk.32, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.32, level = 0.95))
  
  svymean(~statin_sec, statins.risk.55, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.55, level = 0.95)) 
  
  svymean(~statin_sec, statins.risk.0, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.0, level = 0.95)) 
  
  svymean(~statin_sec, statins.risk.second.all, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.second.all, level = 0.95)) 
  
  
#get significance level by agegroup
  statins.second.women <- statins.second.women %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
        
  age3 <- filter(statins.second.women, agegroup=='35-44')
  statin.primary.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~statin_sec + poor55, statin.primary.treat.age3) #0.6068
  svychisq(~statin_sec + poor0, statin.primary.treat.age3) #0.6068
  
  age4 <- filter(statins.second.women, agegroup=='45-54')
  statin.primary.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~statin_sec + poor32, statin.primary.treat.age4) #0.0003155
  svychisq(~statin_sec + poor55, statin.primary.treat.age4) #0.1836
  svychisq(~statin_sec + poor0, statin.primary.treat.age4) #0.1836
  
  age5 <- filter(statins.second.women, agegroup=='55-64')
  statin.primary.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~statin_sec + poor32, statin.primary.treat.age5) #2.376e-05
  svychisq(~statin_sec + poor55, statin.primary.treat.age5) #1.118e-08
  svychisq(~statin_sec + poor0, statin.primary.treat.age5) #1.118e-08
  
  age6 <- filter(statins.second.women, agegroup=='>=65')
  statin.primary.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~statin_sec + poor55, statin.primary.treat.age6) #7.9e-09
  svychisq(~statin_sec + poor0, statin.primary.treat.age6)#7.9e-09

###FIGURE S22: cascade prevalence for females
  
#bring into longer format
  hypt_treat <- hypt_treat %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "hypt treated") 
  hypt_control <- hypt_control %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "hypt controlled") 
  dia_treat <- dia_treat %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "dia treated") 
  statin_primary <- statin_primary %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "statin primary") 
  statin_secondary <- statin_secondary %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "statin secondary") 

#merge
  plot.all <- hypt_treat %>% 
    left_join(hypt_control) %>% 
    left_join(dia_treat) %>% 
    left_join(statin_primary) %>% 
    left_join(statin_secondary)
  
  plot.all <- plot.all[plot.all$agegroups != "all", ]

#plot cascades by agegroup
  plot.all <- plot.all %>% 
    gather(`hypt treated`, `hypt controlled`, `dia treated`, `statin primary`, `statin secondary`, key="step", value="temp")   
  plot.all <- tidyr::separate(plot.all, temp, c("est", "V2"), "\\s(?:.+\\s)?")
  plot.all$V2  <- gsub("[()]", "", plot.all$V2 )
  plot.all <- tidyr::separate(plot.all, V2, c("lowci", "highci"), "\\-") 
  plot.all <- plot.all %>% 
    mutate(step = fct_relevel(step, 
           "hypt treated", "hypt controlled", "dia treated", "statin primary", "statin secondary"),
            est = as.numeric(est),
            lowci = as.numeric(lowci),
            highci = as.numeric(highci),
            pov_group = as.character(pov_group))
  plot.all$agegroups <- plot.all$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65", "all"))
  plot.all$pov_group <- plot.all$pov_group %>% factor(c("poor19", "poor32", "poor55", "poor0", "allpov"))
  
  cols <- c("poor19" = "#FEE8C8", "poor32" = "#FDD49E", "poor55" = "#FDBB84", "poor0" = "#EF6548", "allpov" = "black")

  cascades.all.women <- ggplot(plot.all, aes(x=step, y=est, fill=pov_group)) +
      geom_bar(stat='identity', position='dodge')+
      geom_errorbar(aes(ymin=lowci, ymax=highci), width=.2,
                   position=position_dodge(.9), show.legend = F) +
      theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=18, face="bold"),
          legend.text=element_text(size=18, family="Times"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=18, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=18, face="bold", family="Times")) + 
     scale_y_continuous(breaks = c(0, 20, 40, 60, 80)) +
     coord_cartesian(ylim=c(0, 80)) +
     facet_wrap(~agegroups) +
     labs(x = "",
         y = "%",
         fill="") +
     scale_fill_manual(values = c("#FEE8C8", "#FDD49E", "#FDBB84", "#EF6548", "black"), labels=c("poor19" = "<$1.90/day", "poor32" = "<$3.20/day", 
                                                                                                 "poor55" = "<$5.50/day", "poor0" = ">$5.50/day", 
                                                                                                 "allpov" = "Total")) +
    coord_fixed(5/80) ##stopped here
    ggsave("cascades.all.women.png", height = 12, width = 16)

#Version 2: complete agegroups only
  plot.all <- plot.all %>% 
    gather(`hypt treated`, `hypt controlled`, `dia treated`, `statin primary`, `statin secondary`, key="step", value="temp")  
  plot.all <- tidyr::separate(plot.all, temp, c("est", "V2"), "\\s(?:.+\\s)?")
  plot.all$V2  <- gsub("[()]", "", plot.all$V2 )
  plot.all <- tidyr::separate(plot.all, V2, c("lowci", "highci"), "\\-") 
  plot.all <- plot.all %>% 
    mutate(step = fct_relevel(step, 
                 "hypt treated", "hypt controlled", "dia treated", "statin primary", "statin secondary"),
            est = as.numeric(est),
            lowci = as.numeric(lowci),
            highci = as.numeric(highci),
            pov_group = as.character(pov_group))
  
  plot.all <- filter(plot.all, agegroups!='15-24')
  plot.all <- filter(plot.all, agegroups!='25-34')
  plot.all <- filter(plot.all, agegroups!='35-44')
  plot.all$agegroups <- plot.all$agegroups %>% factor(c("45-54", "55-64", ">=65", "all"))
  plot.all$pov_group <- plot.all$pov_group %>% factor(c("poor19", "poor32", "poor55", "poor0", "allpov"))
  
  cols <- c("poor19" = "#FEE8C8", "poor32" = "#FDD49E", "poor55" = "#FDBB84", "poor0" = "#EF6548", "allpov" = "black")
  
  cascades.all.women.completeage.only <- ggplot(plot.all, aes(x=step, y=est, fill=pov_group)) +
      geom_bar(stat='identity', position='dodge')+
      geom_errorbar(aes(ymin=lowci, ymax=highci), width=.2,
                   position=position_dodge(.9), show.legend = F) +
      theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=18, face="bold"),
          legend.text=element_text(size=18, family="Times"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=18, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=18, face="bold", family="Times")) + 
     scale_y_continuous(breaks = c(0, 20, 40, 60, 80)) +
     coord_cartesian(ylim=c(0, 80)) +
     facet_wrap(~agegroups) +
     labs(x = "",
         y = "%",
         fill="") +
     scale_fill_manual(values = c("#FEE8C8", "#FDD49E", "#FDBB84", "#EF6548", "black"), labels=c("poor19" = "<$1.90/day", "poor32" = "<$3.20/day", 
                                                                                                 "poor55" = "<$5.50/day", "poor0" = ">$5.50/day", 
                                                                                                 "allpov" = "Total")) +
     coord_fixed(5/80)
  
     ggsave("cascades.all.women.completeage.only.png", height = 12, width = 16)

###CASCADE - SAME PROCEDURE FOR MALES

#calculate proportions with surveydesign
  hypt_meds.men <- select(hypt_cascades_subset, country, sex, age, all_hypt, hypt_treat, w_hypt_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  hypt_meds.men <- filter(hypt_meds.men, is.na(all_hypt)==F)
  hypt_meds.men <- filter(hypt_meds.men, all_hypt==1)
  hypt_meds.men <- filter(hypt_meds.men, is.na(hypt_treat)==F)
  hypt_meds.men <- filter(hypt_meds.men, is.na(w_hypt_poor19_age)==F)
  hypt_meds.men <- filter(hypt_meds.men, is.na(poor19)==F)
  hypt_meds.men <- filter(hypt_meds.men, sex==0)
  hypt_meds.men <- hypt_meds.men %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  hypt_meds.men <- filter(hypt_meds.men, age<=95)
  hypt_meds.men <-hypt_meds.men %>% 
    mutate(agegroups = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#for each poverty group
  risk.hypt.pov19.cascades.men <- hypt_meds.men %>% filter(poor19==1)
  risk.hypt.pov19.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19.cascades.men, nest = T)
  
  risk.hypt.pov32.cascades.men <- hypt_meds.men %>% filter(poor32==1)
  risk.hypt.pov32.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32.cascades.men, nest = T)
  
  risk.hypt.pov55.cascades.men <- hypt_meds.men %>% filter(poor55==1)
  risk.hypt.pov55.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55.cascades.men, nest = T)
  
  risk.hypt.pov0.cascades.men <- hypt_meds.men %>% filter(poor55==0)
  risk.hypt.pov0.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0.cascades.men, nest = T)
  
  risk.hypt.all_povgroups.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_meds.men, nest = T)

#to get the total for all age groupss
  prev.hypt.pov19.cascades.men <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov19.cascades.men, svyciprop, proportion=TRUE, prop_method="asin",
                                        vartype = "ci")
  prev.hypt.pov19.cascades.men <- unite_ci(prev.hypt.pov19.cascades.men, "Prev_poor19", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.cascades.men <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov32.cascades.men, svyciprop, proportion=TRUE, prop_method="asin",
                                        vartype = "ci")
  prev.hypt.pov32.cascades.men <- unite_ci(prev.hypt.pov32.cascades.men, "Prev_poor32", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.cascades.men <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov55.cascades.men, svyciprop, proportion=TRUE, prop_method="asin",
                                        vartype = "ci")
  prev.hypt.pov55.cascades.men <- unite_ci(prev.hypt.pov55.cascades.men, "Prev_poor55", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.cascades.men <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.pov0.cascades.men, svyciprop, proportion=TRUE, prop_method="asin", 
                                       vartype = "ci")
  prev.hypt.pov0.cascades.men <- unite_ci(prev.hypt.pov0.cascades.men, "Prev_poor0", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.cascades.men <- svyby(~hypt_treat, by=~agegroups, design=risk.hypt.all_povgroups.cascades.men, svyciprop, proportion=TRUE, 
                                         prop_method="asin", vartype = "ci")
  prev.hypt.allpov.cascades.men <- unite_ci(prev.hypt.allpov.cascades.men, "Prev_allpov", hypt_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalence by agegroups
  prev.hypt.agegroups.cascades.men <- prev.hypt.pov19.cascades.men %>% 
    left_join(prev.hypt.pov32.cascades.men) %>% 
    left_join(prev.hypt.pov55.cascades.men) %>% 
    left_join(prev.hypt.pov0.cascades.men)
  
#bring into right format     
    prev.hypt.agegroups.cascades.men <- prev.hypt.agegroups.cascades.men %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.hypt.agegroups.cascades.men$prevalence <- gsub('--', '-', prev.hypt.agegroups.cascades.men$prevalence)  
    prev.hypt.agegroups.cascades.men <- tidyr::separate(prev.hypt.agegroups.cascades.men, prevalence, c("hypt_treat", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.agegroups.cascades.men$V2  <- gsub("[()]", "", prev.hypt.agegroups.cascades.men$V2 )
    prev.hypt.agegroups.cascades.men <- tidyr::separate(prev.hypt.agegroups.cascades.men, V2, c("cil_hypt", "ciu_hypt"), "\\-") 
    prev.hypt.agegroups.cascades.men <- prev.hypt.agegroups.cascades.men %>% 
      mutate(hypt_treat = as.numeric(hypt_treat),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_treat = str_c(as.character(hypt_treat), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_treat)  %>% pivot_wider(names_from = pov_group, values_from = hypt_treat)
  
    write.csv(prev.hypt.agegroups.cascades.men, "~/prev.hypt.agegroups.cascades.men.csv")
    
#bring into right format 
    prev.hypt.allpov.cascades.men <- prev.hypt.allpov.cascades.men %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
    prev.hypt.allpov.cascades.men$prevalence <- gsub('--', '-', prev.hypt.allpov.cascades.men$prevalence)  
    prev.hypt.allpov.cascades.men <- tidyr::separate(prev.hypt.allpov.cascades.men, prevalence, c("hypt_treat", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.allpov.cascades.men$V2  <- gsub("[()]", "", prev.hypt.allpov.cascades.men$V2 )
    prev.hypt.allpov.cascades.men <- tidyr::separate(prev.hypt.allpov.cascades.men, V2, c("cil_hypt", "ciu_hypt"), "\\-")
    prev.hypt.allpov.cascades.men <- prev.hypt.allpov.cascades.men %>% 
      mutate(hypt_treat = as.numeric(hypt_treat),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_treat = str_c(as.character(hypt_treat), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_treat) %>% pivot_wider(names_from = pov_group, values_from = hypt_treat)
        
    write.csv(prev.hypt.allpov.cascades.men, "~/prev.hypt.allpov.cascades.men.csv")
  
#to get total for each risk factor
  svymean(~hypt_treat, risk.hypt.pov19.cascades.men, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov19.cascades.men, level = 0.95))  
  
  svymean(~hypt_treat, risk.hypt.pov32.cascades.men, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov32.cascades.men, level = 0.95))
  
  svymean(~hypt_treat, risk.hypt.pov55.cascades.men, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov55.cascades.men, level = 0.95)) 
  
  svymean(~hypt_treat, risk.hypt.pov0.cascades.men, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.pov0.cascades.men, level = 0.95)) 
  
  svymean(~hypt_treat, risk.hypt.all_povgroups.cascades.men, deff=TRUE)  
  confint(svymean(~hypt_treat, risk.hypt.all_povgroups.cascades.men, level = 0.95)) 

#check if difference between poor and non-poor is significant: get p-values
  hypt_meds.men <- hypt_meds.men %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(hypt_meds.men, agegroups=='15-24')
  hypt.meds.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age1, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age1) # 0.104
  svychisq(~hypt_treat + poor32, hypt.meds.age1) #0.512
  svychisq(~hypt_treat + poor55, hypt.meds.age1) #0.05687
  svychisq(~hypt_treat + poor0, hypt.meds.age1)# 0.05687
  
  age2 <- filter(hypt_meds.men, agegroups=='25-34')
  hypt.meds.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age2, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age2) #3.55e-09
  svychisq(~hypt_treat + poor32, hypt.meds.age2) #6.457e-08
  svychisq(~hypt_treat + poor55, hypt.meds.age2) #0.001261
  svychisq(~hypt_treat + poor0, hypt.meds.age2)#0.001261
  
  age3 <- filter(hypt_meds.men, agegroups=='35-44')
  hypt.meds.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age3, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age3) #0.5888
  svychisq(~hypt_treat + poor32, hypt.meds.age3) #0.01693
  svychisq(~hypt_treat + poor55, hypt.meds.age3) #0.00592
  svychisq(~hypt_treat + poor0, hypt.meds.age3)#0.00592
  
  age4 <- filter(hypt_meds.men, agegroups=='45-54')
  hypt.meds.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age4, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age4) #0.008044
  svychisq(~hypt_treat + poor32, hypt.meds.age4) #6.861e-05
  svychisq(~hypt_treat + poor55, hypt.meds.age4) #0.007292
  svychisq(~hypt_treat + poor0, hypt.meds.age4)#0.007292

  age5 <- filter(hypt_meds.men, agegroups=='55-64')
  hypt.meds.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age5, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age5) #0.3098
  svychisq(~hypt_treat + poor32, hypt.meds.age5) #0.004294
  svychisq(~hypt_treat + poor55, hypt.meds.age5) #4.795e-08
  svychisq(~hypt_treat + poor0, hypt.meds.age5)#4.795e-08
  
  age6 <- filter(hypt_meds.men, agegroups=='>=65')
  hypt.meds.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age6, nest = T)
  svychisq(~hypt_treat + poor19, hypt.meds.age6) #9.026e-05
  svychisq(~hypt_treat + poor32, hypt.meds.age6) #4.582e-05
  svychisq(~hypt_treat + poor55, hypt.meds.age6) #1.556e-05
  svychisq(~hypt_treat + poor0, hypt.meds.age6)# 1.556e-05

###CASCADE 2:hypertensive who achieved control
  hypt_control.men <- select(hypt_cascades_subset, country, sex, age, all_hypt, hypt_ctrl, w_hypt_poor19_age, psu, stratum, hh_id, poor19, poor32, 
                             poor55)
  hypt_control.men <- filter(hypt_control.men, is.na(all_hypt)==F)
  hypt_control.men <- filter(hypt_control.men, all_hypt==1)
  hypt_control.men <- filter(hypt_control.men, is.na(hypt_ctrl)==F)
  hypt_control.men <- filter(hypt_control.men, is.na(w_hypt_poor19_age)==F)
  hypt_control.men <- filter(hypt_control.men, is.na(poor19)==F)
  hypt_control.men <- filter(hypt_control.men, sex==0)
  hypt_control.men <- hypt_control.men %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum))
  hypt_control.men <-hypt_control.men %>% 
    mutate(agegroups = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#for each poverty group
  risk.hypt.pov19.cascades.ctrl.men <- hypt_control.men %>% filter(poor19==1)
  risk.hypt.pov19.cascades.ctrl.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov19.cascades.ctrl.men, 
                                                 nest = T)
  
  risk.hypt.pov32.cascades.ctrl.men <- hypt_control.men %>% filter(poor32==1)
  risk.hypt.pov32.cascades.ctrl.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov32.cascades.ctrl.men, 
                                                 nest = T)
  
  risk.hypt.pov55.cascades.ctrl.men <- hypt_control.men %>% filter(poor55==1)
  risk.hypt.pov55.cascades.ctrl.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov55.cascades.ctrl.men, 
                                                 nest = T)
  
  risk.hypt.pov0.cascades.ctrl.men <- hypt_control.men %>% filter(poor55==0)
  risk.hypt.pov0.cascades.ctrl.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=risk.hypt.pov0.cascades.ctrl.men, nest 
                                                = T)
  
  risk.hypt.all_povgroups.cascades.ctrl.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=hypt_control.men, nest = T)

#to get the total for all age groupss
  prev.hypt.pov19.cascades.ctrl.men <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov19.cascades.ctrl.men, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.hypt.pov19.cascades.ctrl.men <- unite_ci(prev.hypt.pov19.cascades.ctrl.men, "Prev_poor19", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.hypt.pov32.cascades.ctrl.men <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov32.cascades.ctrl.men, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.hypt.pov32.cascades.ctrl.men <- unite_ci(prev.hypt.pov32.cascades.ctrl.men, "Prev_poor32", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov55.cascades.ctrl.men <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov55.cascades.ctrl.men, svyciprop, proportion=TRUE, 
                                             prop_method="asin", vartype = "ci")
  prev.hypt.pov55.cascades.ctrl.men <- unite_ci(prev.hypt.pov55.cascades.ctrl.men, "Prev_poor55", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.pov0.cascades.ctrl.men <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.pov0.cascades.ctrl.men, svyciprop, proportion=TRUE, 
                                            prop_method="asin", vartype = "ci")
  prev.hypt.pov0.cascades.ctrl.men <- unite_ci(prev.hypt.pov0.cascades.ctrl.men, "Prev_poor0", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.hypt.allpov.cascades.ctrl.men <- svyby(~hypt_ctrl, by=~agegroups, design=risk.hypt.all_povgroups.cascades.ctrl.men, svyciprop, proportion=TRUE, 
                                              prop_method="asin", vartype = "ci")
  prev.hypt.allpov.cascades.ctrl.men <- unite_ci(prev.hypt.allpov.cascades.ctrl.men, "Prev_allpov", hypt_ctrl, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.hypt.agegroups.cascades.ctrl.men <- prev.hypt.pov19.cascades.ctrl.men %>% 
    left_join(prev.hypt.pov32.cascades.ctrl.men) %>% 
    left_join(prev.hypt.pov55.cascades.ctrl.men) %>% 
    left_join(prev.hypt.pov0.cascades.ctrl.men)

#bring into right format     
    prev.hypt.agegroups.cascades.ctrl.men <- prev.hypt.agegroups.cascades.ctrl.men %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                                      "prevalence")
    prev.hypt.agegroups.cascades.ctrl.men$prevalence <- gsub('--', '-', prev.hypt.agegroups.cascades.ctrl.men$prevalence)  
    prev.hypt.agegroups.cascades.ctrl.men <- tidyr::separate(prev.hypt.agegroups.cascades.ctrl.men, prevalence, c("hypt_ctrl", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.agegroups.cascades.ctrl.men$V2  <- gsub("[()]", "", prev.hypt.agegroups.cascades.ctrl.men$V2 )
    prev.hypt.agegroups.cascades.ctrl.men <- tidyr::separate(prev.hypt.agegroups.cascades.ctrl.men, V2, c("cil_hypt", "ciu_hypt"), "\\-") 
    prev.hypt.agegroups.cascades.ctrl.men <- prev.hypt.agegroups.cascades.ctrl.men %>% 
      mutate(hypt_ctrl = as.numeric(hypt_ctrl),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1)%>% 
      mutate(hypt_ctrl = str_c(as.character(hypt_ctrl), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_ctrl)  %>% pivot_wider(names_from = pov_group, values_from = hypt_ctrl)
  
    write.csv(prev.hypt.agegroups.cascades.ctrl.men, "~/prev.hypt.agegroups.cascades.ctrl.men.csv")
    
#bring into right format 
    prev.hypt.allpov.cascades.ctrl.men <- prev.hypt.allpov.cascades.ctrl.men %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                                "prevalence")
    prev.hypt.allpov.cascades.ctrl.men$prevalence <- gsub('--', '-', prev.hypt.allpov.cascades.ctrl.men$prevalence)  
    prev.hypt.allpov.cascades.ctrl.men <- tidyr::separate(prev.hypt.allpov.cascades.ctrl.men, prevalence, c("hypt_ctrl", "V2"), "\\s(?:.+\\s)?")
    prev.hypt.allpov.cascades.ctrl.men$V2  <- gsub("[()]", "", prev.hypt.allpov.cascades.ctrl.men$V2 )
    prev.hypt.allpov.cascades.ctrl.men <- tidyr::separate(prev.hypt.allpov.cascades.ctrl.men, V2, c("cil_hypt", "ciu_hypt"), "\\-")
    prev.hypt.allpov.cascades.ctrl.men <- prev.hypt.allpov.cascades.ctrl.men %>% 
      mutate(hypt_ctrl = as.numeric(hypt_ctrl),
          cil_hypt = as.numeric(cil_hypt),
          ciu_hypt = as.numeric(ciu_hypt))  %>% 
      mutate_if(is.numeric, round, digits = 1) %>% 
      mutate(hypt_ctrl = str_c(as.character(hypt_ctrl), " (", as.character(cil_hypt), "-", as.character(ciu_hypt), ")", sep="")) %>%
      select(agegroups, pov_group, hypt_ctrl) %>% pivot_wider(names_from = pov_group, values_from = hypt_ctrl)
        
    write.csv(prev.hypt.allpov.cascades.ctrl.men, "~/prev.hypt.allpov.cascades.ctrl.men.csv")
  
#to get total for each risk factor
  svymean(~hypt_ctrl, risk.hypt.pov19.cascades.ctrl.men, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov19.cascades.ctrl.men, level = 0.95))  
  
  svymean(~hypt_ctrl, risk.hypt.pov32.cascades.ctrl.men, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov32.cascades.ctrl.men, level = 0.95))
  
  svymean(~hypt_ctrl, risk.hypt.pov55.cascades.ctrl.men, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov55.cascades.ctrl.men, level = 0.95)) 
  
  svymean(~hypt_ctrl, risk.hypt.pov0.cascades.ctrl.men, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.pov0.cascades.ctrl.men, level = 0.95)) 
  
  svymean(~hypt_ctrl, risk.hypt.all_povgroups.cascades.ctrl.men, deff=TRUE)  
  confint(svymean(~hypt_ctrl, risk.hypt.all_povgroups.cascades.ctrl.men, level = 0.95)) 

#get p-values
  hypt_control.men <- hypt_control.men %>% mutate(
    poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(hypt_control.men, agegroups=='15-24')
  hypt.control.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age1, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age1) # 0.2736
  svychisq(~hypt_ctrl + poor32, hypt.control.age1) #0.9667
  svychisq(~hypt_ctrl + poor55, hypt.control.age1) #0.6289
  svychisq(~hypt_ctrl + poor0, hypt.control.age1)#0.6289
  
  age2 <- filter(hypt_control.men, agegroups=='25-34')
  hypt.control.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age2, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age2) #0.0002052
  svychisq(~hypt_ctrl + poor32, hypt.control.age2) #0.007212
  svychisq(~hypt_ctrl + poor55, hypt.control.age2) #0.00176
  svychisq(~hypt_ctrl + poor0, hypt.control.age2) #0.00176
  
  age3 <- filter(hypt_control.men, agegroups=='35-44')
  hypt.control.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age3, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age3) #0.8107
  svychisq(~hypt_ctrl + poor32, hypt.control.age3) #0.03894
  svychisq(~hypt_ctrl + poor55, hypt.control.age3) #0.2256
  svychisq(~hypt_ctrl + poor0, hypt.control.age3)# 0.2256
  
  age4 <- filter(hypt_control.men, agegroups=='45-54')
  hypt.control.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age4, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age4) #0.151
  svychisq(~hypt_ctrl + poor32, hypt.control.age4) #0.2753
  svychisq(~hypt_ctrl + poor55, hypt.control.age4) #0.005317
  svychisq(~hypt_ctrl + poor0, hypt.control.age4)#0.005317
  
  age5 <- filter(hypt_control.men, agegroups=='55-64')
  hypt.control.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age5, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age5) # 0.1992
  svychisq(~hypt_ctrl + poor32, hypt.control.age5) #0.009611
  svychisq(~hypt_ctrl + poor55, hypt.control.age5) #7.105e-05
  svychisq(~hypt_ctrl + poor0, hypt.control.age5)#7.105e-05
  
  age6 <- filter(hypt_control.men, agegroups=='>=65')
  hypt.control.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_hypt_poor19_age, data=age6, nest = T)
  svychisq(~hypt_ctrl + poor19, hypt.control.age6) #0.008742
  svychisq(~hypt_ctrl + poor32, hypt.control.age6) #0.006568
  svychisq(~hypt_ctrl + poor55, hypt.control.age6) #0.0261
  svychisq(~hypt_ctrl + poor0, hypt.control.age6)#0.0261


###CASCADE 3: diabetes meds 
#plot proportion of extreme poor with diabetes who take medication
  dia_meds.men <- select(dia_cascades_subset, country, sex, age, all_dia, dia_treat, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  dia_meds.men <- filter(dia_meds.men, is.na(all_dia)==F)
  dia_meds.men <- filter(dia_meds.men, all_dia==1)
  dia_meds.men <- filter(dia_meds.men, is.na(dia_treat)==F)
  dia_meds.men <- filter(dia_meds.men, is.na(w_dia_poor19_age)==F)
  dia_meds.men <- filter(dia_meds.men, is.na(poor19)==F)
  dia_meds.men <- filter(dia_meds.men, sex==0)
  dia_meds.men <- dia_meds.men %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
        age = as.integer(age),
        hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
        stratum = ifelse(is.na(stratum==T), 1, stratum))%>% 
    mutate(agegroups = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#for each poverty group
  risk.dia.pov19.cascades.men <- dia_meds.men %>% filter(poor19==1)
  #remove prevalences from samples <50
  #dia_meds.men<-dia_meds.men[!(dia_meds.men$poor19==1 & dia_meds.men$agegroup=='>=65' & dia_meds.men$sex==0),]
  risk.dia.pov19.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov19.cascades.men, nest = T)
  
  risk.dia.pov32.cascades.men <- dia_meds.men %>% filter(poor32==1)
  risk.dia.pov32.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov32.cascades.men, nest = T)
  
  risk.dia.pov55.cascades.men <- dia_meds.men %>% filter(poor55==1)
  risk.dia.pov55.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov55.cascades.men, nest = T)
  
  risk.dia.pov0.cascades.men <- dia_meds.men %>% filter(poor55==0)
  risk.dia.pov0.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=risk.dia.pov0.cascades.men, nest = T)
  
  risk.dia.all_povgroups.cascades.men <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=dia_meds.men, nest = T)

#to get the total for all age groupss
  prev.dia.pov19.cascades.men <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov19.cascades.men, svyciprop, proportion=TRUE, prop_method="asin", 
                                       vartype = "ci")
  prev.dia.pov19.cascades.men <- unite_ci(prev.dia.pov19.cascades.men, "Prev_poor19", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)

  prev.dia.pov32.cascades.men <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov32.cascades.men, svyciprop, proportion=TRUE, prop_method="asin", 
                                       vartype = "ci")
  prev.dia.pov32.cascades.men <- unite_ci(prev.dia.pov32.cascades.men, "Prev_poor32", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov55.cascades.men <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov55.cascades.men, svyciprop, proportion=TRUE, prop_method="asin", 
                                       vartype = "ci")
  prev.dia.pov55.cascades.men <- unite_ci(prev.dia.pov55.cascades.men, "Prev_poor55", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.pov0.cascades.men <- svyby(~dia_treat, by=~agegroups, design=risk.dia.pov0.cascades.men, svyciprop, proportion=TRUE, prop_method="asin", 
                                      vartype = "ci")
  prev.dia.pov0.cascades.men <- unite_ci(prev.dia.pov0.cascades.men, "Prev_poor0", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
  prev.dia.allpov.cascades.men <- svyby(~dia_treat, by=~agegroups, design=risk.dia.all_povgroups.cascades.men, svyciprop, proportion=TRUE, 
                                        prop_method="asin", vartype = "ci")
  prev.dia.allpov.cascades.men <- unite_ci(prev.dia.allpov.cascades.men, "Prev_allpov", dia_treat, ci_l, ci_u, m100 = T, percent = FALSE)
  
#merge prevalences by agegroups
  prev.dia.agegroups.cascades.men <- prev.dia.pov32.cascades.men %>% 
    left_join(prev.dia.pov19.cascades.men) %>% 
    left_join(prev.dia.pov55.cascades.men) %>% 
    left_join(prev.dia.pov0.cascades.men)
  
#bring into right format  
        prev.dia.agegroups.cascades.men <- prev.dia.agegroups.cascades.men %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = 
                                                                                              "prevalence")
        prev.dia.agegroups.cascades.men$prevalence <- gsub('--', '-', prev.dia.agegroups.cascades.men$prevalence)  
        prev.dia.agegroups.cascades.men <- tidyr::separate(prev.dia.agegroups.cascades.men, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
        prev.dia.agegroups.cascades.men$V2  <- gsub("[()]", "", prev.dia.agegroups.cascades.men$V2 )
        prev.dia.agegroups.cascades.men <- tidyr::separate(prev.dia.agegroups.cascades.men, V2, c("cil_dia", "ciu_dia"), "\\-") 
        prev.dia.agegroups.cascades.men <- prev.dia.agegroups.cascades.men %>% 
          mutate(dia_treat = as.numeric(dia_treat),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
          select(agegroups, pov_group, dia_treat)  %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
  
         write.csv(prev.dia.agegroups.cascades.men, "~/prev.dia.agegroups.cascades.men.csv")
    
#bring into right format 
        prev.dia.allpov.cascades.men <- prev.dia.allpov.cascades.men %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "prevalence")
        prev.dia.allpov.cascades.men$prevalence <- gsub('--', '-', prev.dia.allpov.cascades.men$prevalence)  
        prev.dia.allpov.cascades.men <- tidyr::separate(prev.dia.allpov.cascades.men, prevalence, c("dia_treat", "V2"), "\\s(?:.+\\s)?")
        prev.dia.allpov.cascades.men$V2  <- gsub("[()]", "", prev.dia.allpov.cascades.men$V2 )
        prev.dia.allpov.cascades.men <- tidyr::separate(prev.dia.allpov.cascades.men, V2, c("cil_dia", "ciu_dia"), "\\-")
        prev.dia.allpov.cascades.men <- prev.dia.allpov.cascades.men %>% 
          mutate(dia_treat = as.numeric(dia_treat),
          cil_dia = as.numeric(cil_dia),
          ciu_dia = as.numeric(ciu_dia))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(dia_treat = str_c(as.character(dia_treat), " (", as.character(cil_dia), "-", as.character(ciu_dia), ")", sep="")) %>%
          select(agegroups, pov_group, dia_treat) %>% pivot_wider(names_from = pov_group, values_from = dia_treat)
        
         write.csv(prev.dia.allpov.cascades.men, "~/prev.dia.allpov.cascades.men.csv")
  
#to get total for each poverty group
  svymean(~dia_treat, risk.dia.pov19.cascades.men, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov19.cascades.men, level = 0.95))  
  
  svymean(~dia_treat, risk.dia.pov32.cascades.men, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov32.cascades.men, level = 0.95))
  
  svymean(~dia_treat, risk.dia.pov55.cascades.men, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov55.cascades.men, level = 0.95)) 
  
  svymean(~dia_treat, risk.dia.pov0.cascades.men, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.pov0.cascades.men, level = 0.95)) 
  
  svymean(~dia_treat, risk.dia.all_povgroups.cascades.men, deff=TRUE)  
  confint(svymean(~dia_treat, risk.dia.all_povgroups.cascades.men, level = 0.95)) 
  
#get significance levels  
  dia_meds.men <- dia_meds.men %>% mutate(
    poor0 = ifelse(poor55==0, 1, 0))
    
  age1 <- filter(dia_meds.men, agegroups=='15-24')
  dia.treat.age1 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age1, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age1) #0.1366
  svychisq(~dia_treat + poor32, dia.treat.age1) #0.3989
  svychisq(~dia_treat + poor55, dia.treat.age1) #0.9147
  svychisq(~dia_treat + poor0, dia.treat.age1) #0.9147
  
  
  age2 <- filter(dia_meds.men, agegroups=='25-34')
  dia.treat.age2 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age2, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age2) #0.02101
  svychisq(~dia_treat + poor32, dia.treat.age2) #0.5581
  svychisq(~dia_treat + poor55, dia.treat.age2) #0.8509
  svychisq(~dia_treat + poor0, dia.treat.age2) #0.8509
  
  age3 <- filter(dia_meds.men, agegroups=='35-44')
  dia.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age3) #0.0001198
  svychisq(~dia_treat + poor32, dia.treat.age3) #0.141
  svychisq(~dia_treat + poor55, dia.treat.age3) #0.007468
  svychisq(~dia_treat + poor0, dia.treat.age3) #0.007468
  
  age4 <- filter(dia_meds.men, agegroups=='45-54')
  dia.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age4) #0.1326
  svychisq(~dia_treat + poor32, dia.treat.age4) #6.238e-05
  svychisq(~dia_treat + poor55, dia.treat.age4) #0.0007651
  svychisq(~dia_treat + poor0, dia.treat.age4) #0.0007651
  
  age5 <- filter(dia_meds.men, agegroups=='55-64')
  dia.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age5) #0.001613
  svychisq(~dia_treat + poor32, dia.treat.age5) #2.738e-06
  svychisq(~dia_treat + poor55, dia.treat.age5) #5.936e-11
  svychisq(~dia_treat + poor0, dia.treat.age5) #5.936e-11
  
  age6 <- filter(dia_meds.men, agegroups=='>=65')
  dia.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~dia_treat + poor19, dia.treat.age6) #0.0006774
  svychisq(~dia_treat + poor32, dia.treat.age6) #0.0006371
  svychisq(~dia_treat + poor55, dia.treat.age6) #1.462e-05
  svychisq(~dia_treat + poor0, dia.treat.age6) #1.462e-05

###CASCADES:statins
  
#calculate prevalence for primary prevention
  statins.primary.men <- select(cvd_risk_comb, country, statin_pri, sex, age, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  statins.primary.men <- filter(statins.primary.men, is.na(statin_pri)==F)
  statins.primary.men <- filter(statins.primary.men, is.na(w_dia_poor19_age)==F)
  statins.primary.men <- filter(statins.primary.men, is.na(poor19)==F)
  statins.primary.men <- filter(statins.primary.men, sex==0)
  statins.primary.men <- statins.primary.men %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
        age = as.integer(age),
        hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
        stratum = ifelse(is.na(stratum==T), 1, stratum))%>% 
    mutate(agegroup = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))
#for poor55
  statins.risk.55 <- statins.primary.men %>% filter(poor55==1)
  #statins.risk.55<-statins.risk.55[!(statins.risk.55$poor55==1 & statins.risk.55$agegroup=='45-54'),]
  #statins.risk.55<-statins.risk.55[!(statins.risk.55$poor55==1 & statins.risk.55$agegroup=='35-44'),]
  #statins.risk.55<-statins.risk.55[!(statins.risk.55$poor55==1 & statins.risk.55$agegroup=='>=65'),] 
  statins.risk.55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.55, nest = T)
  statins.prev.55 <- svyby(~statin_pri, by=~agegroup, design=statins.risk.55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.55 <- unite_ci(statins.prev.55, "Prev_poor55", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor0
  statins.risk.0 <- statins.primary.men %>% filter(poor55==0)
  #statins.risk.0<-statins.risk.0[!(statins.risk.0$poor55==0 & statins.risk.0$agegroup=='35-44'),]
  statins.risk.0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.0, nest = T)
  statins.prev.0 <- svyby(~statin_pri, by=~agegroup, design=statins.risk.0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.0 <- unite_ci(statins.prev.0, "Prev_poor0", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

#for all povgroups
  statins.risk.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.primary.men, nest = T)
  #statins.risk.all<-statins.risk.all[!(statins.risk.all$agegroup=='35-44'),]
  statins.prev.all <- svyby(~statin_pri, by=~agegroup, design=statins.risk.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.all <- unite_ci(statins.prev.all, "Prev_poorall", statin_pri, ci_l, ci_u, m100 = T, percent = FALSE)

  statins.primary.comb <- statins.prev.0 %>%
    left_join(statins.prev.55)

#bring into right format
        statins.primary.comb <- statins.primary.comb %>% pivot_longer(!agegroup, names_to = "pov_group", values_to = "prevalence")
        statins.primary.comb$prevalence <- gsub('--', '-', statins.primary.comb$prevalence)  
        statins.primary.comb <- tidyr::separate(statins.primary.comb, prevalence, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.primary.comb$V2  <- gsub("[()]", "", statins.primary.comb$V2 )
        statins.primary.comb <- tidyr::separate(statins.primary.comb, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\-") 
        statins.primary.comb <- statins.primary.comb %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, pov_group, statin_treat_prim)  %>% pivot_wider(names_from = pov_group, values_from = statin_treat_prim)
  
        write.csv(statins.primary.comb, "~/statins.primary.comb.csv")
    
#bring into right format 
        statins.prev.all <- tidyr::separate(statins.prev.all, Prev_poorall, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.prev.all$V2  <- gsub("[()]", "", statins.prev.all$V2 )
        statins.prev.all <- tidyr::separate(statins.prev.all, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\--")
        statins.prev.all <- statins.prev.all %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
          cil_statin_prim = as.numeric(cil_statin_prim),
          ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1) %>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")", sep="")) %>%
          select(agegroup, statin_treat_prim)
        
         write.csv(statins.prev.all, "~/statins.prev.all.csv")

#to get totals
  svymean(~statin_pri, statins.risk.55, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.55, level = 0.95)) 
  
  svymean(~statin_pri, statins.risk.0, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.0, level = 0.95)) 
  
  svymean(~statin_pri, statins.risk.all, deff=TRUE)  
  confint(svymean(~statin_pri, statins.risk.all, level = 0.95)) 

#get significance level
  statins.primary.men <- statins.primary.men %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
  
  age4 <- filter(statins.primary.men, agegroup=='45-54')
  statin.primary.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~statin_pri + poor0, statin.primary.treat.age4) #0.07132
  
  age5 <- filter(statins.primary.men, agegroup=='55-64')
  statin.primary.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~statin_pri + poor55, statin.primary.treat.age5) #2.311e-05
  svychisq(~statin_pri + poor0, statin.primary.treat.age5) #2.311e-05
  
  age6 <- filter(statins.primary.men, agegroup=='>=65')
  statin.primary.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~statin_pri + poor0, statin.primary.treat.age6)#1.767e-10

###secondary prevention
  statins.second.men <- select(cvd_risk_comb, country, statin_sec, sex, age, w_dia_poor19_age, psu, stratum, hh_id, poor19, poor32, poor55)
  statins.second.men <- filter(statins.second.men, is.na(statin_sec)==F)
  statins.second.men <- filter(statins.second.men, is.na(w_dia_poor19_age)==F)
  statins.second.men <- filter(statins.second.men, is.na(poor19)==F)
  statins.second.men <- filter(statins.second.men, sex==0)
  statins.second.men <- statins.second.men %>% 
    mutate(psu = ifelse(is.na(psu==T), 1, psu),
          age = as.integer(age),
          hh_id = ifelse(is.na(hh_id==T), psu, hh_id),
          stratum = ifelse(is.na(stratum==T), 1, stratum)) %>% 
    mutate(agegroup = ifelse(age>=15 & age<=24, '15-24',
                      ifelse(age>=25 & age<=34, '25-34',
                             ifelse(age>=35 & age<=44, '35-44',
                                    ifelse(age>=45 & age<=54, '45-54',
                                           ifelse(age>=55 & age<=64, '55-64',
                                                  ifelse(age>=65, '>=65', NA)))))))

#for poor32
  statins.risk.32 <- statins.second.men %>% filter(poor32==1)
  statins.risk.32 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.32, nest = T)
  svymean(~statin_sec, statins.risk.32, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.32, level = 0.95))

#for poor55
  statins.risk.55 <- statins.second.men %>% filter(poor55==1)
  #statins.risk.55<-statins.risk.55[!(statins.risk.55$poor55==1 & statins.risk.55$agegroup=="35-44"),]
  statins.risk.55 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.55, nest = T)
  statins.prev.55 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.55, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.55 <- unite_ci(statins.prev.55, "Prev_poor55", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for poor0
  statins.risk.0 <- statins.second.men %>% filter(poor55==0)
  statins.risk.0 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.risk.0, nest = T)
  statins.prev.0 <- svyby(~statin_sec, by=~agegroup, design=statins.risk.0, svyciprop, proportion=TRUE, prop_method="asin", vartype = "ci")
  statins.prev.0 <- unite_ci(statins.prev.0, "Prev_poor0", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#for all povgroups
  statins.risk.second.all <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=statins.second.men, nest = T)
  statins.prev.second.all <- svyby(~statin_sec, by=~agegroup, design=statins.risk.second.all, svyciprop, proportion=TRUE, prop_method="asin", vartype = 
                                     "ci")
  statins.prev.second.all <- unite_ci(statins.prev.second.all, "Prev_poorall", statin_sec, ci_l, ci_u, m100 = T, percent = FALSE)

#append
  statins.second.comb <- statins.prev.0 %>%
    left_join(statins.prev.55) %>%
    left_join(statins.prev.32) 

#bring into right format
        statins.second.comb <- statins.second.comb %>% pivot_longer(!agegroup, names_to = "pov_group", values_to = "prevalence")
        statins.second.comb$prevalence <- gsub('--', '-', statins.second.comb$prevalence)  
        statins.second.comb <- tidyr::separate(statins.second.comb, prevalence, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.second.comb$V2  <- gsub("[()]", "", statins.second.comb$V2 )
        statins.second.comb <- tidyr::separate(statins.second.comb, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\-") 
        statins.second.comb <- statins.second.comb %>% 
          mutate( statin_treat_prim = as.numeric(statin_treat_prim),
                  cil_statin_prim = as.numeric(cil_statin_prim),
                  ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1) %>% 
          mutate(statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), 
                                           ")",sep="")) %>%
          select(agegroup, pov_group, statin_treat_prim)  %>% pivot_wider(names_from = pov_group, values_from = statin_treat_prim)
  
         write.csv(statins.second.comb, "~/statins.second.comb.csv")
    
#bring into right format 
        statins.prev.second.all <- tidyr::separate(statins.prev.second.all, Prev_poorall, c("statin_treat_prim", "V2"), "\\s(?:.+\\s)?")
        statins.prev.second.all$V2  <- gsub("[()]", "", statins.prev.second.all$V2 )
        statins.prev.second.all <- tidyr::separate(statins.prev.second.all, V2, c("cil_statin_prim", "ciu_statin_prim"), "\\--")
        statins.prev.second.all <- statins.prev.second.all %>% 
          mutate(statin_treat_prim = as.numeric(statin_treat_prim),
                  cil_statin_prim = as.numeric(cil_statin_prim),
                  ciu_statin_prim = as.numeric(ciu_statin_prim))  %>% 
          mutate_if(is.numeric, round, digits = 1)%>% mutate(
          statin_treat_prim = str_c(as.character(statin_treat_prim), " (", as.character(cil_statin_prim), "-", as.character(ciu_statin_prim), ")", 
                                    sep="")) %>%
          select(agegroup, statin_treat_prim)
        
        write.csv(statins.prev.second.all, "~/statins.prev.second.all.csv")

#to get totals
  svymean(~statin_sec, statins.risk.55, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.55, level = 0.95)) 
  
  svymean(~statin_sec, statins.risk.0, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.0, level = 0.95)) 
  
  svymean(~statin_sec, statins.risk.second.all, deff=TRUE)  
  confint(svymean(~statin_sec, statins.risk.second.all, level = 0.95)) 

#get significance level
  statins.second.men <- statins.second.men %>% 
    mutate(poor0 = ifelse(poor55==0, 1, 0))
  
  age3 <- filter(statins.second.men, agegroup=='35-44')
  statin.primary.treat.age3 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age3, nest = T)
  svychisq(~statin_sec + poor0, statin.primary.treat.age3) #0.01001
  
  age4 <- filter(statins.second.men, agegroup=='45-54')
  statin.primary.treat.age4 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age4, nest = T)
  svychisq(~statin_sec + poor55, statin.primary.treat.age4) #0.0004764
  svychisq(~statin_sec + poor0, statin.primary.treat.age4) #0.0004764
  
  age5 <- filter(statins.second.men, agegroup=='55-64')
  statin.primary.treat.age5 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age5, nest = T)
  svychisq(~statin_sec + poor55, statin.primary.treat.age5) #0.01382
  svychisq(~statin_sec + poor0, statin.primary.treat.age5) #0.01382
  
  age6 <- filter(statins.second.men, agegroup=='>=65')
  statin.primary.treat.age6 <- svydesign(id=~psu+hh_id, strata=~stratum, weights=~w_dia_poor19_age, data=age6, nest = T)
  svychisq(~statin_sec + poor55, statin.primary.treat.age6) #4.07e-12
  svychisq(~statin_sec + poor0, statin.primary.treat.age6)#4.07e-12

#bring all files into long format
  hypt_treat <- hypt_treat %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "hypt treated") 
  hypt_control <- hypt_control %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "hypt controlled") 
  dia_treat <- dia_treat %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "dia treated") 
  statin_primary <- statin_primary %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "statin primary") 
  statin_secondary <- statin_secondary %>% pivot_longer(!agegroups, names_to = "pov_group", values_to = "statin secondary") 

#merge
  plot.all <- hypt_treat %>% 
    left_join(hypt_control) %>% 
    left_join(dia_treat) %>% 
    left_join(statin_primary) %>% 
    left_join(statin_secondary)
  plot.all <- plot.all[plot.all$agegroups != "all", ]

###FIGURE S23 cascades by agegroup; males only
  plot.all <- plot.all %>% 
      gather(`hypt treated`, `hypt controlled`, `dia treated`, `statin primary`, `statin secondary`, key="step", value="temp")      
  plot.all <- tidyr::separate(plot.all, temp, c("est", "V2"), "\\s(?:.+\\s)?")
  plot.all$V2  <- gsub("[()]", "", plot.all$V2 )
  plot.all <- tidyr::separate(plot.all, V2, c("lowci", "highci"), "\\-") 
  plot.all <- plot.all %>% mutate(
      step = fct_relevel(step, 
           "hypt treated", "hypt controlled", "dia treated", "statin primary", "statin secondary"),
      est = as.numeric(est),
      lowci = as.numeric(lowci),
      highci = as.numeric(highci),
      pov_group = as.character(pov_group))
  plot.all$agegroups <- plot.all$agegroups %>% factor(c("15-24", "25-34", "35-44", "45-54", "55-64", ">=65", "all"))
  plot.all$pov_group <- plot.all$pov_group %>% factor(c("poor19", "poor32", "poor55", "poor0", "allpov"))
  
  cols <- c("poor19" = "#FEE8C8", "poor32" = "#FDD49E", "poor55" = "#FDBB84", "poor0" = "#EF6548", "allpov" = "black")

  cascades.all.men <- ggplot(plot.all, aes(x=step, y=est, fill=pov_group)) +
        geom_bar(stat='identity', position='dodge')+
        geom_errorbar(aes(ymin=lowci, ymax=highci), width=.2,
                   position=position_dodge(.9), show.legend = F) +
        theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=18, face="bold"),
          legend.text=element_text(size=18, family="Times"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=18, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=18, face="bold", family="Times")) + 
        scale_y_continuous(breaks = c(0, 20, 40, 60, 80)) +
        coord_cartesian(ylim=c(0, 80)) +
        facet_wrap(~agegroups) +
        labs(x = "",
             y = "%",
             fill="") +
        scale_fill_manual(values = c("#FEE8C8", "#FDD49E", "#FDBB84", "#EF6548", "black"), labels=c("poor19" = "<$1.90/day", "poor32" = "<$3.20/day", 
                                                                                                    "poor55" = "<$5.50/day", "poor0" = ">$5.50/day", 
                                                                                                    "allpov" = "Total")) +
        coord_fixed(5/80) 
        ggsave("cascades.all.men.png", height = 12, width = 16)

#Version 2: complete agegroups only
  plot.all <- plot.all %>% 
   gather(`hypt treated`, `hypt controlled`, `dia treated`, `statin primary`, `statin secondary`, key="step", value="temp")   
  plot.all <- tidyr::separate(plot.all, temp, c("est", "V2"), "\\s(?:.+\\s)?")
  plot.all$V2  <- gsub("[()]", "", plot.all$V2 )
  plot.all <- tidyr::separate(plot.all, V2, c("lowci", "highci"), "\\-") 
  plot.all <- plot.all %>% mutate(
      step = fct_relevel(step, 
          "hypt treated", "hypt controlled", "dia treated", "statin primary", "statin secondary"),
      est = as.numeric(est),
      lowci = as.numeric(lowci),
      highci = as.numeric(highci),
      pov_group = as.character(pov_group))
  plot.all <- filter(plot.all, agegroups!='15-24')
  plot.all <- filter(plot.all, agegroups!='25-34')
  plot.all <- filter(plot.all, agegroups!='35-44')
  plot.all$agegroups <- plot.all$agegroups %>% factor(c("45-54", "55-64", ">=65", "all"))
  plot.all$pov_group <- plot.all$pov_group %>% factor(c("poor19", "poor32", "poor55", "poor0", "allpov"))
  
  cols <- c("poor19" = "#FEE8C8", "poor32" = "#FDD49E", "poor55" = "#FDBB84", "poor0" = "#EF6548", "allpov" = "black")

  cascades.all.men.completeage.only <- ggplot(plot.all, aes(x=step, y=est, fill=pov_group)) +
        geom_bar(stat='identity', position='dodge')+
        geom_errorbar(aes(ymin=lowci, ymax=highci), width=.2,
                   position=position_dodge(.9), show.legend = F) +
        theme(axis.text.y=element_text(size=18, colour = "black"),
          axis.text.x=element_text(size=18, angle = 60, hjust = 1, colour = "black"),
          axis.title=element_text(size=18, face="bold"),
          legend.text=element_text(size=18, family="Times"),
          legend.title = element_blank(),
          #legend.position="none",
          axis.title.x = element_text(margin = margin(t = 20)),
          axis.title.y = element_text(margin = margin(r = 20), colour = "black"),
          strip.text.x = element_text(size=18, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          title = element_text(size=18, face="bold", family="Times")) + 
        scale_y_continuous(breaks = c(0, 20, 40, 60, 80)) +
        coord_cartesian(ylim=c(0, 80)) +
        facet_wrap(~agegroups) +
        labs(x = "",
             y = "%",
             fill="") +
        scale_fill_manual(values = c("#FEE8C8", "#FDD49E", "#FDBB84", "#EF6548", "black"), labels=c("poor19" = "<$1.90/day", "poor32" = "<$3.20/day", 
                                                                                                    "poor55" = "<$5.50/day", "poor0" = ">$5.50/day", 
                                                                                                    "allpov" = "Total")) +
        coord_fixed(5/80)
        ggsave("cascades.all.men.completeage.only.png", height = 12, width = 16)

```




```{r Regression figures, Figure 2, Figure S14-S21}

#Visualize regressions - keep regions with NA in figures so that they all have the same format - make it two plots, one displaying the risk ratio (RR), one showing the Average marginal effects (AME), separately for each risk factor. Use univariate regression results, I did some formatting in excel and then used separate excel sheets for each risk factor

###1) Hypertension

#A URBAN VS RURAL
#RR (risk ratio)
    urban_vs_rural <- read_excel("~/Hypertension(13).xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?")
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% 
      mutate(est = as.numeric(est),
            estimate_low = as.numeric(estimate_low),
            estimate_upp = as.numeric(estimate_upp))  
    urban_vs_rural <- urban_vs_rural  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Hypertension.urban.rr <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 0.8, 1, 1.2, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.8, 1.2))
  Hypertension.urban.rr
  ggsave("Hypertension.urban.rr.png", height = 12, width = 12)

#AME
  urban_vs_rural <- read_excel("~/Hypertension(14).xlsx")
  urban_vs_rural <- urban_vs_rural %>% 
    rename(est = 'est AMR',
          estimate_low = "estimate_low...8",
          estimate_upp = "estimate_upp...9",
          p = 'p...10', 
          pov_group = '...1')
  urban_vs_rural <- urban_vs_rural  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

#create figure  
  Hypertension.urban.ame <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.15, to=0.15, by=0.15), limits=c(-0.15, 0.15), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.15, 0.15))  # over write scale limits to display
  Hypertension.urban.ame
  ggsave("Hypertension.urban.ame.png", height = 12, width = 12)

#B MALE VS FEMALE 
#RR
    male_vs_female <- read_excel("~/Hypertension(15).xlsx")
    male_vs_female <- male_vs_female[-7,]
    male_vs_female <- male_vs_female %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    male_vs_female <- tidyr::separate(male_vs_female, est, c("est", "V2"), "\\s(?:.+\\s)?")
    male_vs_female$V2  <- gsub("[()]", "", male_vs_female$V2 )
    male_vs_female <- tidyr::separate(male_vs_female, V2, c("estimate_low", "estimate_upp"), "\\-") 
    male_vs_female <- male_vs_female %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  
    male_vs_female <- male_vs_female  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Hypertension.sex.rr <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
  Hypertension.sex.rr
  ggsave("Hypertension.sex.rr.png", height = 12, width = 12)

#AMR
  male_vs_female <- read_excel("~/Hypertension(15).xlsx")
  male_vs_female <- male_vs_female[-7,]
  male_vs_female <- male_vs_female %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')
      
  male_vs_female <- male_vs_female  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
  pov_group = as.factor(pov_group))
  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))  

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Hypertension.sex.ame <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  Hypertension.sex.ame
  ggsave("Hypertension.sex.ame.png", height = 12, width = 12)

###HIGH VS LOW EDUCATION
# RR
    high_vs_lowedu <- read_excel("~/Hypertension(16).xlsx")
    high_vs_lowedu <- high_vs_lowedu[-7,]
    high_vs_lowedu <- high_vs_lowedu %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    high_vs_lowedu$V2  <- gsub("[()]", "", high_vs_lowedu$V2 )
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    high_vs_lowedu <- high_vs_lowedu %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  
    high_vs_lowedu <- high_vs_lowedu  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

#create figure  
  Hypertension.edu.rr <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0.5, 1, 5, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.5, 5))
  Hypertension.edu.rr
  ggsave("Hypertension.edu.rr.png", height = 12, width = 12)

#AMR
  high_vs_lowedu <- read_excel("~/Hypertension(16).xlsx")
  high_vs_lowedu <- high_vs_lowedu[-7,]
  high_vs_lowedu <- high_vs_lowedu %>% 
    rename(est = 'est AMR',
          estimate_low = "estimate_low...8",
          estimate_upp = "estimate_upp...9",
          p = 'p...10', 
          pov_group = '...1')
  high_vs_lowedu <- high_vs_lowedu  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Hypertension.edu.ame <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.2, to=0.2, by=0.1), limits=c(-0.2, 0.2), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.2, 0.2))  # over write scale limits to display
  Hypertension.edu.ame
  ggsave("Hypertension.edu.ame.png", height = 12, width = 12)

###2) DIABETES -------------------------------------------------------------------------------------------------------------------------------------

# A URBAN VS RURAL
# RR
    urban_vs_rural <- read_excel("~/Diabetes(16).xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?")
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% 
      mutate(est = as.numeric(est),
            estimate_low = as.numeric(estimate_low),
            estimate_upp = as.numeric(estimate_upp))  
    urban_vs_rural <- urban_vs_rural  %>%            
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Diabetes.urban.rr <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 0.8, 1, 2, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.8, 2))
  Diabetes.urban.rr
  ggsave("Diabetes.urban.rr.png", height = 12, width = 12)

#AME
  urban_vs_rural <- read_excel("~/Diabetes(16).xlsx")
  urban_vs_rural <- urban_vs_rural %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')
      
  urban_vs_rural <- urban_vs_rural  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Diabetes.urban.ame <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.15, to=0.15, by=0.15), limits=c(-0.15, 0.15), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.15, 0.15))  # over write scale limits to display
  Diabetes.urban.ame
  ggsave("Diabetes.urban.ame.png", height = 12, width = 12)

#B MALE VS FEMALE 
#RR
    male_vs_female <- read_excel("~/Diabetes(17).xlsx")
    male_vs_female <- male_vs_female %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    male_vs_female <- tidyr::separate(male_vs_female, est, c("est", "V2"), "\\s(?:.+\\s)?")
    male_vs_female$V2  <- gsub("[()]", "", male_vs_female$V2 )
    male_vs_female <- tidyr::separate(male_vs_female, V2, c("estimate_low", "estimate_upp"), "\\-") 
    male_vs_female <- male_vs_female %>% 
      mutate(est = as.numeric(est),
            estimate_low = as.numeric(estimate_low),
            estimate_upp = as.numeric(estimate_upp))  
    male_vs_female <- male_vs_female  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
#create figure  
  Diabetes.sex.rr <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
  Diabetes.sex.rr
  ggsave("Diabetes.sex.rr.png", height = 12, width = 12)

#AMR
  male_vs_female <- read_excel("~/Diabetes(17).xlsx")
  male_vs_female <- male_vs_female %>% 
    rename(est = 'est AMR',
            estimate_low = "estimate_low...8",
            estimate_upp = "estimate_upp...9",
            p = 'p...10', 
            pov_group = '...1')
  male_vs_female <- male_vs_female  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Diabetes.sex.ame <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  Diabetes.sex.ame
  ggsave("Diabetes.sex.ame.png", height = 12, width = 12)

#HIGH VS LOW EDUCATION
#RR
    high_vs_lowedu <- read_excel("~/Diabetes(18).xlsx")
    high_vs_lowedu <- high_vs_lowedu %>% 
      rename(est = 'est RR',
            p = 'p...5', 
            pov_group = '...1')
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    high_vs_lowedu$V2  <- gsub("[()]", "", high_vs_lowedu$V2 )
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    high_vs_lowedu <- high_vs_lowedu %>% 
      mutate(est = as.numeric(est),
            estimate_low = as.numeric(estimate_low),
            estimate_upp = as.numeric(estimate_upp))  
    high_vs_lowedu <- high_vs_lowedu  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
    
    Diabetes.edu.rr <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0.5, 1, 5, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.5, 5))
    Diabetes.edu.rr
    ggsave("Diabetes.edu.rr.png", height = 12, width = 12)

#AMR
  high_vs_lowedu <- read_excel("~/Diabetes(18).xlsx")
  high_vs_lowedu <- high_vs_lowedu %>% 
    rename( est = 'est AMR',
            estimate_low = "estimate_low...8",
            estimate_upp = "estimate_upp...9",
            p = 'p...10', 
            pov_group = '...1')
  high_vs_lowedu <- high_vs_lowedu  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Diabetes.edu.ame <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.2, to=0.2, by=0.1), limits=c(-0.2, 0.2), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.2, 0.2))  # over write scale limits to display
  Diabetes.edu.ame
  ggsave("Diabetes.edu.ame.png", height = 12, width = 12)

###3) OVERWEIGHT --------------------------------------------------------------------------------------------------------------------------

# A URBAN VS RURAL
# RR
    urban_vs_rural <- read_excel("~/Overweight(9).xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?")
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% 
      mutate(est = as.numeric(est),
            estimate_low = as.numeric(estimate_low),
            estimate_upp = as.numeric(estimate_upp))  
    urban_vs_rural <- urban_vs_rural  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Overweight.urban.rr <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 0.8, 1, 2, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.8, 2))
  Overweight.urban.rr
  ggsave("Overweight.urban.rr.png", height = 12, width = 12)

#AME
  urban_vs_rural <- read_excel("~/Overweight(9).xlsx")
  urban_vs_rural <- urban_vs_rural %>% 
    rename(est = 'est AMR',
            estimate_low = "estimate_low...8",
            estimate_upp = "estimate_upp...9",
            p = 'p...10', 
            pov_group = '...1')
  urban_vs_rural <- urban_vs_rural  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Overweight.urban.ame <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.15, to=0.15, by=0.15), limits=c(-0.15, 0.15), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.15, 0.15))  # over write scale limits to display
    ggsave("Overweight.urban.ame.png", height = 12, width = 12)

#B MALE VS FEMALE 
#RR
    male_vs_female <- read_excel("~/Overweight(10).xlsx")
    male_vs_female <- male_vs_female %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    male_vs_female <- tidyr::separate(male_vs_female, est, c("est", "V2"), "\\s(?:.+\\s)?")
    male_vs_female$V2  <- gsub("[()]", "", male_vs_female$V2 )
    male_vs_female <- tidyr::separate(male_vs_female, V2, c("estimate_low", "estimate_upp"), "\\-") 
    male_vs_female <- male_vs_female %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  
    male_vs_female <- male_vs_female  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
    
    Overweight.sex.rr <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
    Overweight.sex.rr
    ggsave("Overweight.sex.rr.png", height = 12, width = 12)

#AMR
  male_vs_female <- read_excel("~/Overweight(10).xlsx")
  male_vs_female <- male_vs_female %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')
  male_vs_female <- male_vs_female  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Overweight.sex.ame <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  Overweight.sex.ame
  ggsave("Overweight.sex.ame.png", height = 12, width = 12)

#HIGH VS LOW EDUCATION
#RR
    high_vs_lowedu <- read_excel("~/Overweight(11).xlsx")
    high_vs_lowedu <- high_vs_lowedu %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    high_vs_lowedu$V2  <- gsub("[()]", "", high_vs_lowedu$V2 )
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    high_vs_lowedu <- high_vs_lowedu %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  
    high_vs_lowedu <- high_vs_lowedu  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
    
    Overweight.edu.rr <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0.5, 1, 5, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.5, 5))
    Overweight.edu.rr
    ggsave("Overweight.edu.rr.png", height = 12, width = 12)

#AMR
  high_vs_lowedu <- read_excel("~/Overweight(11).xlsx")
  high_vs_lowedu <- high_vs_lowedu %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')
  high_vs_lowedu <- high_vs_lowedu  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
  high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Overweight.edu.ame <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.2, to=0.2, by=0.1), limits=c(-0.2, 0.2), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.2, 0.2))  # over write scale limits to display
  Overweight.edu.ame
  ggsave("Overweight.edu.ame.png", height = 12, width = 12)

###4) OBESITY -----------------------------------------------------------------------------------------------------------------------------------

#A URBAN VS RURAL
#RR
    urban_vs_rural <- read_excel("~/Obesity(15).xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?")
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

    urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
  
    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

#create figure  
    Obesity.urban.rr <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0, 0.01, 0.1, 0.8, 1, 2, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.8, 2))
    Obesity.urban.rr
    ggsave("Obesity.urban.rr.png", height = 12, width = 12)

#AME
  urban_vs_rural <- read_excel("~/Obesity(15).xlsx")
  urban_vs_rural <- urban_vs_rural %>% 
    rename(est = 'est AMR',
            estimate_low = "estimate_low...8",
            estimate_upp = "estimate_upp...9",
            p = 'p...10', 
            pov_group = '...1' ) %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
      
  urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))  
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

#create figure  
  Obesity.urban.ame <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.15, to=0.15, by=0.15), limits=c(-0.15, 0.15), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.15, 0.15)) # over write scale limits to display
  Obesity.urban.ame
  ggsave("Obesity.urban.ame.png", height = 12, width = 12)

###B MALE VS FEMALE 
#RR
    male_vs_female <- read_excel("~/Obesity(16).xlsx")
    male_vs_female <- male_vs_female %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    male_vs_female <- tidyr::separate(male_vs_female, est, c("est", "V2"), "\\s(?:.+\\s)?")
    male_vs_female$V2  <- gsub("[()]", "", male_vs_female$V2 )
    male_vs_female <- tidyr::separate(male_vs_female, V2, c("estimate_low", "estimate_upp"), "\\-") 
    male_vs_female <- male_vs_female %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))

  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

#create figure    
  Obesity.sex.rr <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
  Obesity.sex.rr
  ggsave("Obesity.sex.rr.png", height = 12, width = 12)

##AMR
  male_vs_female <- read_excel("~/Obesity(16).xlsx")
  male_vs_female <- male_vs_female %>% 
    rename( est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
      
  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

#create figure  
  Obesity.sex.ame <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  Obesity.sex.ame
  ggsave("Obesity.sex.ame.png", height = 12, width = 12)

###HIGH VS LOW EDUCATION
#RR
    high_vs_lowedu <- read_excel("~/Obesity(17).xlsx")
    high_vs_lowedu <- high_vs_lowedu %>% 
      rename(est = 'est RR',
            p = 'p...5', 
            pov_group = '...1')
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    high_vs_lowedu$V2  <- gsub("[()]", "", high_vs_lowedu$V2 )
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    high_vs_lowedu <- high_vs_lowedu %>% 
      mutate(est = as.numeric(est),
          estimate_low = as.numeric(estimate_low),
          estimate_upp = as.numeric(estimate_upp))  
       mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
         sig = as.factor(sig),
         pov_group = as.factor(pov_group))
  
  high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Obesity.edu.rr <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0.5, 1, 5, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.5, 5))
  Obesity.edu.rr
  ggsave("Obesity.edu.rr.png", height = 12, width = 12)

#AMR
  high_vs_lowedu <- read_excel("~/Obesity(17).xlsx")
  high_vs_lowedu <- high_vs_lowedu[-7,]
  high_vs_lowedu <- high_vs_lowedu %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1') %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
      
  high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Obesity.edu.ame <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.2, to=0.2, by=0.1), limits=c(-0.2, 0.2), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.2, 0.2)) # over write scale limits to display
  Obesity.edu.ame
  ggsave("Obesity.edu.ame.png", height = 12, width = 12)

###5)SMOKING 

###A URBAN VS RURAL
# RR
    urban_vs_rural <- read_excel("~/Smoking(9).xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?")
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

    urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
    
    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
    Smoking.urban.rr <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0, 0.01, 0.1, 0.8, 1, 2, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.8, 2))
    Smoking.urban.rr
    ggsave("Smoking.urban.rr.png", height = 12, width = 12)

# AME
  urban_vs_rural <- read_excel("~/Smoking(9).xlsx")
  urban_vs_rural <- urban_vs_rural %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')  %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
      
  urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Smoking.urban.ame <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.15, to=0.15, by=0.15), limits=c(-0.15, 0.15), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.15, 0.15))  # over write scale limits to display
  Smoking.urban.ame
  ggsave("Smoking.urban.ame.png", height = 12, width = 12)

###B MALE VS FEMALE 
# RR
    male_vs_female <- read_excel("~/Smoking(11).xlsx")
    male_vs_female <- male_vs_female %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    male_vs_female <- tidyr::separate(male_vs_female, est, c("est", "V2"), "\\s(?:.+\\s)?")
    male_vs_female$V2  <- gsub("[()]", "", male_vs_female$V2 )
    male_vs_female <- tidyr::separate(male_vs_female, V2, c("estimate_low", "estimate_upp"), "\\-") 
    male_vs_female <- male_vs_female %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Smoking.sex.rr <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 1), colour = 'grey80') + 
    geom_point(size=8, alpha=1, aes(group=pov_group)) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Risk Ratio",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          #     axis.ticks.y = element_blank(),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + 
    scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
    scale_color_manual(values=cols) +
    scale_fill_discrete(guide = FALSE) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
  Smoking.sex.rr
  ggsave("Smoking.sex.rr.png", height = 12, width = 12)

#AMR
  male_vs_female <- read_excel("~/Smoking(11).xlsx")
  male_vs_female <- male_vs_female %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1')%>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
      
  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  Smoking.sex.ame <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  Smoking.sex.ame
  ggsave("Smoking.sex.ame.png", height = 12, width = 12)

###HIGH VS LOW EDUCATION
# RR
    high_vs_lowedu <- read_excel("~/Smoking(12).xlsx")
    high_vs_lowedu <- high_vs_lowedu %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    high_vs_lowedu$V2  <- gsub("[()]", "", high_vs_lowedu$V2 )
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    high_vs_lowedu <- high_vs_lowedu %>% 
      mutate(est = as.numeric(est),
          estimate_low = as.numeric(estimate_low),
          estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

    high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
    
    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
    
    Smoking.edu.rr <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0.5, 1, 5, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.5, 5))
    Smoking.edu.rr
    ggsave("Smoking.edu.rr.png", height = 12, width = 12)

#AMR
  high_vs_lowedu <- read_excel("~/Smoking(13).xlsx")
  high_vs_lowedu <- high_vs_lowedu %>% 
    rename(est = 'est AMR',
        estimate_low = "estimate_low...8",
        estimate_upp = "estimate_upp...9",
        p = 'p...10', 
        pov_group = '...1') %>%
    mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
           sig = as.factor(sig),
           pov_group = as.factor(pov_group))
    
  high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  Smoking.edu.ame <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-0.2, to=0.2, by=0.1), limits=c(-0.2, 0.2), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.2, 0.2))  # over write scale limits to display
  Smoking.edu.ame
  ggsave("Smoking.edu.ame.png", height = 12, width = 12)

###6) LIPIDS

#A URBAN VS RURAL
#RR
    urban_vs_rural <- read_excel("~/Lipids(16).xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?")
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

    urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
    
    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

    lipids.urban.rr <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
    lipids.urban.rr
    ggsave("lipids.urban.rr.png", height = 12, width = 12)

#AME
  urban_vs_rural <- read_excel("~/Lipids(16).xlsx")
  urban_vs_rural <- urban_vs_rural %>% 
      rename(est = 'est AMR',
          estimate_low = "estimate_low...8",
          estimate_upp = "estimate_upp...9",
          p = 'p...10', 
          pov_group = '...1') %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
    
  urban_vs_rural$pov_group <- urban_vs_rural$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))  
  
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
  
  lipids.urban.ame <- ggplot(data = urban_vs_rural, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  lipids.urban.ame
  ggsave("lipids.urban.ame.png", height = 12, width = 12)

###B MALE VS FEMALE 

# RR
    male_vs_female <- read_excel("~/Lipids(17).xlsx")
    male_vs_female <- male_vs_female %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    male_vs_female <- tidyr::separate(male_vs_female, est, c("est", "V2"), "\\s(?:.+\\s)?")
    male_vs_female$V2  <- gsub("[()]", "", male_vs_female$V2 )
    male_vs_female <- tidyr::separate(male_vs_female, V2, c("estimate_low", "estimate_upp"), "\\-") 
    male_vs_female <- male_vs_female %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

    male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
    
    cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
    
    lipids.sex.rr <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
      geom_vline(aes(xintercept = 1), colour = 'grey80') + 
      geom_point(size=8, alpha=1, aes(group=pov_group)) + 
      geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                     show.legend = F, alpha = 1.5) + 
      theme_classic() + 
      labs(x = "Risk Ratio",
           y = "",
           fill="",
           color="Significance") + 
      theme(axis.text.x=element_text(size=30),
            axis.text.y=element_text(size=30),
            #     axis.ticks.y = element_blank(),
            axis.title=element_text(size=30, face="bold"),
            axis.title.y = element_text(margin = margin(r = 20)),
            strip.text.x = element_text(size=30, face="bold"),
            strip.background = element_blank(),
            panel.spacing = unit(2, "lines"),
            legend.position = "none" ) + 
      scale_x_continuous(breaks = c(0, 0.01, 0.1, 1, 10)) +
      scale_color_manual(values=cols) +
      scale_fill_discrete(guide = FALSE) +
      scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                  "pov0" = "Inc. >5.50 USD/day")) + 
      coord_trans(x="log10", y = "identity", xlim = c(0.01, 14.5))
    lipids.sex.rr
    ggsave("lipids.sex.rr.png", height = 12, width = 12)

#AMR
  male_vs_female <- read_excel("~/Lipids(17).xlsx")
  male_vs_female <- male_vs_female %>% 
      rename(est = 'est AMR',
          estimate_low = "estimate_low...8",
          estimate_upp = "estimate_upp...9",
          p = 'p...10', 
          pov_group = '...1') %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))
      
  male_vs_female$pov_group <- male_vs_female$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
  cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

  lipids.sex.ame <- ggplot(data = male_vs_female, aes(y=pov_group, x=est, color=sig)) +
    geom_vline(aes(xintercept = 0), colour = 'grey80') +
    geom_point(size=8, alpha=1) + 
    geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                   show.legend = F, alpha = 1.5) + 
    theme_classic() + 
    labs(x = "Absolute difference (% points)",
         y = "",
         fill="",
         color="Significance") + 
    theme(axis.text.x=element_text(size=30),
          axis.text.y=element_text(size=30),
          axis.title=element_text(size=30, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          panel.spacing = unit(2, "lines"),
          legend.position = "none" ) + #,
    scale_color_manual(values=cols) +
    scale_x_continuous(breaks = seq(from=-1, to=1, by=0.2), limits=c(-1, 1), labels = percent_format(accuracy = 1, suffix = " ")) +
    scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                "pov0" = "Inc. >5.50 USD/day")) + 
    coord_cartesian(xlim=c(-0.4, 0.4))  # over write scale limits to display
  lipids.sex.ame
  ggsave("lipids.sex.ame.png", height = 12, width = 12)

###HIGH VS LOW EDUCATION

#RR
    high_vs_lowedu <- read_excel("~/Lipids(18).xlsx")
    high_vs_lowedu <- high_vs_lowedu %>% 
      rename(est = 'est RR',
              p = 'p...5', 
              pov_group = '...1')
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    high_vs_lowedu$V2  <- gsub("[()]", "", high_vs_lowedu$V2 )
    high_vs_lowedu <- tidyr::separate(high_vs_lowedu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    high_vs_lowedu <- high_vs_lowedu %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
             sig = as.factor(sig),
             pov_group = as.factor(pov_group))

      high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))
      
      cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")
      
#create figure      
      lipids.edu.rr <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
        geom_vline(aes(xintercept = 1), colour = 'grey80') + 
        geom_point(size=8, alpha=1, aes(group=pov_group)) + 
        geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                       show.legend = F, alpha = 1.5) + 
        theme_classic() + 
        labs(x = "Risk Ratio",
             y = "",
             fill="",
             color="Significance") + 
        theme(axis.text.x=element_text(size=30),
              axis.text.y=element_text(size=30),
              #     axis.ticks.y = element_blank(),
              axis.title=element_text(size=30, face="bold"),
              axis.title.y = element_text(margin = margin(r = 20)),
              strip.text.x = element_text(size=30, face="bold"),
              strip.background = element_blank(),
              panel.spacing = unit(2, "lines"),
              legend.position = "none" ) + 
        scale_x_continuous(breaks = c(0.5, 1, 5, 10)) +
        scale_color_manual(values=cols) +
        scale_fill_discrete(guide = FALSE) +
        scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                    "pov0" = "Inc. >5.50 USD/day")) + 
        coord_trans(x="log10", y = "identity", xlim = c(0.5, 5))
      lipids.edu.rr
      ggsave("lipids.edu.rr.png", height = 12, width = 12)

#AMR
      high_vs_lowedu <- read_excel("~/Lipids(18).xlsx")
      high_vs_lowedu <- high_vs_lowedu %>% 
          rename(est = 'est AMR',
              estimate_low = "estimate_low...8",
              estimate_upp = "estimate_upp...9",
              p = 'p...10', 
              pov_group = '...1') %>%
          mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),
                 sig = as.factor(sig),
                 pov_group = as.factor(pov_group))
          
      high_vs_lowedu$pov_group <- high_vs_lowedu$pov_group %>% factor(c("total", "pov19", "pov32", "pov55", "pov0"))    
      cols <- c("p < 0.05" = "seagreen4", "p >= 0.05" = "orangered4")

      lipids.edu.ame <- ggplot(data = high_vs_lowedu, aes(y=pov_group, x=est, color=sig)) +
        geom_vline(aes(xintercept = 0), colour = 'grey80') +
        geom_point(size=8, alpha=1) + 
        geom_errorbar(aes(xmin=estimate_low, xmax=estimate_upp), height=0.3, 
                       show.legend = F, alpha = 1.5) + 
        theme_classic() + 
        labs(x = "Absolute difference (% points)",
             y = "",
             fill="",
             color="Significance") + 
        theme(axis.text.x=element_text(size=30),
              axis.text.y=element_text(size=30),
              axis.title=element_text(size=30, face="bold"),
              axis.title.y = element_text(margin = margin(r = 20)),
              strip.text.x = element_text(size=30, face="bold"),
              strip.background = element_blank(),
              panel.spacing = unit(2, "lines"),
              legend.position = "none" ) + #,
        scale_color_manual(values=cols) +
        scale_x_continuous(breaks = seq(from=-0.2, to=0.2, by=0.1), limits=c(-0.2, 0.2), labels = percent_format(accuracy = 1, suffix = " ")) +
        scale_y_discrete(labels = c("total" = "Total", "pov19" = "Inc. <1.90 USD/day", "pov32" = "Inc. <3.20 USD/day", "pov55" = "Inc. <5.50 USD/day", 
                                    "pov0" = "Inc. >5.50 USD/day")) + 
        coord_cartesian(xlim=c(-0.2, 0.2))  # over write scale limits to display
      lipids.edu.ame
      ggsave("lipids.edu.ame.png", height = 12, width = 12)

```


``` {r regression figures by risk factor, Figure S15-S18}

#forest plot that depicts risk ratios for all poverty groups by risk factor. Three figures: i) Urban vs rural, ii) high vs low education, iii) male vs female. Previous formatting was done in excel, use univariate regression results

#i) urban vs rural
    urban_vs_rural <- read_excel("~/urban_rural.xlsx")
    urban_vs_rural <- urban_vs_rural %>% 
      rename(risk_factor = '...1',
            povgroup = "poverty group") 
    urban_vs_rural <- tidyr::separate(urban_vs_rural, est, c("est", "V2"), "\\s(?:.+\\s)?") #split format to show lower CI and upper CI separately
    urban_vs_rural$V2  <- gsub("[()]", "", urban_vs_rural$V2 )
    urban_vs_rural <- tidyr::separate(urban_vs_rural, V2, c("estimate_low", "estimate_upp"), "\\-") 
    urban_vs_rural <- urban_vs_rural %>% mutate(
          est = as.numeric(est),
          estimate_low = as.numeric(estimate_low),
          estimate_upp = as.numeric(estimate_upp))  
    urban_vs_rural <- urban_vs_rural  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"), #we want to display significance vs non-significance by shape
             sig = as.factor(sig),
             risk_factor = as.factor(risk_factor))
    
#set factor levels to ensure common format in all figures
  urban_vs_rural$risk_factor <- urban_vs_rural$risk_factor %>% factor(c("Dyslipidemia", "Smoking", "Obesity", "Diabetes", "Hypertension"))
  urban_vs_rural$povgroup <- urban_vs_rural$povgroup %>% factor(c("<$1.90/day", "<$3.20/day", "<$5.50/day", ">$5.50/day", "Total"))

#create figure  
  urban.rr <- ggplot(urban_vs_rural, aes(x=est, y=risk_factor, xmin=estimate_low, xmax=estimate_upp, group=povgroup, color=povgroup)) + 
    geom_linerange(size=1,position=position_dodge(width = 0.5)) +
    geom_vline(xintercept=1, lty=2) +
    geom_point(aes(shape=sig),na.rm=TRUE, position=position_dodge(width=0.5), colour="black", size = 3)+
      theme_classic() + 
      theme(axis.text.x=element_text(size=40, margin = margin(t = 0, r = 0, b = 20, l = 0)),
          axis.text.y=element_text(size=30),
          title = element_text(size=30, face="bold", family="Times"), 
          axis.title=element_text(size=40, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          legend.text=element_text(size=14),
          panel.spacing = unit(2, "lines"),
          legend.position = "right", legend.title=element_text(size=14)) + 
    scale_x_continuous(breaks = c(0.2, 0.5, 1, 2, 10)) +
    coord_trans(x="log10", y = "identity", xlim = c(0.2, 15))+
    labs(title = paste0("Urban vs rural (reference category)"),
         x = "Risk ratio",
         y = "",
         fill="",
         color="Poverty group") + 
    guides(shape=guide_legend("Significance")) 
  urban.rr
  ggsave("urban.rr.png", height = 12, width = 12)

###ii) high vs low education
    edu <- read_excel("~/high_lowedu.xlsx")
    edu <- edu %>% 
      rename(risk_factor = '...1',
            povgroup = "poverty group") 
    edu <- tidyr::separate(edu, est, c("est", "V2"), "\\s(?:.+\\s)?")
    edu$V2  <- gsub("[()]", "", edu$V2 )
    edu <- tidyr::separate(edu, V2, c("estimate_low", "estimate_upp"), "\\-") 
    edu <- edu %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))  %>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),,
             sig = as.factor(sig),
             risk_factor = as.factor(risk_factor))
    
#set factor levels to ensure common format in all figures
  edu$risk_factor <- edu$risk_factor %>% factor(c("Dyslipidemia", "Smoking", "Obesity", "Diabetes", "Hypertension"))
  edu$povgroup <- edu$povgroup %>% factor(c("<$1.90/day", "<$3.20/day", "<$5.50/day", ">$5.50/day", "Total"))
  
  edu.rr <- ggplot(edu, aes(x=est, y=risk_factor, xmin=estimate_low, xmax=estimate_upp, group=povgroup, color=povgroup)) + 
    geom_linerange(size=1,position=position_dodge(width = 0.5)) +
    geom_vline(xintercept=1, lty=2) +
    geom_point(aes(shape=sig),na.rm=TRUE, position=position_dodge(width=0.5), colour="black", size = 3)+
      theme_classic() + 
        theme(axis.text.x=element_text(size=40, margin = margin(t = 0, r = 0, b = 20, l = 0)),
          axis.text.y=element_text(size=30),
          title = element_text(size=30, face="bold", family="Times"), 
          axis.title=element_text(size=40, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          legend.text=element_text(size=14),
          panel.spacing = unit(2, "lines"),
          legend.position = "right", legend.title=element_text(size=14)) + 
    scale_x_continuous(breaks = c(0.2, 0.5, 1, 2, 10)) +
    coord_trans(x="log10", y = "identity", xlim = c(0.2, 15))+
    labs(title = paste0("High school or above vs 
  no schooling (reference category)"),
         x = "Risk ratio",
         y = "",
         fill="",
         color="Poverty group") + 
    guides(shape=guide_legend("Significance")) 
  edu.rr
  ggsave("edu.rr.png", height = 12, width = 12)

###iii) male vs female
    sex <- read_excel("~/male_female.xlsx")
    sex <- sex %>% 
      rename(risk_factor = '...1',
             povgroup = "poverty group") 
    sex <- tidyr::separate(sex, est, c("est", "V2"), "\\s(?:.+\\s)?")
    sex$V2  <- gsub("[()]", "", sex$V2 )
    sex <- tidyr::separate(sex, V2, c("estimate_low", "estimate_upp"), "\\-") 
    sex <- sex %>% 
      mutate(est = as.numeric(est),
              estimate_low = as.numeric(estimate_low),
              estimate_upp = as.numeric(estimate_upp))%>%
      mutate(sig = ifelse(p < 0.05, "p < 0.05", "p >= 0.05"),,
             sig = as.factor(sig),
             risk_factor = as.factor(risk_factor))

#set factor levels to ensure common format in all figures    
  sex$risk_factor <- sex$risk_factor %>% factor(c("Dyslipidemia", "Smoking", "Obesity", "Diabetes", "Hypertension"))
  sex$povgroup <- sex$povgroup %>% factor(c("<$1.90/day", "<$3.20/day", "<$5.50/day", ">$5.50/day", "Total"))
  
  sex.rr <- ggplot(sex, aes(x=est, y=risk_factor, xmin=estimate_low, xmax=estimate_upp, group=povgroup, color=povgroup)) + 
    geom_linerange(size=1,position=position_dodge(width = 0.5)) +
    geom_vline(xintercept=1, lty=2) +
    geom_point(aes(shape=sig),na.rm=TRUE, position=position_dodge(width=0.5), colour="black", size = 3)+
        theme_classic() + 
        theme(axis.text.x=element_text(size=40, margin = margin(t = 0, r = 0, b = 20, l = 0)),
          axis.text.y=element_text(size=30),
          title = element_text(size=30, face="bold", family="Times"), 
          axis.title=element_text(size=40, face="bold"),
          axis.title.y = element_text(margin = margin(r = 20)),
          strip.text.x = element_text(size=30, face="bold"),
          strip.background = element_blank(),
          legend.text=element_text(size=14),
          panel.spacing = unit(2, "lines"),
          legend.position = "right", legend.title=element_text(size=14)) + 
    scale_x_continuous(breaks = c(0.2, 0.5, 1, 2, 10)) +
    coord_trans(x="log10", y = "identity", xlim = c(0.2, 15))+
    labs(title = paste0("Male vs female (reference category)"),
         x = "Risk ratio",
         y = "",
         fill="",
         color="Poverty group") + 
    guides(shape=guide_legend("Significance")) 
  sex.rr
  ggsave("sex.rr.png", height = 12, width = 12)
  
  
```




